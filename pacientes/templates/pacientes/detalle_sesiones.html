{% extends 'base.html' %}

{% block title %}Sesiones de {{ paciente.nombre_completo }} - Centro Infantil Misael{% endblock %}

{% block content %}
<style>
    /* Estilos para las sesiones expandibles */
    .sesion-expandida {
        display: none;
        background-color: #f9fafb;
    }
    
    .sesion-expandida.active {
        display: table-row;
    }
    
    /* Badges de estado */
    .badge-realizada { background: #d1fae5; color: #065f46; }
    .badge-retraso { background: #fef3c7; color: #92400e; }
    .badge-programada { background: #dbeafe; color: #1e40af; }
    .badge-falta { background: #fee2e2; color: #991b1b; }
    .badge-permiso { background: #e9d5ff; color: #6b21a8; }
    .badge-cancelada { background: #f3f4f6; color: #374151; }
    .badge-reprogramada { background: #fed7aa; color: #9a3412; }
    
    .badge-pagado { background: #d1fae5; color: #065f46; }
    .badge-parcial { background: #fef3c7; color: #92400e; }
    .badge-pendiente { background: #fee2e2; color: #991b1b; }
    .badge-no-aplica { background: #f3f4f6; color: #6b7280; }
    
    /* Accordion */
    .accordion-content {
        display: none;
        overflow: hidden;
    }
    
    .accordion-content.active {
        display: block;
    }
    
    /* Responsive tables */
    @media (max-width: 768px) {
        .desktop-table { display: none; }
        .mobile-cards { display: block; }
    }
    
    @media (min-width: 769px) {
        .desktop-table { display: block; }
        .mobile-cards { display: none; }
    }
</style>

<!-- ==================== HEADER ==================== -->
<div class="mb-8">
    <div class="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 rounded-3xl p-6 shadow-xl relative overflow-hidden">
        <div class="absolute top-0 right-0 -mr-8 -mt-8 w-40 h-40 rounded-full bg-white opacity-10 blur-3xl"></div>

        <div class="relative flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <div class="flex items-center gap-3 text-purple-100 text-xs font-bold uppercase tracking-wider mb-1">
                    <span>üìä An√°lisis Completo de Sesiones</span>
                </div>
                <h1 class="text-2xl sm:text-3xl font-black text-white">
                    {{ paciente.nombre_completo }}
                </h1>
                <p class="text-purple-100 text-sm mt-1">
                    Total: {{ stats.total_sesiones }} sesiones registradas
                </p>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'pacientes:detalle' paciente.id %}" 
                   class="bg-white/10 hover:bg-white hover:text-purple-600 text-white px-5 py-2 rounded-full font-bold text-xs transition-all border border-white/20 backdrop-blur-md flex items-center gap-2">
                    <span>‚Üê</span> Volver al Perfil
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ESTAD√çSTICAS GENERALES ==================== -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-2xl p-4 shadow-md border border-blue-100">
        <p class="text-xs text-blue-600 font-bold uppercase">Normales</p>
        <p class="text-3xl font-black text-blue-900">{{ stats.total_normales }}</p>
    </div>
    <div class="bg-white rounded-2xl p-4 shadow-md border border-purple-100">
        <p class="text-xs text-purple-600 font-bold uppercase">Mensualidades</p>
        <p class="text-3xl font-black text-purple-900">{{ stats.total_mensualidades }}</p>
    </div>
    <div class="bg-white rounded-2xl p-4 shadow-md border border-pink-100">
        <p class="text-xs text-pink-600 font-bold uppercase">Proyectos</p>
        <p class="text-3xl font-black text-pink-900">{{ stats.total_proyectos }}</p>
    </div>
    <div class="bg-white rounded-2xl p-4 shadow-md border border-green-100">
        <p class="text-xs text-green-600 font-bold uppercase">Asistencia</p>
        <p class="text-3xl font-black text-green-900">{{ stats.tasa_asistencia|floatformat:0 }}%</p>
    </div>
</div>

<!-- ==================== TABS ==================== -->
<div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden">
    <!-- Tabs Header -->
    <div class="border-b border-gray-200">
        <nav class="flex flex-wrap gap-2 p-4" role="tablist">
            <a href="?tab=normales{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
               class="px-6 py-3 rounded-xl font-bold text-sm transition-all
                      {% if tab_activo == 'normales' %}
                          bg-blue-600 text-white shadow-md
                      {% else %}
                          bg-gray-100 text-gray-600 hover:bg-gray-200
                      {% endif %}">
                üìÑ Sesiones Normales ({{ stats.total_normales }})
            </a>
            
            <a href="?tab=mensualidades{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
               class="px-6 py-3 rounded-xl font-bold text-sm transition-all
                      {% if tab_activo == 'mensualidades' %}
                          bg-purple-600 text-white shadow-md
                      {% else %}
                          bg-gray-100 text-gray-600 hover:bg-gray-200
                      {% endif %}">
                üí≥ Mensualidades ({{ stats.total_mensualidades }})
            </a>
            
            <a href="?tab=proyectos{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
               class="px-6 py-3 rounded-xl font-bold text-sm transition-all
                      {% if tab_activo == 'proyectos' %}
                          bg-pink-600 text-white shadow-md
                      {% else %}
                          bg-gray-100 text-gray-600 hover:bg-gray-200
                      {% endif %}">
                üì¶ Proyectos ({{ stats.total_proyectos }})
            </a>
        </nav>
    </div>
    
    <!-- Filtros (solo para normales y mensualidades) -->
    {% if tab_activo == 'normales' or tab_activo == 'mensualidades' %}
    <div class="bg-gray-50 p-4 border-b border-gray-200">
        <form method="get" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
            <input type="hidden" name="tab" value="{{ tab_activo }}">
            
            <select name="estado" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-bold">
                <option value="">üîÑ Todos los estados</option>
                {% for value, label in estados_sesion %}
                <option value="{{ value }}" {% if filtros.estado == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            
            <select name="pago" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-bold">
                <option value="">üí∞ Estado de pago</option>
                <option value="pagado" {% if filtros.pago == 'pagado' %}selected{% endif %}>Pagado</option>
                <option value="parcial" {% if filtros.pago == 'parcial' %}selected{% endif %}>Parcial</option>
                <option value="pendiente" {% if filtros.pago == 'pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="no_aplica" {% if filtros.pago == 'no_aplica' %}selected{% endif %}>No aplica</option>
            </select>
            
            <select name="profesional" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-bold">
                <option value="">üë®‚Äç‚öïÔ∏è Profesional</option>
                {% for prof in profesionales %}
                <option value="{{ prof.id }}" {% if filtros.profesional|stringformat:"s" == prof.id|stringformat:"s" %}selected{% endif %}>
                    {{ prof.apellido }} {{ prof.nombre }}
                </option>
                {% endfor %}
            </select>
            
            <input type="date" name="desde" value="{{ filtros.desde }}" 
                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-bold"
                   placeholder="Desde">
            
            <input type="date" name="hasta" value="{{ filtros.hasta }}" 
                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-bold"
                   placeholder="Hasta">
            
            <button type="submit" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all shadow-md">
                üîç Filtrar
            </button>
            
            <a href="?tab={{ tab_activo }}" 
               class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm transition-all text-center">
                üîÑ Limpiar
            </a>
        </form>
    </div>
    {% endif %}
    
    <!-- Contenido de los Tabs -->
    <div class="p-6">
        {% if tab_activo == 'normales' %}
            {% include 'pacientes/partials/sesiones_normales.html' %}
        {% elif tab_activo == 'mensualidades' %}
            {% include 'pacientes/partials/sesiones_mensualidades.html' %}
        {% elif tab_activo == 'proyectos' %}
            {% include 'pacientes/partials/sesiones_proyectos.html' %}
        {% endif %}
    </div>
</div>

<!-- ==================== JAVASCRIPT ==================== -->
<script>
// Toggle sesiones expandibles
function toggleSesion(id) {
    const expandida = document.getElementById(`expandida-${id}`);
    const icon = document.getElementById(`icon-${id}`);
    
    if (expandida.classList.contains('active')) {
        expandida.classList.remove('active');
        icon.textContent = '‚ñº';
    } else {
        // Cerrar todas las dem√°s
        document.querySelectorAll('.sesion-expandida').forEach(el => {
            el.classList.remove('active');
        });
        document.querySelectorAll('[id^="icon-"]').forEach(el => {
            el.textContent = '‚ñº';
        });
        
        expandida.classList.add('active');
        icon.textContent = '‚ñ≤';
    }
}

// Toggle accordion mensualidades
function toggleAccordion(id) {
    const content = document.getElementById(`accordion-${id}`);
    const icon = document.getElementById(`accordion-icon-${id}`);
    
    if (content.classList.contains('active')) {
        content.classList.remove('active');
        icon.textContent = '+';
    } else {
        content.classList.add('active');
        icon.textContent = '‚àí';
    }
}
</script>

{% endblock %}