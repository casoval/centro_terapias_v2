{% extends 'base.html' %}

{% block title %}Eliminar Paciente - Centro Infantil Misael{% endblock %}

{% block content %}
<style>
    .btn-peligro { transition: all 0.2s ease; }
    .btn-peligro:hover { transform: scale(1.02); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3); }
    .btn-seguro { transition: all 0.2s ease; }
    .btn-seguro:hover { transform: scale(1.02); box-shadow: 0 10px 25px rgba(251, 146, 60, 0.3); }
</style>

<div class="mb-8">
    <div class="relative bg-gradient-to-r from-red-500 via-red-600 to-red-700 rounded-3xl p-6 sm:p-8 shadow-xl overflow-hidden">
        <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 rounded-full bg-orange-400 opacity-20 blur-2xl"></div>
        <div class="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 rounded-full bg-pink-500 opacity-20 blur-xl"></div>
        
        <div class="relative flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-black text-white flex items-center gap-3">
                    <span class="bg-white/20 p-2 rounded-xl backdrop-blur-sm shadow-inner">‚ö†Ô∏è</span> 
                    Eliminar Paciente
                </h1>
                <p class="text-red-100 text-sm mt-2 font-medium">
                    {% if tiene_datos %}üîí Acci√≥n restringida por seguridad{% else %}Esta acci√≥n NO se puede deshacer{% endif %}
                </p>
            </div>
            <a href="{% url 'pacientes:lista' %}" 
               class="group bg-white/10 text-white px-6 py-2.5 rounded-full font-bold text-sm shadow-lg hover:bg-white hover:text-red-600 transition-all flex items-center gap-2 border border-white/20 backdrop-blur-md">
                <span>‚Üê</span> Cancelar
            </a>
        </div>
    </div>
</div>

<div class="max-w-3xl mx-auto">
    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
        
        <div class="bg-red-50 p-8 text-center border-b border-red-100">
            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-4xl shadow-md mx-auto mb-4 border-4 border-red-100">
                {% if tiene_datos %}üîí{% else %}üóëÔ∏è{% endif %}
            </div>
            <h2 class="text-2xl font-black text-gray-800 mb-2">
                {% if tiene_datos %}
                No se puede eliminar este paciente
                {% else %}
                ¬øEst√°s completamente seguro?
                {% endif %}
            </h2>
            <p class="text-sm text-red-600 font-medium max-w-md mx-auto">
                {% if tiene_datos %}
                Existen registros hist√≥ricos vinculados a este perfil que no pueden ser borrados.
                {% else %}
                Est√°s a punto de borrar permanentemente el siguiente perfil del sistema.
                {% endif %}
            </p>
        </div>
        
        <div class="p-8">
            <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm mb-6 flex flex-col sm:flex-row items-center sm:items-start gap-6">
                <div class="flex-shrink-0">
                    {% if paciente.tiene_foto %}
                        <img src="{{ paciente.get_foto_thumbnail }}" 
                             alt="{{ paciente.nombre_completo }}"
                             class="w-20 h-20 rounded-full object-cover border-4 border-gray-50 shadow-sm">
                    {% else %}
                        <div class="bg-indigo-50 text-indigo-300 w-20 h-20 rounded-full flex items-center justify-center text-4xl border-4 border-white shadow-sm">
                            üë§
                        </div>
                    {% endif %}
                </div>
                
                <div class="flex-1 w-full text-center sm:text-left">
                    <h3 class="text-xl font-black text-gray-800">{{ paciente.nombre_completo }}</h3>
                    <div class="flex flex-wrap justify-center sm:justify-start gap-2 mt-2 mb-3">
                        <span class="px-2 py-0.5 text-xs font-bold bg-blue-50 text-blue-600 rounded-lg">{{ paciente.edad }} a√±os</span>
                        <span class="px-2 py-0.5 text-xs font-bold bg-gray-100 text-gray-600 rounded-lg">{{ paciente.get_genero_display }}</span>
                        {% if paciente.estado == 'activo' %}
                        <span class="px-2 py-0.5 text-xs font-bold bg-green-50 text-green-600 rounded-lg">Activo</span>
                        {% else %}
                        <span class="px-2 py-0.5 text-xs font-bold bg-gray-200 text-gray-500 rounded-lg">Inactivo</span>
                        {% endif %}
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-left border-t border-gray-50 pt-3">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Tutor Principal</p>
                            <p class="text-sm font-bold text-gray-700">{{ paciente.nombre_tutor }}</p>
                            <p class="text-xs text-gray-500">üìû {{ paciente.telefono_tutor }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Sucursales</p>
                            <div class="flex flex-wrap gap-1 mt-1">
                                {% for sucursal in paciente.sucursales.all %}
                                <span class="px-1.5 py-0.5 bg-indigo-50 text-indigo-600 rounded text-[10px] font-bold border border-indigo-100">
                                    {{ sucursal.nombre }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                {% if tiene_datos %}
                <div class="bg-red-50 border border-red-200 rounded-2xl p-5">
                    <div class="flex items-start gap-4">
                        <span class="text-2xl bg-white rounded-full p-1 shadow-sm">üö´</span>
                        <div class="flex-1">
                            <p class="text-sm font-black text-red-900 mb-1">ELIMINACI√ìN BLOQUEADA</p>
                            <p class="text-xs text-red-700 font-medium mb-3">
                                Este paciente tiene datos asociados importantes:
                            </p>
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                {% if datos_relacionados.sesiones > 0 %}
                                <div class="bg-white/60 rounded-xl p-2 border border-red-100 text-center">
                                    <p class="text-lg font-black text-red-800">{{ datos_relacionados.sesiones }}</p>
                                    <p class="text-[9px] text-red-500 font-bold uppercase">Sesiones</p>
                                </div>
                                {% endif %}
                                {% if datos_relacionados.servicios > 0 %}
                                <div class="bg-white/60 rounded-xl p-2 border border-red-100 text-center">
                                    <p class="text-lg font-black text-red-800">{{ datos_relacionados.servicios }}</p>
                                    <p class="text-[9px] text-red-500 font-bold uppercase">Servicios</p>
                                </div>
                                {% endif %}
                                {% if datos_relacionados.proyectos > 0 %}
                                <div class="bg-white/60 rounded-xl p-2 border border-red-100 text-center">
                                    <p class="text-lg font-black text-red-800">{{ datos_relacionados.proyectos }}</p>
                                    <p class="text-[9px] text-red-500 font-bold uppercase">Proyectos</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-orange-50 border border-orange-200 rounded-2xl p-5 shadow-sm">
                    <div class="flex items-start gap-4">
                        <span class="text-2xl bg-white rounded-full p-1 shadow-sm">‚úÖ</span>
                        <div class="flex-1">
                            <p class="text-sm font-black text-orange-900 mb-1">SOLUCI√ìN: Desactivar Paciente</p>
                            <p class="text-xs text-orange-800 mb-3">Al desactivar el paciente:</p>
                            <ul class="text-xs text-orange-800 font-medium space-y-1 ml-1">
                                <li>üîí No aparecer√° en b√∫squedas ni listas activas.</li>
                                <li>üíæ Se conserva todo el historial m√©dico y de pagos.</li>
                                <li>üîÑ Puedes reactivarlo cuando quieras.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-4">
                    <p class="text-xs font-bold text-yellow-800 flex items-center gap-2">
                        <span>‚ö†Ô∏è</span> Consecuencias de eliminar:
                    </p>
                    <ul class="mt-2 space-y-1 ml-6 list-disc text-[11px] text-yellow-800">
                        <li>Se borrar√° el perfil y sus servicios contratados.</li>
                        {% if paciente.user %}
                        <li>Se desvincular√° del usuario <strong>{{ paciente.user.username }}</strong> (el usuario no se borra).</li>
                        {% endif %}
                        <li>No podr√°s recuperar esta informaci√≥n.</li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="bg-gray-50 p-6 sm:p-8 border-t border-gray-100">
            <form method="post" id="formEliminar" class="flex flex-col gap-3">
                {% csrf_token %}
                
                <button type="submit" 
                        name="accion"
                        value="desactivar"
                        class="btn-seguro w-full bg-gradient-to-r from-orange-400 to-orange-500 text-white py-4 rounded-xl font-black text-sm shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <span>üîí</span> DESACTIVAR PACIENTE (Recomendado)
                </button>
                
                {% if not tiene_datos %}
                <button type="button" 
                        name="accion" 
                        value="eliminar" 
                        onclick="confirmarEliminacion(event)"
                        class="btn-peligro w-full bg-white border-2 border-red-100 text-red-600 hover:bg-red-50 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 mt-2">
                    <span>üóëÔ∏è</span> S√≠, eliminar permanentemente
                </button>
                {% endif %}
                
                <a href="{% url 'pacientes:lista' %}" class="text-center text-xs font-bold text-gray-400 hover:text-gray-600 mt-2">
                    Cancelar y volver
                </a>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmarEliminacion(event) {
    event.preventDefault();
    
    Swal.fire({
        title: '¬øEst√°s completamente seguro?',
        text: "Vas a eliminar a {{ paciente.nombre_completo }}. Esta acci√≥n es irreversible y se perder√° todo el historial m√©dico.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444', // Rojo
        cancelButtonColor: '#6b7280',   // Gris
        confirmButtonText: 'S√≠, eliminar permanentemente',
        cancelButtonText: 'No, cancelar',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.getElementById('formEliminar');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'accion';
            hiddenInput.value = 'eliminar';
            form.appendChild(hiddenInput);
            form.submit();
        }
    });
}
</script>
{% endblock %}