<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Centro de Terapias{% endblock %}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    {% block extra_css %}{% endblock %}
    
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* ===== FONDO DEGRADADO ATARDECER C√ÅLIDO ===== */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #FFFF99 0%, #FFD700 20%, #FF8C00 50%, #FF4500 75%, #8B4513 100%);
            z-index: -2;
        }

        /* Formas geom√©tricas de fondo */
        .background-shapes {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            top: 0;
            left: 0;
            z-index: -1;
            pointer-events: none;
        }

        .polygon {
            position: absolute;
            opacity: 0.15;
            animation: rotate-float 20s infinite ease-in-out;
        }

        .polygon-1 {
            width: 0;
            height: 0;
            border-left: 150px solid transparent;
            border-right: 150px solid transparent;
            border-bottom: 260px solid #FF1493;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .polygon-2 {
            width: 200px;
            height: 200px;
            background: #00CED1;
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
            top: 15%;
            right: 15%;
            animation-delay: 3s;
        }

        .polygon-3 {
            width: 180px;
            height: 180px;
            background: #9370DB;
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            bottom: 20%;
            left: 20%;
            animation-delay: 6s;
        }

        .polygon-4 {
            width: 220px;
            height: 220px;
            background: #32CD32;
            clip-path: polygon(50% 0%, 90% 20%, 100% 60%, 75% 100%, 25% 100%, 0% 60%, 10% 20%);
            bottom: 15%;
            right: 25%;
            animation-delay: 9s;
        }

        @keyframes rotate-float {
            0%, 100% {
                transform: rotate(0deg) translateY(0) scale(1);
            }
            25% {
                transform: rotate(90deg) translateY(-20px) scale(1.1);
            }
            50% {
                transform: rotate(180deg) translateY(-40px) scale(0.9);
            }
            75% {
                transform: rotate(270deg) translateY(-20px) scale(1.05);
            }
        }
        /* ===== FIN FONDO ATARDECER C√ÅLIDO ===== */


        /* Degradado elegante para la barra de navegaci√≥n */
        .navbar-gradient {
            background: linear-gradient(135deg, 
                #ffffff 0%,
                #eff6ff 12%,
                #dbeafe 20%,
                #fef3c7 30%,
                #fde68a 40%,
                #dbeafe 50%,
                #bfdbfe 60%,
                #dbeafe 70%,
                #bfdbfe 80%,
                #eff6ff 90%,
                #ffffff 100%);
            background-size: 400% 400%;
            animation: gradientMove 15s ease-in-out infinite;
            backdrop-filter: blur(16px) saturate(180%);
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, #93c5fd, #fde68a, #93c5fd, #a5b4fc, #93c5fd) 1;
            border-image-slice: 1;
            position: relative;
            transition: all 0.3s ease;
        }

        /* Efecto hover en la barra completa */
        .navbar-gradient:hover {
            background-size: 450% 450%;
            border-bottom: 3px solid rgba(30, 64, 175, 0.3);
        }

        /* Animaci√≥n de movimiento del degradado - m√°s lenta y suave */
        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }
            25% {
                background-position: 50% 100%;
            }
            50% {
                background-position: 100% 50%;
            }
            75% {
                background-position: 50% 0%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Borde animado inferior - DESACTIVADO */
        .navbar-gradient::after {
            display: none;
        }

        @keyframes borderMove {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 300% 0%;
            }
        }

        /* Mejora de legibilidad de textos en la barra */
        .navbar-gradient h1,
        .navbar-gradient .text-slate-800 {
            color: #1e293b !important;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8), 0 0 8px rgba(255, 255, 255, 0.4);
            font-weight: 700;
        }

        .navbar-gradient .text-blue-600 {
            color: #1d4ed8 !important;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.9), 0 0 10px rgba(255, 255, 255, 0.5);
            font-weight: 800;
        }

        .navbar-gradient .text-slate-600,
        .navbar-gradient .text-slate-500,
        .navbar-gradient .text-slate-700 {
            color: #334155 !important;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }

        .navbar-gradient a,
        .navbar-gradient button {
            color: #1e293b !important;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
            position: relative;
        }

        .navbar-gradient a:hover,
        .navbar-gradient button:hover {
            color: #1e40af !important;
            text-shadow: 
                0 0 10px rgba(30, 64, 175, 0.8),
                0 0 20px rgba(165, 180, 252, 0.6),
                0 0 30px rgba(191, 219, 254, 0.4),
                0 2px 4px rgba(255, 255, 255, 0.9);
            transform: translateY(-1px) scale(1.05);
            filter: brightness(1.2);
        }

        /* Excepci√≥n: mantener bot√≥n Cerrar Sesi√≥n con texto blanco */
        .navbar-gradient a.bg-red-600,
        .navbar-gradient a.bg-red-600:hover {
            color: #ffffff !important;
            text-shadow: none !important;
        }

        /* T√≠tulos adaptativos responsive */
        .title-mobile { display: inline; }
        .title-tablet { display: none; }
        .title-desktop { display: none; }

        @media (min-width: 640px) {
            .title-mobile { display: none; }
            .title-tablet { display: inline; }
            .title-desktop { display: none; }
        }

        @media (min-width: 1024px) {
            .title-mobile { display: none; }
            .title-tablet { display: none; }
            .title-desktop { display: inline; }
        }

        /* Estilos mejorados para el dropdown desktop */
        .dropdown {
            position: relative;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            min-width: 14rem;
            padding: 0.5rem;
            margin-top: 0.05rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(30, 64, 175, 0.12), 0 8px 10px -6px rgba(147, 197, 253, 0.1), 0 0 40px rgba(165, 180, 252, 0.08);
            border: 1px solid #dbeafe;
            animation: fadeIn 0.15s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.6rem 1rem;
            color: #475569;
            text-decoration: none;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            position: relative;
        }
        .dropdown-item:hover {
            background-color: #f8fafc;
            color: #1e40af;
            transform: translateX(3px);
            border-left: 3px solid #1e40af;
            padding-left: calc(1rem - 3px);
        }
        .dropdown-item:active {
            transform: translateX(2px);
            background-color: #f1f5f9;
        }
        
        /* Men√∫ m√≥vil oculto por defecto */
        .mobile-menu { display: none; }
        .mobile-menu.active { display: block; animation: slideDown 0.2s ease-out; }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animaci√≥n para el √≠cono de flecha en m√≥vil */
        .rotate-180 { transform: rotate(180deg); }
        
        /* ===== DISE√ëO ULTRA COMPACTO ===== */
        #quick-menu-trigger {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 80px;
            z-index: 9998;
            cursor: pointer;
            background: linear-gradient(180deg, 
                transparent,
                rgba(59, 130, 246, 0.5), 
                rgba(59, 130, 246, 0.9),
                rgba(59, 130, 246, 0.5),
                transparent);
            border-radius: 0 0.25rem 0.25rem 0;
            transition: all 0.2s ease;
            animation: edgePulse 2s ease-in-out infinite;
        }

        #quick-menu-trigger:hover {
            width: 6px;
            background: linear-gradient(180deg, 
                transparent,
                rgba(59, 130, 246, 0.7), 
                rgba(59, 130, 246, 1),
                rgba(59, 130, 246, 0.7),
                transparent);
        }

        @keyframes edgePulse {
            0%, 100% { opacity: 0.6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); }
            50% { opacity: 1; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        }

        #quick-access-menu {
            position: fixed;
            left: -130px;
            top: 50%;
            transform: translateY(-50%);
            width: 120px;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 0 0.75rem 0.75rem 0;
            box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
            z-index: 9999;
            transition: all 0.25s ease;
            border: 1px solid rgba(59, 130, 246, 0.15);
            backdrop-filter: blur(8px);
        }

        #quick-access-menu.show {
            left: 0;
            box-shadow: 0 15px 30px -8px rgba(0, 0, 0, 0.15);
        }

        #quick-access-menu h3 {
            font-size: 0.6rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.4rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
        }

        .quick-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.15rem;
            padding: 0.35rem 0.25rem;
            margin-bottom: 0.3rem;
            background: white;
            border-radius: 0.5rem;
            text-decoration: none;
            color: #334155;
            font-weight: 600;
            font-size: 0.6rem;
            transition: all 0.15s ease;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .quick-menu-item:hover {
            transform: translateX(3px);
            background: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.12);
        }

        .quick-menu-icon {
            font-size: 1.25rem;
            transition: all 0.15s ease;
        }

        .quick-menu-item:hover .quick-menu-icon {
            transform: scale(1.15);
        }

        .quick-menu-title {
            font-size: 0.65rem;
            font-weight: 600;
            color: #1e293b;
            line-height: 1;
        }

        /* Animaci√≥n de entrada de items */
        #quick-access-menu.show .quick-menu-item {
            animation: fadeInUp 0.25s ease-out backwards;
        }

        #quick-access-menu.show .quick-menu-item:nth-child(2) { animation-delay: 0.02s; }
        #quick-access-menu.show .quick-menu-item:nth-child(3) { animation-delay: 0.04s; }
        #quick-access-menu.show .quick-menu-item:nth-child(4) { animation-delay: 0.06s; }
        #quick-access-menu.show .quick-menu-item:nth-child(5) { animation-delay: 0.08s; }
        #quick-access-menu.show .quick-menu-item:nth-child(6) { animation-delay: 0.1s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive: ocultar en m√≥viles */
        @media (max-width: 768px) {
            #quick-menu-trigger,
            #quick-access-menu {
                display: none;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    
    
    <!-- ===== FORMAS GEOM√âTRICAS DEL FONDO ATARDECER C√ÅLIDO ===== -->
    <div class="background-shapes">
        <div class="polygon polygon-1"></div>
        <div class="polygon polygon-2"></div>
        <div class="polygon polygon-3"></div>
        <div class="polygon polygon-4"></div>
    </div>
    <!-- ===== FIN FORMAS GEOM√âTRICAS ===== -->

    <!-- ‚ú® DISE√ëO 1: MEN√ö MINIMALISTA MODERNO ‚ú® -->
    {% if user.is_authenticated and not user.perfil.es_paciente %}
    <div id="quick-menu-trigger"></div>
    
    <div id="quick-access-menu">
        <h3>Accesos</h3>
        
        <a href="{% url 'pacientes:agregar' %}" class="quick-menu-item">
            <div class="quick-menu-icon">üë∂</div>
            <div class="quick-menu-title">Crear Paciente</div>
        </a>
        
        <a href="{% url 'agenda:crear_proyecto' %}" class="quick-menu-item">
            <div class="quick-menu-icon">üì¶</div>
            <div class="quick-menu-title">Crear Proyecto</div>
        </a>
        
        <a href="{% url 'agenda:crear_mensualidad' %}" class="quick-menu-item">
            <div class="quick-menu-icon">üí≥</div>
            <div class="quick-menu-title">Crear Mensualidad</div>
        </a>
        
        <a href="{% url 'agenda:agendar_recurrente' %}" class="quick-menu-item">
            <div class="quick-menu-icon">üìÖ</div>
            <div class="quick-menu-title">Nueva Sesi√≥n</div>
        </a>
        
        <a href="{% url 'facturacion:registrar_pago' %}" class="quick-menu-item">
            <div class="quick-menu-icon">üí∞</div>
            <div class="quick-menu-title">Nuevo Pago</div>
        </a>
    </div>
    {% endif %}
    
    {% if user.is_authenticated %}
    
    {% if not user.perfil.es_paciente %}
    <nav class="navbar-gradient sticky top-0 z-50 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-2">
                    {% load static %}
                    <img src="{% static 'img/logo_misael.png' %}" alt="Logo" class="h-12 w-auto object-contain -ml-2">
                    
                    <div class="flex-shrink-0">
                        <h1 class="text-lg lg:text-xl font-bold text-slate-800 tracking-tight">
                            <span class="title-mobile">Centro Neurodesarrollo <span class="text-blue-600">Misael</span></span>
                            <span class="title-tablet">Centro de Neurodesarrollo <span class="text-blue-600">Misael</span></span>
                            <span class="title-desktop">Centro de Neurodesarrollo Infantil <span class="text-blue-600">Misael</span></span>
                        </h1>

                        <div class="text-xs text-slate-500 font-medium">
                            <span class="text-slate-700">
                                {{ user.get_full_name|default:user.username }}
                            </span>
                            {% if user.is_superuser %}
                                <span class="ml-1 text-blue-600 font-bold bg-blue-50 px-1.5 py-0.5 rounded-full">Super Admin</span>
                            {% elif user.perfil.rol %}
                                <span class="ml-1 text-slate-400">
                                    ({{ user.perfil.get_rol_display }})
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="hidden lg:ml-8 lg:flex lg:space-x-1 lg:items-center">
                        
                        {% if not user.perfil.es_profesional or user.is_superuser %}
                        <a href="{% url 'core:dashboard' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            Menu Principal
                        </a>
                        {% endif %}
                        
                        {% if user.is_superuser or user.perfil.es_profesional or user.perfil.es_recepcionista or user.perfil.es_gerente %}
                        <a href="{% url 'agenda:calendario' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            {% if user.perfil.es_profesional and not user.is_superuser %}Mi Agenda{% else %}Agenda{% endif %}
                        </a>
                        {% endif %}
                        
                        {% if user.perfil.es_profesional %}
                        <a href="{% url 'profesionales:mis_pacientes' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            üë∂ Mis Pacientes
                        </a>
                        {% endif %}
                        
                        {% if user.is_superuser or user.perfil.es_recepcionista or user.perfil.es_gerente %}
                        <div class="dropdown group">
                            <button class="flex items-center px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors focus:outline-none">
                                Cat√°logos
                                <svg class="ml-1.5 h-4 w-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div class="dropdown-menu">
                                <a href="{% url 'agenda:agendar_recurrente' %}" class="dropdown-item">
                                    <span class="mr-2">üìÖ</span> Agendar Sesi√≥n
                                </a>
                                <a href="{% url 'agenda:lista_proyectos' %}" class="dropdown-item">
                                    <span class="mr-2">üì¶</span> Proy/Evaluaci√≥n
                                </a>
                                
                                <a href="{% url 'agenda:lista_mensualidades' %}" class="dropdown-item">
                                    <span class="mr-2">üí≥</span> Mensualidades
                                </a>

                                <div class="h-px bg-slate-100 my-1 mx-2"></div>
                                
                                <a href="{% url 'pacientes:lista' %}" class="dropdown-item">
                                    <span class="mr-2">üë∂</span> Pacientes
                                </a>
                                
                                <a href="{% url 'profesionales:lista' %}" class="dropdown-item">
                                    <span class="mr-2">üë®‚Äç‚öïÔ∏è</span> Profesionales
                                </a>
                                
                                <div class="h-px bg-slate-100 my-1 mx-2"></div>
                                
                                <a href="{% url 'servicios:lista_servicios' %}" class="dropdown-item">
                                    <span class="mr-2">ü•º</span> Servicios
                                </a>
                                <a href="{% url 'servicios:lista_sucursales' %}" class="dropdown-item">
                                    <span class="mr-2">üè¢</span> Sucursales
                                </a>
                                
                                {% if user.is_superuser %}
                                <div class="h-px bg-slate-100 my-1 mx-2"></div>
                                
                                <a href="{% url 'core:lista_usuarios' %}" class="dropdown-item">
                                    <span class="mr-2">üë•</span> Usuarios y Roles
                                </a>
                                {% endif %}
                            </div>
                        </div>

                        <div class="dropdown group">
                            <button class="flex items-center px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors focus:outline-none">
                                Facturaci√≥n
                                <svg class="ml-1.5 h-4 w-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                <a href="{% url 'facturacion:cuentas_corrientes' %}" class="dropdown-item">
                                    <span class="mr-2">üìã</span> Cuentas Corrientes
                                </a>
                                <a href="{% url 'facturacion:pagos_masivos' %}" class="dropdown-item">
                                    <span class="mr-2">üí∞</span> Pagos Masivos
                                </a>
                                <a href="{% url 'facturacion:historial_pagos' %}" class="dropdown-item">
                                    <span class="mr-2">üìú</span> Historial de Pagos
                                </a>
                                <a href="{% url 'facturacion:registrar_pago' %}" class="dropdown-item">
                                    <span class="mr-2">‚ûï</span> Registrar Pago
                                </a>
                                <a href="{% url 'facturacion:registrar_devolucion' %}" class="dropdown-item text-red-600 hover:bg-red-50">
                                    <span class="mr-2">üîô</span> Registrar Devoluci√≥n
                                </a>

                                {% if user.is_superuser or user.perfil.es_gerente %}
                                <div class="h-px bg-slate-100 my-1 mx-2"></div>
                                <a href="{% url 'facturacion:dashboard_reportes' %}" class="dropdown-item">
                                    <span class="mr-2">üìä</span> Reportes
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if user.is_superuser %}
                        <a href="/admin/" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            Admin
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <a href="{% url 'core:logout' %}" 
                       class="hidden sm:inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        Cerrar Sesi√≥n
                    </a>
                    
                    <button id="mobile-menu-button" class="lg:hidden inline-flex items-center justify-center p-2 rounded-lg text-slate-500 hover:text-blue-600 hover:bg-slate-100 focus:outline-none transition-colors">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="mobile-menu" class="mobile-menu lg:hidden border-t border-slate-100 bg-white">
            <div class="px-2 pt-2 pb-3 space-y-1">
                {% if not user.perfil.es_profesional or user.is_superuser %}
                <a href="{% url 'core:dashboard' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    Men√∫ Principal
                </a>
                {% endif %}
                
                {% if user.is_superuser or user.perfil.es_profesional or user.perfil.es_recepcionista or user.perfil.es_gerente %}
                <a href="{% url 'agenda:calendario' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    {% if user.perfil.es_profesional and not user.is_superuser %}Mi Agenda{% else %}Agenda{% endif %}
                </a>
                {% endif %}
                
                {% if user.perfil.es_profesional %}
                <a href="{% url 'profesionales:mis_pacientes' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    üë∂ Mis Pacientes
                </a>
                {% endif %}
                
                {% if user.is_superuser or user.perfil.es_recepcionista or user.perfil.es_gerente %}
                <div>
                    <button id="catalogos-toggle" class="w-full flex justify-between items-center px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 focus:outline-none">
                        <span>Cat√°logos</span>
                        <svg id="catalogos-icon" class="h-5 w-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div id="catalogos-menu" class="hidden pl-4 space-y-1 mt-1 bg-slate-50 rounded-lg mx-2">
                        <a href="{% url 'agenda:agendar_recurrente' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üìÖ Agendar Sesi√≥n
                        </a>
                        <a href="{% url 'agenda:lista_proyectos' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üì¶ Proy/Evaluaci√≥n
                        </a>
                        
                        <a href="{% url 'agenda:lista_mensualidades' %}" class="dropdown-item">
                            <span class="mr-2">üí≥</span> Mensualidades
                        </a>

                        <div class="border-t border-slate-200 my-1 mx-3"></div>
                        
                        <a href="{% url 'pacientes:lista' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üë∂ Pacientes
                        </a>
                        
                        <a href="{% url 'profesionales:lista' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üë®‚Äç‚öïÔ∏è Profesionales
                        </a>
                        
                        <div class="border-t border-slate-200 my-1 mx-3"></div>
                        
                        <a href="{% url 'servicios:lista_servicios' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            ü•º Servicios
                        </a>
                        <a href="{% url 'servicios:lista_sucursales' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üè¢ Sucursales
                        </a>
                        
                        {% if user.is_superuser %}
                        <div class="border-t border-slate-200 my-1 mx-3"></div>
                        
                        <a href="{% url 'core:lista_usuarios' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üë• Usuarios y Roles
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <div>
                    <button id="facturacion-toggle" class="w-full flex justify-between items-center px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 focus:outline-none">
                        <span>Facturaci√≥n</span>
                        <svg id="facturacion-icon" class="h-5 w-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="facturacion-menu" class="hidden pl-4 space-y-1 mt-1 bg-slate-50 rounded-lg mx-2">
                        <a href="{% url 'facturacion:cuentas_corrientes' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üìã Cuentas Corrientes
                        </a>
                        <a href="{% url 'facturacion:pagos_masivos' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üí∞ Pagos Masivos
                        </a>
                        <a href="{% url 'facturacion:historial_pagos' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üìú Historial de Pagos
                        </a>
                        <a href="{% url 'facturacion:registrar_pago' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            ‚ûï Registrar Pago
                        </a>
                        <a href="{% url 'facturacion:registrar_devolucion' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50">
                            üîô Registrar Devoluci√≥n
                        </a>
                                                
                        {% if user.is_superuser or user.perfil.es_gerente %}
                        <a href="{% url 'facturacion:dashboard_reportes' %}" class="block px-3 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-blue-600">
                            üìä Reportes
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if user.is_superuser %}
                <a href="/admin/" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    ‚≠ê Admin
                </a>
                {% endif %}
                
                <div class="border-t border-slate-100 pt-3 mt-3">
                    <div class="px-3 py-2 text-sm">
                        <p class="text-slate-800 font-bold">{{ user.get_full_name|default:user.username }}</p>
                        {% if user.is_superuser %}
                        <p class="text-xs text-blue-600 font-bold">‚≠ê Super Admin</p>
                        {% elif user.perfil.rol %}
                        <p class="text-xs text-slate-500">{{ user.perfil.get_rol_display }}</p>
                        {% endif %}
                    </div>
                    <a href="{% url 'core:logout' %}" 
                       class="block px-3 py-2 rounded-lg text-base font-medium text-red-600 hover:bg-red-50">
                        Cerrar Sesi√≥n
                    </a>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    {% if user.perfil.es_paciente %}
    <nav class="navbar-gradient shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-2">
                    {% load static %}
                    <img src="{% static 'img/logo_misael.png' %}" alt="Logo" class="h-12 w-auto object-contain -ml-2">
                    
                    <div class="flex-shrink-0">
                        <h1 class="text-lg lg:text-xl font-bold text-slate-800 tracking-tight">
                            Centro <span class="text-blue-600">Misael</span>
                        </h1>
                        <div class="text-xs text-slate-500 leading-tight">
                            <span class="font-medium bg-green-50 text-green-700 px-2 py-0.5 rounded-full">Portal del Paciente</span>
                        </div>
                    </div>
                    
                    <div class="hidden lg:ml-8 lg:flex lg:space-x-2">
                        <a href="{% url 'facturacion:mi_cuenta' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            üí∞ Mi Cuenta
                        </a>
                        <a href="{% url 'pacientes:mis_sesiones' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            üìÖ Mis Sesiones
                        </a>
                        <a href="{% url 'pacientes:mis_profesionales' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            üë®‚Äç‚öïÔ∏è Mis Profesionales
                        </a>
                        <a href="{% url 'facturacion:mis_deudas' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            ‚ö†Ô∏è Mis Deudas
                        </a>
                        <a href="{% url 'facturacion:mis_pagos' %}" 
                           class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 transition-colors">
                            üíµ Mis Pagos
                        </a>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-slate-600 hidden sm:block">
                        Hola, <strong>{{ user.perfil.paciente.nombre }}</strong>
                    </span>
                    <a href="{% url 'core:logout' %}" 
                       class="hidden sm:inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        Cerrar Sesi√≥n
                    </a>
                    
                    <button id="mobile-menu-button-paciente" class="lg:hidden inline-flex items-center justify-center p-2 rounded-lg text-slate-500 hover:text-blue-600 hover:bg-slate-100 focus:outline-none transition-colors">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="mobile-menu-paciente" class="mobile-menu lg:hidden border-t border-slate-100 bg-white">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="{% url 'facturacion:mi_cuenta' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    üí∞ Mi Cuenta
                </a>
                <a href="{% url 'pacientes:mis_sesiones' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    üìÖ Mis Sesiones
                </a>
                <a href="{% url 'pacientes:mis_profesionales' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    üë®‚Äç‚öïÔ∏è Mis Profesionales
                </a>
                <a href="{% url 'facturacion:mis_deudas' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    ‚ö†Ô∏è Mis Deudas
                </a>
                <a href="{% url 'facturacion:mis_pagos' %}" 
                   class="block px-3 py-2 rounded-lg text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50">
                    üíµ Mis Pagos
                </a>
                
                <div class="border-t border-slate-100 pt-3 mt-3">
                    <div class="px-3 py-2 text-sm">
                        <p class="text-slate-800 font-bold">{{ user.perfil.paciente.nombre }}</p>
                        <p class="text-xs text-slate-500">Paciente</p>
                    </div>
                    <a href="{% url 'core:logout' %}" 
                       class="block px-3 py-2 rounded-lg text-base font-medium text-red-600 hover:bg-red-50">
                        Cerrar Sesi√≥n
                    </a>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    {% endif %}
    
    {% if messages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        {% for message in messages %}
        <div class="rounded-xl p-4 mb-4 shadow-sm border border-l-4 flex items-center
            {% if message.tags == 'error' %}bg-red-50 border-red-500 text-red-700
            {% elif message.tags == 'success' %}bg-green-50 border-green-500 text-green-700
            {% else %}bg-blue-50 border-blue-500 text-blue-700{% endif %}">
            <span class="font-medium">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
        {% block content %}{% endblock %}
    </main>
    
    <script>
        // Toggle men√∫ m√≥vil principal (Staff)
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.classList.toggle('active');
            });
        }
        
        // Toggle men√∫ m√≥vil pacientes
        const mobileMenuButtonPaciente = document.getElementById('mobile-menu-button-paciente');
        const mobileMenuPaciente = document.getElementById('mobile-menu-paciente');
        
        if (mobileMenuButtonPaciente && mobileMenuPaciente) {
            mobileMenuButtonPaciente.addEventListener('click', function() {
                mobileMenuPaciente.classList.toggle('active');
            });
        }
        
        // Toggle submen√∫ cat√°logos en m√≥vil
        const catalogosToggle = document.getElementById('catalogos-toggle');
        const catalogosMenu = document.getElementById('catalogos-menu');
        const catalogosIcon = document.getElementById('catalogos-icon');
        
        if (catalogosToggle && catalogosMenu && catalogosIcon) {
            catalogosToggle.addEventListener('click', function() {
                catalogosMenu.classList.toggle('hidden');
                catalogosIcon.classList.toggle('rotate-180');
            });
        }

        // Toggle submen√∫ facturaci√≥n en m√≥vil
        const facturacionToggle = document.getElementById('facturacion-toggle');
        const facturacionMenu = document.getElementById('facturacion-menu');
        const facturacionIcon = document.getElementById('facturacion-icon');
        
        if (facturacionToggle && facturacionMenu && facturacionIcon) {
            facturacionToggle.addEventListener('click', function() {
                facturacionMenu.classList.toggle('hidden');
                facturacionIcon.classList.toggle('rotate-180');
            });
        }
        
        // ===== MEN√ö LATERAL DE ACCESO R√ÅPIDO =====
        const quickMenu = document.getElementById('quick-access-menu');
        const quickMenuTrigger = document.getElementById('quick-menu-trigger');
        let menuTimeout;
        
        if (quickMenu && quickMenuTrigger) {
            // Mostrar men√∫ al pasar por el trigger o el men√∫ mismo
            quickMenuTrigger.addEventListener('mouseenter', function() {
                clearTimeout(menuTimeout);
                quickMenu.classList.add('show');
            });
            
            quickMenu.addEventListener('mouseenter', function() {
                clearTimeout(menuTimeout);
                quickMenu.classList.add('show');
            });
            
            // Ocultar men√∫ con delay
            quickMenuTrigger.addEventListener('mouseleave', function() {
                menuTimeout = setTimeout(() => {
                    quickMenu.classList.remove('show');
                }, 300);
            });
            
            quickMenu.addEventListener('mouseleave', function() {
                menuTimeout = setTimeout(() => {
                    quickMenu.classList.remove('show');
                }, 300);
            });
        }
    </script>
    
<!-- ===== ESTILOS ULTRA COMPACTOS PARA SELECTOR DE PACIENTES ===== -->
<style>
/* Bot√≥n flotante - m√°s peque√±o */
#paciente-selector-float {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 9999;
}

.float-trigger {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.float-trigger:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
}

.float-icon {
    font-size: 1.3rem;
    animation: floatPulse 2s ease-in-out infinite;
}

@keyframes floatPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Men√∫ desplegable - ULTRA COMPACTO */
.paciente-menu {
    position: absolute;
    bottom: 58px;
    left: 0;
    width: 240px;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateY(15px) scale(0.95);
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 2px solid #e2e8f0;
    max-height: 420px;
    display: flex;
    flex-direction: column;
}

.paciente-menu.active {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: all;
}

/* Header - m√°s compacto */
.menu-header {
    padding: 0.6rem 0.8rem;
    border-bottom: 2px solid #f1f5f9;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 1rem 1rem 0 0;
    color: white;
}

.menu-header h3 {
    font-size: 0.75rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

/* Buscador - m√°s compacto */
.search-box {
    padding: 0.5rem 0.7rem;
    border-bottom: 1px solid #e2e8f0;
    background: #fafbfc;
}

.search-input {
    width: 100%;
    padding: 0.35rem 0.6rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.4rem;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

/* Lista de pacientes - m√°s compacta */
.pacientes-list {
    overflow-y: auto;
    max-height: 320px;
    padding: 0.4rem;
}

.pacientes-list::-webkit-scrollbar {
    width: 5px;
}

.pacientes-list::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 10px;
}

.pacientes-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}

.pacientes-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Item de paciente - ULTRA COMPACTO - ‚úÖ CLICKEABLE */
.paciente-item {
    padding: 0.45rem 0.6rem;
    border-radius: 0.6rem;
    margin-bottom: 0.3rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    background: #f8fafc;
    position: relative;
}

.paciente-item:hover {
    background: #eff6ff;
    border-color: #667eea;
    transform: translateX(2px);
}

/* Header del item - nombre + foto - ‚úÖ CLICKEABLE */
.paciente-header {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    cursor: pointer;
}

.paciente-header:hover .paciente-nombre {
    color: #667eea;
}

/* Foto del paciente - MUESTRA LA FOTO REAL SI EXISTE */
.paciente-foto {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    border: 2px solid #e2e8f0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.paciente-header:hover .paciente-foto {
    border-color: #667eea;
    transform: scale(1.05);
}

.paciente-foto img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.paciente-foto-placeholder {
    color: white;
    font-size: 0.9rem;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Nombre - m√°s peque√±o */
.paciente-nombre {
    font-size: 0.75rem;
    font-weight: 600;
    color: #1e293b;
    flex: 1;
    line-height: 1.2;
    transition: color 0.2s ease;
}

/* Acciones - aparecen al hover */
.paciente-acciones {
    display: flex;
    gap: 0.35rem;
    margin-top: 0.4rem;
    opacity: 0;
    transform: translateY(-3px);
    transition: all 0.2s ease;
}

.paciente-item:hover .paciente-acciones {
    opacity: 1;
    transform: translateY(0);
}

/* Botones de acci√≥n - m√°s peque√±os */
.accion-btn {
    flex: 1;
    padding: 0.3rem 0.5rem;
    border-radius: 0.4rem;
    font-size: 0.65rem;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.2rem;
    position: relative;
    z-index: 2;
}

.accion-sesiones {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.accion-sesiones:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
}

.accion-cuenta {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.accion-cuenta:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(245, 87, 108, 0.3);
}

/* Mensaje sin resultados */
.no-results {
    text-align: center;
    padding: 1.5rem 0.8rem;
    color: #64748b;
    font-size: 0.75rem;
}

/* Badge contador - m√°s peque√±o */
.count-badge {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    padding: 0.1rem 0.4rem;
    border-radius: 0.8rem;
    font-size: 0.65rem;
    font-weight: 700;
}

/* Animaci√≥n de entrada */
.paciente-item {
    animation: slideInUp 0.25s ease-out backwards;
}

.paciente-item:nth-child(1) { animation-delay: 0.03s; }
.paciente-item:nth-child(2) { animation-delay: 0.06s; }
.paciente-item:nth-child(3) { animation-delay: 0.09s; }
.paciente-item:nth-child(4) { animation-delay: 0.12s; }
.paciente-item:nth-child(5) { animation-delay: 0.15s; }

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive */
@media (max-width: 768px) {
    #paciente-selector-float {
        bottom: 15px;
        left: 15px;
    }
    
    .paciente-menu {
        width: 220px;
        max-height: 380px;
    }
    
    .float-trigger {
        width: 44px;
        height: 44px;
    }
}
</style>

<!-- ===== HTML DEL SELECTOR ===== -->
{% if user.is_authenticated and not user.perfil.es_paciente %}
<div id="paciente-selector-float">
    <!-- Bot√≥n flotante -->
    <div class="float-trigger" onclick="togglePacienteMenu()">
        <span class="float-icon">üë∂</span>
    </div>
    
    <!-- Men√∫ desplegable -->
    <div class="paciente-menu" id="paciente-menu">
        <div class="menu-header">
            <h3>
                <span>üîç</span>
                Pacientes
                <span class="count-badge ml-auto" id="pacientes-count">0</span>
            </h3>
        </div>
        
        <div class="search-box">
            <input type="text" 
                   id="search-paciente" 
                   class="search-input" 
                   placeholder="Buscar..."
                   onkeyup="filterPacientes()">
        </div>
        
        <div class="pacientes-list" id="pacientes-list">
            <div class="text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <p class="text-xs text-slate-500 mt-2">Cargando...</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ===== JAVASCRIPT ===== -->
<script>
// Variable global para almacenar pacientes
let pacientesData = [];
let pacientesLoaded = false;

// Toggle men√∫ de pacientes y cargar datos si es necesario
function togglePacienteMenu() {
    const menu = document.getElementById('paciente-menu');
    menu.classList.toggle('active');
    
    // Cargar pacientes solo la primera vez que se abre el men√∫
    if (menu.classList.contains('active') && !pacientesLoaded) {
        cargarPacientes();
    }
}

// Cargar pacientes v√≠a AJAX
function cargarPacientes() {
    const listaContainer = document.getElementById('pacientes-list');
    
    fetch('{% url "pacientes:api_lista_pacientes" %}')
        .then(response => response.json())
        .then(data => {
            pacientesData = data.pacientes;
            pacientesLoaded = true;
            renderizarPacientes(pacientesData);
            
            // Actualizar contador
            document.getElementById('pacientes-count').textContent = pacientesData.length;
        })
        .catch(error => {
            console.error('Error al cargar pacientes:', error);
            listaContainer.innerHTML = '<div class="no-results">‚ùå Error al cargar</div>';
        });
}

// ‚úÖ Ir al perfil del paciente
function irAPerfil(pacienteId) {
    window.location.href = `/pacientes/${pacienteId}/`;
}

// Renderizar lista de pacientes
function renderizarPacientes(pacientes) {
    const listaContainer = document.getElementById('pacientes-list');
    
    if (pacientes.length === 0) {
        listaContainer.innerHTML = '<div class="no-results">Sin pacientes</div>';
        return;
    }
    
    listaContainer.innerHTML = pacientes.map((paciente, index) => `
        <div class="paciente-item" data-nombre="${paciente.nombre_completo.toLowerCase()}" style="animation-delay: ${index * 0.03}s">
            <!-- ‚úÖ Header clickeable que va al perfil -->
            <div class="paciente-header" onclick="irAPerfil(${paciente.id})">
                <div class="paciente-foto">
                    ${paciente.foto_url ? 
                        `<img src="${paciente.foto_url}" alt="${paciente.nombre_completo}">` :
                        `<div class="paciente-foto-placeholder">${paciente.inicial}</div>`
                    }
                </div>
                <div class="paciente-nombre">
                    ${paciente.nombre_completo}
                </div>
            </div>
            <!-- ‚úÖ Botones con onclick que previenen la propagaci√≥n -->
            <div class="paciente-acciones">
                <a href="/pacientes/${paciente.id}/sesiones/" 
                   class="accion-btn accion-sesiones"
                   onclick="event.stopPropagation()">
                    üìÖ Sesiones
                </a>
                <a href="/facturacion/cuenta/${paciente.id}/" 
                   class="accion-btn accion-cuenta"
                   onclick="event.stopPropagation()">
                    üí∞ Cuenta
                </a>
            </div>
        </div>
    `).join('');
}

// Cerrar al hacer click fuera
document.addEventListener('click', function(event) {
    const selector = document.getElementById('paciente-selector-float');
    const menu = document.getElementById('paciente-menu');
    
    if (selector && menu && !selector.contains(event.target)) {
        menu.classList.remove('active');
    }
});

// Filtrar pacientes
function filterPacientes() {
    const input = document.getElementById('search-paciente');
    const filter = input.value.toLowerCase();
    const list = document.getElementById('pacientes-list');
    const items = list.getElementsByClassName('paciente-item');
    
    let visibleCount = 0;
    
    for (let i = 0; i < items.length; i++) {
        const nombre = items[i].getAttribute('data-nombre');
        if (nombre.indexOf(filter) > -1) {
            items[i].style.display = '';
            visibleCount++;
        } else {
            items[i].style.display = 'none';
        }
    }
    
    // Mostrar mensaje si no hay resultados
    if (visibleCount === 0 && pacientesLoaded) {
        list.innerHTML = '<div class="no-results">üòï Sin resultados</div>';
    } else if (visibleCount === 0 && !pacientesLoaded) {
        // Si a√∫n no se han cargado, esperar
    } else if (filter === '' && visibleCount === 0 && pacientesLoaded) {
        // Si borr√≥ todo el filtro y no hay resultados, recargar
        renderizarPacientes(pacientesData);
    }
}
</script>

    {% block extra_js %}{% endblock %}

<!-- ===== BOT√ìN FLOTANTE DE CHAT ===== -->
{% load chat_tags %}
{% if user.is_authenticated %}
<a href="{% url 'chat:lista_conversaciones' %}" 
   class="fixed bottom-6 right-6 z-50 w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full shadow-2xl flex items-center justify-center text-white text-2xl hover:scale-110 transition-all duration-300 hover:shadow-blue-500/50 hover:rotate-12"
   title="Mensajes">
    üí¨
    
    <!-- Badge de notificaciones -->
    {% contar_mensajes_no_leidos user as mensajes_count %}
    {% if mensajes_count > 0 %}
    <span id="chat-badge-count" class="absolute -top-2 -right-2 min-w-[20px] h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold px-1.5 border-2 border-white shadow-lg animate-pulse">
        {{ mensajes_count }}
    </span>
    {% endif %}
</a>
{% endif %}
<!-- ===== FIN BOT√ìN FLOTANTE DE CHAT ===== -->

</body>
</html>