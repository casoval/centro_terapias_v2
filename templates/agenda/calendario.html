{% extends 'base.html' %}
{% load static %}
{% load fecha_tags %}

{% block title %}Agenda - Centro Infantil Misael{% endblock %}

{% block content %}
<style>
    .vista-btn {
        transition: all 0.3s ease;
    }
    .vista-btn:hover {
        transform: translateY(-2px);
    }
</style>

    <div class="min-h-screen">
    <!-- Header con filtros -->
    <div class="bg-white shadow-lg border-b-2 border-blue-200 rounded-b-2xl">
        <div class="max-w-full mx-auto px-2 py-3">
            <!-- TÃ­tulo y acciones -->
            <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                            <span class="text-lg">ğŸ“…</span>
                        </div>
                        <h1 class="text-xl font-black bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
                            Agenda
                        </h1>
                    </div>
                    <p class="text-xs text-gray-700 font-bold ml-10">
                        {% if vista == 'diaria' %}
                            ğŸ“† {{ fecha_base|fecha_larga }}
                        {% elif vista == 'semanal' %}
                            ğŸ“Š {{ fecha_inicio|date:"d/m/Y" }} - {{ fecha_fin|date:"d/m/Y" }}
                        {% elif vista == 'mensual' %}
                            ğŸ“… {{ fecha_base|mes_anio }}
                        {% else %}
                            ğŸ“‹ {{ fecha_inicio|mes_anio }}
                        {% endif %}
                    </p>
                </div>
                
                <div class="flex gap-2">
                    <a href="{% url 'agenda:agendar_recurrente' %}" 
                       class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-3 py-2 rounded-full flex items-center gap-2 transition-all shadow-lg font-bold text-xs">
                        <span class="text-base">â•</span>
                        <span>Agendar</span>
                    </a>
                </div>
            </div>

            <!-- NavegaciÃ³n y cambio de vista -->
            <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                <!-- NavegaciÃ³n de fechas -->
                <div class="flex items-center gap-1">
                    <a href="?vista={{ vista }}&fecha={{ fecha_anterior|date:'Y-m-d' }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}{% if sucursal_id %}&sucursal={{ sucursal_id }}{% endif %}" 
                       class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded-lg text-xs font-bold">
                        â†
                    </a>
                    
                    <a href="?vista={{ vista }}" 
                       class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg font-bold text-xs">
                        ğŸ¯ Hoy
                    </a>
                    
                    <a href="?vista={{ vista }}&fecha={{ fecha_siguiente|date:'Y-m-d' }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}{% if sucursal_id %}&sucursal={{ sucursal_id }}{% endif %}" 
                       class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded-lg text-xs font-bold">
                        â†’
                    </a>
                </div>

                <!-- Cambio de vista -->
                <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                    <a href="?vista=diaria{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}{% if sucursal_id %}&sucursal={{ sucursal_id }}{% endif %}" 
                       class="vista-btn px-2 py-1 rounded-lg text-xs font-bold {% if vista == 'diaria' %}bg-white text-blue-600 shadow{% else %}text-gray-600 hover:bg-white{% endif %}">
                        ğŸ“„ Diaria
                    </a>
                    <a href="?vista=semanal{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}{% if sucursal_id %}&sucursal={{ sucursal_id }}{% endif %}" 
                       class="vista-btn px-2 py-1 rounded-lg text-xs font-bold {% if vista == 'semanal' %}bg-white text-blue-600 shadow{% else %}text-gray-600 hover:bg-white{% endif %}">
                        ğŸ“Š Semanal
                    </a>
                    <a href="?vista=mensual{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}{% if sucursal_id %}&sucursal={{ sucursal_id }}{% endif %}" 
                       class="vista-btn px-2 py-1 rounded-lg text-xs font-bold {% if vista == 'mensual' %}bg-white text-blue-600 shadow{% else %}text-gray-600 hover:bg-white{% endif %}">
                        ğŸ“… Mensual
                    </a>
                    <a href="?vista=lista{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}{% if sucursal_id %}&sucursal={{ sucursal_id }}{% endif %}" 
                       class="vista-btn px-2 py-1 rounded-lg text-xs font-bold {% if vista == 'lista' %}bg-white text-blue-600 shadow{% else %}text-gray-600 hover:bg-white{% endif %}">
                        ğŸ“‹ Lista
                    </a>
                </div>
            </div>

            <!-- Filtros avanzados -->
            <form method="get" class="bg-yellow-50 p-2 rounded-lg border-2 border-yellow-200" id="filtrosForm">
                <input type="hidden" name="vista" value="{{ vista }}">
                <input type="hidden" name="fecha" value="{{ fecha_base|date:'Y-m-d' }}">
                
                <div class="grid grid-cols-2 lg:grid-cols-6 gap-2">
                    <!-- Filtro Paciente -->
                    <div>
                        <label class="block text-[10px] font-bold text-gray-700 mb-1">
                            ğŸ‘¶ Paciente
                        </label>
                        <select name="paciente" class="w-full px-2 py-1 border border-blue-300 rounded-lg text-[10px] font-bold" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for p in pacientes %}
                                <option value="{{ p.id }}" {% if paciente_id == p.id|stringformat:"s" %}selected{% endif %}>
                                    {{ p.nombre }} {{ p.apellido }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Profesional -->
                    <div>
                        <label class="block text-[10px] font-bold text-gray-700 mb-1">
                            ğŸ‘¨â€âš•ï¸ Profesional
                        </label>
                        <select name="profesional" class="w-full px-2 py-1 border border-green-300 rounded-lg text-[10px] font-bold" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for prof in profesionales %}
                                <option value="{{ prof.id }}" {% if profesional_id == prof.id|stringformat:"s" %}selected{% endif %}>
                                    {{ prof.nombre }} {{ prof.apellido }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Servicio -->
                    <div>
                        <label class="block text-[10px] font-bold text-gray-700 mb-1">
                            ğŸ¥ Servicio
                        </label>
                        <select name="servicio" class="w-full px-2 py-1 border border-purple-300 rounded-lg text-[10px] font-bold" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for srv in servicios %}
                                <option value="{{ srv.id }}" {% if servicio_id == srv.id|stringformat:"s" %}selected{% endif %}>
                                    {{ srv.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Sucursal -->
                    <div>
                        <label class="block text-[10px] font-bold text-gray-700 mb-1">
                            ğŸ¢ Sucursal
                        </label>
                        <select name="sucursal" class="w-full px-2 py-1 border border-cyan-300 rounded-lg text-[10px] font-bold" onchange="this.form.submit()">
                            <option value="">Todas</option>
                            {% for sucursal in sucursales %}
                                <option value="{{ sucursal.id }}" {% if sucursal_id == sucursal.id|stringformat:"s" %}selected{% endif %}>
                                    {{ sucursal.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Estado -->
                    <div>
                        <label class="block text-[10px] font-bold text-gray-700 mb-1">
                            ğŸ“Š Estado
                        </label>
                        <select name="estado" class="w-full px-2 py-1 border border-pink-300 rounded-lg text-[10px] font-bold" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for estado_val, estado_nombre in estados %}
                                <option value="{{ estado_val }}" {% if estado_filtro == estado_val %}selected{% endif %}>
                                    {{ estado_nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- BotÃ³n limpiar -->
                    <div class="flex items-end">
                        <a href="?vista={{ vista }}" class="w-full bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-lg text-center text-[10px] font-bold">
                            ğŸ”„ Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenido segÃºn vista -->
    <div class="max-w-full mx-auto p-2">
        {% if vista == 'diaria' %}
            {% include 'agenda/partials/calendario_diario.html' %}
        {% elif vista == 'semanal' %}
            {% include 'agenda/partials/calendario_semanal.html' %}
        {% elif vista == 'mensual' %}
            {% include 'agenda/partials/calendario_mensual.html' %}
        {% else %}
            {% include 'agenda/partials/calendario_lista.html' %}
        {% endif %}
    </div>
</div>

<!-- Modal para editar sesiÃ³n (HTMX) -->
<div id="modal-editar" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-2">
    <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-gray-200">
        <div id="modal-content">
            <!-- Contenido cargado por HTMX -->
        </div>
    </div>
</div>

<script>
    // Abrir modal
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'modal-content') {
            document.getElementById('modal-editar').classList.remove('hidden');
        }
    });

    // Cerrar modal
    function cerrarModal() {
        document.getElementById('modal-editar').classList.add('hidden');
        document.getElementById('modal-content').innerHTML = '';
        window.location.reload();
    }

    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            cerrarModal();
        }
    });

    // Cerrar al hacer click fuera
    document.getElementById('modal-editar').addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModal();
        }
    });
</script>
{% endblock %}