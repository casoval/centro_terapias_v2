{% extends 'base.html' %}
{% load static %}
{% load fecha_tags %}

{% block title %}Agenda - Centro Infantil Misael{% endblock %}

{% block content %}
<style>
    .vista-btn {
        transition: all 0.3s ease;
    }
    .vista-btn:hover {
        transform: translateY(-2px);
    }
</style>

<div class="min-h-screen">
    <!-- Header con filtros -->
    <div class="bg-white shadow-xl border-b-4 border-blue-200 rounded-b-3xl">
        <div class="max-w-full mx-auto px-4 py-6">
            <!-- TÃ­tulo y acciones -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div>
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-xl border-3 border-white transform hover:scale-110 transition-all">
                            <span class="text-4xl">ğŸ“…</span>
                        </div>
                        <h1 class="text-4xl font-black bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
                            Agenda
                        </h1>
                    </div>
                    <p class="text-base text-gray-700 mt-2 font-bold ml-20">
                        {% if vista == 'diaria' %}
                            ğŸ“† {{ fecha_base|fecha_larga }}
                        {% elif vista == 'semanal' %}
                            ğŸ“Š Semana del {{ fecha_inicio|date:"d/m/Y" }} al {{ fecha_fin|date:"d/m/Y" }}
                        {% elif vista == 'mensual' %}
                            ğŸ“… {{ fecha_base|mes_anio }}
                        {% else %}
                            ğŸ“‹ {{ fecha_inicio|mes_anio }}
                        {% endif %}
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <a href="{% url 'agenda:agendar_recurrente' %}" 
                       class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-4 rounded-full flex items-center gap-3 transition-all shadow-xl hover:shadow-2xl transform hover:scale-105 font-black text-lg border-3 border-green-700">
                        <span class="text-2xl">â•</span>
                        Agendar Sesiones
                    </a>
                </div>
            </div>

            <!-- NavegaciÃ³n y cambio de vista -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <!-- NavegaciÃ³n de fechas -->
                <div class="flex items-center gap-3">
                    <a href="?vista={{ vista }}&fecha={{ fecha_anterior|date:'Y-m-d' }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}" 
                       class="bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 px-5 py-3 rounded-xl transition-all font-black shadow-md hover:shadow-lg transform hover:scale-105">
                        â† Anterior
                    </a>
                    
                    <a href="?vista={{ vista }}" 
                       class="bg-gradient-to-r from-blue-400 to-blue-500 hover:from-blue-500 hover:to-blue-600 text-white px-6 py-3 rounded-xl font-black transition-all shadow-lg hover:shadow-xl transform hover:scale-105 border-2 border-blue-600">
                        ğŸ¯ Hoy
                    </a>
                    
                    <a href="?vista={{ vista }}&fecha={{ fecha_siguiente|date:'Y-m-d' }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}" 
                       class="bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 px-5 py-3 rounded-xl transition-all font-black shadow-md hover:shadow-lg transform hover:scale-105">
                        Siguiente â†’
                    </a>
                </div>

                <!-- Cambio de vista -->
                <div class="flex gap-2 bg-gradient-to-r from-gray-100 to-gray-200 p-2 rounded-2xl border-3 border-gray-300 shadow-lg">
                    <a href="?vista=diaria{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}" 
                       class="vista-btn px-4 py-2 rounded-xl transition text-base font-black {% if vista == 'diaria' %}bg-white text-blue-600 shadow-md border-2 border-blue-300{% else %}text-gray-600 hover:text-gray-900 hover:bg-white{% endif %}">
                        ğŸ“„ Diaria
                    </a>
                    <a href="?vista=semanal{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}" 
                       class="vista-btn px-4 py-2 rounded-xl transition text-base font-black {% if vista == 'semanal' %}bg-white text-blue-600 shadow-md border-2 border-blue-300{% else %}text-gray-600 hover:text-gray-900 hover:bg-white{% endif %}">
                        ğŸ“Š Semanal
                    </a>
                    <a href="?vista=mensual{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}" 
                       class="vista-btn px-4 py-2 rounded-xl transition text-base font-black {% if vista == 'mensual' %}bg-white text-blue-600 shadow-md border-2 border-blue-300{% else %}text-gray-600 hover:text-gray-900 hover:bg-white{% endif %}">
                        ğŸ“… Mensual
                    </a>
                    <a href="?vista=lista{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if paciente_id %}&paciente={{ paciente_id }}{% endif %}{% if profesional_id %}&profesional={{ profesional_id }}{% endif %}{% if servicio_id %}&servicio={{ servicio_id }}{% endif %}" 
                       class="vista-btn px-4 py-2 rounded-xl transition text-base font-black {% if vista == 'lista' %}bg-white text-blue-600 shadow-md border-2 border-blue-300{% else %}text-gray-600 hover:text-gray-900 hover:bg-white{% endif %}">
                        ğŸ“‹ Lista
                    </a>
                </div>
            </div>

            <!-- Filtros avanzados -->
            <form method="get" class="bg-gradient-to-br from-yellow-50 to-orange-50 p-6 rounded-2xl border-4 border-yellow-200 shadow-lg" id="filtrosForm">
                <input type="hidden" name="vista" value="{{ vista }}">
                <input type="hidden" name="fecha" value="{{ fecha_base|date:'Y-m-d' }}">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <!-- Filtro Paciente -->
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2 flex items-center gap-2">
                            <span class="text-xl">ğŸ‘¶</span> Paciente
                        </label>
                        <select name="paciente" class="w-full px-4 py-3 border-3 border-blue-300 rounded-xl focus:ring-4 focus:ring-blue-400 font-bold shadow-md" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for p in pacientes %}
                                <option value="{{ p.id }}" {% if paciente_id == p.id|stringformat:"s" %}selected{% endif %}>
                                    {{ p.nombre }} {{ p.apellido }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Profesional -->
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2 flex items-center gap-2">
                            <span class="text-xl">ğŸ‘¨â€âš•ï¸</span> Profesional
                        </label>
                        <select name="profesional" class="w-full px-4 py-3 border-3 border-green-300 rounded-xl focus:ring-4 focus:ring-green-400 font-bold shadow-md" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for prof in profesionales %}
                                <option value="{{ prof.id }}" {% if profesional_id == prof.id|stringformat:"s" %}selected{% endif %}>
                                    {{ prof.nombre }} {{ prof.apellido }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Servicio -->
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2 flex items-center gap-2">
                            <span class="text-xl">ğŸ¥</span> Servicio
                        </label>
                        <select name="servicio" class="w-full px-4 py-3 border-3 border-purple-300 rounded-xl focus:ring-4 focus:ring-purple-400 font-bold shadow-md" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for srv in servicios %}
                                <option value="{{ srv.id }}" {% if servicio_id == srv.id|stringformat:"s" %}selected{% endif %}>
                                    {{ srv.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Estado -->
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2 flex items-center gap-2">
                            <span class="text-xl">ğŸ“Š</span> Estado
                        </label>
                        <select name="estado" class="w-full px-4 py-3 border-3 border-pink-300 rounded-xl focus:ring-4 focus:ring-pink-400 font-bold shadow-md" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for estado_val, estado_nombre in estados %}
                                <option value="{{ estado_val }}" {% if estado_filtro == estado_val %}selected{% endif %}>
                                    {{ estado_nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- BotÃ³n limpiar -->
                    <div class="flex items-end">
                        <a href="?vista={{ vista }}" class="w-full bg-gradient-to-r from-red-400 to-red-500 hover:from-red-500 hover:to-red-600 text-white px-4 py-3 rounded-xl text-center transition-all font-black shadow-lg hover:shadow-xl transform hover:scale-105 border-2 border-red-600">
                            ğŸ”„ Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenido segÃºn vista -->
    <div class="max-w-full mx-auto p-4">
        {% if vista == 'diaria' %}
            {% include 'agenda/partials/calendario_diario.html' %}
        {% elif vista == 'semanal' %}
            {% include 'agenda/partials/calendario_semanal.html' %}
        {% elif vista == 'mensual' %}
            {% include 'agenda/partials/calendario_mensual.html' %}
        {% else %}
            {% include 'agenda/partials/calendario_lista.html' %}
        {% endif %}
    </div>
</div>

<!-- Modal para editar sesiÃ³n (HTMX) -->
<div id="modal-editar" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-4 border-gray-200">
        <div id="modal-content">
            <!-- Contenido cargado por HTMX -->
        </div>
    </div>
</div>

<script>
    // Abrir modal
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'modal-content') {
            document.getElementById('modal-editar').classList.remove('hidden');
        }
    });

    // Cerrar modal
    function cerrarModal() {
        document.getElementById('modal-editar').classList.add('hidden');
        document.getElementById('modal-content').innerHTML = '';
        window.location.reload();
    }

    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            cerrarModal();
        }
    });

    // Cerrar al hacer click fuera
    document.getElementById('modal-editar').addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModal();
        }
    });
</script>
{% endblock %}