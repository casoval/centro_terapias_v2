{% extends 'base.html' %}
{% load static %}

{% block title %}Agendar Sesiones Recurrentes{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="mb-6">
            <a href="{% url 'agenda:calendario' %}" class="text-blue-600 hover:text-blue-800 flex items-center gap-2 mb-4">
                ‚Üê Volver a la Agenda
            </a>
            <h1 class="text-3xl font-bold text-gray-900">‚ûï Agendar Sesiones Recurrentes</h1>
            <p class="text-gray-600 mt-2">Programa m√∫ltiples sesiones de forma autom√°tica</p>
        </div>

        <!-- Formulario -->
        <form method="post" class="bg-white rounded-lg shadow-lg p-6 space-y-6">
            {% csrf_token %}

            <!-- ‚úÖ PASO 1: SUCURSAL (PRIMERO) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    üè¢ Sucursal * <span class="text-xs text-gray-500">(Paso 1)</span>
                </label>
                <select name="sucursal" 
                        id="sucursal-select"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        hx-get="{% url 'agenda:pacientes_sucursal' %}"
                        hx-target="#pacientes-container"
                        hx-swap="innerHTML"
                        hx-trigger="change"
                        hx-include="this"
                        onchange="resetearCascada()"
                        required>
                    <option value="">Seleccione una sucursal</option>
                    {% for sucursal in sucursales %}
                    <option value="{{ sucursal.id }}">{{ sucursal.nombre }}</option>
                    {% endfor %}
                </select>
                {% if sucursales_usuario and sucursales_usuario.count == 1 %}
                <p class="text-xs text-gray-500 mt-1">üîí Solo tienes acceso a esta sucursal</p>
                {% endif %}
            </div>

            <!-- ‚úÖ PASO 2: PACIENTE (se carga con HTMX) -->
            <div id="pacientes-container">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    üë§ Paciente * <span class="text-xs text-gray-500">(Paso 2)</span>
                </label>
                <select name="paciente" 
                        id="paciente-select"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" 
                        disabled 
                        required>
                    <option value="">Primero seleccione una sucursal</option>
                </select>
            </div>

            <!-- ‚úÖ PASO 3: SERVICIO (se carga con HTMX) -->
            <div id="servicios-container">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    üè• Servicio * <span class="text-xs text-gray-500">(Paso 3)</span>
                </label>
                <select name="servicio" 
                        id="servicio-select"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" 
                        disabled 
                        required>
                    <option value="">Primero seleccione un paciente</option>
                </select>
            </div>

            <!-- ‚úÖ PASO 4: PROFESIONAL (se carga con HTMX) -->
            <div id="profesionales-container">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    üë®‚Äç‚öïÔ∏è Profesional * <span class="text-xs text-gray-500">(Paso 4)</span>
                </label>
                <select name="profesional" 
                        id="profesional-select"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" 
                        disabled 
                        required>
                    <option value="">Primero seleccione un servicio</option>
                </select>
            </div>

            <!-- Rango de fechas -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Fecha de Inicio *</label>
                    <input type="date" 
                           name="fecha_inicio" 
                           id="fecha-inicio"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           onchange="actualizarVistaPrevia()"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Fecha de Fin *</label>
                    <input type="date" 
                           name="fecha_fin" 
                           id="fecha-fin"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           onchange="actualizarVistaPrevia()"
                           required>
                </div>
            </div>

            <!-- Hora -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">üïê Hora de Inicio *</label>
                <input type="time" 
                       name="hora" 
                       id="hora"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                       onchange="actualizarVistaPrevia()"
                       required>
            </div>

            <!-- Duraci√≥n de sesi√≥n -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <label class="text-sm font-medium text-gray-700">‚è±Ô∏è Duraci√≥n de la Sesi√≥n</label>
                    <div id="duracion-servicio-info" class="text-sm text-blue-600 font-semibold">
                        Seleccione un servicio
                    </div>
                </div>
                
                <!-- Checkbox para usar duraci√≥n est√°ndar -->
                <label class="flex items-center gap-2 cursor-pointer mb-3">
                    <input type="checkbox" 
                           id="usar-duracion-estandar" 
                           checked
                           onchange="toggleDuracionPersonalizada()"
                           class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                    <span class="text-sm text-gray-700">Usar duraci√≥n est√°ndar del servicio</span>
                </label>
                
                <!-- Campo de duraci√≥n personalizada (oculto por defecto) -->
                <div id="duracion-personalizada-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Duraci√≥n personalizada (minutos) *
                    </label>
                    <input type="number" 
                           name="duracion_personalizada" 
                           id="duracion-personalizada"
                           min="15"
                           max="240"
                           step="5"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           onchange="actualizarVistaPrevia()"
                           placeholder="Ej: 45, 60, 90">
                    <p class="text-xs text-gray-500 mt-1">
                        üí° Esta duraci√≥n se aplicar√° a todas las sesiones recurrentes
                    </p>
                </div>
            </div>

            <!-- D√≠as de la semana -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">üìÜ D√≠as de la Semana *</label>
                <div class="grid grid-cols-7 gap-2">
                    <label class="flex flex-col items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="dias_semana" value="0" class="mb-2" onchange="actualizarVistaPrevia()">
                        <span class="text-sm font-medium">Lun</span>
                    </label>
                    <label class="flex flex-col items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="dias_semana" value="1" class="mb-2" onchange="actualizarVistaPrevia()">
                        <span class="text-sm font-medium">Mar</span>
                    </label>
                    <label class="flex flex-col items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="dias_semana" value="2" class="mb-2" onchange="actualizarVistaPrevia()">
                        <span class="text-sm font-medium">Mi√©</span>
                    </label>
                    <label class="flex flex-col items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="dias_semana" value="3" class="mb-2" onchange="actualizarVistaPrevia()">
                        <span class="text-sm font-medium">Jue</span>
                    </label>
                    <label class="flex flex-col items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="dias_semana" value="4" class="mb-2" onchange="actualizarVistaPrevia()">
                        <span class="text-sm font-medium">Vie</span>
                    </label>
                    <label class="flex flex-col items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="dias_semana" value="5" class="mb-2" onchange="actualizarVistaPrevia()">
                        <span class="text-sm font-medium">S√°b</span>
                    </label>
                    <label class="flex flex-col items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="dias_semana" value="6" class="mb-2" onchange="actualizarVistaPrevia()">
                        <span class="text-sm font-medium">Dom</span>
                    </label>
                </div>
            </div>

            <!-- Vista previa -->
            <div id="vista-previa" class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-sm text-gray-600 text-center">Seleccione las fechas y d√≠as para ver la vista previa</p>
            </div>

            <!-- Botones -->
            <div class="flex gap-4 pt-4">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition">
                    ‚úÖ Generar Sesiones
                </button>
                <a href="{% url 'agenda:calendario' %}" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Funci√≥n para resetear la cascada cuando cambia la sucursal
function resetearCascada() {
    // Resetear paciente
    const pacienteContainer = document.getElementById('pacientes-container');
    pacienteContainer.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-2">
            üë§ Paciente * <span class="text-xs text-gray-500">(Paso 2)</span>
        </label>
        <select name="paciente" id="paciente-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" disabled required>
            <option value="">Cargando pacientes...</option>
        </select>
    `;
    
    // Resetear servicio
    const serviciosContainer = document.getElementById('servicios-container');
    serviciosContainer.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-2">
            üè• Servicio * <span class="text-xs text-gray-500">(Paso 3)</span>
        </label>
        <select name="servicio" id="servicio-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" disabled required>
            <option value="">Primero seleccione un paciente</option>
        </select>
    `;
    
    // Resetear profesional
    const profesionalesContainer = document.getElementById('profesionales-container');
    profesionalesContainer.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-2">
            üë®‚Äç‚öïÔ∏è Profesional * <span class="text-xs text-gray-500">(Paso 4)</span>
        </label>
        <select name="profesional" id="profesional-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" disabled required>
            <option value="">Primero seleccione un servicio</option>
        </select>
    `;
    
    // Resetear duraci√≥n
    document.getElementById('duracion-servicio-info').textContent = 'Seleccione un servicio';
    document.getElementById('usar-duracion-estandar').checked = true;
    document.getElementById('duracion-personalizada-container').classList.add('hidden');
    
    // Limpiar vista previa
    document.getElementById('vista-previa').innerHTML = 
        '<p class="text-sm text-gray-600 text-center">Seleccione las fechas y d√≠as para ver la vista previa</p>';
}

// Funci√≥n para toggle de duraci√≥n personalizada
function toggleDuracionPersonalizada() {
    const checkbox = document.getElementById('usar-duracion-estandar');
    const container = document.getElementById('duracion-personalizada-container');
    const inputPersonalizado = document.getElementById('duracion-personalizada');
    
    if (checkbox.checked) {
        container.classList.add('hidden');
        inputPersonalizado.value = '';
    } else {
        container.classList.remove('hidden');
        // Establecer valor por defecto desde el servicio seleccionado
        const servicioSelect = document.getElementById('servicio-select');
        if (servicioSelect && servicioSelect.value) {
            const selectedOption = servicioSelect.options[servicioSelect.selectedIndex];
            const duracion = selectedOption.getAttribute('data-duracion');
            if (duracion) {
                inputPersonalizado.value = duracion;
            }
        }
        inputPersonalizado.focus();
    }
    
    actualizarVistaPrevia();
}

// Funci√≥n para obtener la duraci√≥n efectiva
function obtenerDuracionEfectiva() {
    const usarEstandar = document.getElementById('usar-duracion-estandar').checked;
    
    if (usarEstandar) {
        const servicioSelect = document.getElementById('servicio-select');
        if (servicioSelect && servicioSelect.value) {
            const selectedOption = servicioSelect.options[servicioSelect.selectedIndex];
            return parseInt(selectedOption.getAttribute('data-duracion')) || 60;
        }
        return 60;
    } else {
        const duracionPersonalizada = document.getElementById('duracion-personalizada').value;
        return parseInt(duracionPersonalizada) || 60;
    }
}

function actualizarVistaPrevia() {
    const fechaInicio = document.getElementById('fecha-inicio').value;
    const fechaFin = document.getElementById('fecha-fin').value;
    const hora = document.getElementById('hora').value;
    
    const diasSeleccionados = [];
    document.querySelectorAll('input[name="dias_semana"]:checked').forEach(checkbox => {
        diasSeleccionados.push(checkbox.value);
    });
    
    if (!fechaInicio || !fechaFin || !hora || diasSeleccionados.length === 0) {
        document.getElementById('vista-previa').innerHTML = 
            '<p class="text-sm text-gray-600 text-center">Seleccione las fechas, hora y d√≠as para ver la vista previa</p>';
        return;
    }
    
    if (new Date(fechaInicio) > new Date(fechaFin)) {
        document.getElementById('vista-previa').innerHTML = 
            '<p class="text-sm text-red-600 text-center">‚ö†Ô∏è La fecha de inicio debe ser anterior a la fecha de fin</p>';
        return;
    }
    
    const pacienteId = document.getElementById('paciente-select')?.value || '';
    const profesionalId = document.getElementById('profesional-select')?.value || '';
    const servicioId = document.getElementById('servicio-select')?.value || '';
    const duracionEfectiva = obtenerDuracionEfectiva();
    
    const params = new URLSearchParams({
        fecha_inicio: fechaInicio,
        fecha_fin: fechaFin,
        hora: hora,
        paciente: pacienteId,
        profesional: profesionalId,
        servicio: servicioId,
        duracion: duracionEfectiva
    });
    
    diasSeleccionados.forEach(dia => {
        params.append('dias_semana', dia);
    });
    
    document.getElementById('vista-previa').innerHTML = 
        '<p class="text-sm text-gray-600 text-center">‚è≥ Cargando vista previa...</p>';
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url = '{% url "agenda:vista_previa" %}?' + params.toString();
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.text();
        })
        .then(html => {
            const container = document.getElementById('vista-previa');
            if (!container) {
                console.error('‚ùå No se encontr√≥ el contenedor vista-previa');
                return;
            }
            container.innerHTML = html;
            
            // ‚úÖ Actualizar contador despu√©s de cargar la vista previa
            actualizarContador();
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            document.getElementById('vista-previa').innerHTML = 
                '<p class="text-sm text-red-600 text-center">‚ùå Error al cargar la vista previa. Por favor, intente nuevamente.</p>';
        });
}

// ‚úÖ NUEVA: Funci√≥n para toggle de conflictos
window.toggleConflicto = function(panelId, btn) {
    var panel = document.getElementById(panelId);
    if (panel) {
        if (panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'block';
            btn.innerHTML = '‚ñ≤ Ocultar';
        } else {
            panel.style.display = 'none';
            btn.innerHTML = '‚ñº Ver detalle';
        }
    }
};

// ‚úÖ NUEVA: Funci√≥n para actualizar el contador de sesiones seleccionadas
window.actualizarContador = function() {
    const checkboxes = document.querySelectorAll('.sesion-checkbox:checked');
    const total = document.querySelectorAll('.sesion-checkbox').length;
    const seleccionadas = checkboxes.length;
    
    const contadorElement = document.getElementById('contador-seleccionadas');
    if (contadorElement) {
        contadorElement.textContent = seleccionadas;
    }
    
    const totalElement = document.getElementById('total-sesiones');
    if (totalElement) {
        totalElement.textContent = total;
    }
};

// ‚úÖ NUEVA: Validar antes de enviar el formulario
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const checkboxes = document.querySelectorAll('.sesion-checkbox:checked');
            
            if (checkboxes.length === 0) {
                e.preventDefault();
                alert('‚ö†Ô∏è Debes seleccionar al menos una sesi√≥n para agendar');
                return false;
            }
        });
    }
});

// Observer para detectar cuando se carga el select de servicios y actualizar la info de duraci√≥n
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        const servicioSelect = document.getElementById('servicio-select');
        if (servicioSelect && !servicioSelect.disabled) {
            servicioSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const duracion = selectedOption.getAttribute('data-duracion');
                
                // ‚úÖ CORREGIDO: Solo mostrar duraci√≥n en minutos
                if (duracion) {
                    document.getElementById('duracion-servicio-info').textContent = 
                        `${duracion} minutos`;
                }
            });
        }
    });
});

observer.observe(document.getElementById('servicios-container'), {
    childList: true,
    subtree: true
});
</script>
{% endblock %}