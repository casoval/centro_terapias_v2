{% load fecha_tags %}
<div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200 font-sans">
    
    <div class="px-5 py-3 border-b border-gray-100 bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-md relative overflow-hidden">
        <div class="absolute top-0 right-0 -mt-2 -mr-2 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
        <div class="absolute bottom-0 left-0 -mb-2 -ml-2 w-16 h-16 bg-white opacity-10 rounded-full blur-lg"></div>
        
        <div class="relative z-10 flex items-center justify-between gap-4">
            <!-- Icono y t√≠tulo -->
            <div class="flex items-center gap-3">
                <div class="text-4xl font-black tracking-tight leading-none opacity-95">
                    üìÜ
                </div>
                <div class="h-10 w-px bg-white/30"></div>
            </div>
            
            <!-- Informaci√≥n de vista -->
            <div class="flex-1">
                <div class="text-lg font-bold capitalize tracking-wide opacity-90 leading-tight">
                    Vista Mensual
                </div>
                <div class="text-xs font-medium uppercase tracking-wider opacity-75">
                    Gesti√≥n Global
                </div>
            </div>
            
            <!-- Controles -->
            <label class="flex items-center gap-2 cursor-pointer bg-white/10 px-3 py-1.5 rounded-full border border-white/20 hover:bg-white/20 transition-all">
                <input type="checkbox" 
                       id="toggle-domingos-mensual" 
                       class="w-4 h-4 text-blue-600 rounded focus:ring-offset-0 focus:ring-0 cursor-pointer accent-white"
                       onchange="toggleDomingosMensual(this.checked)">
                <span class="text-xs text-white font-bold tracking-wide">Mostrar Domingos</span>
            </label>
        </div>
    </div>

    <div id="header-dias-mensual" class="grid grid-cols-7 gap-0 border-b bg-gray-50 divide-x divide-gray-200 text-gray-500">
        <div class="py-2 text-center text-[10px] font-bold uppercase tracking-widest">Lun</div>
        <div class="py-2 text-center text-[10px] font-bold uppercase tracking-widest">Mar</div>
        <div class="py-2 text-center text-[10px] font-bold uppercase tracking-widest">Mi√©</div>
        <div class="py-2 text-center text-[10px] font-bold uppercase tracking-widest">Jue</div>
        <div class="py-2 text-center text-[10px] font-bold uppercase tracking-widest">Vie</div>
        <div class="py-2 text-center text-[10px] font-bold uppercase tracking-widest">S√°b</div>
        <div class="py-2 text-center text-[10px] font-bold uppercase tracking-widest columna-domingo-mensual">Dom</div>
    </div>

    <div id="grid-mensual" class="bg-gray-200 gap-px border-b border-gray-200">
        {% for semana in calendario_data.semanas %}
        <div class="grid grid-cols-7 gap-px bg-gray-200" style="min-height: 140px;">
            {% for dia in semana %}
            <div class="bg-white relative flex flex-col p-1 transition-all border-b border-gray-200 dia-celda
                        {% if dia.es_otro_mes %}bg-gray-50/50 text-gray-400{% endif %}
                        {% if forloop.last %}columna-domingo-mensual{% endif %}" 
                 data-dia="{{ forloop.counter0 }}"
                 data-fecha="{{ dia.fecha|date:'Y-m-d' }}"
                 data-dia-nombre="{{ dia.fecha|date:'l, d' }} de {{ dia.fecha|date:'F Y' }}"
                 data-tiene-sesiones="{% if dia.sesiones_agrupadas %}true{% else %}false{% endif %}"
                 onclick="abrirModalDia(this, event)">
                
                {% if dia.fecha %}
                    <div class="flex justify-end mb-1 dia-numero-header">
                        {% if dia.es_hoy %}
                            <span class="inline-flex items-center justify-center w-7 h-7 bg-blue-600 text-white rounded-full font-black text-sm shadow-sm shadow-blue-200 scale-110">
                                {{ dia.dia_numero }}
                            </span>
                        {% elif dia.es_otro_mes %}
                            <span class="inline-flex items-center justify-center w-7 h-7 text-gray-300 font-semibold text-xs">
                                {{ dia.dia_numero }}
                            </span>
                        {% else %}
                            <span class="inline-flex items-center justify-center w-7 h-7 bg-gray-200 text-gray-800 rounded-full font-bold text-sm shadow-sm hover:bg-gray-300 rounded-full transition-colors cursor-pointer">
                                {{ dia.dia_numero }}
                            </span>
                        {% endif %}
                    </div>

                    <div class="flex-1 space-y-1 sesiones-container">
                        {% if dia.sesiones_agrupadas %}
                            {% for grupo in dia.sesiones_agrupadas %}
                                
                                {% if grupo.mostrar_linea_tarde %}
                                    <div class="my-1 border-t border-dashed border-orange-300 w-full relative h-1">
                                         <span class="absolute -top-1.5 left-0 text-[6px] text-orange-400 bg-white px-0.5 font-bold">PM</span>
                                    </div>
                                {% endif %}
                                
                                {% for sesion in grupo.sesiones %}
                                <div class="group relative cursor-pointer rounded-md border-l-[3px] shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 p-1.5
                                    {% if sesion.estado == 'programada' %}bg-blue-50 border-l-blue-500 border border-blue-100
                                    {% elif sesion.estado == 'realizada' %}bg-emerald-50 border-l-emerald-500 border border-emerald-100
                                    {% elif sesion.estado == 'realizada_retraso' %}bg-amber-50 border-l-amber-500 border border-amber-100
                                    {% elif sesion.estado == 'falta' %}bg-rose-50 border-l-rose-500 border border-rose-100
                                    {% elif sesion.estado == 'permiso' %}bg-purple-50 border-l-purple-500 border border-purple-100
                                    {% elif sesion.estado == 'cancelada' %}bg-gray-50 border-l-gray-400 border border-gray-200 opacity-70
                                    {% elif sesion.estado == 'reprogramada' %}bg-orange-50 border-l-orange-500 border border-orange-100
                                    {% endif %}"
                                     hx-get="{% url 'agenda:editar_sesion' sesion.id %}"
                                     hx-target="#modal-content"
                                     hx-swap="innerHTML"
                                     data-sesion-info='{"hora_inicio":"{{ sesion.hora_inicio|time:"g:i A" }}","hora_fin":"{{ sesion.hora_fin|time:"g:i A" }}","paciente":"{{ sesion.paciente.nombre }} {{ sesion.paciente.apellido }}","servicio":"{{ sesion.servicio.nombre }}","profesional":"{{ sesion.profesional.nombre }} {{ sesion.profesional.apellido }}","sucursal":"{{ sesion.sucursal.nombre }}","estado":"{{ sesion.get_estado_display }}","monto":"{{ sesion.monto_cobrado }}"{% if sesion.proyecto %},"proyecto":"{{ sesion.proyecto.codigo }}"{% endif %}{% if sesion.mensualidad %},"mensualidad":"{{ sesion.mensualidad.codigo }}"{% endif %}}'>
                                    
                                    <div class="flex items-center justify-between leading-none mb-1 pb-1 border-b border-black/5">
                                        <div class="flex items-center gap-1">
                                            <span class="text-[10px] font-bold text-gray-800">
                                                {{ sesion.hora_inicio|time:"g:i A" }}
                                            </span>
                                            <span class="text-[8px] text-gray-500">
                                                -{{ sesion.hora_fin|time:"g:i A" }}
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center gap-0.5">
                                            {% if sesion.monto_cobrado > 0 %}
                                                {% if sesion.pagado %}
                                                <span class="text-[9px] text-emerald-600" title="Pagado">‚úÖ</span>
                                                {% else %}
                                                <span class="text-[9px] text-rose-600 font-bold animate-pulse" title="Pago Pendiente">üí∞</span>
                                                {% endif %}
                                            {% endif %}
                                            
                                            {% if sesion.es_ultima_sesion_paciente_servicio %}
                                            <span class="text-[9px] text-amber-600" title="√öltima sesi√≥n">‚ö†Ô∏è</span>
                                            {% endif %}

                                            {% if sesion.proyecto %}
                                            <span class="text-[9px] text-purple-600" title="Proyecto: {{ sesion.proyecto.codigo }}">üì¶</span>
                                            {% endif %}

                                            {% if sesion.mensualidad %}
                                            <span class="text-[9px] text-indigo-600" title="Mensualidad: {{ sesion.mensualidad.codigo }}">üí≥</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="text-[9px] font-bold text-gray-800 leading-tight mb-0.5 truncate">
                                        {{ sesion.paciente.nombre }} {{ sesion.paciente.apellido }}
                                    </div>
                                    
                                    <div class="flex items-center gap-1 mb-0.5">
                                        <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background-color: {{ sesion.servicio.color }};"></span>
                                        <span class="text-[8px] text-gray-600 font-medium leading-tight truncate">
                                            {{ sesion.servicio.nombre }}
                                        </span>
                                    </div>

                                    <div class="flex flex-col gap-0.5 mt-1 pt-0.5 border-t border-black/5">
                                        <div class="text-[7px] text-gray-500 flex items-center gap-1 truncate">
                                            <span class="flex-shrink-0">üë®‚Äç‚öïÔ∏è</span> <span class="truncate">{{ sesion.profesional.nombre }} {{ sesion.profesional.apellido }}</span>
                                        </div>
                                        <div class="text-[7px] text-gray-500 flex items-center gap-1 truncate">
                                            <span class="flex-shrink-0">üè¢</span> <span class="truncate">{{ sesion.sucursal.nombre }}</span>
                                        </div>
                                    </div>

                                    {% if sesion.estado == 'programada' and not sesion.pagos.exists %}
                                        {% if user.is_superuser or user.perfil.puede_eliminar_sesiones %}
                                        <button onclick="confirmarEliminar(event, {{ sesion.id }}, '{{ sesion.paciente.nombre|escapejs }} {{ sesion.paciente.apellido|escapejs }}', '{{ sesion.servicio.nombre|escapejs }}', '{{ sesion.fecha|date:"d/m/Y" }}', '{{ sesion.hora_inicio|time:"g:i A" }}')"
                                                class="absolute bottom-1 right-1 p-0.5 bg-rose-500 text-white rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-all z-20 hover:scale-110"
                                                title="Eliminar sesi√≥n">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                        {% endif %}
                                    {% endif %}

                                    <div class="sesion-tooltip-trigger"></div>
                                </div>
                                {% endfor %}
                            {% endfor %}
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <div class="p-3 bg-white border-t border-gray-200">
        <div class="flex flex-wrap gap-2 items-center justify-center text-[9px] font-medium text-gray-600">
            <span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 border border-blue-200">Prog.</span>
            <span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">Real.</span>
            <span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-200">Retraso</span>
            <span class="px-2 py-0.5 rounded-full bg-rose-100 text-rose-700 border border-rose-200">Falta</span>
            <span class="px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 border border-purple-200">Permiso</span>
            <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 border border-gray-200">Cancel.</span>
            
            <div class="w-px h-3 bg-gray-300 mx-1"></div>
            
            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-purple-200 shadow-sm">
                <span class="text-purple-600">üì¶</span>
                <span class="text-purple-700 font-bold">Proyecto</span>
            </div>
            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-indigo-200 shadow-sm">
                <span class="text-indigo-600">üí≥</span>
                <span class="text-indigo-700 font-bold">Mensualidad</span>
            </div>
            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-emerald-200 shadow-sm">
                <span class="text-emerald-600">‚úÖ</span>
                <span class="text-emerald-700 font-bold">Pagado</span>
            </div>
            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-rose-200 shadow-sm">
                <span class="text-rose-600 font-bold">üí∞</span>
                <span class="text-rose-700 font-bold">Pendiente</span>
            </div>
            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-amber-200 shadow-sm">
                <span class="text-amber-600">‚ö†Ô∏è</span>
                <span class="text-amber-700 font-bold">√öltima Sesi√≥n</span>
            </div>
        </div>
    </div>
</div>

<!-- Tooltip flotante con posici√≥n fija -->
<div id="sesion-tooltip" class="fixed hidden z-[9999] pointer-events-none">
    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-3 rounded-lg shadow-2xl border border-gray-700 backdrop-blur-sm transform transition-all duration-200 ease-out scale-95 opacity-0" style="min-width: 240px; max-width: 280px;">
        <div class="flex items-center justify-between mb-2 pb-1.5 border-b border-gray-700">
            <div class="flex items-center gap-1.5">
                <div class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse"></div>
                <span class="text-xs font-bold text-blue-300" id="tooltip-horario"></span>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        
        <div class="space-y-2">
            <div class="flex items-start gap-2">
                <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Paciente:</span>
                <span class="text-xs font-semibold text-white" id="tooltip-paciente"></span>
            </div>
            
            <div class="flex items-start gap-2">
                <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Servicio:</span>
                <span class="text-xs text-blue-200" id="tooltip-servicio"></span>
            </div>
            
            <div class="h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent my-1.5"></div>
            
            <div class="flex items-start gap-2">
                <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Prof:</span>
                <span class="text-[10px] text-gray-300" id="tooltip-profesional"></span>
            </div>
            
            <div class="flex items-start gap-2">
                <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Sucursal:</span>
                <span class="text-[10px] text-gray-300" id="tooltip-sucursal"></span>
            </div>
            
            <div id="tooltip-extra-info" class="hidden">
                <div class="h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent my-1.5"></div>
                
                <div class="flex items-start gap-2">
                    <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Estado:</span>
                    <span class="text-[10px] font-semibold" id="tooltip-estado"></span>
                </div>
                
                <div class="flex items-start gap-2">
                    <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Monto:</span>
                    <span class="text-[10px] text-emerald-300" id="tooltip-monto"></span>
                </div>
                
                <div id="tooltip-proyecto-container" class="hidden flex items-start gap-2">
                    <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Proyecto:</span>
                    <span class="text-[10px] text-purple-300" id="tooltip-proyecto"></span>
                </div>
                
                <div id="tooltip-mensualidad-container" class="hidden flex items-start gap-2">
                    <span class="text-[10px] text-gray-400 w-14 flex-shrink-0 font-medium">Mens.:</span>
                    <span class="text-[10px] text-indigo-300" id="tooltip-mensualidad"></span>
                </div>
            </div>
        </div>
        
        <div class="mt-2 pt-2 border-t border-gray-700">
            <div class="flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                </svg>
                <span class="text-[9px] text-gray-500 italic">Click para editar</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n de eliminaci√≥n -->
<div id="modal-eliminar-sesion" class="fixed inset-0 bg-black bg-opacity-50 z-[9998] hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all duration-300 scale-95 opacity-0">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-rose-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-xl font-black text-gray-900">Confirmar Eliminaci√≥n</h3>
        </div>
        
        <div class="mb-6 space-y-2">
            <p class="text-sm text-gray-600">¬øEst√°s seguro de eliminar esta sesi√≥n?</p>
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-1">
                <p class="text-xs text-gray-700"><span class="font-bold">Paciente:</span> <span id="eliminar-paciente"></span></p>
                <p class="text-xs text-gray-700"><span class="font-bold">Servicio:</span> <span id="eliminar-servicio"></span></p>
                <p class="text-xs text-gray-700"><span class="font-bold">Fecha:</span> <span id="eliminar-fecha"></span></p>
                <p class="text-xs text-gray-700"><span class="font-bold">Hora:</span> <span id="eliminar-hora"></span></p>
            </div>
            <p class="text-xs text-rose-600 font-bold">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="cerrarModalEliminar()" 
                    class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-200 transition-colors">
                Cancelar
            </button>
            <button id="confirmar-eliminar-btn" 
                    class="flex-1 px-4 py-2.5 bg-rose-600 text-white rounded-lg font-bold text-sm hover:bg-rose-700 transition-colors">
                Eliminar
            </button>
        </div>
    </div>
</div>

<script>
// Tooltip flotante avanzado
let tooltipTimeout;
const tooltip = document.getElementById('sesion-tooltip');

document.addEventListener('DOMContentLoaded', function() {
    const sesiones = document.querySelectorAll('.group');
    
    sesiones.forEach(sesion => {
        sesion.addEventListener('mouseenter', function(e) {
            clearTimeout(tooltipTimeout);
            
            tooltipTimeout = setTimeout(() => {
                const sesionInfo = JSON.parse(this.getAttribute('data-sesion-info'));
                
                document.getElementById('tooltip-horario').textContent = 
                    `${sesionInfo.hora_inicio} - ${sesionInfo.hora_fin}`;
                document.getElementById('tooltip-paciente').textContent = sesionInfo.paciente;
                document.getElementById('tooltip-servicio').textContent = sesionInfo.servicio;
                document.getElementById('tooltip-profesional').textContent = sesionInfo.profesional;
                document.getElementById('tooltip-sucursal').textContent = sesionInfo.sucursal;
                document.getElementById('tooltip-estado').textContent = sesionInfo.estado;
                document.getElementById('tooltip-monto').textContent = `Bs. ${sesionInfo.monto}`;
                
                const extraInfo = document.getElementById('tooltip-extra-info');
                extraInfo.classList.remove('hidden');
                
                const proyectoContainer = document.getElementById('tooltip-proyecto-container');
                if (sesionInfo.proyecto) {
                    proyectoContainer.classList.remove('hidden');
                    document.getElementById('tooltip-proyecto').textContent = sesionInfo.proyecto;
                } else {
                    proyectoContainer.classList.add('hidden');
                }
                
                const mensualidadContainer = document.getElementById('tooltip-mensualidad-container');
                if (sesionInfo.mensualidad) {
                    mensualidadContainer.classList.remove('hidden');
                    document.getElementById('tooltip-mensualidad').textContent = sesionInfo.mensualidad;
                } else {
                    mensualidadContainer.classList.add('hidden');
                }
                
                tooltip.classList.remove('hidden');
                
                const tooltipContent = tooltip.firstElementChild;
                requestAnimationFrame(() => {
                    tooltipContent.classList.remove('scale-95', 'opacity-0');
                    tooltipContent.classList.add('scale-100', 'opacity-100');
                });
                
                posicionarTooltip(e);
            }, 400);
        });
        
        sesion.addEventListener('mousemove', posicionarTooltip);
        
        sesion.addEventListener('mouseleave', function() {
            clearTimeout(tooltipTimeout);
            ocultarTooltip();
        });
    });
});

function posicionarTooltip(e) {
    const tooltipContent = tooltip.firstElementChild;
    const tooltipRect = tooltipContent.getBoundingClientRect();
    const offset = 15;
    
    let left = e.clientX + offset;
    let top = e.clientY + offset;
    
    if (left + tooltipRect.width > window.innerWidth) {
        left = e.clientX - tooltipRect.width - offset;
    }
    
    if (top + tooltipRect.height > window.innerHeight) {
        top = e.clientY - tooltipRect.height - offset;
    }
    
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
}

function ocultarTooltip() {
    const tooltipContent = tooltip.firstElementChild;
    tooltipContent.classList.remove('scale-100', 'opacity-100');
    tooltipContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        tooltip.classList.add('hidden');
    }, 200);
}
</script>

<script>
// Modal de eliminaci√≥n
function confirmarEliminar(event, sesionId, paciente, servicio, fecha, hora) {
    event.stopPropagation();
    
    document.getElementById('eliminar-paciente').textContent = paciente;
    document.getElementById('eliminar-servicio').textContent = servicio;
    document.getElementById('eliminar-fecha').textContent = fecha;
    document.getElementById('eliminar-hora').textContent = hora;
    
    const modal = document.getElementById('modal-eliminar-sesion');
    const modalContent = modal.querySelector('div');
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    requestAnimationFrame(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    });
    
    const btnConfirmar = document.getElementById('confirmar-eliminar-btn');
    btnConfirmar.onclick = function() {
        eliminarSesion(sesionId);
    };
}

function cerrarModalEliminar() {
    const modal = document.getElementById('modal-eliminar-sesion');
    const modalContent = modal.querySelector('div');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
    }, 300);
}

function eliminarSesion(sesionId) {
    fetch(`/agenda/eliminar-sesion/${sesionId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cerrarModalEliminar();
            location.reload();
        } else {
            alert('Error al eliminar la sesi√≥n: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar la sesi√≥n');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<script>
function abrirModalDia(elemento, event) {
    if (event.target.closest('.group')) {
        return;
    }
    
    const fecha = elemento.getAttribute('data-fecha');
    const diaNombre = elemento.getAttribute('data-dia-nombre');
    const tieneSesiones = elemento.getAttribute('data-tiene-sesiones') === 'true';
    
    if (!tieneSesiones) {
        return;
    }
    
    const sesiones = elemento.querySelectorAll('.group');
    
    if (sesiones.length === 0) {
        return;
    }
    
    const overlay = document.createElement('div');
    overlay.id = 'modal-dia-overlay';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300';
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            cerrarModalDia();
        }
    };
    
    const modal = document.createElement('div');
    modal.id = 'modal-dia-content';
    modal.className = 'bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden scale-95 opacity-0 transition-all duration-300';
    
    modal.innerHTML = `
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
            <div class="relative z-10 flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-black mb-1">${diaNombre}</h2>
                    <p class="text-sm text-blue-100 font-medium">${sesiones.length} sesi√≥n${sesiones.length !== 1 ? 'es' : ''} programada${sesiones.length !== 1 ? 's' : ''}</p>
                </div>
                <button onclick="cerrarModalDia()" class="p-2 hover:bg-white/20 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div id="modal-sesiones-list" class="space-y-3"></div>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    requestAnimationFrame(() => {
        overlay.classList.remove('opacity-0');
        overlay.classList.add('opacity-100');
        modal.classList.remove('scale-95', 'opacity-0');
        modal.classList.add('scale-100', 'opacity-100');
    });
    
    const modalSesionesList = document.getElementById('modal-sesiones-list');
    
    sesiones.forEach(sesion => {
        const sesionClonada = sesion.cloneNode(true);
        sesionClonada.classList.remove('group');
        sesionClonada.classList.add('hover:shadow-lg');
        
        sesionClonada.querySelectorAll('.text-\\[10px\\]').forEach(el => {
            el.classList.remove('text-[10px]');
            el.classList.add('text-sm');
        });
        sesionClonada.querySelectorAll('.text-\\[9px\\]').forEach(el => {
            el.classList.remove('text-[9px]');
            el.classList.add('text-xs');
        });
        sesionClonada.querySelectorAll('.text-\\[8px\\]').forEach(el => {
            el.classList.remove('text-[8px]');
            el.classList.add('text-[11px]');
        });
        sesionClonada.querySelectorAll('.text-\\[7px\\]').forEach(el => {
            el.classList.remove('text-[7px]');
            el.classList.add('text-[10px]');
        });
        
        modalSesionesList.appendChild(sesionClonada);
    });
}

function cerrarModalDia() {
    const overlay = document.getElementById('modal-dia-overlay');
    const modal = document.getElementById('modal-dia-content');
    
    if (overlay && modal) {
        overlay.classList.remove('opacity-100');
        overlay.classList.add('opacity-0');
        modal.classList.remove('scale-100', 'opacity-100');
        modal.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            overlay.remove();
        }, 300);
    }
}

// Cerrar con tecla ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        cerrarModalDia();
    }
});
</script>

<script>
// L√≥gica de Domingos y Zoom (Sin cambios funcionales, solo adaptado a clases nuevas)
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('toggle-domingos-mensual');
    
    // Verificar si hay sesiones en alg√∫n domingo
    const columnasDomingo = document.querySelectorAll('.columna-domingo-mensual');
    let tieneSesiones = false;
    
    columnasDomingo.forEach(col => {
        if (col.getAttribute('data-dia') === '6') {
            const sesiones = col.querySelectorAll('.group');
            if (sesiones.length > 0) {
                tieneSesiones = true;
            }
        }
    });
    
    if (!tieneSesiones) {
        ocultarDomingosMensual();
        if (toggle) toggle.checked = false;
    } else {
        if (toggle) toggle.checked = true;
    }
});

function toggleDomingosMensual(mostrar) {
    if (mostrar) {
        mostrarDomingosMensual();
    } else {
        ocultarDomingosMensual();
    }
}

function ocultarDomingosMensual() {
    const columnasDomingo = document.querySelectorAll('.columna-domingo-mensual');
    const headerDias = document.getElementById('header-dias-mensual');
    const gridMensual = document.getElementById('grid-mensual');
    
    columnasDomingo.forEach(col => {
        col.style.display = 'none';
    });
    
    if (headerDias) {
        headerDias.classList.remove('grid-cols-7');
        headerDias.classList.add('grid-cols-6');
    }
    
    if (gridMensual) {
        const filas = gridMensual.querySelectorAll('.grid');
        filas.forEach(fila => {
            fila.classList.remove('grid-cols-7');
            fila.classList.add('grid-cols-6');
        });
    }
}

function mostrarDomingosMensual() {
    const columnasDomingo = document.querySelectorAll('.columna-domingo-mensual');
    const headerDias = document.getElementById('header-dias-mensual');
    const gridMensual = document.getElementById('grid-mensual');
    
    columnasDomingo.forEach(col => {
        col.style.display = '';
    });
    
    if (headerDias) {
        headerDias.classList.remove('grid-cols-6');
        headerDias.classList.add('grid-cols-7');
    }
    
    if (gridMensual) {
        const filas = gridMensual.querySelectorAll('.grid');
        filas.forEach(fila => {
            fila.classList.remove('grid-cols-6');
            fila.classList.add('grid-cols-7');
        });
    }
}
</script>

<style>
#header-dias-mensual, #grid-mensual .grid {
    transition: none !important;
}

.dia-celda {
    cursor: pointer;
    transition: all 0.2s ease;
}

.dia-celda:hover:not(.dia-atenuado) {
    background-color: rgb(249, 250, 251);
    transform: scale(1.02);
}

.dia-celda:hover .dia-numero-header span:not(.bg-blue-600) {
    background-color: rgb(243, 244, 246);
}
</style>