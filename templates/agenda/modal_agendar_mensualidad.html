<!-- ========================================
     MODAL AGENDAMIENTO R√ÅPIDO DESDE MENSUALIDAD
     Opci√≥n C: D√≠as espec√≠ficos + Patr√≥n recurrente
     ======================================== -->

<!-- Modal Header -->
<div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2.5 flex items-center justify-between rounded-t-2xl">
    <div class="flex items-center gap-2">
        <span class="text-2xl">üìÖ</span>
        <div>
            <h2 class="text-base font-black text-white">Agendar Sesiones: {{ servicio_profesional.servicio.nombre }}</h2>
            <p class="text-purple-100 text-[11px] mt-0.5">
                {{ mensualidad.periodo_display }} | 
                {{ servicio_profesional.profesional.nombre }} {{ servicio_profesional.profesional.apellido }}
            </p>
        </div>
    </div>
    <button onclick="cerrarModalAgendarRapido()"
            class="text-white hover:bg-white/20 w-7 h-7 rounded-lg transition-colors flex items-center justify-center font-bold text-lg">
        √ó
    </button>
</div>

<!-- Modal Body -->
<form method="post" action="{% url 'agenda:procesar_agendar_mensualidad' servicio_profesional.id %}" 
      id="formAgendarMensualidad" class="p-4">
    {% csrf_token %}
    
    <!-- ========================================
         INPUTS OCULTOS (Datos Pre-cargados)
         ======================================== -->
    <input type="hidden" name="mensualidad_id" value="{{ mensualidad.id }}">
    <input type="hidden" name="paciente_id" value="{{ mensualidad.paciente.id }}">
    <input type="hidden" name="sucursal_id" value="{{ mensualidad.sucursal.id }}">
    <input type="hidden" name="servicio_id" value="{{ servicio_profesional.servicio.id }}">
    <input type="hidden" name="profesional_id" value="{{ servicio_profesional.profesional.id }}">
    <input type="hidden" name="modo_seleccion" id="modo_seleccion" value="recurrente">
    
    <!-- ========================================
         RESUMEN VISUAL (Read-only)
         ======================================== -->
    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-2.5 mb-4 border-2 border-purple-200">
        <h3 class="text-sm font-black text-purple-900 mb-2 flex items-center gap-2">
            <span>üìã</span> Informaci√≥n de la Sesi√≥n
        </h3>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 text-xs">
            <div class="bg-white rounded-lg p-1.5 border border-purple-100">
                <p class="text-purple-600 font-semibold mb-0.5">üë§ Paciente</p>
                <p class="font-bold text-slate-800 truncate">{{ mensualidad.paciente.nombre_completo }}</p>
            </div>
            <div class="bg-white rounded-lg p-1.5 border border-purple-100">
                <p class="text-purple-600 font-semibold mb-0.5">üè¢ Sucursal</p>
                <p class="font-bold text-slate-800 truncate">{{ mensualidad.sucursal.nombre }}</p>
            </div>
            <div class="bg-white rounded-lg p-1.5 border border-purple-100">
                <p class="text-purple-600 font-semibold mb-0.5">üìÖ Per√≠odo</p>
                <p class="font-bold text-slate-800">{{ mensualidad.periodo_display }}</p>
            </div>
            <div class="bg-white rounded-lg p-1.5 border border-purple-100">
                <p class="text-purple-600 font-semibold mb-0.5">üë®‚Äç‚öïÔ∏è Profesional</p>
                <p class="font-bold text-slate-800 truncate">{{ servicio_profesional.profesional.nombre }} {{ servicio_profesional.profesional.apellido|first }}.</p>
            </div>
        </div>
    </div>

    <!-- ========================================
         CONFIGURACI√ìN B√ÅSICA (Hora y Duraci√≥n)
         ======================================== -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
        <div>
            <label class="block text-xs font-bold text-slate-700 mb-1.5 flex items-center gap-1">
                <span>‚è∞</span> Hora de Inicio
            </label>
            <input type="time" 
                   name="hora_inicio" 
                   id="hora-inicio-modal"
                   required
                   onchange="validarAutomaticamente()"
                   class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none font-mono">
        </div>
        
        <div class="bg-blue-50/50 rounded-lg p-2.5 border border-blue-200">
            <div class="flex justify-between items-center mb-1.5">
                <label class="text-blue-800 font-bold text-xs flex items-center gap-1">
                    <span>‚è±Ô∏è</span> Duraci√≥n
                </label>
                <span id="duracion-servicio-info-modal" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">
                    {{ servicio_profesional.servicio.duracion_minutos }} min
                </span>
            </div>
            <div class="flex items-center gap-2 mb-1.5">
                <input type="checkbox" 
                       id="usar-duracion-estandar-modal" 
                       checked 
                       onchange="toggleDuracionPersonalizadaModal()" 
                       class="rounded text-blue-600 focus:ring-blue-400 border-gray-300">
                <span class="text-slate-600 text-xs">Usar duraci√≥n est√°ndar del servicio</span>
            </div>
            <div id="duracion-personalizada-container-modal" class="hidden">
                <input type="number" 
                       name="duracion_personalizada" 
                       id="duracion-personalizada-modal" 
                       min="15" 
                       max="240" 
                       step="5"
                       class="w-full px-3 py-2 bg-white border-2 border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none"
                       oninput="actualizarDuracionHidden()"
                       onchange="validarAutomaticamente()" 
                       placeholder="Ingresa minutos personalizados (ej: 75)">
            </div>
            <!-- Input oculto que contendr√° el valor final -->
            <input type="hidden" name="duracion_minutos" id="duracion-minutos-modal" value="{{ servicio_profesional.servicio.duracion_minutos }}">
        </div>
    </div>

    <!-- ========================================
         OPCI√ìN C: SELECTOR DE MODO
         ======================================== -->
    <div class="mb-6">
        <label class="block text-sm font-black text-slate-800 mb-3 flex items-center gap-2">
            <span>üìÜ</span> ¬øC√≥mo quieres seleccionar los d√≠as?
        </label>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- OPCI√ìN 1: Patr√≥n Recurrente -->
            <label class="flex items-center p-3 bg-white border-2 border-purple-300 rounded-xl cursor-pointer hover:bg-purple-50 transition-all has-[:checked]:bg-purple-100 has-[:checked]:border-purple-500 has-[:checked]:shadow-md">
                <input type="radio" 
                       name="tipo_seleccion" 
                       value="recurrente" 
                       checked
                       onchange="cambiarModoSeleccion('recurrente')"
                       class="w-4 h-4 text-purple-600 focus:ring-purple-500">
                <div class="ml-3 flex-1">
                    <p class="text-sm font-black text-purple-900">üîÑ Patr√≥n Recurrente</p>
                    <p class="text-xs text-purple-700 mt-1">Ej: Todos los Lunes, Mi√©rcoles y Viernes</p>
                </div>
            </label>
            
            <!-- OPCI√ìN 2: D√≠as Espec√≠ficos -->
            <label class="flex items-center p-3 bg-white border-2 border-blue-300 rounded-xl cursor-pointer hover:bg-blue-50 transition-all has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 has-[:checked]:shadow-md">
                <input type="radio" 
                       name="tipo_seleccion" 
                       value="especificos"
                       onchange="cambiarModoSeleccion('especificos')"
                       class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                <div class="ml-3 flex-1">
                    <p class="text-sm font-black text-blue-900">üìÖ D√≠as Espec√≠ficos</p>
                    <p class="text-xs text-blue-700 mt-1">Ej: D√≠as 5, 12, 19 y 26 del mes</p>
                </div>
            </label>
        </div>
    </div>

    <!-- ========================================
         PANEL D√çAS ESPEC√çFICOS (CARACTER√çSTICAS EN CASILLAS)
         ======================================== -->
    <div id="panel-especificos" class="mb-6 hidden">
        <div class="bg-blue-50 rounded-xl p-3 border-2 border-blue-200">
            <h3 class="text-xs font-black text-blue-900 mb-3 flex items-center gap-2">
                <span>üìÖ</span> Selecciona d√≠as y verifica disponibilidad
            </h3>
            
            <p class="text-xs text-blue-700 italic mb-3 text-center">
                üí° Selecciona los d√≠as - sus caracter√≠sticas aparecer√°n en cada casilla
            </p>
            
            <!-- Calendario con espacio para caracter√≠sticas -->
            <div class="grid grid-cols-7 gap-2">
                {% for _, dia_nombre in dias_semana %}
                <div class="text-center text-xs font-bold text-slate-500 py-1">
                    {{ dia_nombre }}
                </div>
                {% endfor %}
                
                {% for dia in dias_mes %}
                <div class="{% if dia.es_otro_mes %}opacity-30{% endif %}">
                    <label class="block relative cursor-pointer group {% if dia.es_otro_mes %}cursor-not-allowed{% endif %}">
                        <input type="checkbox" 
                            name="dias_especificos" 
                            value="{{ dia.fecha }}"
                            {% if dia.es_otro_mes %}disabled{% endif %}
                            onchange="toggleDiaEspecifico('{{ dia.fecha }}')"
                            id="dia-{{ dia.fecha }}"
                            class="sr-only peer">
                        
                        <div class="bg-white border-2 border-blue-200 rounded-lg transition-all
                                    peer-checked:bg-blue-600 peer-checked:border-blue-700
                                    hover:border-blue-400 peer-checked:shadow-md
                                    min-h-[3.5rem] flex flex-col items-center justify-center p-1 relative"
                                    id="casilla-{{ dia.fecha }}">
                            
                            <span class="text-sm font-bold text-slate-700 peer-checked:text-white">
                                {{ dia.numero }}
                            </span>
                            
                            <div id="indicadores-{{ dia.fecha }}" class="hidden mt-0.5 text-[10px] leading-none"></div>
                            
                            <div id="info-{{ dia.fecha }}" class="hidden peer-checked:block w-full mt-1 pt-1 border-t border-white/30 text-center">
                                <div class="text-[9px] text-white">
                                    <span class="loading-info">...</span>
                                </div>
                            </div>

                            <div id="tooltip-{{ dia.fecha }}" 
                                class="hidden group-hover:block absolute z-50 bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 
                                        bg-white border-2 border-slate-200 rounded-lg shadow-xl text-left pointer-events-none p-0 overflow-hidden">
                                </div>
                        </div>
                    </label>
                </div>
                {% endfor %}
            
            <!-- ‚úÖ NUEVO: Contenedor para resumen de validaci√≥n DENTRO del mismo recuadro -->
            <div id="validacion-especificos-container" class="mt-4"></div>
            </div>
        </div>
    </div>
    <!-- ========================================
         PANEL PATR√ìN RECURRENTE
         ======================================== -->
    <div id="panel-recurrente" class="mb-6">
        <div class="bg-purple-50 rounded-xl p-3 border-2 border-purple-200">
            <h3 class="text-xs font-black text-purple-900 mb-3 flex items-center gap-2">
                <span>üîÑ</span> Selecciona los d√≠as de la semana
            </h3>
            <div class="grid grid-cols-3 sm:grid-cols-7 gap-2">
                {% for dia_valor, dia_nombre in dias_semana %}
                <label class="flex flex-col items-center justify-center p-2.5 bg-white border-2 border-purple-200 rounded-lg cursor-pointer hover:border-purple-400 transition-all has-[:checked]:bg-purple-600 has-[:checked]:border-purple-700 has-[:checked]:text-white group">
                    <input type="checkbox" 
                           name="dias_semana_recurrente" 
                           value="{{ dia_valor }}"
                           onchange="validarAutomaticamente()"
                           class="sr-only peer">
                    <span class="text-xs font-black text-purple-700 group-has-[:checked]:text-white">
                        {{ dia_nombre }}
                    </span>
                </label>
                {% endfor %}
            </div>
            <p class="text-xs text-purple-700 mt-3 italic">
                üí° Las sesiones se crear√°n en TODOS estos d√≠as dentro del per√≠odo {{ mensualidad.periodo_display }}
            </p>
            
            <!-- ‚ú® NUEVA OPCI√ìN: Programar sesiones pasadas -->
            <div class="mt-3 bg-blue-50 border border-blue-200 rounded-lg p-3">
                <label class="flex items-start gap-2 cursor-pointer select-none group">
                    <input type="checkbox" 
                           id="incluir_sesiones_pasadas_modal" 
                           name="incluir_sesiones_pasadas" 
                           class="mt-0.5 rounded text-purple-600 focus:ring-purple-500 border-gray-300" 
                           onchange="validarAutomaticamente()">
                    <div class="flex-1">
                        <span class="text-xs font-semibold text-blue-900 group-hover:text-blue-700">üìÖ Programar sesiones pasadas</span>
                        <p class="text-xs text-blue-700 mt-1">Si est√° desmarcado, solo se mostrar√°n sesiones desde ma√±ana en adelante.</p>
                    </div>
                </label>
            </div>
            
            <!-- ‚úÖ NUEVO: Contenedor para validaci√≥n DENTRO del mismo recuadro -->
            <div id="validacion-recurrente-container" class="mt-4"></div>
        </div>
    </div>


    <!-- ========================================
         OBSERVACIONES
         ======================================== -->
    <div class="mb-6">
        <label class="block text-xs font-bold text-slate-700 mb-2 flex items-center gap-1">
            <span>üìù</span> Observaciones (opcional)
        </label>
        <textarea name="observaciones" 
                  rows="3"
                  class="w-full px-3 py-2.5 border-2 border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none resize-none"
                  placeholder="Notas adicionales sobre estas sesiones..."></textarea>
    </div>

    <!-- ========================================
         BOTONES DE ACCI√ìN
         ======================================== -->
    <div class="flex flex-wrap gap-2 pt-4 border-t-2 border-slate-200">
        
        <button type="button" 
                onclick="cerrarModalAgendarRapido()"
                class="bg-slate-300 hover:bg-slate-400 text-slate-700 font-black py-2 px-4 rounded-xl transition-all">
            Cancelar
        </button>
        
        <button type="submit" 
                class="flex-1 min-w-[140px] bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white font-black py-2 px-4 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
            <span>‚úÖ</span> Confirmar y Agendar
        </button>
    </div>
</form>

<!-- ========================================
     JAVASCRIPT DEL MODAL
     ======================================== -->
<script>
console.log('üöÄ Inicializando modal de agendamiento...');

// ========================================
// VARIABLES GLOBALES
// ‚úÖ CAMBIO: Usamos var o window para evitar errores al reabrir el modal
// ========================================
var FECHA_INICIO_PERIODO = '{{ fecha_inicio }}';
var FECHA_FIN_PERIODO = '{{ fecha_fin }}';
var NOMBRE_MES = '{{ mensualidad.periodo_display }}';

console.log('Fechas del per√≠odo:', FECHA_INICIO_PERIODO, 'a', FECHA_FIN_PERIODO);

// ========================================
// CAMBIAR MODO DE SELECCI√ìN
// ========================================
window.cambiarModoSeleccion = function(modo) {
    console.log('üîÑ Cambiando modo a:', modo);
    const panelRecurrente = document.getElementById('panel-recurrente');
    const panelEspecificos = document.getElementById('panel-especificos');
    const inputModo = document.getElementById('modo_seleccion');
    
    if (modo === 'recurrente') {
        panelRecurrente.classList.remove('hidden');
        panelEspecificos.classList.add('hidden');
        inputModo.value = 'recurrente';
        
        // Limpiar d√≠as espec√≠ficos
        document.querySelectorAll('input[name="dias_especificos"]').forEach(cb => {
            cb.checked = false;
        });
    } else {
        panelRecurrente.classList.add('hidden');
        panelEspecificos.classList.remove('hidden');
        inputModo.value = 'especificos';
        
        // Limpiar d√≠as recurrentes
        document.querySelectorAll('input[name="dias_semana_recurrente"]').forEach(cb => {
            cb.checked = false;
        });
    }
    
    // Revalidar autom√°ticamente al cambiar modo
    validarAutomaticamente();
}

// ========================================
// GENERAR FECHAS RECURRENTES
// ========================================
window.generarFechasRecurrentes = function(fechaInicio, fechaFin, diasSemana) {
    console.log('üîÑ Generando fechas recurrentes...');
    
    const fechas = [];
    // ‚úÖ FIX: Usar '/' reemplaza '-' para evitar problemas de zona horaria en algunos navegadores
    // O simplemente a√±adir T00:00:00 como estabas haciendo
    const inicio = new Date(fechaInicio + 'T00:00:00');
    const fin = new Date(fechaFin + 'T00:00:00');
    
    let fechaActual = new Date(inicio);
    let iteraciones = 0;
    const maxIteraciones = 100; // Aumentado un poco por si acaso
    
    while (fechaActual <= fin && iteraciones < maxIteraciones) {
        const diaSemana = fechaActual.getDay(); // 0=Domingo, 1=Lunes...
        
        if (diasSemana.includes(diaSemana)) {
            const year = fechaActual.getFullYear();
            const month = String(fechaActual.getMonth() + 1).padStart(2, '0');
            const day = String(fechaActual.getDate()).padStart(2, '0');
            const fechaStr = `${year}-${month}-${day}`;
            fechas.push(fechaStr);
        }
        
        fechaActual.setDate(fechaActual.getDate() + 1);
        iteraciones++;
    }
    
    console.log(`Total fechas generadas: ${fechas.length}`);
    return fechas;
}

// ========================================
// RENDERIZAR VISTA PREVIA
// ========================================

// ========================================
// CERRAR MODAL
// ========================================
// Asegurar que la funci√≥n global existe (aunque est√© en detalle_mensualidad)
if (!window.cerrarModalAgendarRapido) {
    window.cerrarModalAgendarRapido = function() {
        document.getElementById('modalAgendarRapido').classList.add('hidden');
    }
}

// ========================================
// VARIABLE GLOBAL PARA DEBOUNCE
// ========================================
let timeoutValidacion = null;

// ========================================
// TOGGLE D√çA ESPEC√çFICO (NUEVA FUNCI√ìN)
// ========================================
window.toggleDiaEspecifico = function(fecha) {
    const checkbox = document.getElementById('dia-' + fecha);
    const infoContainer = document.getElementById('info-' + fecha);
    
    if (!checkbox || !infoContainer) return;
    
    // Si el checkbox est√° marcado, cargar informaci√≥n
    if (checkbox.checked) {
        cargarInfoDia(fecha, infoContainer);
    } else {
        // Si se desmarca, limpiar
        infoContainer.innerHTML = '<div class="loading-info">‚è≥</div>';
    }
}

// ========================================
// CARGAR INFORMACI√ìN DE UN D√çA ESPEC√çFICO
// ========================================
// ========================================
// CARGAR INFORMACI√ìN DE UN D√çA ESPEC√çFICO (CORREGIDO)
// ========================================
function cargarInfoDia(fecha, container) {
    const horaInicio = document.getElementById('hora-inicio-modal');
    const duracion = document.getElementById('duracion-minutos-modal');
    
    // Elementos del DOM
    const indicadoresDiv = document.getElementById('indicadores-' + fecha);
    const tooltipDiv = document.getElementById('tooltip-' + fecha);
    const casillaDiv = document.getElementById('casilla-' + fecha);
    const checkbox = document.getElementById('dia-' + fecha);
    
    if (!horaInicio || !duracion || !horaInicio.value || !duracion.value) {
        if (container) container.innerHTML = '<span class="text-[8px] text-white/50">Falta hora</span>';
        return;
    }

    const horaInicioValue = horaInicio.value;
    const duracionValue = duracion.value;

    // Mostrar loading
    if (container) container.innerHTML = '<span class="animate-pulse">‚è≥</span>';

    // Construir par√°metros
    const params = new URLSearchParams();
    params.append('servicio_profesional_id', SERVICIO_PROFESIONAL_ID);
    params.append('hora', horaInicioValue);
    params.append('duracion', duracionValue);
    params.append('modo_seleccion', 'especificos');
    params.append('dias_especificos', fecha);
    params.append('solo_dia', 'true'); // Flag importante para tu backend

    // Petici√≥n AJAX
    const url = '{% url "agenda:vista_previa_mensualidad" %}?' + params.toString();

    fetch(url, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        // 1. MANEJO DE CONFLICTOS
        if (data.tiene_conflicto) {
            
            // A) Actualizar Casilla (Color Rojo)
            if (checkbox && checkbox.checked && casillaDiv) {
                casillaDiv.classList.remove('peer-checked:bg-blue-600', 'peer-checked:border-blue-700');
                casillaDiv.classList.add('!bg-red-100', '!border-red-300');
            }
            
            // B) Texto interno (Info)
            if (container) {
                container.innerHTML = '<span class="font-bold text-red-200">üö´ Ocupado</span>';
            }

            // C) Indicadores (Iconos bajo el n√∫mero)
            if (indicadoresDiv) {
                let iconos = '<span class="text-red-500 font-bold text-xs">‚óè</span>'; 
                if (data.tiene_conflicto_paciente) iconos += 'üë§';
                if (data.tiene_conflicto_profesional) iconos += 'üë®‚Äç‚öïÔ∏è';
                indicadoresDiv.innerHTML = iconos;
                indicadoresDiv.classList.remove('hidden');
            }

            // D) CONSTRUIR EL TOOLTIP (HTML RICO)
            if (tooltipDiv) {
                let html = `
                    <div class="bg-red-50 border-b border-red-100 p-2">
                        <p class="text-xs font-black text-red-800 flex items-center gap-1">
                            üö´ CONFLICTO DETECTADO
                        </p>
                    </div>
                    <div class="p-2 space-y-2">
                `;

                // Conflictos Paciente
                if (data.conflictos_paciente && data.conflictos_paciente.length > 0) {
                    html += `
                        <div>
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">üë§ Paciente Ocupado:</p>
                            ${data.conflictos_paciente.map(c => `
                                <div class="bg-white border border-red-200 rounded p-1.5 shadow-sm text-[10px] mb-1">
                                    <p class="font-bold text-red-700 truncate">${c.servicio}</p>
                                    <p class="text-slate-500">${c.hora_inicio} - ${c.hora_fin}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Conflictos Profesional
                if (data.conflictos_profesional && data.conflictos_profesional.length > 0) {
                    html += `
                        <div>
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">üë®‚Äç‚öïÔ∏è Prof. Ocupado:</p>
                            ${data.conflictos_profesional.map(c => `
                                <div class="bg-white border border-orange-200 rounded p-1.5 shadow-sm text-[10px] mb-1">
                                    <p class="font-bold text-orange-700 truncate">${c.paciente}</p>
                                    <p class="text-slate-500">${c.hora_inicio} - ${c.hora_fin}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html += '</div>'; // Cerrar p-2
                // Triangulito del tooltip
                html += '<div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-transparent border-t-slate-200"></div>';
                
                tooltipDiv.innerHTML = html;
            }

        } else {
            // 2. DISPONIBLE (SIN CONFLICTOS)
            
            // Restaurar colores azules
            if (casillaDiv) {
                casillaDiv.classList.remove('!bg-red-100', '!border-red-300');
                casillaDiv.classList.add('peer-checked:bg-blue-600', 'peer-checked:border-blue-700');
            }

            if (container) {
                container.innerHTML = '<span class="font-bold text-green-600">‚úÖ Libre</span>';
            }

            if (indicadoresDiv) {
                indicadoresDiv.innerHTML = '<span class="text-green-500 text-xs">‚úî</span>';
                indicadoresDiv.classList.remove('hidden');
            }

            // Tooltip simple de disponible
            if (tooltipDiv) {
                tooltipDiv.innerHTML = `
                    <div class="bg-green-50 p-2 text-center border-green-100">
                        <p class="text-xs font-bold text-green-700">‚úÖ Horario Disponible</p>
                        <p class="text-[10px] text-green-600">${horaInicioValue} - ${calculaHoraFin(horaInicioValue, duracionValue)}</p>
                    </div>
                     <div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-transparent border-t-green-200"></div>
                `;
            }
        }
    })
    .catch(error => {
        console.error('Error al validar d√≠a:', error);
        if (container) container.innerHTML = '‚ùå';
    });
}

// Funci√≥n auxiliar simple para calcular hora fin visualmente
function calculaHoraFin(inicio, duracionMin) {
    if(!inicio) return '';
    let [h, m] = inicio.split(':').map(Number);
    let date = new Date();
    date.setHours(h, m + parseInt(duracionMin));
    return date.toTimeString().slice(0,5);
}
// ========================================
// VALIDACI√ìN AUTOM√ÅTICA (con debounce)
// ========================================
window.validarAutomaticamente = function() {
    // Cancelar timeout anterior si existe
    if (timeoutValidacion) {
        clearTimeout(timeoutValidacion);
    }
    
    // Esperar 500ms antes de validar (evita validar en cada tecla/click)
    timeoutValidacion = setTimeout(() => {
        const modo = document.getElementById('modo_seleccion');
        
        if (modo && modo.value === 'especificos') {
            // En modo espec√≠fico, validar TODOS los d√≠as del mes para mostrar indicadores
            validarTodosDiasMes();
        } else {
            // En modo recurrente, usar la vista previa tradicional
            generarVistaPreviaModal();
        }
    }, 500);
}

// ========================================
// ACTUALIZAR D√çAS ESPEC√çFICOS SELECCIONADOS
// ========================================
function actualizarDiasEspecificos() {
    const checkboxes = document.querySelectorAll('input[name="dias_especificos"]:checked');
    
    checkboxes.forEach(checkbox => {
        const fecha = checkbox.value;
        const infoContainer = document.getElementById('info-' + fecha);
        if (infoContainer) {
            cargarInfoDia(fecha, infoContainer);
        }
    });
}

// ========================================
// VALIDAR TODOS LOS D√çAS DEL MES (para mostrar indicadores)
// ========================================
function validarTodosDiasMes() {
    const horaInicio = document.getElementById('hora-inicio-modal');
    if (!horaInicio || !horaInicio.value) return;
    
    // OPCI√ìN A (Recomendada): Validar SOLO los seleccionados para no bloquear el navegador
    const checkedCheckboxes = document.querySelectorAll('input[name="dias_especificos"]:checked');
    checkedCheckboxes.forEach(checkbox => {
        cargarInfoDia(checkbox.value, document.getElementById('info-' + checkbox.value));
    });

    // OPCI√ìN B: Si realmente quieres validar TODOS (incluso no seleccionados),
    // hazlo con un peque√±o retraso entre cada uno para no saturar.
    /*
    const allCheckboxes = document.querySelectorAll('input[name="dias_especificos"]:not([disabled])');
    allCheckboxes.forEach((checkbox, index) => {
        setTimeout(() => {
             cargarInfoDia(checkbox.value, document.getElementById('info-' + checkbox.value));
        }, index * 50); // 50ms de diferencia entre cada petici√≥n
    });
    */
}

// ========================================
// GENERAR VISTA PREVIA (llamada por validarAutomaticamente)
// ========================================
window.generarVistaPreviaModal = function() {
    console.log('üîç Validando disponibilidad autom√°ticamente...');
    
    const horaInicio = document.getElementById('hora-inicio-modal');
    const modo = document.getElementById('modo_seleccion');
    
    if (!horaInicio || !modo) {
        return; // Salir silenciosamente si faltan elementos
    }
    
    const horaInicioValue = horaInicio.value;
    
    // ‚úÖ Obtener duraci√≥n efectiva (est√°ndar o personalizada)
    const duracionValue = obtenerDuracionEfectivaModal();
    const modoValue = modo.value;
    
    // Determinar el contenedor correcto seg√∫n el modo
    const containerRecurrente = document.getElementById('validacion-recurrente-container');
    const containerEspecificos = document.getElementById('validacion-especificos-container');
    
    // Limpiar TODOS los contenedores primero
    if (containerRecurrente) containerRecurrente.innerHTML = '';
    if (containerEspecificos) containerEspecificos.innerHTML = '';
    
    // Seleccionar el contenedor apropiado
    const container = modoValue === 'recurrente' ? containerRecurrente : containerEspecificos;
    
    if (!container) return;
    
    // Si no hay hora o duraci√≥n, limpiar vista previa
    if (!horaInicioValue || !duracionValue || duracionValue < 15) {
        container.innerHTML = '';
        return;
    }
    
    // Validar que hay d√≠as seleccionados
    let hasDiasSeleccionados = false;
    
    if (modoValue === 'recurrente') {
        const checkboxes = document.querySelectorAll('input[name="dias_semana_recurrente"]:checked');
        hasDiasSeleccionados = checkboxes.length > 0;
    } else {
        const checkboxes = document.querySelectorAll('input[name="dias_especificos"]:checked');
        hasDiasSeleccionados = checkboxes.length > 0;
    }
    
    // Si no hay d√≠as seleccionados, mostrar mensaje informativo
    if (!hasDiasSeleccionados) {
        container.innerHTML = `
            <div class="bg-white border-2 border-dashed ${modoValue === 'recurrente' ? 'border-purple-300' : 'border-blue-300'} rounded-lg p-2.5 text-center">
                <div class="text-2xl mb-1">üìÖ</div>
                <p class="${modoValue === 'recurrente' ? 'text-purple-700' : 'text-blue-700'} font-bold text-xs">Selecciona d√≠as para ver disponibilidad</p>
                <p class="${modoValue === 'recurrente' ? 'text-purple-600' : 'text-blue-600'} text-[10px] mt-1">Los conflictos se mostrar√°n en rojo üö´</p>
            </div>
        `;
        return;
    }
    
    // Construir par√°metros para la petici√≥n
    const params = new URLSearchParams();
    params.append('servicio_profesional_id', SERVICIO_PROFESIONAL_ID);
    params.append('hora', horaInicioValue);
    params.append('duracion', duracionValue);
    params.append('modo_seleccion', modoValue);
    
    if (modoValue === 'recurrente') {
        const checkboxes = document.querySelectorAll('input[name="dias_semana_recurrente"]:checked');
        checkboxes.forEach(cb => params.append('dias_semana', cb.value));
        
        // ‚ú® NUEVO: Verificar si se deben incluir sesiones pasadas
        const incluirPasadas = document.getElementById('incluir_sesiones_pasadas_modal')?.checked || false;
        params.append('incluir_pasadas', incluirPasadas ? 'true' : 'false');
    } else {
        const checkboxes = document.querySelectorAll('input[name="dias_especificos"]:checked');
        checkboxes.forEach(cb => params.append('dias_especificos', cb.value));
    }
    
    // Mostrar indicador de carga (m√°s compacto)
    container.innerHTML = `
        <div class="bg-white border-2 ${modoValue === 'recurrente' ? 'border-purple-300' : 'border-blue-300'} rounded-lg p-2.5 text-center">
            <div class="animate-pulse flex items-center justify-center gap-2">
                <span class="text-xl">‚è≥</span>
                <span class="${modoValue === 'recurrente' ? 'text-purple-700' : 'text-blue-700'} font-bold text-xs">Validando...</span>
            </div>
        </div>
    `;
    
    // Hacer la petici√≥n AJAX
    const url = '{% url "agenda:vista_previa_mensualidad" %}?' + params.toString();
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) throw new Error('Error en la respuesta');
        return response.text();
    })
    .then(html => {
        container.innerHTML = html;
        // Actualizar contador de sesiones seleccionadas
        setTimeout(() => {
            if (typeof actualizarContadorMensualidad === 'function') {
                actualizarContadorMensualidad();
            }
        }, 100);
    })
    .catch(error => {
        console.error('Error:', error);
        container.innerHTML = `
            <div class="bg-red-50 border-2 border-red-300 rounded-lg p-2.5 text-center">
                <p class="text-red-700 font-bold text-xs">‚ùå Error al validar</p>
                <p class="text-red-600 text-[10px] mt-1">Intenta nuevamente</p>
            </div>
        `;
    });
}

// ========================================
// FUNCI√ìN PARA TOGGLE DE CONFLICTOS
// ========================================
window.toggleConflictoModal = function(panelId, btn) {
    const panel = document.getElementById(panelId);
    if (panel) {
        if (panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'block';
            btn.innerHTML = '‚ñ≤ Ocultar';
        } else {
            panel.style.display = 'none';
            btn.innerHTML = '‚ñº Detalle';
        }
    }
};

// ========================================
// ACTUALIZAR CONTADOR DE SESIONES SELECCIONADAS
// ========================================
window.actualizarContadorMensualidad = function() {
    const checkboxes = document.querySelectorAll('.sesion-checkbox-mensualidad:checked');
    const contadorElement = document.getElementById('contador-seleccionadas-mensualidad');
    if (contadorElement) {
        contadorElement.textContent = checkboxes.length;
    }
};

// ========================================
// TOGGLE DURACI√ìN PERSONALIZADA
// ========================================
window.toggleDuracionPersonalizadaModal = function() {
    const checkbox = document.getElementById('usar-duracion-estandar-modal');
    const container = document.getElementById('duracion-personalizada-container-modal');
    const inputPersonalizado = document.getElementById('duracion-personalizada-modal');
    const inputHidden = document.getElementById('duracion-minutos-modal');
    
    // Obtener la duraci√≥n est√°ndar del servicio
    const duracionEstandar = document.getElementById('duracion-servicio-info-modal').textContent.trim().replace(' min', '');
    
    if (checkbox.checked) {
        // Usar duraci√≥n est√°ndar del servicio
        container.classList.add('hidden');
        inputPersonalizado.value = '';
        inputHidden.value = duracionEstandar;
        console.log('‚úÖ Usando duraci√≥n est√°ndar:', duracionEstandar);
    } else {
        // Usar duraci√≥n personalizada
        container.classList.remove('hidden');
        // Pre-llenar con la duraci√≥n est√°ndar como punto de partida si est√° vac√≠o
        if (!inputPersonalizado.value) {
            inputPersonalizado.value = duracionEstandar;
        }
        inputHidden.value = inputPersonalizado.value;
        inputPersonalizado.focus();
        console.log('‚úÖ Usando duraci√≥n personalizada:', inputPersonalizado.value);
    }
    
    validarAutomaticamente();
};

// ========================================
// OBTENER DURACI√ìN EFECTIVA
// ========================================
window.obtenerDuracionEfectivaModal = function() {
    const usarEstandar = document.getElementById('usar-duracion-estandar-modal').checked;
    
    if (usarEstandar) {
        const duracionEstandar = document.getElementById('duracion-servicio-info-modal').textContent.trim().replace(' min', '');
        return parseInt(duracionEstandar) || 45;
    } else {
        const duracionPersonalizada = document.getElementById('duracion-personalizada-modal').value;
        return parseInt(duracionPersonalizada) || 45;
    }
};

// ========================================
// ACTUALIZAR INPUT HIDDEN DE DURACI√ìN
// ========================================
window.actualizarDuracionHidden = function() {
    const inputPersonalizado = document.getElementById('duracion-personalizada-modal');
    const inputHidden = document.getElementById('duracion-minutos-modal');
    
    if (inputPersonalizado && inputHidden) {
        inputHidden.value = inputPersonalizado.value;
        console.log('‚úÖ Duraci√≥n actualizada a:', inputPersonalizado.value);
    }
};

// ========================================
// DEFINIR CONSTANTE GLOBAL
// ========================================
const SERVICIO_PROFESIONAL_ID = {{ servicio_profesional.id }};

// ========================================
// EJECUTAR VALIDACI√ìN AL CARGAR (si ya hay datos)
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    // Esperar un momento para que el DOM est√© completamente listo
    setTimeout(() => {
        validarAutomaticamente();
    }, 100);
});

console.log('‚úÖ Funciones de modal cargadas (validaci√≥n autom√°tica activada)');
</script>