<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Recibo {{ pago.numero_recibo }}</title>
    <style>
        @page {
            size: letter landscape;
            margin: 0.3cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ============================================
           VARIABLES DE TAMA√ëO - AJUSTAR AQU√ç
           ============================================ */
        
        /* Tama√±o de fuente general del documento */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10px;           /* üëà AJUSTAR: Tama√±o base de texto (8-12px) */
            line-height: 1.3;          /* üëà AJUSTAR: Espaciado entre l√≠neas (1.2-1.5) */
            color: #2c3e50;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
     
        /* Altura total del recibo */
        .contenedor-recibos {
            display: table;
            width: 100%;
            height: 20.6cm;            /* üëà AJUSTAR: Altura total (19-21.5cm) */
        }
        
        /* ============================================
           MODO COMPACTO (para contenido extenso)
           Se activa autom√°ticamente con observaciones largas o pagos masivos
           ============================================ */
        
        /* Cuando hay m√°s de 5 items en pago masivo O observaciones largas */
        body.modo-compacto {
            font-size: 9px;            /* Reducir tama√±o base */
            line-height: 1.2;
        }
        
        .modo-compacto .contenedor-recibos {
            height: 20cm;              /* Reducir altura total */
        }
        
        .modo-compacto .tabla-sesiones {
            font-size: 8px;            /* Tablas m√°s peque√±as */
        }
        
        .modo-compacto .tabla-sesiones th,
        .modo-compacto .tabla-sesiones td {
            padding: 4px;              /* Menos padding */
            font-size: 8px;
        }
        
        .modo-compacto .firma-titulo {
            margin-bottom: 25px;       /* Menos espacio para firmas */
        }
        
        .modo-compacto .section {
            margin-bottom: 8px;        /* Menos espacio entre secciones */
        }
        
        .modo-compacto .header {
            margin-bottom: 10px;       /* Header m√°s compacto */
        }
        
        .modo-compacto .monto-total {
            padding: 8px;              /* Monto total m√°s peque√±o */
            margin: 8px 0;
        }
        
        .modo-compacto .monto-total .valor {
            font-size: 18px;           /* Valor m√°s peque√±o */
        }
        
        .modo-compacto table td {
            padding: 5px 8px;          /* Menos padding en tablas */
        }
        
        /* Limitar observaciones a 3 l√≠neas */
        .observaciones-text {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 4.5em;         /* 3 l√≠neas aproximadamente */
        }
        
        .recibo-copia {
            display: table-cell;
            width: 49%;
            padding: 0.6cm;
            vertical-align: top;
            border: 3px solid #1e88e5;
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 50%, #fff9e6 100%);
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            box-shadow: inset 0 0 20px rgba(30, 136, 229, 0.1);
        }
        
        .recibo-copia.izquierda {
            border-right: 2px dashed #666;
        }
        
        .linea-divisoria {
            display: table-cell;
            width: 2%;
            text-align: center;
            background: linear-gradient(to bottom, #FFD700 0%, #1e88e5 50%, #E63946 100%);
            position: relative;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .linea-divisoria::before {
            content: "‚úÇ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        .etiqueta-copia {
            position: absolute;
            top: 0.5cm;
            right: 0.5cm;
            background: linear-gradient(135deg, #E63946 0%, #c62828 100%);
            padding: 6px 16px;
            border: 3px solid #FFD700;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 1px;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .etiqueta-copia.sucursal {
            background: linear-gradient(135deg, #FFD700 0%, #f9a825 100%);
            border-color: #1e88e5;
            color: #0d47a1;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .header {
            text-align: center;
            margin-bottom: 14px;
            border-bottom: 4px solid transparent;
            border-image: linear-gradient(to right, #E63946, #FFD700, #1e88e5) 1;
            padding-bottom: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 30%, #fff5e1 70%, #ffffff 100%);
            padding-top: 12px;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .header .logo {
            max-width: 150px;
            max-height: 80px;
            margin-bottom: 8px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header h1 {
            font-size: 20px;
            background: linear-gradient(135deg, #E63946 0%, #1e88e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .header p {
            font-size: 11px;
            color: #1565c0;
            font-weight: 600;
        }
        
        .recibo-numero {
            text-align: right;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 12px;
            color: white;
            background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
            padding: 7px 16px;
            display: inline-block;
            float: right;
            border-radius: 15px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            letter-spacing: 1px;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .clear {
            clear: both;
        }
        
        .section {
            margin-bottom: 12px;
            clear: both;
        }
        
        .section-title {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 6px;
            color: white;
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            padding: 6px 12px;
            border-radius: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 10px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table td {
            padding: 7px 10px;
            border: 1px solid #90caf9;
        }
        
        table td:first-child {
            width: 40%;
            font-weight: 600;
            color: #1565c0;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        table td:last-child {
            width: 60%;
            color: #2c3e50;
            background-color: white;
        }
        
        .tabla-sesiones {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 10px;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .tabla-sesiones thead {
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            color: white;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .tabla-sesiones th {
            padding: 7px;
            text-align: left;
            font-size: 10px;
            border: 1px solid #64b5f6;
            font-weight: 600;
        }
        
        .tabla-sesiones td {
            padding: 6px;
            border: 1px solid #e3f2fd;
            font-size: 10px;
        }
        
        .tabla-sesiones tbody tr:nth-child(even) {
            background: #f5f5f5;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .tabla-sesiones tfoot {
            background: linear-gradient(135deg, #FFD700 0%, #fff9c4 100%);
            font-weight: bold;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .tabla-sesiones tfoot td {
            padding: 7px;
            font-size: 11px;
            color: #d32f2f;
        }
        
        .tipo-item {
            font-size: 8px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            font-weight: 600;
        }
        
        .tipo-sesion {
            background: #e3f2fd;
            color: #1565c0;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .tipo-proyecto {
            background: #f3e5f5;
            color: #6a1b9a;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .monto-total {
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
            border: 3px solid #E63946;
            padding: 10px;
            margin: 12px 0;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .monto-total .label {
            font-size: 10px;
            color: #c62828;
            margin-bottom: 3px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .monto-total .valor {
            font-size: 22px;
            font-weight: bold;
            color: #b71c1c;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Contenedor de firmas */
        .firmas-container {
            margin-top: 16px;          /* üëà AJUSTAR: Espacio antes de firmas (10-25px) */
            display: table;
            width: 100%;
            margin-bottom: 12px;       /* üëà AJUSTAR: Espacio despu√©s de firmas (8-20px) */
        }
        
        .firma-bloque {
            display: table-cell;
            width: 48%;
            text-align: center;
            vertical-align: bottom;
        }
        
        .firma-bloque.izquierda {
            padding-right: 2%;
        }
        
        .firma-bloque.derecha {
            padding-left: 2%;
        }
        
        /* Espacio para firmas */
        .firma-titulo {
            font-size: 10px;
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 35px;       /* üëà AJUSTAR: Espacio hasta l√≠nea de firma (25-50px) */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .firma-linea {
            border-top: 2px solid #1e88e5;
            padding-top: 6px;
            margin: 0 15px;
        }
        
        .firma-cargo {
            font-size: 9px;
            color: #546e7a;
            font-weight: 600;
        }
        
        /* Footer (informaci√≥n final) */
        .footer {
            margin-top: 12px;          /* üëà AJUSTAR: Espacio antes del footer (8-20px) */
            padding: 10px;             /* üëà AJUSTAR: Padding interno del footer (8-15px) */
            text-align: center;
            font-size: 9px;            /* üëà AJUSTAR: Tama√±o de texto del footer (8-11px) */
            color: white;
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            border-radius: 5px;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .footer .direccion {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 10px;
        }
        
        .footer .comprobante {
            font-size: 8px;
            opacity: 0.9;
        }
        
        .recibo-copia::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(to right, #E63946, #FFD700, #1e88e5);
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .recibo-copia::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(to right, #1e88e5, #FFD700, #E63946);
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .contenedor-recibos {
                page-break-inside: avoid;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
    </style>
</head>
<body{% if es_pago_masivo and pagos_relacionados|length > 5 %} class="modo-compacto"{% elif pago.observaciones|length > 100 %} class="modo-compacto"{% endif %}>
    <div class="contenedor-recibos">
        <!-- COPIA 1: CLIENTE -->
        <div class="recibo-copia izquierda">
            <div class="etiqueta-copia cliente">COPIA CLIENTE</div>
            
            <div class="header">
                {% if logo_base64 %}
                <img src="data:image/png;base64,{{ logo_base64 }}" class="logo" alt="Logo">
                {% endif %}
                <h1>Recibo de Pago</h1>
                <p>Centro de Neurodesarrollo Infantil Misael</p>
            </div>
            
            <div class="recibo-numero">
                N¬∞ {{ pago.numero_recibo }}
            </div>
            <div class="clear"></div>
            
            <div class="section">
                <div class="section-title">Datos del Paciente</div>
                <table>
                    <tr>
                        <td>Paciente:</td>
                        <td>{{ pago.paciente.nombre_completo }}</td>
                    </tr>
                    <tr>
                        <td>Tutor/Responsable:</td>
                        <td>{{ pago.paciente.nombre_tutor|default:"N/A" }}</td>
                    </tr>
                    <tr>
                        <td>Tel√©fono:</td>
                        <td>{{ pago.paciente.telefono_tutor|default:"N/A" }}</td>
                    </tr>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">Datos del Pago</div>
                <table>
                    <tr>
                        <td>Fecha de Pago:</td>
                        <td>{{ pago.fecha_pago|date:"d/m/Y" }}</td>
                    </tr>
                    <tr>
                        <td>M√©todo de Pago:</td>
                        <td>{{ pago.metodo_pago.nombre }}</td>
                    </tr>
                    {% if pago.numero_transaccion %}
                    <tr>
                        <td>N¬∞ Transacci√≥n:</td>
                        <td>{{ pago.numero_transaccion }}</td>
                    </tr>
                    {% endif %}
                    {% if pago.observaciones %}
                    <tr>
                        <td>Observaciones:</td>
                        <td><div class="observaciones-text">{{ pago.observaciones }}</div></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            
            {% if es_pago_masivo %}
            <div class="section">
                <div class="section-title">Detalle de Items Pagados</div>
                <table class="tabla-sesiones">
                    <thead>
                        <tr>
                            <th>Fecha/C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Tipo</th>
                            <th style="text-align: right;">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago_rel in pagos_relacionados %}
                        <tr>
                            {% if pago_rel.sesion %}
                                <td>{{ pago_rel.sesion.fecha|date:"d/m/Y" }}</td>
                                <td>{{ pago_rel.sesion.servicio.nombre }}</td>
                                <td><span class="tipo-item tipo-sesion">Sesi√≥n</span></td>
                                <td style="text-align: right;">Bs. {{ pago_rel.monto|floatformat:2 }}</td>
                            {% elif pago_rel.proyecto %}
                                <td style="color: #6a1b9a; font-weight: bold;">{{ pago_rel.proyecto.codigo }}</td>
                                <td>{{ pago_rel.proyecto.nombre }}</td>
                                <td><span class="tipo-item tipo-proyecto">Proyecto</span></td>
                                <td style="text-align: right;">Bs. {{ pago_rel.monto|floatformat:2 }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right;">TOTAL:</td>
                            <td style="text-align: right;">Bs. {{ total_recibo|floatformat:2 }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="section">
                <table>
                    <tr>
                        <td>Concepto:</td>
                        <td>{{ pago.concepto }}</td>
                    </tr>
                </table>
            </div>
            {% endif %}
            
            <div class="monto-total">
                <div class="label">Monto Total Pagado</div>
                <div class="valor">Bs. {{ total_recibo|floatformat:2 }}</div>
            </div>
            
            <div class="firmas-container">
                <div class="firma-bloque izquierda">
                    <div class="firma-titulo">RECIB√ç CONFORME</div>
                    <div class="firma-linea">
                        <div class="firma-cargo">Responsable</div>
                    </div>
                </div>
                
                <div class="firma-bloque derecha">
                    <div class="firma-titulo">PAGU√â CONFORME</div>
                    <div class="firma-linea">
                        <div class="firma-cargo">Tutor/Responsable</div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <div class="direccion">Direcci√≥n Central: Calle Jap√≥n #28 - Tel√©fono: 76175352 - Potos√≠ - Bolivia</div>
                <div class="comprobante">Generado el {{ pago.fecha_registro|date:"d/m/Y H:i" }} - Comprobante v√°lido de pago</div>
            </div>
        </div>
        
        <div class="linea-divisoria"></div>
        
        <!-- COPIA 2: ADMINISTRACI√ìN -->
        <div class="recibo-copia">
            <div class="etiqueta-copia sucursal">COPIA ADMINISTRACI√ìN</div>
            
            <div class="header">
                {% if logo_base64 %}
                <img src="data:image/png;base64,{{ logo_base64 }}" class="logo" alt="Logo">
                {% endif %}
                <h1>Recibo de Pago</h1>
                <p>Centro de Neurodesarrollo Infantil Misael</p>
            </div>
            
            <div class="recibo-numero">
                N¬∞ {{ pago.numero_recibo }}
            </div>
            <div class="clear"></div>
            
            <div class="section">
                <div class="section-title">Datos del Paciente</div>
                <table>
                    <tr>
                        <td>Paciente:</td>
                        <td>{{ pago.paciente.nombre_completo }}</td>
                    </tr>
                    <tr>
                        <td>Tutor/Responsable:</td>
                        <td>{{ pago.paciente.nombre_tutor|default:"N/A" }}</td>
                    </tr>
                    <tr>
                        <td>Tel√©fono:</td>
                        <td>{{ pago.paciente.telefono_tutor|default:"N/A" }}</td>
                    </tr>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">Datos del Pago</div>
                <table>
                    <tr>
                        <td>Fecha de Pago:</td>
                        <td>{{ pago.fecha_pago|date:"d/m/Y" }}</td>
                    </tr>
                    <tr>
                        <td>M√©todo de Pago:</td>
                        <td>{{ pago.metodo_pago.nombre }}</td>
                    </tr>
                    {% if pago.numero_transaccion %}
                    <tr>
                        <td>N¬∞ Transacci√≥n:</td>
                        <td>{{ pago.numero_transaccion }}</td>
                    </tr>
                    {% endif %}
                    {% if pago.observaciones %}
                    <tr>
                        <td>Observaciones:</td>
                        <td><div class="observaciones-text">{{ pago.observaciones }}</div></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            
            {% if es_pago_masivo %}
            <div class="section">
                <div class="section-title">Detalle de Items Pagados</div>
                <table class="tabla-sesiones">
                    <thead>
                        <tr>
                            <th>Fecha/C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Tipo</th>
                            <th style="text-align: right;">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago_rel in pagos_relacionados %}
                        <tr>
                            {% if pago_rel.sesion %}
                                <td>{{ pago_rel.sesion.fecha|date:"d/m/Y" }}</td>
                                <td>{{ pago_rel.sesion.servicio.nombre }}</td>
                                <td><span class="tipo-item tipo-sesion">Sesi√≥n</span></td>
                                <td style="text-align: right;">Bs. {{ pago_rel.monto|floatformat:2 }}</td>
                            {% elif pago_rel.proyecto %}
                                <td style="color: #6a1b9a; font-weight: bold;">{{ pago_rel.proyecto.codigo }}</td>
                                <td>{{ pago_rel.proyecto.nombre }}</td>
                                <td><span class="tipo-item tipo-proyecto">Proyecto</span></td>
                                <td style="text-align: right;">Bs. {{ pago_rel.monto|floatformat:2 }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right;">TOTAL:</td>
                            <td style="text-align: right;">Bs. {{ total_recibo|floatformat:2 }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="section">
                <table>
                    <tr>
                        <td>Concepto:</td>
                        <td>{{ pago.concepto }}</td>
                    </tr>
                </table>
            </div>
            {% endif %}
            
            <div class="monto-total">
                <div class="label">Monto Total Pagado</div>
                <div class="valor">Bs. {{ total_recibo|floatformat:2 }}</div>
            </div>
            
            <div class="firmas-container">
                <div class="firma-bloque izquierda">
                    <div class="firma-titulo">RECIB√ç CONFORME</div>
                    <div class="firma-linea">
                        <div class="firma-cargo">Responsable</div>
                    </div>
                </div>
                
                <div class="firma-bloque derecha">
                    <div class="firma-titulo">PAGU√â CONFORME</div>
                    <div class="firma-linea">
                        <div class="firma-cargo">Tutor/Responsable</div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <div class="direccion">Direcci√≥n Central: Calle Jap√≥n #28 - Tel√©fono: 76175352 - Potos√≠ - Bolivia</div>
                <div class="comprobante">Generado el {{ pago.fecha_registro|date:"d/m/Y H:i" }} - Comprobante v√°lido de pago</div>
            </div>
        </div>
    </div>
</body>
</html>