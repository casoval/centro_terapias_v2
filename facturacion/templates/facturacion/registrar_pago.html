{% extends 'base.html' %}
{% load static %}

{% block title %}üíµ Registrar Pago{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-indigo-600 rounded-xl text-white shadow-lg shadow-indigo-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Registrar Pago</h1>
                <p class="text-sm text-gray-500 font-medium">
                    {% if sesion %}Sesi√≥n <span class="text-indigo-600">#{{ sesion.id }}</span> &bull; {{ sesion.fecha|date:"d M Y" }}
                    {% elif proyecto %}Proyecto <span class="text-purple-600">{{ proyecto.codigo }}</span>
                    {% elif mensualidad %}Mensualidad <span class="text-blue-600">{{ mensualidad.codigo }}</span> &bull; {{ mensualidad.periodo_display }}
                    {% elif modo == 'adelantado' %}Dep√≥sito a Billetera/Credito (Adelantado)
                    {% else %}Nueva Transacci√≥n{% endif %}
                </p>
            </div>
        </div>
        <a href="javascript:history.back()" class="px-4 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition shadow-sm">
            Esc Cancelar
        </a>
    </div>

    <form method="post" id="form-pago">
        {% csrf_token %}
        
        {% if sesion %}<input type="hidden" name="tipo_pago" value="sesion"><input type="hidden" name="sesion_id" value="{{ sesion.id }}">
        {% elif proyecto %}<input type="hidden" name="tipo_pago" value="proyecto"><input type="hidden" name="proyecto_id" value="{{ proyecto.id }}">
        {% elif mensualidad %}<input type="hidden" name="tipo_pago" value="mensualidad"><input type="hidden" name="mensualidad_id" value="{{ mensualidad.id }}">
        {% elif paciente %}<input type="hidden" name="tipo_pago" value="adelantado"><input type="hidden" name="paciente_adelantado" value="{{ paciente.id }}">
        {% endif %}

        {% if not paciente %}
        <div class="max-w-lg mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 p-8 mt-10">
            <div class="text-center mb-6">
                <div class="inline-flex p-3 bg-blue-50 rounded-full text-blue-600 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Buscar Paciente</h3>
                <p class="text-sm text-gray-500">Selecciona a qui√©n se le realizar√° el cobro</p>
            </div>
            
            <select name="paciente_id" id="paciente_select" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-base focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" onchange="cargarOpcionesPaciente()">
                <option value="">-- Seleccionar de la lista --</option>
                {% for pac in pacientes_lista %}
                <option value="{{ pac.id }}">{{ pac.nombre }} {{ pac.apellido }}</option>
                {% endfor %}
            </select>
            
            <div id="opciones-tipo-pago" class="hidden mt-6 space-y-4 animate-fade-in-down">
                <!-- Proyectos -->
                <div class="p-4 bg-purple-50 rounded-xl border border-purple-100 transition hover:border-purple-300 cursor-pointer">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="es_proyecto_checkbox" class="w-5 h-5 rounded text-purple-600 focus:ring-purple-500" onchange="toggleSelectorTipo('proyecto')">
                        <span class="font-semibold text-purple-800">üì¶ Es pago de un Proyecto/Evaluaci√≥n</span>
                    </label>
                    <div id="selector-proyectos" class="hidden mt-3 pl-8">
                        <select id="proyecto_select" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-white"></select>
                        <button type="button" onclick="irAProyecto()" class="mt-2 w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm font-medium transition shadow-sm">Continuar con Proyecto/Evaluaci√≥n</button>
                    </div>
                </div>

                <!-- ‚úÖ NUEVO: Mensualidades -->
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 transition hover:border-blue-300 cursor-pointer">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="es_mensualidad_checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="toggleSelectorTipo('mensualidad')">
                        <span class="font-semibold text-blue-800">üìÖ Es pago de Mensualidad</span>
                    </label>
                    <div id="selector-mensualidades" class="hidden mt-3 pl-8">
                        <select id="mensualidad_select" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-white"></select>
                        <button type="button" onclick="irAMensualidad()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium transition shadow-sm">Continuar con Mensualidad</button>
                    </div>
                </div>

                <button type="button" id="boton-adelantado" onclick="irAPagoAdelantado()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md shadow-indigo-200 transition transform active:scale-95 flex items-center justify-center gap-2">
                    <span>Ir a Caja / Pago Adelantado</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
        
        {% else %}
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-white px-5 py-3 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            Datos del Paciente
                        </h3>
                        {% if credito_disponible > 0 %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200 shadow-sm">
                            Saldo a favor: Bs. {{ credito_disponible }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="p-5">
                        <h2 class="text-xl font-bold text-gray-900">{{ paciente.nombre_completo }}</h2>
                        <div class="flex items-center gap-4 mt-1 text-sm text-gray-500">
                            <span>üéÇ {{ paciente.fecha_nacimiento|date:"d/m/Y" }}</span>
                            {% if paciente.edad %}<span class="bg-gray-100 px-2 rounded text-xs text-gray-600">{{ paciente.edad }} a√±os</span>{% endif %}
                        </div>

                        {% if paciente.nombre_tutor %}
                        <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] text-gray-400 uppercase font-bold">Tutor Responsable</label>
                                    <p class="text-sm font-semibold text-gray-700">{{ paciente.nombre_tutor }}</p>
                                    <p class="text-xs text-gray-500 capitalize">{{ paciente.parentesco|default:"Parentesco no registrado" }}</p>
                                </div>
                                <div class="text-right">
                                    <label class="block text-[10px] text-gray-400 uppercase font-bold">Contacto Tutor</label>
                                    <a href="tel:{{ paciente.telefono_tutor }}" class="text-sm font-bold text-indigo-600 hover:underline">
                                        {{ paciente.telefono_tutor|default:"S/N" }} üìû
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if sesion %}
                <div class="bg-white rounded-2xl shadow-sm border border-indigo-100 overflow-hidden relative group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div class="bg-indigo-50/50 px-5 py-3 border-b border-indigo-100">
                        <h3 class="text-xs font-bold text-indigo-900 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                            Detalle del Servicio
                        </h3>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-lg font-bold text-gray-900 leading-tight">{{ sesion.servicio.nombre }}</p>
                                    <p class="text-xs text-indigo-600 font-medium mt-0.5">{{ sesion.profesional.nombre_completo }}</p>
                                </div>
                                <div class="text-right bg-gray-50 px-2 py-1 rounded border border-gray-100">
                                    <label class="block text-[10px] text-gray-400 uppercase">Precio Base</label>
                                    <span class="font-mono text-xs font-bold text-gray-600">Bs. {{ sesion.servicio.costo_base|default:'0' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-px bg-gray-200 rounded-lg overflow-hidden border border-gray-200">
                            <div class="bg-white p-3 text-center">
                                <span class="block text-[10px] text-gray-500 uppercase font-bold">Acordado</span>
                                <span class="block text-base font-bold text-gray-800">{{ sesion.monto_cobrado }}</span>
                            </div>
                            <div class="bg-green-50 p-3 text-center">
                                <span class="block text-[10px] text-green-700 uppercase font-bold">Pagado</span>
                                <span class="block text-base font-bold text-green-700">{{ sesion.total_pagado }}</span>
                            </div>
                            <div class="bg-red-50 p-3 text-center">
                                <span class="block text-[10px] text-red-700 uppercase font-bold">Pendiente</span>
                                <span class="block text-xl font-black text-red-600" id="pendiente-display">{{ sesion.saldo_pendiente }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if proyecto %}
                <div class="bg-white rounded-2xl shadow-sm border border-purple-100 overflow-hidden relative group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                    <div class="bg-purple-50/50 px-5 py-3 border-b border-purple-100">
                        <h3 class="text-xs font-bold text-purple-900 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Detalle del Proyecto
                        </h3>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <h3 class="font-bold text-lg text-purple-900">{{ proyecto.nombre }}</h3>
                            <p class="text-sm text-gray-600">C√≥digo: {{ proyecto.codigo }}</p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-px bg-gray-200 rounded-lg overflow-hidden border border-gray-200">
                            <div class="bg-white p-3 text-center">
                                <span class="block text-[10px] text-gray-500 uppercase font-bold">Acordado</span>
                                <span class="block text-base font-bold text-gray-800">{{ proyecto.costo_total }}</span>
                            </div>
                            <div class="bg-green-50 p-3 text-center">
                                <span class="block text-[10px] text-green-700 uppercase font-bold">Pagado</span>
                                <span class="block text-base font-bold text-green-700">{{ proyecto.total_pagado|default:'0' }}</span>
                            </div>
                            <div class="bg-red-50 p-3 text-center">
                                <span class="block text-[10px] text-red-700 uppercase font-bold">Pendiente</span>
                                <span class="block text-xl font-black text-red-600" id="pendiente-display">{{ proyecto.saldo_pendiente }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if mensualidad %}
                <div class="bg-white rounded-2xl shadow-sm border border-blue-100 overflow-hidden relative group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <div class="bg-blue-50/50 px-5 py-3 border-b border-blue-100">
                        <h3 class="text-xs font-bold text-blue-900 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Detalle de Mensualidad
                        </h3>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <h3 class="font-bold text-lg text-blue-900">{{ mensualidad.codigo }}</h3>
                            <p class="text-sm text-gray-600">Periodo: {{ mensualidad.periodo_display }}</p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-px bg-gray-200 rounded-lg overflow-hidden border border-gray-200">
                            <div class="bg-white p-3 text-center">
                                <span class="block text-[10px] text-gray-500 uppercase font-bold">Acordado</span>
                                <span class="block text-base font-bold text-gray-800">{{ mensualidad.costo_mensual }}</span>
                            </div>
                            <div class="bg-green-50 p-3 text-center">
                                <span class="block text-[10px] text-green-700 uppercase font-bold">Pagado</span>
                                <span class="block text-base font-bold text-green-700">{{ mensualidad.total_pagado|default:'0' }}</span>
                            </div>
                            <div class="bg-red-50 p-3 text-center">
                                <span class="block text-[10px] text-red-700 uppercase font-bold">Pendiente</span>
                                <span class="block text-xl font-black text-red-600" id="pendiente-display">{{ mensualidad.saldo_pendiente }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="lg:col-span-7">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 h-full flex flex-col relative overflow-hidden">
                    
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h2 class="font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            Detalle de Transacci√≥n
                        </h2>
                        <input type="date" name="fecha_pago" value="{{ fecha_hoy|date:'Y-m-d' }}" max="{{ fecha_hoy|date:'Y-m-d' }}" class="text-sm border-gray-200 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-600 font-medium">
                    </div>

                    <div class="p-6 space-y-6 flex-1 overflow-y-auto">
                        
                        {% if credito_disponible > 0 and modo != 'adelantado' %}
                        <div class="rounded-xl border border-emerald-200 bg-emerald-50/50 p-4 transition-all duration-300 hover:shadow-md">
                            <div class="flex items-center justify-between mb-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" name="usar_credito" id="usar_credito" class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-emerald-400 bg-white checked:bg-emerald-500 transition-all" onchange="toggleCredito()">
                                        <svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity" viewBox="0 0 14 14" fill="none"><path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                    </div>
                                    <span class="font-bold text-emerald-900">Usar Saldo a Favor (Credito)</span>
                                </label>
                                <span class="text-xs font-bold text-emerald-600 bg-white px-2 py-1 rounded border border-emerald-100">
                                    Disponible: Bs. {{ credito_disponible }}
                                </span>
                            </div>

                            <div id="campo-credito" class="hidden pl-8 animate-fade-in">
                                <div class="flex items-center gap-3">
                                    <div class="relative w-full max-w-[200px]">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-emerald-600 font-bold">Bs.</span>
                                        <input type="number" name="monto_credito" id="monto_credito" min="0" max="{{ credito_disponible }}" step="1" value="0" inputmode="numeric" pattern="[0-9]*" class="w-full pl-10 pr-3 py-2 text-emerald-800 font-bold border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 bg-white" oninput="this.value=this.value.replace(/[^0-9]/g,''); calcularTotal()" onkeydown="return soloEnteros(event)" onpaste="setTimeout(()=>{this.value=this.value.replace(/[^0-9]/g,''); calcularTotal();},0)">
                                    </div>
                                    <button type="button" onclick="usarSoloPendiente()" class="text-xs bg-emerald-200 hover:bg-emerald-300 text-emerald-800 px-3 py-2 rounded-lg font-bold transition">
                                        Cubrir Todo
                                    </button>
                                </div>
                                <p class="text-[11px] text-emerald-600 mt-2">Este monto se descontar√° del Credito del paciente.</p>
                            </div>
                        </div>
                        {% endif %}

                        <div class="rounded-xl border border-gray-200 bg-slate-50 p-5 relative">
                            <div class="absolute -top-3 left-4 bg-white px-2 text-xs font-bold text-gray-500 uppercase tracking-wider border border-gray-100 rounded shadow-sm">
                                Pago Al Contado
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-1">
                                <div>
                                    <label class="block text-xs font-bold text-gray-600 mb-2">M√©todo de Pago *</label>
                                    <select name="metodo_pago" id="metodo_pago" class="w-full px-4 py-2.5 text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm" required onchange="manejarCambioMetodoPago()">
                                        <option value="">-- Seleccionar m√©todo --</option>
                                        {% for metodo in metodos_pago %}
                                        <option value="{{ metodo.id }}">{{ metodo.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-gray-600 mb-2">Monto a Recibir (Dinero) *</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Bs.</span>
                                        <input type="number" name="monto" id="monto"
                                            step="1" min="0"
                                            value=""
                                            inputmode="numeric"
                                            pattern="[0-9]*"
                                            class="w-full pl-12 pr-4 py-2.5 text-xl font-bold text-gray-800 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-colors"
                                            onkeydown="return soloEnteros(event)"
                                            placeholder="0">
                                    </div>
                                </div>
                            </div>

                            <!-- ‚úÖ NUEVO: Mensaje informativo din√°mico -->
                            <div id="mensaje-informativo" class="hidden mt-4 p-3 rounded-lg animate-fade-in">
                                <div class="flex items-start gap-2">
                                    <svg id="icono-mensaje" class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
                                    <div>
                                        <p id="texto-mensaje" class="text-sm font-semibold"></p>
                                        <p id="subtexto-mensaje" class="text-xs mt-1"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            {% if modo == 'sesion' or modo == 'proyecto' or modo == 'mensualidad' %}
                            <label class="flex items-start gap-3 p-4 rounded-xl cursor-pointer transition-all duration-200
                                border-2 border-blue-200 bg-blue-50 hover:border-blue-400 hover:bg-blue-100
                                has-[:checked]:border-blue-500 has-[:checked]:bg-blue-100 has-[:checked]:shadow-md">
                                <div class="relative flex items-center mt-0.5">
                                    <input type="checkbox" name="pago_completo" id="pago_completo"
                                        class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border-2 border-blue-400 bg-white checked:bg-blue-500 checked:border-blue-500 transition-all focus:ring-2 focus:ring-blue-300"
                                        onchange="togglePagoCompleto()">
                                    <svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity" viewBox="0 0 14 14" fill="none">
                                        <path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span class="text-sm font-bold text-blue-800">Marcar deuda como Saldada</span>
                                    </div>
                                    <span class="block text-xs text-blue-600 mt-0.5">Ajusta autom√°ticamente el monto para dejar la deuda en 0.</span>
                                </div>
                            </label>
                            {% endif %}

                            <div class="rounded-xl border border-gray-200 bg-gray-50 p-4">
                                <label class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Nota / Observaci√≥n
                                </label>
                                <textarea name="observaciones" rows="2"
                                    class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-white placeholder-gray-300 transition"
                                    placeholder="Ej: Pago realizado por el padre..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 border-t border-gray-200">
                        <div class="flex justify-between items-end mb-5">
                            <div class="space-y-1 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="w-20 text-gray-500">Contado:</span>
                                    <span id="resumen-adicional" class="font-bold text-gray-800">Bs. 0</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-20 text-gray-500">Credito:</span>
                                    <span id="resumen-credito" class="font-bold text-emerald-600">Bs. 0</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Total Transacci√≥n</span>
                                <span class="text-3xl font-black text-indigo-700 leading-none tracking-tight" id="resumen-total">Bs. {{ monto_sugerido|default:'0' }}</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            Confirmar Pago
                        </button>
                    </div>

                </div>
            </div>
        </div>
        {% endif %}
    </form>
</div>

<script>
// ‚úÖ VALIDACI√ìN: Solo permite teclas de n√∫meros enteros (sin decimales)
function soloEnteros(e) {
    const permitidas = ['Backspace','Delete','Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'];
    if (permitidas.includes(e.key)) return true;
    if (/^[0-9]$/.test(e.key) && !e.ctrlKey && !e.metaKey) return true;
    return false;
}

let pacienteSeleccionadoId = null;
const creditoDisponible = parseFloat("{{ credito_disponible }}".replace(',','.')) || 0;
const montoPendiente = parseFloat("{{ monto_sugerido }}".replace(',','.')) || 0;
const modoActual = "{{ modo }}";

function cargarOpcionesPaciente() {
    const select = document.getElementById('paciente_select');
    const opciones = document.getElementById('opciones-tipo-pago');
    if (select && select.value) {
        pacienteSeleccionadoId = select.value;
        opciones.classList.remove('hidden');
        cargarProyectosPaciente(pacienteSeleccionadoId);
        cargarMensualidadesPaciente(pacienteSeleccionadoId);
    } else {
        pacienteSeleccionadoId = null;
        opciones.classList.add('hidden');
    }
}

function toggleSelectorTipo(tipo) {
    const proyectoCheck = document.getElementById('es_proyecto_checkbox');
    const mensualidadCheck = document.getElementById('es_mensualidad_checkbox');
    const selectorProyectos = document.getElementById('selector-proyectos');
    const selectorMensualidades = document.getElementById('selector-mensualidades');
    const botonAdelantado = document.getElementById('boton-adelantado');
    
    if (tipo === 'proyecto') {
        if (proyectoCheck.checked) {
            // Desmarcar mensualidad
            mensualidadCheck.checked = false;
            selectorMensualidades.classList.add('hidden');
            
            selectorProyectos.classList.remove('hidden');
            if(botonAdelantado) botonAdelantado.classList.add('hidden');
            if (pacienteSeleccionadoId) cargarProyectosPaciente(pacienteSeleccionadoId);
        } else {
            selectorProyectos.classList.add('hidden');
            if(botonAdelantado) botonAdelantado.classList.remove('hidden');
        }
    } else if (tipo === 'mensualidad') {
        if (mensualidadCheck.checked) {
            // Desmarcar proyecto
            proyectoCheck.checked = false;
            selectorProyectos.classList.add('hidden');
            
            selectorMensualidades.classList.remove('hidden');
            if(botonAdelantado) botonAdelantado.classList.add('hidden');
            if (pacienteSeleccionadoId) cargarMensualidadesPaciente(pacienteSeleccionadoId);
        } else {
            selectorMensualidades.classList.add('hidden');
            if(botonAdelantado) botonAdelantado.classList.remove('hidden');
        }
    }
}

async function cargarProyectosPaciente(pacienteId) {
    const select = document.getElementById('proyecto_select');
    if(!select) return;
    
    select.innerHTML = '<option value="">‚è≥ Buscando...</option>';
    select.disabled = true;
    
    try {
        const response = await fetch(`/facturacion/api/proyectos-paciente/${pacienteId}/`);
        const data = await response.json();
        
        select.disabled = false;
        
        if (data.proyectos && data.proyectos.length > 0) {
            select.innerHTML = '<option value="">-- Selecciona un proyecto --</option>';
            data.proyectos.forEach(proyecto => {
                const option = document.createElement('option');
                option.value = proyecto.id;
                option.textContent = `${proyecto.nombre} - Pendiente: Bs. ${proyecto.saldo_pendiente}`;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${data.proyectos.length} proyectos cargados`);
        } else {
            select.innerHTML = '<option value="">‚úì Sin proyectos pendientes</option>';
            console.log('‚ÑπÔ∏è No hay proyectos con saldo pendiente');
        }
    } catch (error) {
        console.error('‚ùå Error al cargar proyectos:', error);
        select.innerHTML = '<option value="">‚ùå Error al cargar proyectos</option>';
        select.disabled = false;
        alert(`‚ùå Error al cargar proyectos: ${error.message}\n\nRevisa la consola del navegador para m√°s detalles.`);
    }
}

async function cargarMensualidadesPaciente(pacienteId) {
    const select = document.getElementById('mensualidad_select');
    if(!select) return;
    
    select.innerHTML = '<option value="">‚è≥ Buscando...</option>';
    select.disabled = true;
    
    try {
        const response = await fetch(`/facturacion/api/mensualidades-paciente/${pacienteId}/`);
        const data = await response.json();
        
        select.disabled = false;
        
        if (data.mensualidades && data.mensualidades.length > 0) {
            select.innerHTML = '<option value="">-- Selecciona una mensualidad --</option>';
            data.mensualidades.forEach(mensualidad => {
                const option = document.createElement('option');
                option.value = mensualidad.id;
                option.textContent = `${mensualidad.codigo} - ${mensualidad.periodo_display} - Pendiente: Bs. ${mensualidad.saldo_pendiente}`;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${data.mensualidades.length} mensualidades cargadas`);
        } else {
            select.innerHTML = '<option value="">‚úì Sin mensualidades pendientes</option>';
            console.log('‚ÑπÔ∏è No hay mensualidades con saldo pendiente');
        }
    } catch (error) {
        console.error('‚ùå Error al cargar mensualidades:', error);
        select.innerHTML = '<option value="">‚ùå Error al cargar mensualidades</option>';
        select.disabled = false;
        alert(`‚ùå Error al cargar mensualidades: ${error.message}\n\nRevisa la consola del navegador para m√°s detalles.`);
    }
}

function irAProyecto() {
    const proyectoId = document.getElementById('proyecto_select').value;
    if (!proyectoId) { alert('‚ö†Ô∏è Por favor selecciona un proyecto'); return; }
    window.location.href = `/facturacion/pago/registrar/?proyecto=${proyectoId}`;
}

function irAMensualidad() {
    const mensualidadId = document.getElementById('mensualidad_select').value;
    if (!mensualidadId) { alert('‚ö†Ô∏è Por favor selecciona una mensualidad'); return; }
    window.location.href = `/facturacion/pago/registrar/?mensualidad=${mensualidadId}`;
}

function irAPagoAdelantado() {
    if (!pacienteSeleccionadoId) { alert('‚ö†Ô∏è Selecciona un paciente primero'); return; }
    window.location.href = `/facturacion/pago/registrar/?paciente=${pacienteSeleccionadoId}`;
}

function toggleCredito() {
    const checkbox = document.getElementById('usar_credito');
    const campo = document.getElementById('campo-credito');
    
    if (checkbox && checkbox.checked) {
        campo.classList.remove('hidden');
        // Pre-llenar con el monto sugerido si est√° disponible
        const inputCred = document.getElementById('monto_credito');
        if (inputCred && parseFloat(inputCred.value) === 0) {
            let objetivo = montoPendiente > 0 ? montoPendiente : creditoDisponible;
            const montoCubrir = Math.min(creditoDisponible, objetivo);
            inputCred.value = montoCubrir.toFixed(0);
        }
        calcularTotal();
    } else if (campo) {
        campo.classList.add('hidden');
        const inputCred = document.getElementById('monto_credito');
        if(inputCred) inputCred.value = 0;
        calcularTotal();
    }
}

function usarSoloPendiente() {
    let objetivo = montoPendiente > 0 ? montoPendiente : creditoDisponible;
    const montoCubrir = Math.min(creditoDisponible, objetivo);
    
    const inputCred = document.getElementById('monto_credito');
    if(inputCred) {
        inputCred.value = montoCubrir.toFixed(0);
        calcularTotal();
    }
}

// ‚úÖ FUNCI√ìN NUEVA: Manejar cambios en m√©todo de pago (incluye l√≥gica "Sin cobro")
function manejarCambioMetodoPago() {
    const metodoPago = document.getElementById('metodo_pago');
    const montoInput = document.getElementById('monto');
    const usarCreditoCheckbox = document.getElementById('usar_credito');
    const pagoCompletoCheckbox = document.getElementById('pago_completo');
    
    if (!metodoPago) return;
    
    const metodoSeleccionado = metodoPago.options[metodoPago.selectedIndex]?.text || '';
    const esSinCobro = metodoSeleccionado.toLowerCase().includes('sin cobro');
    
    // ‚úÖ L√ìGICA PARA "SIN COBRO"
    if (esSinCobro) {
        // 1. Bloquear campo monto y establecer en 0
        if (montoInput) {
            montoInput.value = '0';
            montoInput.setAttribute('readonly', 'readonly');
            montoInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        }
        
        // 2. Bloquear checkbox "Usar Saldo a Favor" SI EXISTE (solo si hay cr√©dito disponible)
        if (usarCreditoCheckbox) {
            usarCreditoCheckbox.setAttribute('disabled', 'disabled');
            usarCreditoCheckbox.checked = false;
            const wrapper = usarCreditoCheckbox.closest('.rounded-xl');
            if (wrapper) wrapper.classList.add('opacity-50', 'pointer-events-none');
        }
        
        // 3. Marcar y bloquear checkbox "Marcar deuda como Saldada"
        if (pagoCompletoCheckbox) {
            pagoCompletoCheckbox.checked = true;
            pagoCompletoCheckbox.setAttribute('disabled', 'disabled');
            const label = pagoCompletoCheckbox.closest('label');
            if (label) label.classList.add('opacity-75', 'pointer-events-none');
        }
    } 
    // ‚úÖ L√ìGICA PARA CUALQUIER OTRO M√âTODO
    else {
        // 1. Habilitar campo monto (sin borrar el valor que el usuario haya ingresado)
        if (montoInput) {
            montoInput.removeAttribute('readonly');
            montoInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
        
        // 2. Habilitar checkbox "Usar Saldo a Favor" SI EXISTE (mantiene l√≥gica condicional)
        if (usarCreditoCheckbox) {
            usarCreditoCheckbox.removeAttribute('disabled');
            usarCreditoCheckbox.checked = false;
            // ‚úÖ CORREGIDO Bug 1: limpiar monto_credito y ocultar el campo.
            // El input sigue en el DOM aunque est√© oculto y el navegador lo env√≠a igual,
            // por eso hay que resetear el valor a 0 expl√≠citamente.
            const inputCred = document.getElementById('monto_credito');
            if (inputCred) inputCred.value = '0';
            document.getElementById('campo-credito')?.classList.add('hidden');
            const wrapper = usarCreditoCheckbox.closest('.rounded-xl');
            if (wrapper) wrapper.classList.remove('opacity-50', 'pointer-events-none');
        }
        
        // 3. Desmarcar y habilitar checkbox "Marcar deuda como Saldada"
        if (pagoCompletoCheckbox) {
            pagoCompletoCheckbox.checked = false;
            pagoCompletoCheckbox.removeAttribute('disabled');
            const label = pagoCompletoCheckbox.closest('label');
            if (label) label.classList.remove('opacity-75', 'pointer-events-none');
        }
    }
    
    // Recalcular totales y actualizar mensajes
    calcularTotal();
}

// ‚úÖ NUEVA FUNCI√ìN: Actualizar mensajes informativos din√°micos
function actualizarMensajeInformativo() {
    const contenedor = document.getElementById('mensaje-informativo');
    const icono = document.getElementById('icono-mensaje');
    const texto = document.getElementById('texto-mensaje');
    const subtexto = document.getElementById('subtexto-mensaje');
    
    if (!contenedor || !icono || !texto || !subtexto) return;
    
    // Solo mostrar mensajes si hay un monto pendiente (sesi√≥n, proyecto, mensualidad)
    if (modoActual !== 'sesion' && modoActual !== 'proyecto' && modoActual !== 'mensualidad') {
        contenedor.classList.add('hidden');
        return;
    }
    
    const pagoCompleto = document.getElementById('pago_completo')?.checked || false;
    const montoAdicional = parseFloat(document.getElementById('monto')?.value) || 0;
    const usarCredito = document.getElementById('usar_credito')?.checked || false;
    const montoCredito = usarCredito ? (parseFloat(document.getElementById('monto_credito')?.value) || 0) : 0;
    const totalPago = montoCredito + montoAdicional;
    
    // ‚úÖ VALIDACI√ìN: Cr√©dito en 0 NO es v√°lido
    if (usarCredito && montoCredito === 0) {
        contenedor.classList.remove('hidden');
        contenedor.className = 'mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200 animate-fade-in';
        icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        icono.className = 'w-5 h-5 flex-shrink-0 mt-0.5 text-amber-600';
        texto.textContent = '‚ö†Ô∏è Ingresa el monto de cr√©dito a usar';
        subtexto.textContent = 'El monto de cr√©dito debe ser mayor a 0, o desmarca "Usar Saldo a Favor".';
        return;
    }
    
    // ‚úÖ VALIDACI√ìN: Pago de 0 sin checkbox "Marcar deuda como Saldada" NO es v√°lido
    if (totalPago === 0 && !pagoCompleto) {
        contenedor.classList.remove('hidden');
        contenedor.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200 animate-fade-in';
        icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-red-600";
        texto.textContent = '‚ö†Ô∏è Pago de Bs. 0 no es v√°lido';
        subtexto.textContent = 'Debes ingresar un monto o marcar "Marcar deuda como Saldada" para condonar la deuda.';
        return;
    }
    
    // Casos cuando est√° marcado "Pago Completo"
    if (pagoCompleto) {
        if (totalPago === 0) {
            // ‚úÖ VALIDACI√ìN: No permitir cr√©dito en pago de 0
            if (usarCredito) {
                contenedor.classList.remove('hidden');
                contenedor.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200 animate-fade-in';
                icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-red-600";
                texto.textContent = '‚ö†Ô∏è No puedes saldar deuda en 0 usando cr√©dito';
                subtexto.textContent = 'Desmarca "Usar Saldo a Favor" para saldar con Bs. 0 en efectivo.';
                return;
            }
            
            // Pago de 0 CON checkbox marcado (condonaci√≥n de deuda)
            contenedor.classList.remove('hidden');
            contenedor.className = 'mt-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200 animate-fade-in';
            icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
            icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-yellow-600";
            texto.textContent = '‚ö†Ô∏è Condonaci√≥n de deuda (Beca/Caso especial)';
            subtexto.textContent = 'Se registrar√° un pago de Bs. 0 y la deuda quedar√° saldada.';
        } else if (totalPago < montoPendiente) {
            contenedor.classList.remove('hidden');
            contenedor.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200 animate-fade-in';
            icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-blue-600";
            texto.textContent = `‚úì Deuda saldada con Bs. ${totalPago.toFixed(0)}`;
            subtexto.textContent = usarCredito 
                ? `(Cr√©dito: ${montoCredito.toFixed(0)} + Efectivo: ${montoAdicional.toFixed(0)}) - La deuda quedar√° en cero.`
                : 'El monto total cobrado se ajustar√° y la deuda quedar√° en cero.';
        } else if (totalPago > montoPendiente) {
            contenedor.classList.remove('hidden');
            contenedor.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200 animate-fade-in';
            icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-blue-600";
            texto.textContent = `‚úì Deuda saldada - Se cobrar√°n Bs. ${totalPago.toFixed(0)}`;
            subtexto.textContent = usarCredito
                ? `Cr√©dito: ${montoCredito.toFixed(0)} + Efectivo: ${montoAdicional.toFixed(0)} - El monto acordado se ajustar√° a Bs. ${totalPago.toFixed(0)} y la deuda quedar√° en cero.`
                : `El monto acordado se ajustar√° a Bs. ${totalPago.toFixed(0)} y la deuda quedar√° en cero.`;
        } else {
            // Pago exacto con checkbox marcado
            contenedor.classList.remove('hidden');
            contenedor.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200 animate-fade-in';
            icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-green-600";
            texto.textContent = '‚úì Pago completo y exacto';
            subtexto.textContent = usarCredito
                ? `Cr√©dito: ${montoCredito.toFixed(0)} + Efectivo: ${montoAdicional.toFixed(0)} = Bs. ${totalPago.toFixed(0)} - Deuda saldada.`
                : 'La deuda quedar√° totalmente saldada.';
        }
        return;
    }
    
    // Casos normales (sin "Pago Completo" marcado)
    if (totalPago < montoPendiente) {
        const porcentaje = ((totalPago / montoPendiente) * 100).toFixed(0);
        const faltante = montoPendiente - totalPago;
        
        contenedor.classList.remove('hidden');
        contenedor.className = 'mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200 animate-fade-in';
        icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-amber-600";
        texto.textContent = `‚ÑπÔ∏è Se cobrar√° el ${porcentaje}% del total (Bs. ${totalPago.toFixed(0)})`;
        subtexto.textContent = usarCredito
            ? `Cr√©dito: ${montoCredito.toFixed(0)} + Efectivo: ${montoAdicional.toFixed(0)} - Faltar√≠an Bs. ${faltante.toFixed(0)}`
            : `Faltar√≠an Bs. ${faltante.toFixed(0)} para completar el pago.`;
    } else if (totalPago > montoPendiente) {
        const exceso = totalPago - montoPendiente;
        
        contenedor.classList.remove('hidden');
        contenedor.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200 animate-fade-in';
        icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-red-600";
        texto.textContent = `‚ö†Ô∏è El monto excede lo debido en Bs. ${exceso.toFixed(0)}`;
        subtexto.textContent = usarCredito
            ? `Total: Bs. ${totalPago.toFixed(0)} (Cr√©dito: ${montoCredito.toFixed(0)} + Efectivo: ${montoAdicional.toFixed(0)}) - Marca "Saldada" para ajustar.`
            : 'No puedes pagar m√°s de lo que se debe. Usa "Pago Adelantado" o marca "Saldada" para ajustar.';
    } else {
        // Pago exacto
        contenedor.classList.remove('hidden');
        contenedor.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200 animate-fade-in';
        icono.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        icono.className = "w-5 h-5 flex-shrink-0 mt-0.5 text-green-600";
        texto.textContent = '‚úì Pago exacto del monto pendiente';
        subtexto.textContent = usarCredito
            ? `Cr√©dito: ${montoCredito.toFixed(0)} + Efectivo: ${montoAdicional.toFixed(0)} = Bs. ${totalPago.toFixed(0)} - Deuda saldada.`
            : 'La deuda quedar√° totalmente saldada.';
    }
}

function calcularTotal() {
    const usarCredito = document.getElementById('usar_credito')?.checked || false;
    let montoCredito = usarCredito ? (parseFloat(document.getElementById('monto_credito')?.value) || 0) : 0;
    const montoAdicional = parseFloat(document.getElementById('monto')?.value) || 0;
    
    // Corregir cr√©dito si excede el disponible (sin alert, solo clamp)
    if (montoCredito > creditoDisponible) {
        montoCredito = creditoDisponible;
        const inputCred = document.getElementById('monto_credito');
        if (inputCred) inputCred.value = creditoDisponible.toFixed(0);
    }
    
    const total = montoCredito + montoAdicional;
    
    // Siempre actualizar el DOM primero
    const resumenCredito = document.getElementById('resumen-credito');
    const resumenAdicional = document.getElementById('resumen-adicional');
    const resumenTotal = document.getElementById('resumen-total');
    
    if (resumenCredito) resumenCredito.textContent = `Bs. ${montoCredito.toFixed(0)}`;
    if (resumenAdicional) resumenAdicional.textContent = `Bs. ${montoAdicional.toFixed(0)}`;
    if (resumenTotal) resumenTotal.textContent = `Bs. ${total.toFixed(0)}`;
    
    const metodo = document.getElementById('metodo_pago');
    if (metodo) {
        if (montoAdicional > 0) {
            metodo.setAttribute('required', 'required');
        } else {
            metodo.removeAttribute('required');
        }
    }
    
    // Actualizar mensajes informativos
    actualizarMensajeInformativo();
}

function togglePagoCompleto() {
    const check = document.getElementById('pago_completo');
    const montoInput = document.getElementById('monto');
    
    if (check && check.checked) {
        montoInput.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-800');
    } else {
        montoInput.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-800');
    }
    
    // ‚úÖ NUEVO: Actualizar mensajes cuando cambia el checkbox
    actualizarMensajeInformativo();
}

document.addEventListener('DOMContentLoaded', () => {
    // ‚úÖ Registrar listener oninput en JS puro (evita bugs de comillas escapadas en atributo HTML)
    const montoInput = document.getElementById('monto');
    if (montoInput) {
        montoInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            calcularTotal();
        });
        montoInput.addEventListener('paste', function() {
            setTimeout(() => {
                this.value = this.value.replace(/[^0-9]/g, '');
                calcularTotal();
            }, 0);
        });
    }
    // Inicializar c√°lculos con el monto pre-cargado
    calcularTotal();
    actualizarMensajeInformativo();
});

// ‚úÖ VALIDACI√ìN MEJORADA EN EL SUBMIT
document.getElementById('form-pago').addEventListener('submit', function(e) {
    const pagoCompleto = document.getElementById('pago_completo')?.checked || false;
    const usarCredito = document.getElementById('usar_credito')?.checked || false;
    const montoCredito = parseFloat(document.getElementById('monto_credito')?.value) || 0;
    const montoAdicional = parseFloat(document.getElementById('monto')?.value) || 0;
    const totalPago = montoCredito + montoAdicional;
    const metodoPago = document.getElementById('metodo_pago');
    const metodoTexto = metodoPago?.options[metodoPago.selectedIndex]?.text || '';
    const esSinCobro = metodoTexto.toLowerCase().includes('sin cobro');
    
    // ‚úÖ VALIDACI√ìN NUEVA: M√©todos que NO son "Sin cobro" NO pueden tener monto 0 (excepto con cr√©dito)
    if (!esSinCobro && montoAdicional === 0 && !usarCredito && (modoActual === 'sesion' || modoActual === 'proyecto' || modoActual === 'mensualidad')) {
        e.preventDefault();
        alert('‚ö†Ô∏è No puedes registrar un pago de Bs. 0 en este m√©todo\n\nOpciones:\n‚Ä¢ Ingresa el monto a cobrar\n‚Ä¢ Usa el m√©todo "Sin cobro" si quieres saldar sin cobrar\n‚Ä¢ Usa cr√©dito disponible del paciente');
        document.getElementById('monto').focus();
        return false;
    }
    
    // ‚úÖ VALIDACI√ìN CR√çTICA: Si usa cr√©dito, NO puede ser 0
    if (usarCredito && montoCredito === 0) {
        e.preventDefault();
        alert('‚ö†Ô∏è Si vas a usar cr√©dito, debes ingresar un monto mayor a 0.\n\nOpciones:\n‚Ä¢ Ingresa el monto de cr√©dito a usar\n‚Ä¢ Desmarca "Usar Saldo a Favor" si no vas a usar cr√©dito');
        document.getElementById('monto_credito').focus();
        return false;
    }
    
    // ‚úÖ VALIDACI√ìN: Pago de 0 SOLO permitido con checkbox "Marcar deuda como Saldada" Y sin cr√©dito
    if (totalPago === 0 && (modoActual === 'sesion' || modoActual === 'proyecto' || modoActual === 'mensualidad')) {
        if (!pagoCompleto) {
            e.preventDefault();
            alert('‚ö†Ô∏è No puedes registrar un pago de Bs. 0 sin marcar "Marcar deuda como Saldada"\n\nOpciones:\n‚Ä¢ Marca el checkbox "Marcar deuda como Saldada" para saldar la deuda en 0\n‚Ä¢ Ingresa el monto que vas a cobrar\n‚Ä¢ Usa el m√©todo "Sin cobro"');
            document.getElementById('monto').focus();
            return false;
        }
        if (usarCredito) {
            e.preventDefault();
            alert('‚ö†Ô∏è No puedes saldar deuda en 0 usando cr√©dito\n\nPara saldar deuda en 0:\n‚Ä¢ Desmarca "Usar Saldo a Favor"\n‚Ä¢ Deja el monto en efectivo en 0\n‚Ä¢ Marca "Marcar deuda como Saldada"');
            return false;
        }
        // Si est√° marcado el checkbox y NO usa cr√©dito, confirmar la acci√≥n
        const confirmar = confirm('‚ö†Ô∏è Vas a registrar un pago de Bs. 0 y saldar la deuda\n\nEsto es √∫til para casos de becas o situaciones especiales donde se condona la deuda.\n\n¬øDeseas continuar?');
        if (!confirmar) {
            e.preventDefault();
            return false;
        }
    }
    
    // Validar que haya m√©todo de pago si se cobra en efectivo
    if (montoAdicional > 0 || (montoAdicional === 0 && !usarCredito)) {
        const metodo = document.getElementById('metodo_pago').value;
        if (!metodo) {
            e.preventDefault();
            alert('‚ö†Ô∏è Selecciona un m√©todo de pago');
            document.getElementById('metodo_pago').focus();
            return false;
        }
    }
    
    // ‚úÖ VALIDACI√ìN: No se puede pagar m√°s de lo debido (a menos que est√© marcado "Pago Completo")
    if ((modoActual === 'sesion' || modoActual === 'proyecto' || modoActual === 'mensualidad') && !pagoCompleto) {
        if (totalPago > montoPendiente) {
            e.preventDefault();
            const exceso = totalPago - montoPendiente;
            alert(`‚ö†Ô∏è El monto total (Bs. ${totalPago.toFixed(0)}) excede lo debido (Bs. ${montoPendiente.toFixed(0)}) por Bs. ${exceso.toFixed(0)}\n\nOpciones:\n‚Ä¢ Ajusta el monto a Bs. ${montoPendiente.toFixed(0)}\n‚Ä¢ Usa "Pago Adelantado" para abonar cr√©dito adicional\n‚Ä¢ Marca "Marcar deuda como Saldada" para ajustar autom√°ticamente`);
            document.getElementById('monto').focus();
            return false;
        }
    }
    
    // Confirmaci√≥n para pagos parciales significativos
    if ((modoActual === 'sesion' || modoActual === 'proyecto' || modoActual === 'mensualidad') && !pagoCompleto) {
        if (totalPago < montoPendiente && totalPago > 0) {
            const porcentaje = ((totalPago / montoPendiente) * 100).toFixed(0);
            const faltante = montoPendiente - totalPago;
            
            const confirmar = confirm(`‚ÑπÔ∏è Pago parcial detectado\n\nSe cobrar√°: Bs. ${totalPago.toFixed(0)} (${porcentaje}%)\nFaltante: Bs. ${faltante.toFixed(0)}\n\n¬øDeseas continuar?`);
            if (!confirmar) {
                e.preventDefault();
                return false;
            }
        }
    }
    
    return true;
});
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-down { animation: fadeInDown 0.4s ease-out; }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}