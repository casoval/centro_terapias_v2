{% extends 'base.html' %}
{% load static %}

{% block title %}üíµ Registrar Pago{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-indigo-600 rounded-xl text-white shadow-lg shadow-indigo-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Registrar Pago</h1>
                <p class="text-sm text-gray-500 font-medium">
                    {% if sesion %}Sesi√≥n <span class="text-indigo-600">#{{ sesion.id }}</span> &bull; {{ sesion.fecha|date:"d M Y" }}
                    {% elif proyecto %}Proyecto <span class="text-purple-600">{{ proyecto.codigo }}</span>
                    {% elif mensualidad %}Mensualidad <span class="text-blue-600">{{ mensualidad.codigo }}</span> &bull; {{ mensualidad.periodo_display }}
                    {% elif modo == 'adelantado' %}Dep√≥sito a Billetera/Credito (Adelantado)
                    {% else %}Nueva Transacci√≥n{% endif %}
                </p>
            </div>
        </div>
        <a href="javascript:history.back()" class="px-4 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition shadow-sm">
            Esc Cancelar
        </a>
    </div>

    <form method="post" id="form-pago">
        {% csrf_token %}
        
        {% if sesion %}<input type="hidden" name="tipo_pago" value="sesion"><input type="hidden" name="sesion_id" value="{{ sesion.id }}">
        {% elif proyecto %}<input type="hidden" name="tipo_pago" value="proyecto"><input type="hidden" name="proyecto_id" value="{{ proyecto.id }}">
        {% elif mensualidad %}<input type="hidden" name="tipo_pago" value="mensualidad"><input type="hidden" name="mensualidad_id" value="{{ mensualidad.id }}">
        {% elif paciente %}<input type="hidden" name="tipo_pago" value="adelantado"><input type="hidden" name="paciente_adelantado" value="{{ paciente.id }}">
        {% endif %}

        {% if not paciente %}
        <div class="max-w-lg mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 p-8 mt-10">
            <div class="text-center mb-6">
                <div class="inline-flex p-3 bg-blue-50 rounded-full text-blue-600 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Buscar Paciente</h3>
                <p class="text-sm text-gray-500">Selecciona a qui√©n se le realizar√° el cobro</p>
            </div>
            
            <select name="paciente_id" id="paciente_select" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-base focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" onchange="cargarOpcionesPaciente()">
                <option value="">-- Seleccionar de la lista --</option>
                {% for pac in pacientes_lista %}
                <option value="{{ pac.id }}">{{ pac.nombre }} {{ pac.apellido }}</option>
                {% endfor %}
            </select>
            
            <div id="opciones-tipo-pago" class="hidden mt-6 space-y-4 animate-fade-in-down">
                <!-- Proyectos -->
                <div class="p-4 bg-purple-50 rounded-xl border border-purple-100 transition hover:border-purple-300 cursor-pointer">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="es_proyecto_checkbox" class="w-5 h-5 rounded text-purple-600 focus:ring-purple-500" onchange="toggleSelectorTipo('proyecto')">
                        <span class="font-semibold text-purple-800">üì¶ Es pago de un Proyecto/Evaluaci√≥n</span>
                    </label>
                    <div id="selector-proyectos" class="hidden mt-3 pl-8">
                        <select id="proyecto_select" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-white"></select>
                        <button type="button" onclick="irAProyecto()" class="mt-2 w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm font-medium transition shadow-sm">Continuar con Proyecto/Evaluaci√≥n</button>
                    </div>
                </div>

                <!-- ‚úÖ NUEVO: Mensualidades -->
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 transition hover:border-blue-300 cursor-pointer">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="es_mensualidad_checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="toggleSelectorTipo('mensualidad')">
                        <span class="font-semibold text-blue-800">üìÖ Es pago de Mensualidad</span>
                    </label>
                    <div id="selector-mensualidades" class="hidden mt-3 pl-8">
                        <select id="mensualidad_select" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-white"></select>
                        <button type="button" onclick="irAMensualidad()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium transition shadow-sm">Continuar con Mensualidad</button>
                    </div>
                </div>

                <button type="button" id="boton-adelantado" onclick="irAPagoAdelantado()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md shadow-indigo-200 transition transform active:scale-95 flex items-center justify-center gap-2">
                    <span>Ir a Caja / Pago Adelantado</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
        
        {% else %}
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-white px-5 py-3 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            Datos del Paciente
                        </h3>
                        {% if credito_disponible > 0 %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200 shadow-sm">
                            Saldo a favor: Bs. {{ credito_disponible }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="p-5">
                        <h2 class="text-xl font-bold text-gray-900">{{ paciente.nombre_completo }}</h2>
                        <div class="flex items-center gap-4 mt-1 text-sm text-gray-500">
                            <span>üéÇ {{ paciente.fecha_nacimiento|date:"d/m/Y" }}</span>
                            {% if paciente.edad %}<span class="bg-gray-100 px-2 rounded text-xs text-gray-600">{{ paciente.edad }} a√±os</span>{% endif %}
                        </div>

                        {% if paciente.nombre_tutor %}
                        <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] text-gray-400 uppercase font-bold">Tutor Responsable</label>
                                    <p class="text-sm font-semibold text-gray-700">{{ paciente.nombre_tutor }}</p>
                                    <p class="text-xs text-gray-500 capitalize">{{ paciente.parentesco|default:"Parentesco no registrado" }}</p>
                                </div>
                                <div class="text-right">
                                    <label class="block text-[10px] text-gray-400 uppercase font-bold">Contacto Tutor</label>
                                    <a href="tel:{{ paciente.telefono_tutor }}" class="text-sm font-bold text-indigo-600 hover:underline">
                                        {{ paciente.telefono_tutor|default:"S/N" }} üìû
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if sesion %}
                <div class="bg-white rounded-2xl shadow-sm border border-indigo-100 overflow-hidden relative group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div class="bg-indigo-50/50 px-5 py-3 border-b border-indigo-100">
                        <h3 class="text-xs font-bold text-indigo-900 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                            Detalle del Servicio
                        </h3>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-lg font-bold text-gray-900 leading-tight">{{ sesion.servicio.nombre }}</p>
                                    <p class="text-xs text-indigo-600 font-medium mt-0.5">{{ sesion.profesional.nombre_completo }}</p>
                                </div>
                                <div class="text-right bg-gray-50 px-2 py-1 rounded border border-gray-100">
                                    <label class="block text-[10px] text-gray-400 uppercase">Precio Base</label>
                                    <span class="font-mono text-xs font-bold text-gray-600">Bs. {{ sesion.servicio.costo_base|default:'0.00' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-px bg-gray-200 rounded-lg overflow-hidden border border-gray-200">
                            <div class="bg-white p-3 text-center">
                                <span class="block text-[10px] text-gray-500 uppercase font-bold">Acordado</span>
                                <span class="block text-base font-bold text-gray-800">{{ sesion.monto_cobrado }}</span>
                            </div>
                            <div class="bg-green-50 p-3 text-center">
                                <span class="block text-[10px] text-green-700 uppercase font-bold">Pagado</span>
                                <span class="block text-base font-bold text-green-700">{{ sesion.total_pagado }}</span>
                            </div>
                            <div class="bg-red-50 p-3 text-center">
                                <span class="block text-[10px] text-red-700 uppercase font-bold">Pendiente</span>
                                <span class="block text-xl font-black text-red-600" id="pendiente-display">{{ sesion.saldo_pendiente }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                {% elif proyecto %}
                <div class="bg-white rounded-2xl shadow-sm border border-purple-100 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                    <div class="bg-purple-50 px-5 py-3 border-b border-purple-100">
                        <h3 class="text-xs font-bold text-purple-900 uppercase tracking-wider">Proyecto {{ proyecto.codigo }}</h3>
                    </div>
                    <div class="p-5">
                        <p class="text-lg font-bold text-gray-900 mb-4">{{ proyecto.nombre }}</p>
                        <div class="flex justify-between items-center text-sm border-t border-gray-100 pt-3">
                            <span class="text-gray-500">Costo Total:</span>
                            <span class="font-bold text-gray-800">Bs. {{ proyecto.costo_total }}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-2">
                            <span class="text-gray-500">Saldo Pendiente:</span>
                            <span class="font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded">Bs. {{ proyecto.saldo_pendiente }}</span>
                        </div>
                    </div>
                </div>

                {% elif mensualidad %}
                <!-- ‚úÖ Card para mensualidad -->
                <div class="bg-white rounded-2xl shadow-sm border border-blue-100 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <div class="bg-blue-50 px-5 py-3 border-b border-blue-100">
                        <h3 class="text-xs font-bold text-blue-900 uppercase tracking-wider">Mensualidad {{ mensualidad.codigo }}</h3>
                    </div>
                    <div class="p-5">
                        <p class="text-lg font-bold text-gray-900 mb-2">{{ mensualidad.servicio.nombre|default:"Tratamiento mensual" }}</p>
                        <p class="text-sm text-gray-600 mb-4">Periodo: {{ mensualidad.periodo_display }}</p>
                        <div class="flex justify-between items-center text-sm border-t border-gray-100 pt-3">
                            <span class="text-gray-500">Monto Mensual:</span>
                            <span class="font-bold text-gray-800">Bs. {{ mensualidad.costo_mensual }}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-2">
                            <span class="text-gray-500">Saldo Pendiente:</span>
                            <span class="font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded">Bs. {{ mensualidad.saldo_pendiente }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="lg:col-span-7">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 h-full flex flex-col relative overflow-hidden">
                    
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h2 class="font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            Detalle de Transacci√≥n
                        </h2>
                        <input type="date" name="fecha_pago" value="{{ fecha_hoy|date:'Y-m-d' }}" max="{{ fecha_hoy|date:'Y-m-d' }}" class="text-sm border-gray-200 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-600 font-medium">
                    </div>

                    <div class="p-6 space-y-6 flex-1 overflow-y-auto">
                        
                        {% if credito_disponible > 0 and modo != 'adelantado' %}
                        <div class="rounded-xl border border-emerald-200 bg-emerald-50/50 p-4 transition-all duration-300 hover:shadow-md">
                            <div class="flex items-center justify-between mb-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" name="usar_credito" id="usar_credito" class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-emerald-400 bg-white checked:bg-emerald-500 transition-all" onchange="toggleCredito()">
                                        <svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity" viewBox="0 0 14 14" fill="none"><path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                    </div>
                                    <span class="font-bold text-emerald-900">Usar Saldo a Favor (Credito)</span>
                                </label>
                                <span class="text-xs font-bold text-emerald-600 bg-white px-2 py-1 rounded border border-emerald-100">
                                    Disponible: Bs. {{ credito_disponible }}
                                </span>
                            </div>

                            <div id="campo-credito" class="hidden pl-8 animate-fade-in">
                                <div class="flex items-center gap-3">
                                    <div class="relative w-full max-w-[200px]">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-emerald-600 font-bold">Bs.</span>
                                        <input type="number" name="monto_credito" id="monto_credito" min="0" max="{{ credito_disponible }}" step="0.01" value="0" class="w-full pl-10 pr-3 py-2 text-emerald-800 font-bold border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 bg-white" oninput="calcularTotal()">
                                    </div>
                                    <button type="button" onclick="usarSoloPendiente()" class="text-xs bg-emerald-200 hover:bg-emerald-300 text-emerald-800 px-3 py-2 rounded-lg font-bold transition">
                                        Cubrir Todo
                                    </button>
                                </div>
                                <p class="text-[11px] text-emerald-600 mt-2">Este monto se descontar√° del Credito del paciente.</p>
                            </div>
                        </div>
                        {% endif %}

                        <div class="rounded-xl border border-gray-200 bg-slate-50 p-5 relative">
                            <div class="absolute -top-3 left-4 bg-white px-2 text-xs font-bold text-gray-500 uppercase tracking-wider border border-gray-100 rounded shadow-sm">
                                Pago Al Contado
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-1">
                                <div>
                                    <label class="block text-xs font-bold text-gray-600 mb-2">M√©todo de Pago *</label>
                                    <select name="metodo_pago" id="metodo_pago" class="w-full px-4 py-2.5 text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm" required>
                                        <option value="">-- Seleccionar --</option>
                                        {% for metodo in metodos_pago %}
                                        <option value="{{ metodo.id }}">{{ metodo.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-gray-600 mb-2">Monto a Recibir (Dinero) *</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Bs.</span>
                                        <input type="number" name="monto" id="monto" 
                                            step="0.01" min="0" 
                                            value="{{ monto_sugerido|default:'0' }}" 
                                            class="w-full pl-12 pr-4 py-2.5 text-xl font-bold text-gray-800 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-colors" 
                                            oninput="calcularTotal()" 
                                            placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            {% if modo == 'sesion' or modo == 'proyecto' or modo == 'mensualidad' %}
                            <label class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50 transition border border-transparent hover:border-gray-200 cursor-pointer">
                                <input type="checkbox" name="pago_completo" id="pago_completo" class="mt-1 rounded text-blue-600 focus:ring-blue-500" onchange="togglePagoCompleto()">
                                <div>
                                    <span class="block text-sm font-bold text-gray-700">Marcar deuda como Saldada</span>
                                    <span class="block text-xs text-gray-500">Ajusta autom√°ticamente el monto para dejar la deuda en 0.</span>
                                </div>
                            </label>
                            {% endif %}

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nota / Observaci√≥n</label>
                                <textarea name="observaciones" rows="2" class="w-full px-4 py-2 text-sm border-gray-300 rounded-lg focus:ring-indigo-500 bg-white placeholder-gray-300" placeholder="Ej: Pago realizado por el padre..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 border-t border-gray-200">
                        <div class="flex justify-between items-end mb-5">
                            <div class="space-y-1 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="w-20 text-gray-500">Contado:</span>
                                    <span id="resumen-adicional" class="font-bold text-gray-800">Bs. 0.00</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-20 text-gray-500">Credito:</span>
                                    <span id="resumen-credito" class="font-bold text-emerald-600">Bs. 0.00</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Total Transacci√≥n</span>
                                <span class="text-3xl font-black text-indigo-700 leading-none tracking-tight" id="resumen-total">Bs. {{ monto_sugerido|default:'0.00' }}</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            Confirmar Pago
                        </button>
                    </div>

                </div>
            </div>
        </div>
        {% endif %}
    </form>
</div>

<script>
let pacienteSeleccionadoId = null;
const creditoDisponible = parseFloat("{{ credito_disponible }}".replace(',','.')) || 0;
const montoPendiente = parseFloat("{{ monto_sugerido }}".replace(',','.')) || 0;

function cargarOpcionesPaciente() {
    const select = document.getElementById('paciente_select');
    const opciones = document.getElementById('opciones-tipo-pago');
    if (select && select.value) {
        pacienteSeleccionadoId = select.value;
        opciones.classList.remove('hidden');
        cargarProyectosPaciente(pacienteSeleccionadoId);
        cargarMensualidadesPaciente(pacienteSeleccionadoId);
    } else {
        pacienteSeleccionadoId = null;
        opciones.classList.add('hidden');
    }
}

function toggleSelectorTipo(tipo) {
    const proyectoCheck = document.getElementById('es_proyecto_checkbox');
    const mensualidadCheck = document.getElementById('es_mensualidad_checkbox');
    const selectorProyectos = document.getElementById('selector-proyectos');
    const selectorMensualidades = document.getElementById('selector-mensualidades');
    const botonAdelantado = document.getElementById('boton-adelantado');
    
    if (tipo === 'proyecto') {
        if (proyectoCheck.checked) {
            // Desmarcar mensualidad
            mensualidadCheck.checked = false;
            selectorMensualidades.classList.add('hidden');
            
            selectorProyectos.classList.remove('hidden');
            if(botonAdelantado) botonAdelantado.classList.add('hidden');
            if (pacienteSeleccionadoId) cargarProyectosPaciente(pacienteSeleccionadoId);
        } else {
            selectorProyectos.classList.add('hidden');
            if(botonAdelantado) botonAdelantado.classList.remove('hidden');
        }
    } else if (tipo === 'mensualidad') {
        if (mensualidadCheck.checked) {
            // Desmarcar proyecto
            proyectoCheck.checked = false;
            selectorProyectos.classList.add('hidden');
            
            selectorMensualidades.classList.remove('hidden');
            if(botonAdelantado) botonAdelantado.classList.add('hidden');
            if (pacienteSeleccionadoId) cargarMensualidadesPaciente(pacienteSeleccionadoId);
        } else {
            selectorMensualidades.classList.add('hidden');
            if(botonAdelantado) botonAdelantado.classList.remove('hidden');
        }
    }
}

async function cargarProyectosPaciente(pacienteId) {
    const select = document.getElementById('proyecto_select');
    if(!select) return;
    
    select.innerHTML = '<option value="">‚è≥ Buscando...</option>';
    select.disabled = true;
    
    try {
        const response = await fetch(`/facturacion/api/proyectos-paciente/${pacienteId}/`);
        const data = await response.json();
        
        select.innerHTML = '';
        select.disabled = false;
        
        if (data.success && data.proyectos && data.proyectos.length > 0) {
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Seleccionar Tratamiento --';
            select.appendChild(defaultOption);
            data.proyectos.forEach(proyecto => {
                const option = document.createElement('option');
                option.value = proyecto.id;
                option.textContent = `${proyecto.codigo} - ${proyecto.nombre} (Debe: Bs. ${proyecto.saldo_pendiente})`;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">‚úì Sin deudas de proyectos</option>';
        }
    } catch (error) {
        select.innerHTML = '<option value="">‚ùå Error de conexi√≥n</option>';
    }
}

// ‚úÖ MEJORADO: Funci√≥n para cargar mensualidades con mejor manejo de errores
async function cargarMensualidadesPaciente(pacienteId) {
    const select = document.getElementById('mensualidad_select');
    if(!select) {
        console.warn('‚ö†Ô∏è Select de mensualidades no encontrado');
        return;
    }
    
    select.innerHTML = '<option value="">‚è≥ Cargando mensualidades...</option>';
    select.disabled = true;
    
    try {
        console.log(`üì° Cargando mensualidades para paciente ${pacienteId}...`);
        
        const response = await fetch(`/facturacion/api/mensualidades-paciente/${pacienteId}/`);
        const data = await response.json();
        
        console.log('üì• Respuesta recibida:', data);
        
        select.innerHTML = '';
        select.disabled = false;
        
        if (data.success && data.mensualidades && data.mensualidades.length > 0) {
            // Opci√≥n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `-- Seleccionar Mensualidad (${data.mensualidades.length}) --`;
            select.appendChild(defaultOption);
            
            // Agregar cada mensualidad
            data.mensualidades.forEach(mensualidad => {
                const option = document.createElement('option');
                option.value = mensualidad.id;
                option.textContent = `${mensualidad.codigo} - ${mensualidad.periodo} (Debe: Bs. ${mensualidad.saldo_pendiente.toFixed(2)})`;
                option.setAttribute('data-monto', mensualidad.saldo_pendiente);
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${data.mensualidades.length} mensualidades cargadas`);
        } else {
            // Sin mensualidades pendientes
            select.innerHTML = '<option value="">‚úì Sin mensualidades pendientes</option>';
            console.log('‚ÑπÔ∏è No hay mensualidades con saldo pendiente');
        }
    } catch (error) {
        console.error('‚ùå Error al cargar mensualidades:', error);
        select.innerHTML = '<option value="">‚ùå Error al cargar mensualidades</option>';
        select.disabled = false;
        
        // Mostrar alerta al usuario
        alert(`‚ùå Error al cargar mensualidades: ${error.message}\n\nRevisa la consola del navegador para m√°s detalles.`);
    }
}

function irAProyecto() {
    const proyectoId = document.getElementById('proyecto_select').value;
    if (!proyectoId) { alert('‚ö†Ô∏è Por favor selecciona un proyecto'); return; }
    window.location.href = `/facturacion/pago/registrar/?proyecto=${proyectoId}`;
}

// ‚úÖ NUEVO: Funci√≥n para ir a mensualidad
function irAMensualidad() {
    const mensualidadId = document.getElementById('mensualidad_select').value;
    if (!mensualidadId) { alert('‚ö†Ô∏è Por favor selecciona una mensualidad'); return; }
    window.location.href = `/facturacion/pago/registrar/?mensualidad=${mensualidadId}`;
}

function irAPagoAdelantado() {
    if (!pacienteSeleccionadoId) { alert('‚ö†Ô∏è Selecciona un paciente primero'); return; }
    window.location.href = `/facturacion/pago/registrar/?paciente=${pacienteSeleccionadoId}`;
}

function toggleCredito() {
    const checkbox = document.getElementById('usar_credito');
    const campo = document.getElementById('campo-credito');
    
    if (checkbox && checkbox.checked) {
        campo.classList.remove('hidden');
        usarSoloPendiente();
    } else if (campo) {
        campo.classList.add('hidden');
        const inputCred = document.getElementById('monto_credito');
        if(inputCred) inputCred.value = 0;
        calcularTotal();
    }
}

function usarSoloPendiente() {
    let objetivo = montoPendiente > 0 ? montoPendiente : creditoDisponible;
    const montoCubrir = Math.min(creditoDisponible, objetivo);
    
    const inputCred = document.getElementById('monto_credito');
    if(inputCred) {
        inputCred.value = montoCubrir.toFixed(2);
        calcularTotal();
    }
}

function calcularTotal() {
    const usarCredito = document.getElementById('usar_credito')?.checked || false;
    const montoCredito = usarCredito ? (parseFloat(document.getElementById('monto_credito')?.value) || 0) : 0;
    const montoAdicional = parseFloat(document.getElementById('monto')?.value) || 0;
    
    if (montoCredito > creditoDisponible) {
        alert("El monto supera el cr√©dito disponible");
        document.getElementById('monto_credito').value = creditoDisponible.toFixed(2);
        return calcularTotal();
    }
    
    const total = montoCredito + montoAdicional;
    
    document.getElementById('resumen-credito').textContent = `Bs. ${montoCredito.toFixed(2)}`;
    document.getElementById('resumen-adicional').textContent = `Bs. ${montoAdicional.toFixed(2)}`;
    document.getElementById('resumen-total').textContent = `Bs. ${total.toFixed(2)}`;
    
    const metodo = document.getElementById('metodo_pago');
    
    if (montoAdicional > 0) {
        metodo.setAttribute('required', 'required');
    } else {
        metodo.removeAttribute('required');
    }
}

function togglePagoCompleto() {
    const check = document.getElementById('pago_completo');
    const montoInput = document.getElementById('monto');
    
    if (check && check.checked) {
        montoInput.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-800');
    } else {
        montoInput.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-800');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    calcularTotal();
});

document.getElementById('form-pago').addEventListener('submit', function(e) {
    const pagoCompleto = document.getElementById('pago_completo')?.checked || false;
    const usarCredito = document.getElementById('usar_credito')?.checked || false;
    const montoCredito = parseFloat(document.getElementById('monto_credito')?.value) || 0;
    const montoAdicional = parseFloat(document.getElementById('monto')?.value) || 0;
    const totalPago = montoCredito + montoAdicional;
    
    if (totalPago === 0 && !pagoCompleto && !usarCredito) {
        e.preventDefault();
        alert('‚ö†Ô∏è Debes especificar un monto a pagar o marcar "Pago Completo"');
        return false;
    }
    
    if (montoAdicional > 0) {
        const metodo = document.getElementById('metodo_pago').value;
        if (!metodo) {
            e.preventDefault();
            alert('‚ö†Ô∏è Selecciona un m√©todo de pago');
            document.getElementById('metodo_pago').focus();
            return false;
        }
    }
    
    return true;
});
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-down { animation: fadeInDown 0.4s ease-out; }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}