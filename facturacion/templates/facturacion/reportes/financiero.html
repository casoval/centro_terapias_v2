{% extends 'base.html' %}
{% block title %}Reporte Financiero Avanzado{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500;700&family=Playfair+Display:wght@700;900&display=swap');

  :root {
    --ink: #0c1220;
    --ink2: #1e2d40;
    --ink3: #2e4057;
    --muted: #5a6f8a;
    --muted2: #8299b0;
    --border: #dde4ef;
    --border2: #eef1f7;
    --surface: #f5f7fc;
    --surface2: #edf0f8;
    --white: #ffffff;

    /* Accents */
    --emerald: #059669;
    --emerald-d: #047857;
    --emerald-l: #d1fae5;
    --emerald-ll: #ecfdf5;
    --gold: #b45309;
    --gold-l: #fef3c7;
    --gold-ll: #fffbeb;
    --sapphire: #1d4ed8;
    --sapphire-l: #dbeafe;
    --sapphire-ll: #eff6ff;
    --ruby: #b91c1c;
    --ruby-l: #fee2e2;
    --ruby-ll: #fff5f5;
    --violet: #6d28d9;
    --violet-l: #ede9fe;
    --teal: #0d9488;
    --teal-l: #ccfbf1;
    --rose: #e11d48;
    --rose-l: #ffe4e6;
    --slate: #475569;
    --amber: #d97706;
    --amber-l: #fef3c7;
    --cyan: #0891b2;
    --cyan-l: #cffafe;
    --indigo: #4f46e5;
    --indigo-l: #e0e7ff;

    --shadow-sm: 0 1px 3px rgba(12,18,32,0.06), 0 1px 2px rgba(12,18,32,0.04);
    --shadow: 0 4px 12px rgba(12,18,32,0.08), 0 2px 4px rgba(12,18,32,0.05);
    --shadow-lg: 0 12px 32px rgba(12,18,32,0.12), 0 4px 8px rgba(12,18,32,0.06);
    --shadow-xl: 0 24px 64px rgba(12,18,32,0.16);

    --r-sm: 8px;
    --r: 12px;
    --r-lg: 16px;
    --r-xl: 20px;
  }

  * { box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--surface); color: var(--ink); }

  /* ‚îÄ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ‚îÄ */
  @media print {
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    body { background: white !important; font-size: 10px; }
    .page-break { page-break-before: always; }
    .hero-header { background: #0c1220 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .card, .chart-card { box-shadow: none !important; border: 1px solid #ddd !important; }
  }
  .print-only { display: none; }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .fin-wrap { max-width: 1380px; margin: 0 auto; padding: 16px 20px 40px; }

  /* ‚îÄ‚îÄ‚îÄ HERO HEADER ‚îÄ‚îÄ‚îÄ */
  .hero-header {
    background: linear-gradient(135deg, #0c1220 0%, #0f1e35 40%, #0c2340 70%, #091c30 100%);
    border-radius: var(--r-xl); padding: 28px 32px 24px; margin-bottom: 18px;
    color: white; position: relative; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.06);
  }
  .hero-header::before {
    content: ''; position: absolute; top: -60px; right: -40px;
    width: 280px; height: 280px;
    background: radial-gradient(circle, rgba(5,150,105,0.18) 0%, transparent 65%);
    border-radius: 50%; pointer-events: none;
  }
  .hero-header::after {
    content: ''; position: absolute; bottom: -40px; left: 30%;
    width: 200px; height: 200px;
    background: radial-gradient(circle, rgba(29,78,216,0.12) 0%, transparent 65%);
    border-radius: 50%; pointer-events: none;
  }
  .hero-nav { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; position: relative; z-index: 1; }
  .back-link { color: rgba(255,255,255,0.55); font-size: 0.72rem; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; letter-spacing: 0.03em; transition: color 0.15s; }
  .back-link:hover { color: rgba(255,255,255,0.9); }
  .hero-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn-ghost { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.85); font-size: 0.72rem; font-weight: 600; padding: 7px 14px; border-radius: var(--r-sm); cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.15s; }
  .btn-ghost:hover { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.25); }
  .hero-body { margin-top: 18px; position: relative; z-index: 1; }
  .hero-label { font-size: 0.62rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: rgba(5,150,105,0.9); margin-bottom: 6px; }
  .hero-title { font-family: 'Playfair Display', serif; font-size: 2.1rem; font-weight: 900; line-height: 1.1; margin: 0 0 6px; letter-spacing: -0.02em; }
  .hero-sub { font-size: 0.78rem; color: rgba(255,255,255,0.45); margin: 0 0 16px; }
  .hero-tags { display: flex; gap: 8px; flex-wrap: wrap; }
  .hero-tag { font-size: 0.68rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }
  .hero-tag.active { background: rgba(5,150,105,0.2); border-color: rgba(5,150,105,0.35); color: #6ee7b7; }

  /* ‚îÄ‚îÄ‚îÄ PERIOD TABS ‚îÄ‚îÄ‚îÄ */
  .period-rail { display: flex; align-items: center; gap: 0; background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 3px; margin-bottom: 14px; overflow-x: auto; box-shadow: var(--shadow-sm); flex-wrap: nowrap; }
  .period-tab { flex: none; font-size: 0.72rem; font-weight: 600; padding: 7px 15px; border-radius: 9px; cursor: pointer; white-space: nowrap; color: var(--muted); text-decoration: none; transition: all 0.15s; letter-spacing: 0.01em; }
  .period-tab.active { background: var(--ink); color: white; box-shadow: 0 2px 6px rgba(12,18,32,0.2); }
  .period-tab:hover:not(.active) { background: var(--surface); color: var(--ink); }

  /* ‚îÄ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ‚îÄ */
  .filter-bar { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 14px 16px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
  .filter-bar form { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end; }
  .filter-bar label { font-size: 0.65rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; display: block; margin-bottom: 4px; }
  .filter-group { display: flex; flex-direction: column; }
  .filter-bar select, .filter-bar input[type="date"] { padding: 8px 10px; font-size: 0.78rem; border: 1px solid var(--border); border-radius: var(--r-sm); color: var(--ink); font-family: 'DM Sans', sans-serif; background: var(--surface); transition: border-color 0.15s; outline: none; }
  .filter-bar select:focus, .filter-bar input[type="date"]:focus { border-color: var(--emerald); }
  .btn-primary { background: var(--emerald); color: white; border: none; padding: 8px 18px; border-radius: var(--r-sm); font-size: 0.78rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: background 0.15s; display: inline-flex; align-items: center; gap: 5px; }
  .btn-primary:hover { background: var(--emerald-d); }

  /* ‚îÄ‚îÄ‚îÄ PERIOD BADGE ‚îÄ‚îÄ‚îÄ */
  .period-indicator { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
  .period-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 0.72rem; font-weight: 700; padding: 5px 12px; border-radius: 20px; background: var(--emerald-ll); border: 1px solid #a7f3d0; color: var(--emerald-d); }
  .cierre-badge { font-size: 0.72rem; font-weight: 700; color: var(--amber); background: var(--amber-l); padding: 5px 12px; border-radius: 20px; border: 1px solid #fcd34d; }

  /* ‚îÄ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ‚îÄ */
  .sec-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
  .sec-hdr h2 { font-size: 0.95rem; font-weight: 700; color: var(--ink); margin: 0; display: flex; align-items: center; gap: 7px; }
  .sec-tag { font-size: 0.65rem; font-weight: 700; padding: 3px 9px; border-radius: 20px; }

  /* ‚îÄ‚îÄ‚îÄ KPI HERO CARDS ‚îÄ‚îÄ‚îÄ */
  .kpi-hero { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px; }
  .kpi-card {
    border-radius: var(--r-lg); padding: 20px 22px 18px; border: 1.5px solid; position: relative; overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
  .kpi-card .kc-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }
  .kpi-card .kc-label { font-size: 0.62rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; margin-bottom: 6px; opacity: 0.7; }
  .kpi-card .kc-val { font-size: 1.9rem; font-weight: 700; font-family: 'DM Mono', monospace; line-height: 1; letter-spacing: -0.02em; }
  .kpi-card .kc-sub { font-size: 0.7rem; margin-top: 8px; opacity: 0.65; }
  .kpi-card .kc-delta { position: absolute; top: 16px; right: 16px; font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 10px; background: rgba(255,255,255,0.2); }
  .kpi-card .kc-sparkline { position: absolute; bottom: 0; right: 0; opacity: 0.12; width: 100px; }

  /* ‚îÄ‚îÄ‚îÄ MINI STAT PILLS ‚îÄ‚îÄ‚îÄ */
  .stat-pills { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; margin-bottom: 16px; }
  .pill { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 13px 14px; box-shadow: var(--shadow-sm); }
  .pill-icon { font-size: 1.1rem; margin-bottom: 5px; }
  .pill-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 4px; }
  .pill-val { font-size: 1.15rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--ink); }
  .pill-sub { font-size: 0.6rem; color: var(--muted); margin-top: 2px; }

  /* ‚îÄ‚îÄ‚îÄ CHART CARDS ‚îÄ‚îÄ‚îÄ */
  .chart-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r-lg); padding: 18px 20px; box-shadow: var(--shadow-sm); }
  .chart-card .cc-title { font-size: 0.82rem; font-weight: 700; color: var(--ink); margin: 0 0 4px; }
  .chart-card .cc-sub { font-size: 0.67rem; color: var(--muted); margin: 0 0 14px; }

  /* ‚îÄ‚îÄ‚îÄ GRIDS ‚îÄ‚îÄ‚îÄ */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 14px; }
  .grid-1-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 14px; margin-bottom: 14px; }
  .grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 14px; margin-bottom: 14px; }
  @media (max-width: 900px) { .grid-2, .grid-3, .grid-1-2, .grid-2-1 { grid-template-columns: 1fr; } }

  /* ‚îÄ‚îÄ‚îÄ PAYMENT METHODS GRID ‚îÄ‚îÄ‚îÄ */
  .pago-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(175px, 1fr)); gap: 10px; margin-bottom: 16px; }
  .pago-card { background: var(--white); border: 1.5px solid var(--border); border-radius: var(--r-lg); padding: 16px; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; transition: transform 0.18s, box-shadow 0.18s; }
  .pago-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
  .pago-card .pg-accent { position: absolute; top: 0; left: 0; right: 0; height: 3px; border-radius: var(--r-lg) var(--r-lg) 0 0; }
  .pago-card .pg-icon { font-size: 1.5rem; margin-bottom: 8px; }
  .pago-card .pg-name { font-size: 0.67rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 6px; }
  .pago-card .pg-val { font-size: 1.25rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--ink); }
  .pago-card .pg-count { font-size: 0.65rem; color: var(--muted); margin-top: 2px; }
  .pago-card .pg-pct { font-size: 0.68rem; font-weight: 700; margin-top: 6px; }
  .pago-card .pg-bar { height: 3px; background: var(--border); border-radius: 10px; margin-top: 8px; overflow: hidden; }
  .pago-card .pg-fill { height: 100%; border-radius: 10px; transition: width 1.2s ease; }

  /* ‚îÄ‚îÄ‚îÄ CARD GENERIC ‚îÄ‚îÄ‚îÄ */
  .card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r-lg); padding: 16px 18px; box-shadow: var(--shadow-sm); }
  .card h3 { font-size: 0.82rem; font-weight: 700; color: var(--ink); margin: 0 0 12px; display: flex; align-items: center; gap: 6px; }

  /* ‚îÄ‚îÄ‚îÄ LIST ITEMS ‚îÄ‚îÄ‚îÄ */
  .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: var(--r-sm); background: var(--surface); margin-bottom: 6px; transition: background 0.12s; }
  .list-item:hover { background: var(--emerald-ll); }
  .li-rank { font-size: 0.7rem; font-weight: 700; color: var(--muted2); width: 20px; flex-shrink: 0; }
  .li-name { font-size: 0.8rem; font-weight: 700; color: var(--ink); }
  .li-sub { font-size: 0.63rem; color: var(--muted); margin-top: 2px; }
  .li-right { text-align: right; }
  .li-val { font-size: 0.9rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--emerald); }
  .li-pct { font-size: 0.62rem; color: var(--muted); margin-top: 2px; }
  .scroll-list { max-height: 280px; overflow-y: auto; padding-right: 4px; }
  .scroll-list::-webkit-scrollbar { width: 4px; }
  .scroll-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

  /* ‚îÄ‚îÄ‚îÄ DEUDORES ‚îÄ‚îÄ‚îÄ */
  .deudor-row { display: flex; justify-content: space-between; align-items: center; padding: 11px 14px; background: var(--ruby-ll); border: 1px solid #fecaca; border-radius: var(--r); margin-bottom: 6px; transition: background 0.12s; }
  .deudor-row:hover { background: var(--ruby-l); }
  .dr-name { font-size: 0.82rem; font-weight: 700; color: var(--ink); }
  .dr-detail { font-size: 0.63rem; color: var(--muted); margin-top: 2px; }
  .dr-badge { display: inline-block; font-size: 0.6rem; font-weight: 700; padding: 2px 7px; border-radius: 10px; margin-top: 3px; }
  .dr-debt { font-size: 1rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--ruby); }

  /* ‚îÄ‚îÄ‚îÄ ADELANTOS / CR√âDITO ‚îÄ‚îÄ‚îÄ */
  .adelanto-row { display: flex; justify-content: space-between; align-items: center; padding: 11px 14px; background: var(--sapphire-ll); border: 1px solid #bfdbfe; border-radius: var(--r); margin-bottom: 6px; transition: background 0.12s; }
  .adelanto-row:hover { background: var(--sapphire-l); }
  .adelanto-name { font-size: 0.82rem; font-weight: 700; color: var(--ink); }
  .adelanto-detail { font-size: 0.63rem; color: var(--muted); margin-top: 2px; }
  .adelanto-val { font-size: 1rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--sapphire); }

  /* ‚îÄ‚îÄ‚îÄ SIN COBRO ‚îÄ‚îÄ‚îÄ */
  .sincobro-row { display: flex; justify-content: space-between; align-items: center; padding: 11px 14px; background: var(--amber-l); border: 1px solid #fcd34d; border-radius: var(--r); margin-bottom: 6px; }
  .sincobro-name { font-size: 0.82rem; font-weight: 700; color: var(--ink); }
  .sincobro-detail { font-size: 0.63rem; color: var(--muted); margin-top: 2px; }
  .sincobro-val { font-size: 1rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--gold); }

  /* ‚îÄ‚îÄ‚îÄ CIERRE DE CAJA ‚îÄ‚îÄ‚îÄ */
  .cierre-box {
    background: linear-gradient(135deg, #0c1220 0%, #0f1e35 50%, #091c30 100%);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: var(--r-xl); padding: 26px 28px; color: white; margin-bottom: 18px;
    position: relative; overflow: hidden;
  }
  .cierre-box::before {
    content: ''; position: absolute; top: -80px; right: -40px; width: 300px; height: 300px;
    background: radial-gradient(circle, rgba(5,150,105,0.12) 0%, transparent 65%);
    border-radius: 50%;
  }
  .cierre-box h2 { font-size: 1rem; font-weight: 700; margin: 0 0 18px; color: #6ee7b7; display: flex; align-items: center; gap: 7px; position: relative; z-index: 1; }
  .cierre-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; position: relative; z-index: 1; }
  .ci { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--r); padding: 14px 16px; }
  .ci.ci-green { background: rgba(5,150,105,0.12); border-color: rgba(5,150,105,0.25); }
  .ci.ci-red { background: rgba(185,28,28,0.1); border-color: rgba(185,28,28,0.2); }
  .ci.ci-blue { background: rgba(29,78,216,0.1); border-color: rgba(29,78,216,0.2); }
  .ci.ci-amber { background: rgba(217,119,6,0.1); border-color: rgba(217,119,6,0.2); }
  .ci-label { font-size: 0.59rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; color: rgba(255,255,255,0.4); margin-bottom: 6px; }
  .ci-val { font-size: 1.25rem; font-weight: 700; font-family: 'DM Mono', monospace; color: white; }
  .ci-green .ci-val { color: #6ee7b7; }
  .ci-red .ci-val { color: #fca5a5; }
  .ci-blue .ci-val { color: #93c5fd; }
  .ci-amber .ci-val { color: #fcd34d; }
  .ci-sub { font-size: 0.61rem; color: rgba(255,255,255,0.3); margin-top: 3px; }
  .cierre-divider { border: none; border-top: 1px solid rgba(255,255,255,0.07); margin: 18px 0; position: relative; z-index: 1; }
  .cierre-neto { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; position: relative; z-index: 1; }
  .cierre-neto-val { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 900; color: #6ee7b7; letter-spacing: -0.02em; }
  .cierre-neto-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; color: rgba(255,255,255,0.35); margin-bottom: 4px; }
  .cierre-firma { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; position: relative; z-index: 1; }
  .firma-box { flex: 1; min-width: 130px; }
  .fb-label { font-size: 0.62rem; color: rgba(255,255,255,0.35); margin-bottom: 8px; display: block; }
  .fb-line { border-bottom: 1px solid rgba(255,255,255,0.15); height: 32px; }
  .fb-name { font-size: 0.6rem; color: rgba(255,255,255,0.25); text-align: center; margin-top: 5px; }
  .cierre-timestamp { font-size: 0.68rem; color: rgba(255,255,255,0.3); margin-top: 14px; display: flex; align-items: center; gap: 6px; position: relative; z-index: 1; }

  /* ‚îÄ‚îÄ‚îÄ EVOLUTION TABLE ‚îÄ‚îÄ‚îÄ */
  .evo-table { width: 100%; border-collapse: collapse; font-size: 0.77rem; }
  .evo-table thead th { background: var(--surface2); color: var(--muted); font-size: 0.63rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; padding: 10px 12px; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
  .evo-table tbody tr { border-bottom: 1px solid var(--border2); transition: background 0.1s; }
  .evo-table tbody tr:hover { background: var(--emerald-ll); }
  .evo-table td { padding: 10px 12px; }
  .evo-table .td-period { font-family: 'DM Sans', sans-serif; font-weight: 700; color: var(--ink); white-space: nowrap; }
  .evo-table .td-money { font-family: 'DM Mono', monospace; font-weight: 700; color: var(--emerald); }
  .evo-table .td-red { font-family: 'DM Mono', monospace; font-weight: 700; color: var(--ruby); }
  .evo-table .td-amber { font-family: 'DM Mono', monospace; font-weight: 700; color: var(--amber); }
  .evo-table .td-blue { font-family: 'DM Mono', monospace; font-weight: 700; color: var(--sapphire); }
  .evo-table .td-muted { font-family: 'DM Mono', monospace; color: var(--muted); }
  .evo-bar { height: 4px; background: var(--border); border-radius: 10px; overflow: hidden; min-width: 60px; }
  .evo-fill { height: 100%; background: linear-gradient(90deg, var(--emerald), #34d399); border-radius: 10px; }

  /* ‚îÄ‚îÄ‚îÄ TRANSACTIONS TABLE ‚îÄ‚îÄ‚îÄ */
  .tx-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
  .tx-table thead th { background: var(--surface2); color: var(--muted); font-size: 0.61rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; padding: 9px 10px; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
  .tx-table tbody tr { border-bottom: 1px solid var(--border2); transition: background 0.1s; }
  .tx-table tbody tr:hover { background: var(--surface); }
  .tx-table td { padding: 9px 10px; }
  .tx-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 0.62rem; font-weight: 700; padding: 3px 8px; border-radius: 20px; white-space: nowrap; }

  /* ‚îÄ‚îÄ‚îÄ PROGRESS BARS ‚îÄ‚îÄ‚îÄ */
  .prog-row { margin-bottom: 12px; }
  .prog-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .prog-label { font-size: 0.74rem; font-weight: 600; color: var(--ink); }
  .prog-vals { font-size: 0.7rem; font-family: 'DM Mono', monospace; color: var(--muted); }
  .prog-track { height: 6px; background: var(--border); border-radius: 10px; overflow: hidden; }
  .prog-fill { height: 100%; border-radius: 10px; transition: width 1.2s ease; }

  /* ‚îÄ‚îÄ‚îÄ ALERT BANNERS ‚îÄ‚îÄ‚îÄ */
  .alert { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; border-radius: var(--r); margin-bottom: 8px; border: 1px solid; }
  .alert-icon { font-size: 1rem; flex-shrink: 0; margin-top: 1px; }
  .alert-body { flex: 1; }
  .alert-title { font-size: 0.78rem; font-weight: 700; margin-bottom: 2px; }
  .alert-text { font-size: 0.7rem; }
  .alert-warning { background: var(--gold-ll); border-color: #fde68a; }
  .alert-warning .alert-title { color: var(--gold); }
  .alert-warning .alert-text { color: var(--amber); }
  .alert-info { background: var(--sapphire-ll); border-color: #bfdbfe; }
  .alert-info .alert-title { color: var(--sapphire); }
  .alert-info .alert-text { color: #1e40af; }
  .alert-success { background: var(--emerald-ll); border-color: #a7f3d0; }
  .alert-success .alert-title { color: var(--emerald-d); }
  .alert-success .alert-text { color: var(--emerald); }

  /* ‚îÄ‚îÄ‚îÄ RESUMEN TOTAL BOTTOM ‚îÄ‚îÄ‚îÄ */
  .total-footer { background: var(--ink); color: white; border-radius: var(--r-lg); padding: 18px 22px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-top: 8px; }
  .tf-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; color: rgba(255,255,255,0.45); margin-bottom: 4px; }
  .tf-val { font-size: 1.4rem; font-weight: 700; font-family: 'DM Mono', monospace; }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVENESS ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 640px) {
    .kpi-hero { grid-template-columns: 1fr 1fr; }
    .pago-grid { grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); }
    .hero-title { font-size: 1.5rem; }
  }

  /* ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
  .kpi-card, .pago-card, .pill { animation: fadeUp 0.4s ease both; }
  .kpi-card:nth-child(1) { animation-delay: 0.05s; }
  .kpi-card:nth-child(2) { animation-delay: 0.1s; }
  .kpi-card:nth-child(3) { animation-delay: 0.15s; }
  .kpi-card:nth-child(4) { animation-delay: 0.2s; }
  .kpi-card:nth-child(5) { animation-delay: 0.25s; }

  /* ‚îÄ‚îÄ‚îÄ SPARKLINE PLACEHOLDER ‚îÄ‚îÄ‚îÄ */
  .sparkline-svg { display: block; width: 100%; height: 36px; margin-top: 8px; opacity: 0.6; }

  /* ‚îÄ‚îÄ‚îÄ TABS WITHIN SECTIONS ‚îÄ‚îÄ‚îÄ */
  .inner-tabs { display: flex; gap: 0; background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-sm); padding: 2px; margin-bottom: 14px; overflow-x: auto; }
  .inner-tab { flex: none; font-size: 0.7rem; font-weight: 600; padding: 5px 12px; border-radius: 6px; cursor: pointer; white-space: nowrap; color: var(--muted); transition: all 0.12s; border: none; background: none; font-family: 'DM Sans', sans-serif; }
  .inner-tab.active { background: var(--white); color: var(--ink); box-shadow: var(--shadow-sm); }

  /* ‚îÄ‚îÄ‚îÄ DIVIDERS ‚îÄ‚îÄ‚îÄ */
  .section-divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

  /* ‚îÄ‚îÄ‚îÄ PERCENTAGE RING ‚îÄ‚îÄ‚îÄ */
  .ring-wrap { display: flex; align-items: center; gap: 10px; }
  .ring-info { }
  .ring-pct { font-size: 1.1rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--ink); }
  .ring-label { font-size: 0.65rem; color: var(--muted); margin-top: 2px; }

  /* ‚îÄ‚îÄ‚îÄ TOTAL PENDIENTES ‚îÄ‚îÄ‚îÄ */
  .pendiente-footer { background: var(--ruby-l); border: 1px solid #fca5a5; border-radius: var(--r); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
  .pf-label { font-size: 0.8rem; font-weight: 700; color: var(--ruby); }
  .pf-val { font-size: 1.2rem; font-weight: 700; font-family: 'DM Mono', monospace; color: var(--ruby); }

  /* ‚îÄ‚îÄ‚îÄ STICKY SUMMARY BAR ‚îÄ‚îÄ‚îÄ */
  .sticky-bar { position: sticky; top: 0; z-index: 100; background: rgba(245,247,252,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 8px 20px; margin: -16px -20px 16px; display: flex; gap: 20px; overflow-x: auto; }
  .sb-item { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
  .sb-val { font-size: 0.9rem; font-weight: 700; font-family: 'DM Mono', monospace; }
  .sb-label { font-size: 0.56rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
</style>

<div class="fin-wrap">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HERO HEADER -->
  <div class="hero-header no-print">
    <div class="hero-nav">
      <a href="{% url 'facturacion:dashboard_reportes' %}" class="back-link">‚Üê Volver a Reportes</a>
      <div class="hero-actions">
        <button onclick="window.print()" class="btn-ghost">üñ®Ô∏è Imprimir</button>
        <button onclick="exportarCSV()" class="btn-ghost">üì• Exportar CSV</button>
      </div>
    </div>
    <div class="hero-body">
      <div class="hero-label">Centro de Anal√≠tica Financiera</div>
      <h1 class="hero-title">Reporte Financiero</h1>
      <p class="hero-sub">Ingresos ¬∑ M√©todos de pago ¬∑ Saldos ¬∑ Deudores ¬∑ Adelantos ¬∑ Evoluci√≥n temporal</p>
      <div class="hero-tags">
        <span class="hero-tag active">üíµ Efectivo</span>
        <span class="hero-tag active">üì± QR</span>
        <span class="hero-tag active">üè¶ Transferencia</span>
        <span class="hero-tag active">üí≥ Tarjeta</span>
        <span class="hero-tag active">üîÆ Cr√©dito</span>
        <span class="hero-tag active">‚è© Adelantos</span>
        <span class="hero-tag active">üéÅ Sin Cobro</span>
        <span class="hero-tag active">‚Ü©Ô∏è Devoluciones</span>
      </div>
    </div>
  </div>

  <!-- Print Header -->
  <div class="print-only" style="margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #e2e8f0;">
    <h1 style="font-size:1.4rem;font-weight:800;margin:0 0 4px;">Reporte Financiero</h1>
    <p style="color:#64748b;font-size:0.78rem;margin:0">Per√≠odo: {{ fecha_desde|date:"d/m/Y" }} ‚Äî {{ fecha_hasta|date:"d/m/Y" }} ¬∑ Generado: {% now "d/m/Y H:i" %} ¬∑ Por: {{ request.user.get_full_name|default:request.user.username }}</p>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERIOD TABS -->
  <div class="period-rail no-print">
    <a href="?rango=hoy"            class="period-tab {% if rango == 'hoy' %}active{% endif %}">üìÖ Hoy</a>
    <a href="?rango=ayer"           class="period-tab {% if rango == 'ayer' %}active{% endif %}">‚óÄ Ayer</a>
    <a href="?rango=semana"         class="period-tab {% if rango == 'semana' %}active{% endif %}">üóì Esta Semana</a>
    <a href="?rango=semana_anterior" class="period-tab {% if rango == 'semana_anterior' %}active{% endif %}">Sem. Ant.</a>
    <a href="?rango=mes"            class="period-tab {% if rango == 'mes' %}active{% endif %}">üìÖ Este Mes</a>
    <a href="?rango=mes_anterior"   class="period-tab {% if rango == 'mes_anterior' %}active{% endif %}">Mes Ant.</a>
    <a href="?rango=trimestre"      class="period-tab {% if rango == 'trimestre' %}active{% endif %}">üìä Trimestre</a>
    <a href="?rango=anio"           class="period-tab {% if rango == 'anio' %}active{% endif %}">üìà A√±o</a>
    <a href="?rango=cierre"         class="period-tab {% if rango == 'cierre' %}active{% endif %}">üîí Cierre de Caja</a>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTER BAR -->
  <div class="filter-bar no-print">
    <form method="get">
      <div class="filter-group">
        <label>Desde</label>
        <input type="date" name="fecha_desde" value="{{ fecha_desde }}" />
      </div>
      <div class="filter-group">
        <label>Hasta</label>
        <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}" />
      </div>
      <div class="filter-group">
        <label>Sucursal</label>
        <select name="sucursal">
          <option value="">Todas las sucursales</option>
          {% for s in sucursales %}<option value="{{ s.id }}" {% if sucursal_id == s.id|stringformat:"s" %}selected{% endif %}>{{ s.nombre }}</option>{% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label>M√©todo de Pago</label>
        <select name="metodo">
          <option value="">Todos los m√©todos</option>
          {% for m in metodos_pago %}<option value="{{ m.id }}" {% if metodo_id == m.id|stringformat:"s" %}selected{% endif %}>{{ m.nombre }}</option>{% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label>Profesional</label>
        <select name="profesional">
          <option value="">Todos</option>
          {% for p in profesionales %}<option value="{{ p.id }}" {% if profesional_id == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }} {{ p.apellido }}</option>{% endfor %}
        </select>
      </div>
      <button type="submit" class="btn-primary">üîç Aplicar Filtros</button>
    </form>
  </div>

  <!-- Period indicator -->
  <div class="period-indicator">
    <span class="period-badge">üìÖ {{ fecha_desde|date:"d/m/Y" }} ‚Äî {{ fecha_hasta|date:"d/m/Y" }}</span>
    {% if rango == 'cierre' %}<span class="cierre-badge">üîí Modo Cierre de Caja</span>{% endif %}
    {% if sucursal_filtrada %}<span class="period-badge" style="background:var(--sapphire-ll);border-color:#93c5fd;color:var(--sapphire)">üè¢ {{ sucursal_filtrada }}</span>{% endif %}
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KPI HERO CARDS -->
  <div class="sec-hdr"><h2>üí∞ Resumen General del Per√≠odo</h2></div>
  <div class="kpi-hero">
    <!-- Total Cobrado -->
    <div class="kpi-card" style="background:var(--emerald-ll);border-color:#6ee7b7;color:var(--emerald-d)">
      <span class="kc-icon">üíµ</span>
      <div class="kc-label">Total Cobrado</div>
      <div class="kc-val">Bs. {{ stats.total_cobrado|default:0|floatformat:2 }}</div>
      <div class="kc-sub">{{ stats.total_pagos|default:0 }} transacciones ¬∑ per√≠odo seleccionado</div>
    </div>
    <!-- Por Cobrar -->
    <div class="kpi-card" style="background:var(--ruby-ll);border-color:#fca5a5;color:var(--ruby)">
      <span class="kc-icon">‚è≥</span>
      <div class="kc-label">Por Cobrar</div>
      <div class="kc-val">Bs. {{ stats.total_pendiente|default:0|floatformat:2 }}</div>
      <div class="kc-sub">{{ stats.pacientes_deudores|default:0 }} pacientes con saldo negativo</div>
    </div>
    <!-- Adelantos / Cr√©dito -->
    <div class="kpi-card" style="background:var(--sapphire-ll);border-color:#93c5fd;color:var(--sapphire)">
      <span class="kc-icon">‚è©</span>
      <div class="kc-label">Adelantos / Cr√©dito</div>
      <div class="kc-val">Bs. {{ stats.total_adelantos|default:0|floatformat:2 }}</div>
      <div class="kc-sub">{{ stats.pacientes_con_credito|default:0 }} pacientes con saldo a favor</div>
    </div>
    <!-- Sin Cobro -->
    <div class="kpi-card" style="background:var(--gold-ll);border-color:#fcd34d;color:var(--gold)">
      <span class="kc-icon">üéÅ</span>
      <div class="kc-label">Sesiones Sin Cobro</div>
      <div class="kc-val">{{ stats.sesiones_sin_cobro|default:0 }}</div>
      <div class="kc-sub">Bs. {{ stats.monto_sin_cobro|default:0|floatformat:2 }} valor referencial</div>
    </div>
    <!-- Neto Final -->
    <div class="kpi-card" style="background:var(--ink2);border-color:var(--ink3);color:white">
      <span class="kc-icon">‚úÖ</span>
      <div class="kc-label" style="color:rgba(255,255,255,0.6)">Neto Final</div>
      <div class="kc-val" style="color:#6ee7b7">Bs. {{ stats.neto_final|default:0|floatformat:2 }}</div>
      <div class="kc-sub" style="color:rgba(255,255,255,0.4)">Cobrado menos devoluciones</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MINI PILLS -->
  <div class="stat-pills">
    <div class="pill">
      <div class="pill-icon">üìä</div>
      <div class="pill-label">Sesiones Realizadas</div>
      <div class="pill-val" style="color:var(--emerald)">{{ stats.sesiones_realizadas|default:0 }}</div>
      <div class="pill-sub">de {{ stats.total_sesiones|default:0 }} programadas</div>
    </div>
    <div class="pill">
      <div class="pill-icon">üìã</div>
      <div class="pill-label">Sesiones Pendientes</div>
      <div class="pill-val" style="color:var(--ruby)">{{ stats.sesiones_pendientes|default:0 }}</div>
      <div class="pill-sub">sin realizar</div>
    </div>
    <div class="pill">
      <div class="pill-icon">üí∞</div>
      <div class="pill-label">Promedio / Sesi√≥n</div>
      <div class="pill-val" style="color:var(--sapphire)">{{ stats.promedio_sesion|default:0|floatformat:0 }}</div>
      <div class="pill-sub">bolivianos</div>
    </div>
    <div class="pill">
      <div class="pill-icon">üìÅ</div>
      <div class="pill-label">Proyectos Activos</div>
      <div class="pill-val" style="color:var(--teal)">{{ stats.proyectos_activos|default:0 }}</div>
      <div class="pill-sub">en curso</div>
    </div>
    <div class="pill">
      <div class="pill-icon">üìÖ</div>
      <div class="pill-label">Mensualidades</div>
      <div class="pill-val" style="color:var(--violet)">{{ stats.mensualidades_activas|default:0 }}</div>
      <div class="pill-sub">activas</div>
    </div>
    <div class="pill">
      <div class="pill-icon">‚Ü©Ô∏è</div>
      <div class="pill-label">Devoluciones</div>
      <div class="pill-val" style="color:var(--ruby)">{{ stats.total_devoluciones_count|default:0 }}</div>
      <div class="pill-sub">Bs. {{ stats.devoluciones|default:0|floatformat:0 }}</div>
    </div>
    <div class="pill">
      <div class="pill-icon">üßæ</div>
      <div class="pill-label">Facturas Emitidas</div>
      <div class="pill-val" style="color:var(--sapphire)">{{ stats.facturas_emitidas|default:0 }}</div>
      <div class="pill-sub">en el per√≠odo</div>
    </div>
    <div class="pill">
      <div class="pill-icon">‚ùå</div>
      <div class="pill-label">Pagos Anulados</div>
      <div class="pill-val" style="color:var(--slate)">{{ stats.pagos_anulados|default:0 }}</div>
      <div class="pill-sub">Bs. {{ stats.monto_anulado|default:0|floatformat:0 }}</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ALERTAS -->
  {% if stats.total_pendiente > 0 %}
  <div class="alert alert-warning">
    <span class="alert-icon">‚ö†Ô∏è</span>
    <div class="alert-body">
      <div class="alert-title">Saldo Pendiente por Cobrar</div>
      <div class="alert-text">Hay Bs. {{ stats.total_pendiente|floatformat:2 }} pendientes de {{ stats.pacientes_deudores|default:0 }} paciente(s). Revisar la secci√≥n de deudores abajo.</div>
    </div>
  </div>
  {% endif %}
  {% if stats.total_adelantos > 0 %}
  <div class="alert alert-info">
    <span class="alert-icon">üí°</span>
    <div class="alert-body">
      <div class="alert-title">Cr√©ditos / Adelantos Disponibles</div>
      <div class="alert-text">{{ stats.pacientes_con_credito|default:0 }} paciente(s) tienen Bs. {{ stats.total_adelantos|floatformat:2 }} de saldo a favor que puede usarse en pr√≥ximas sesiones.</div>
    </div>
  </div>
  {% endif %}
  {% if stats.sesiones_sin_cobro > 0 %}
  <div class="alert alert-success">
    <span class="alert-icon">üéÅ</span>
    <div class="alert-body">
      <div class="alert-title">Sesiones Gratuitas / Sin Cobro</div>
      <div class="alert-text">{{ stats.sesiones_sin_cobro|default:0 }} sesi√≥n(es) marcadas como sin cobro en el per√≠odo (valor referencial: Bs. {{ stats.monto_sin_cobro|default:0|floatformat:2 }}).</div>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARTS -->
  {% if grafico_data %}
  <div class="sec-hdr"><h2>üìà An√°lisis Gr√°fico</h2></div>
  <div class="grid-2" style="margin-bottom:14px">
    <div class="chart-card">
      <div class="cc-title">Evoluci√≥n de Ingresos</div>
      <div class="cc-sub">Cobrado vs Pendiente por per√≠odo</div>
      <canvas id="chart-ingresos" height="160"></canvas>
    </div>
    <div class="chart-card">
      <div class="cc-title">Distribuci√≥n por M√©todo de Pago</div>
      <div class="cc-sub">% del total cobrado</div>
      <canvas id="chart-metodos" height="160"></canvas>
    </div>
  </div>

  <div class="grid-3" style="margin-bottom:14px">
    <div class="chart-card">
      <div class="cc-title">Tipos de Cobro</div>
      <div class="cc-sub">Sesiones ¬∑ Mensualidades ¬∑ Proyectos</div>
      <canvas id="chart-tipos" height="160"></canvas>
    </div>
    <div class="chart-card">
      <div class="cc-title">Efectivo vs Digital</div>
      <div class="cc-sub">Comparativa m√©todos f√≠sicos vs digitales</div>
      <canvas id="chart-efectivo-digital" height="160"></canvas>
    </div>
    <div class="chart-card">
      <div class="cc-title">Ingresos Netos</div>
      <div class="cc-sub">Cobrado menos devoluciones</div>
      <canvas id="chart-neto" height="160"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAYMENT METHODS DETAIL -->
  <div class="sec-hdr">
    <h2>üí≥ Desglose Completo por M√©todo de Pago</h2>
    {% if stats.por_metodo %}<span class="sec-tag" style="background:var(--emerald-ll);color:var(--emerald-d)">{{ stats.por_metodo|length }} m√©todos</span>{% endif %}
  </div>
  <div class="pago-grid">

    <!-- EFECTIVO -->
    {% with efectivo_pct=stats.efectivo|default:0 %}
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#16a34a,#4ade80)"></div>
      <div class="pg-icon">üíµ</div>
      <div class="pg-name">Efectivo</div>
      <div class="pg-val">Bs. {{ stats.efectivo|default:0|floatformat:2 }}</div>
      <div class="pg-count">{{ stats.efectivo_count|default:0 }} transacciones</div>
      <div class="pg-pct" style="color:var(--emerald)">{{ stats.efectivo_pct|default:0|floatformat:1 }}% del total</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ stats.efectivo_pct|default:0 }}%;background:linear-gradient(90deg,#16a34a,#4ade80)"></div></div>
    </div>
    {% endwith %}

    <!-- QR -->
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#7c3aed,#a78bfa)"></div>
      <div class="pg-icon">üì±</div>
      <div class="pg-name">Pago QR</div>
      <div class="pg-val">Bs. {{ stats.qr|default:0|floatformat:2 }}</div>
      <div class="pg-count">{{ stats.qr_count|default:0 }} transacciones</div>
      <div class="pg-pct" style="color:var(--violet)">{{ stats.qr_pct|default:0|floatformat:1 }}% del total</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ stats.qr_pct|default:0 }}%;background:linear-gradient(90deg,#7c3aed,#a78bfa)"></div></div>
    </div>

    <!-- TRANSFERENCIA -->
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#1d4ed8,#60a5fa)"></div>
      <div class="pg-icon">üè¶</div>
      <div class="pg-name">Transferencia</div>
      <div class="pg-val">Bs. {{ stats.transferencia|default:0|floatformat:2 }}</div>
      <div class="pg-count">{{ stats.transferencia_count|default:0 }} transacciones</div>
      <div class="pg-pct" style="color:var(--sapphire)">{{ stats.transferencia_pct|default:0|floatformat:1 }}% del total</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ stats.transferencia_pct|default:0 }}%;background:linear-gradient(90deg,#1d4ed8,#60a5fa)"></div></div>
    </div>

    <!-- TARJETA -->
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#0d9488,#2dd4bf)"></div>
      <div class="pg-icon">üí≥</div>
      <div class="pg-name">Tarjeta</div>
      <div class="pg-val">Bs. {{ stats.tarjeta|default:0|floatformat:2 }}</div>
      <div class="pg-count">{{ stats.tarjeta_count|default:0 }} transacciones</div>
      <div class="pg-pct" style="color:var(--teal)">{{ stats.tarjeta_pct|default:0|floatformat:1 }}% del total</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ stats.tarjeta_pct|default:0 }}%;background:linear-gradient(90deg,#0d9488,#2dd4bf)"></div></div>
    </div>

    <!-- CR√âDITO / CUENTA CORRIENTE -->
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#b45309,#fbbf24)"></div>
      <div class="pg-icon">üîÆ</div>
      <div class="pg-name">Cr√©dito / Cta. Cte.</div>
      <div class="pg-val">Bs. {{ stats.credito|default:0|floatformat:2 }}</div>
      <div class="pg-count">{{ stats.credito_count|default:0 }} usos de cr√©dito</div>
      <div class="pg-pct" style="color:var(--gold)">{{ stats.credito_pct|default:0|floatformat:1 }}% del total</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ stats.credito_pct|default:0 }}%;background:linear-gradient(90deg,#b45309,#fbbf24)"></div></div>
    </div>

    <!-- ADELANTOS USADOS -->
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#0891b2,#22d3ee)"></div>
      <div class="pg-icon">‚è©</div>
      <div class="pg-name">Adelantos Usados</div>
      <div class="pg-val">Bs. {{ stats.adelantos_usados|default:0|floatformat:2 }}</div>
      <div class="pg-count">{{ stats.adelantos_usados_count|default:0 }} aplicaciones</div>
      <div class="pg-pct" style="color:var(--cyan)">Bs. {{ stats.total_adelantos|default:0|floatformat:0 }} en saldo</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ stats.adelantos_usados_pct|default:0 }}%;background:linear-gradient(90deg,#0891b2,#22d3ee)"></div></div>
    </div>

    <!-- SIN COBRO -->
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#d97706,#fde68a)"></div>
      <div class="pg-icon">üéÅ</div>
      <div class="pg-name">Sin Cobro / Gratuito</div>
      <div class="pg-val">{{ stats.sesiones_sin_cobro|default:0 }} ses.</div>
      <div class="pg-count">Valor ref: Bs. {{ stats.monto_sin_cobro|default:0|floatformat:2 }}</div>
      <div class="pg-pct" style="color:var(--amber)">no facturado</div>
      <div class="pg-bar"><div class="pg-fill" style="width:0%;background:linear-gradient(90deg,#d97706,#fde68a)"></div></div>
    </div>

    <!-- DEVOLUCIONES -->
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#b91c1c,#f87171)"></div>
      <div class="pg-icon">‚Ü©Ô∏è</div>
      <div class="pg-name">Devoluciones</div>
      <div class="pg-val" style="color:var(--ruby)">- Bs. {{ stats.devoluciones|default:0|floatformat:2 }}</div>
      <div class="pg-count">{{ stats.total_devoluciones_count|default:0 }} reembolsos</div>
      <div class="pg-pct" style="color:var(--ruby)">resta del total</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ stats.devoluciones_pct|default:0 }}%;background:linear-gradient(90deg,#b91c1c,#f87171)"></div></div>
    </div>

    <!-- Otros m√©todos din√°micos -->
    {% for m in stats.por_metodo %}
    {% if m.metodo_pago__nombre != 'Efectivo' and m.metodo_pago__nombre != 'QR' and m.metodo_pago__nombre != 'Transferencia' and m.metodo_pago__nombre != 'Tarjeta' %}
    <div class="pago-card">
      <div class="pg-accent" style="background:linear-gradient(90deg,#4f46e5,#818cf8)"></div>
      <div class="pg-icon">üí¥</div>
      <div class="pg-name">{{ m.metodo_pago__nombre }}</div>
      <div class="pg-val">Bs. {{ m.total|floatformat:2 }}</div>
      <div class="pg-count">{{ m.cantidad }} transacciones</div>
      <div class="pg-pct" style="color:var(--indigo)">{{ m.porcentaje|default:0|floatformat:1 }}%</div>
      <div class="pg-bar"><div class="pg-fill" style="width:{{ m.porcentaje|default:0 }}%;background:linear-gradient(90deg,#4f46e5,#818cf8)"></div></div>
    </div>
    {% endif %}
    {% endfor %}
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INGRESO POR TIPO -->
  <div class="sec-hdr"><h2>üè∑Ô∏è Ingresos por Tipo de Cobro</h2></div>
  <div class="grid-3" style="margin-bottom:16px">
    <!-- Sesiones -->
    <div class="card">
      <h3>üßë‚Äç‚öïÔ∏è Sesiones</h3>
      <div class="prog-row">
        <div class="prog-header">
          <span class="prog-label">Sesiones Normales</span>
          <span class="prog-vals">Bs. {{ stats.pagos_sesiones|default:0|floatformat:0 }}</span>
        </div>
        <div class="prog-track"><div class="prog-fill" style="width:{{ stats.sesiones_pct|default:0 }}%;background:linear-gradient(90deg,#059669,#34d399)"></div></div>
      </div>
      <div class="prog-row">
        <div class="prog-header">
          <span class="prog-label">Sesiones Programadas</span>
          <span class="prog-vals">{{ stats.sesiones_realizadas|default:0 }} realizadas</span>
        </div>
        <div class="prog-track"><div class="prog-fill" style="width:{{ stats.realizacion_pct|default:0 }}%;background:linear-gradient(90deg,#0891b2,#22d3ee)"></div></div>
      </div>
      <div style="margin-top:12px;padding:10px 12px;background:var(--emerald-ll);border-radius:var(--r-sm)">
        <div style="font-size:0.62rem;color:var(--emerald-d);font-weight:700;margin-bottom:3px">TOTAL SESIONES</div>
        <div style="font-size:1.2rem;font-weight:700;font-family:'DM Mono',monospace;color:var(--emerald-d)">Bs. {{ stats.pagos_sesiones|default:0|floatformat:2 }}</div>
        <div style="font-size:0.65rem;color:var(--emerald)">{{ stats.sesiones_pct|default:0|floatformat:1 }}% del ingreso total</div>
      </div>
    </div>
    <!-- Mensualidades -->
    <div class="card">
      <h3>üìÖ Mensualidades</h3>
      <div class="prog-row">
        <div class="prog-header">
          <span class="prog-label">Mensualidades Cobradas</span>
          <span class="prog-vals">Bs. {{ stats.pagos_mensualidades|default:0|floatformat:0 }}</span>
        </div>
        <div class="prog-track"><div class="prog-fill" style="width:{{ stats.mensualidades_pct|default:0 }}%;background:linear-gradient(90deg,#7c3aed,#a78bfa)"></div></div>
      </div>
      <div class="prog-row">
        <div class="prog-header">
          <span class="prog-label">Mensualidades Activas</span>
          <span class="prog-vals">{{ stats.mensualidades_activas|default:0 }} activas</span>
        </div>
        <div class="prog-track"><div class="prog-fill" style="width:70%;background:linear-gradient(90deg,#6d28d9,#8b5cf6)"></div></div>
      </div>
      <div style="margin-top:12px;padding:10px 12px;background:var(--violet-l);border-radius:var(--r-sm)">
        <div style="font-size:0.62rem;color:#5b21b6;font-weight:700;margin-bottom:3px">TOTAL MENSUALIDADES</div>
        <div style="font-size:1.2rem;font-weight:700;font-family:'DM Mono',monospace;color:#5b21b6">Bs. {{ stats.pagos_mensualidades|default:0|floatformat:2 }}</div>
        <div style="font-size:0.65rem;color:var(--violet)">{{ stats.mensualidades_pct|default:0|floatformat:1 }}% del ingreso total</div>
      </div>
    </div>
    <!-- Proyectos -->
    <div class="card">
      <h3>üìÅ Proyectos</h3>
      <div class="prog-row">
        <div class="prog-header">
          <span class="prog-label">Pagos de Proyectos</span>
          <span class="prog-vals">Bs. {{ stats.pagos_proyectos|default:0|floatformat:0 }}</span>
        </div>
        <div class="prog-track"><div class="prog-fill" style="width:{{ stats.proyectos_pct|default:0 }}%;background:linear-gradient(90deg,#0d9488,#2dd4bf)"></div></div>
      </div>
      <div class="prog-row">
        <div class="prog-header">
          <span class="prog-label">Proyectos Activos</span>
          <span class="prog-vals">{{ stats.proyectos_activos|default:0 }} activos</span>
        </div>
        <div class="prog-track"><div class="prog-fill" style="width:65%;background:linear-gradient(90deg,#0f766e,#0d9488)"></div></div>
      </div>
      <div style="margin-top:12px;padding:10px 12px;background:var(--teal-l);border-radius:var(--r-sm)">
        <div style="font-size:0.62rem;color:#0f766e;font-weight:700;margin-bottom:3px">TOTAL PROYECTOS</div>
        <div style="font-size:1.2rem;font-weight:700;font-family:'DM Mono',monospace;color:#0f766e">Bs. {{ stats.pagos_proyectos|default:0|floatformat:2 }}</div>
        <div style="font-size:0.65rem;color:var(--teal)">{{ stats.proyectos_pct|default:0|floatformat:1 }}% del ingreso total</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CIERRE DE CAJA -->
  <div class="cierre-box">
    <h2>üîí Cierre de Caja ‚Äî {{ fecha_desde|date:"d/m/Y" }}{% if fecha_desde != fecha_hasta %} al {{ fecha_hasta|date:"d/m/Y" }}{% endif %}</h2>
    <div class="cierre-grid">
      <div class="ci ci-green">
        <div class="ci-label">Total Cobrado</div>
        <div class="ci-val">Bs. {{ stats.total_cobrado|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.total_pagos|default:0 }} transacciones</div>
      </div>
      <div class="ci">
        <div class="ci-label">üíµ Efectivo en Caja</div>
        <div class="ci-val">Bs. {{ stats.efectivo|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.efectivo_count|default:0 }} pagos</div>
      </div>
      <div class="ci">
        <div class="ci-label">üì± QR / Digital</div>
        <div class="ci-val">Bs. {{ stats.qr|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.qr_count|default:0 }} pagos</div>
      </div>
      <div class="ci">
        <div class="ci-label">üè¶ Transferencias</div>
        <div class="ci-val">Bs. {{ stats.transferencia|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.transferencia_count|default:0 }} pagos</div>
      </div>
      <div class="ci">
        <div class="ci-label">üí≥ Tarjeta</div>
        <div class="ci-val">Bs. {{ stats.tarjeta|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.tarjeta_count|default:0 }} pagos</div>
      </div>
      <div class="ci ci-amber">
        <div class="ci-label">‚è© Adelantos Ingresados</div>
        <div class="ci-val">Bs. {{ stats.pagos_adelantados|default:0|floatformat:2 }}</div>
        <div class="ci-sub">pagos anticipados</div>
      </div>
      <div class="ci">
        <div class="ci-label">üîÆ Cr√©dito Aplicado</div>
        <div class="ci-val">Bs. {{ stats.credito|default:0|floatformat:2 }}</div>
        <div class="ci-sub">de cuenta corriente</div>
      </div>
      <div class="ci ci-red">
        <div class="ci-label">‚Ü©Ô∏è Devoluciones</div>
        <div class="ci-val">- Bs. {{ stats.devoluciones|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.total_devoluciones_count|default:0 }} reembolsos</div>
      </div>
      <div class="ci ci-red">
        <div class="ci-label">‚è≥ Saldo Pendiente</div>
        <div class="ci-val">Bs. {{ stats.total_pendiente|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.pacientes_deudores|default:0 }} pacientes</div>
      </div>
      <div class="ci ci-blue">
        <div class="ci-label">üí∞ Saldo a Favor</div>
        <div class="ci-val">Bs. {{ stats.total_adelantos|default:0|floatformat:2 }}</div>
        <div class="ci-sub">{{ stats.pacientes_con_credito|default:0 }} pacientes</div>
      </div>
      <div class="ci">
        <div class="ci-label">üéÅ Sin Cobro</div>
        <div class="ci-val">{{ stats.sesiones_sin_cobro|default:0 }} ses.</div>
        <div class="ci-sub">Ref: Bs. {{ stats.monto_sin_cobro|default:0|floatformat:2 }}</div>
      </div>
      <div class="ci">
        <div class="ci-label">‚ùå Pagos Anulados</div>
        <div class="ci-val">{{ stats.pagos_anulados|default:0 }}</div>
        <div class="ci-sub">Bs. {{ stats.monto_anulado|default:0|floatformat:2 }}</div>
      </div>
    </div>

    <hr class="cierre-divider">

    <div class="cierre-neto">
      <div>
        <div class="cierre-neto-label">NETO FINAL DEL PER√çODO</div>
        <div class="cierre-neto-val">Bs. {{ stats.neto_final|default:0|floatformat:2 }}</div>
        <div style="font-size:0.68rem;color:rgba(255,255,255,0.35);margin-top:4px">Cobrado ‚àí Devoluciones = Neto real</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:0.62rem;color:rgba(255,255,255,0.35);margin-bottom:6px">SESIONES REALIZADAS</div>
        <div style="font-size:1.8rem;font-weight:700;font-family:'DM Mono',monospace;color:white">{{ stats.sesiones_realizadas|default:0 }}</div>
        <div style="font-size:0.62rem;color:rgba(255,255,255,0.3)">de {{ stats.total_sesiones|default:0 }} programadas</div>
      </div>
    </div>

    <div class="cierre-firma">
      <div class="firma-box">
        <span class="fb-label">Responsable de Caja</span>
        <div class="fb-line"></div>
        <div class="fb-name">Firma y Aclaraci√≥n</div>
      </div>
      <div class="firma-box">
        <span class="fb-label">Supervisado por</span>
        <div class="fb-line"></div>
        <div class="fb-name">Firma</div>
      </div>
      <div class="firma-box">
        <span class="fb-label">Sello / Visto Bueno</span>
        <div class="fb-line"></div>
        <div class="fb-name"></div>
      </div>
    </div>
    <div class="cierre-timestamp">
      üïê Generado el {% now "d/m/Y \a \l\a\s H:i" %} por {{ request.user.get_full_name|default:request.user.username }}
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SERVICES + PROFESSIONALS -->
  <div class="sec-hdr"><h2>üèÜ Ranking de Rentabilidad</h2></div>
  <div class="grid-2" style="margin-bottom:16px">
    <div class="card">
      <h3>ü©∫ Servicios M√°s Rentables</h3>
      <div class="scroll-list">
        {% for s in stats.por_servicio %}
        <div class="list-item">
          <div style="display:flex;align-items:flex-start;gap:8px">
            <span class="li-rank">#{{ forloop.counter }}</span>
            <div>
              <div class="li-name">{{ s.servicio__nombre }}</div>
              <div class="li-sub">{{ s.cantidad }} sesiones ¬∑ {{ s.realizadas }} realizadas</div>
            </div>
          </div>
          <div class="li-right">
            <div class="li-val">Bs. {{ s.total|default:0|floatformat:2 }}</div>
            <div class="li-pct">{{ s.pct|default:0|floatformat:1 }}% del total</div>
          </div>
        </div>
        {% empty %}<p style="font-size:0.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos en este per√≠odo</p>{% endfor %}
      </div>
    </div>
    <div class="card">
      <h3>üë®‚Äç‚öïÔ∏è Ingresos por Profesional</h3>
      <div class="scroll-list">
        {% for p in stats.por_profesional %}
        <div class="list-item">
          <div style="display:flex;align-items:flex-start;gap:8px">
            <span class="li-rank">#{{ forloop.counter }}</span>
            <div>
              <div class="li-name">{{ p.profesional__nombre }} {{ p.profesional__apellido }}</div>
              <div class="li-sub">{{ p.sesiones }} sesiones ¬∑ {{ p.realizadas }} realizadas</div>
            </div>
          </div>
          <div class="li-right">
            <div class="li-val">Bs. {{ p.ingresos|default:0|floatformat:2 }}</div>
            <div class="li-pct">{{ p.pct|default:0|floatformat:1 }}% del total</div>
          </div>
        </div>
        {% empty %}<p style="font-size:0.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos en este per√≠odo</p>{% endfor %}
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUCURSALES -->
  {% if stats.por_sucursal %}
  <div class="sec-hdr"><h2>üè¢ Ingresos por Sucursal</h2></div>
  <div style="overflow-x:auto;background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin-bottom:16px;box-shadow:var(--shadow-sm)">
    <table class="evo-table">
      <thead>
        <tr>
          <th>Sucursal</th>
          <th>Cobrado</th>
          <th>Pendiente</th>
          <th>Sesiones</th>
          <th>Devoluciones</th>
          <th>Neto</th>
          <th>Participaci√≥n</th>
        </tr>
      </thead>
      <tbody>
        {% for s in stats.por_sucursal %}
        <tr>
          <td class="td-period">{{ s.nombre }}</td>
          <td class="td-money">Bs. {{ s.cobrado|default:0|floatformat:2 }}</td>
          <td class="td-red">Bs. {{ s.pendiente|default:0|floatformat:2 }}</td>
          <td class="td-muted">{{ s.sesiones|default:0 }}</td>
          <td class="td-amber">Bs. {{ s.devoluciones|default:0|floatformat:2 }}</td>
          <td class="td-money">Bs. {{ s.neto|default:0|floatformat:2 }}</td>
          <td><div class="evo-bar"><div class="evo-fill" style="width:{{ s.pct|default:0 }}%"></div></div></td>
        </tr>
        {% empty %}<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted);font-size:0.8rem">Sin datos</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EVOLUTION TABLE -->
  {% if evolucion %}
  <div class="sec-hdr"><h2>üìä Tabla de Evoluci√≥n Hist√≥rica</h2></div>
  <div style="overflow-x:auto;background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin-bottom:16px;box-shadow:var(--shadow-sm)">
    <table class="evo-table">
      <thead>
        <tr>
          <th>Per√≠odo</th>
          <th>Sesiones</th>
          <th>Realizadas</th>
          <th>Sin Cobro</th>
          <th>Cobrado</th>
          <th>Adelantos</th>
          <th>Pendiente</th>
          <th>Devoluciones</th>
          <th>Neto</th>
          <th>Tendencia</th>
        </tr>
      </thead>
      <tbody>
        {% for e in evolucion %}
        <tr>
          <td class="td-period">{{ e.periodo }}</td>
          <td class="td-muted">{{ e.total_sesiones|default:0 }}</td>
          <td style="color:var(--emerald);font-weight:700;font-family:'DM Mono',monospace">{{ e.realizadas|default:0 }}</td>
          <td style="color:var(--amber);font-family:'DM Mono',monospace">{{ e.sin_cobro|default:0 }}</td>
          <td class="td-money">Bs. {{ e.cobrado|default:0|floatformat:2 }}</td>
          <td class="td-blue">Bs. {{ e.adelantos|default:0|floatformat:2 }}</td>
          <td class="td-red">Bs. {{ e.pendiente|default:0|floatformat:2 }}</td>
          <td class="td-amber">Bs. {{ e.devoluciones|default:0|floatformat:2 }}</td>
          <td class="td-money">Bs. {{ e.neto|default:0|floatformat:2 }}</td>
          <td><div class="evo-bar" style="min-width:80px"><div class="evo-fill" style="width:{{ e.pct_max|default:0 }}%"></div></div></td>
        </tr>
        {% empty %}<tr><td colspan="10" style="text-align:center;padding:24px;color:var(--muted);font-size:0.8rem">Sin datos en el per√≠odo seleccionado</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADELANTOS / CR√âDITO -->
  {% if pacientes_credito %}
  <div class="page-break">
    <div class="sec-hdr">
      <h2>‚è© Pacientes con Saldo a Favor / Adelantos</h2>
      <span class="sec-tag" style="background:var(--sapphire-ll);color:var(--sapphire)">{{ pacientes_credito|length }} pacientes</span>
    </div>
    <div class="scroll-list" style="max-height:none;margin-bottom:8px">
      {% for p in pacientes_credito %}
      <div class="adelanto-row">
        <div>
          <div class="adelanto-name">{{ p.nombre_completo }}</div>
          <div class="adelanto-detail">
            Pagos sin asignar: Bs. {{ p.pagos_sin_asignar|default:0|floatformat:2 }}
            {% if p.ultima_fecha %} ¬∑ √öltimo pago: {{ p.ultima_fecha|date:"d/m/Y" }}{% endif %}
          </div>
        </div>
        <div class="adelanto-val">+ Bs. {{ p.saldo_favor|floatformat:2 }}</div>
      </div>
      {% endfor %}
    </div>
    <div style="background:var(--sapphire-ll);border:1px solid #bfdbfe;border-radius:var(--r);padding:12px 16px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:0.8rem;font-weight:700;color:var(--sapphire)">Total saldo a favor acumulado</span>
      <span style="font-size:1.2rem;font-weight:700;font-family:'DM Mono',monospace;color:var(--sapphire)">Bs. {{ stats.total_adelantos|default:0|floatformat:2 }}</span>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEUDORES -->
  {% if deudores %}
  <div class="page-break" style="margin-top:16px">
    <div class="sec-hdr">
      <h2>‚ö†Ô∏è Pacientes con Saldo Pendiente</h2>
      <span class="sec-tag" style="background:var(--ruby-ll);color:var(--ruby)">{{ deudores|length }} pacientes</span>
    </div>
    <div class="scroll-list" style="max-height:none;margin-bottom:8px">
      {% for d in deudores %}
      <div class="deudor-row">
        <div>
          <div class="dr-name">{{ d.nombre_completo }}</div>
          <div class="dr-detail">
            {{ d.sesiones_pendientes|default:0 }} sesi√≥n(es) sin pagar
            {% if d.desde %} ¬∑ desde {{ d.desde|date:"d/m/Y" }}{% endif %}
          </div>
          <div>
            {% if d.deuda > 500 %}
            <span class="dr-badge" style="background:#fecaca;color:var(--ruby)">üî¥ Cr√≠tico</span>
            {% elif d.deuda > 200 %}
            <span class="dr-badge" style="background:#fef3c7;color:var(--gold)">üü° Medio</span>
            {% else %}
            <span class="dr-badge" style="background:#dcfce7;color:var(--emerald-d)">üü¢ Bajo</span>
            {% endif %}
          </div>
        </div>
        <div class="dr-debt">Bs. {{ d.deuda|floatformat:2 }}</div>
      </div>
      {% endfor %}
    </div>
    <div class="pendiente-footer">
      <span class="pf-label">Total deuda pendiente acumulada</span>
      <span class="pf-val">Bs. {{ stats.total_pendiente|default:0|floatformat:2 }}</span>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIN COBRO -->
  {% if sesiones_sin_cobro %}
  <div class="page-break" style="margin-top:16px">
    <div class="sec-hdr">
      <h2>üéÅ Detalle Sesiones Sin Cobro</h2>
      <span class="sec-tag" style="background:var(--gold-ll);color:var(--gold)">{{ sesiones_sin_cobro|length }} sesiones</span>
    </div>
    <div class="scroll-list" style="max-height:300px;margin-bottom:8px">
      {% for s in sesiones_sin_cobro %}
      <div class="sincobro-row">
        <div>
          <div class="sincobro-name">{{ s.paciente__nombre }} {{ s.paciente__apellido }}</div>
          <div class="sincobro-detail">{{ s.fecha|date:"d/m/Y" }} ¬∑ {{ s.servicio__nombre }} ¬∑ {{ s.profesional__nombre }}</div>
        </div>
        <div class="sincobro-val">Bs. {{ s.precio|default:0|floatformat:2 }}</div>
      </div>
      {% endfor %}
    </div>
    <div style="background:var(--gold-ll);border:1px solid #fcd34d;border-radius:var(--r);padding:12px 16px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:0.8rem;font-weight:700;color:var(--gold)">Total valor referencial sin facturar</span>
      <span style="font-size:1.2rem;font-weight:700;font-family:'DM Mono',monospace;color:var(--gold)">Bs. {{ stats.monto_sin_cobro|default:0|floatformat:2 }}</span>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEVOLUCIONES DETALLE -->
  {% if devoluciones %}
  <div class="page-break" style="margin-top:16px">
    <div class="sec-hdr">
      <h2>‚Ü©Ô∏è Detalle de Devoluciones</h2>
      <span class="sec-tag" style="background:var(--ruby-ll);color:var(--ruby)">{{ devoluciones|length }} devoluciones</span>
    </div>
    <div style="overflow-x:auto;background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin-bottom:16px;box-shadow:var(--shadow-sm)">
      <table class="tx-table">
        <thead>
          <tr>
            <th>N¬∞ Devoluci√≥n</th>
            <th>Fecha</th>
            <th>Paciente</th>
            <th>Concepto</th>
            <th>M√©todo</th>
            <th>Monto</th>
          </tr>
        </thead>
        <tbody>
          {% for d in devoluciones %}
          <tr>
            <td style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted)">{{ d.numero_devolucion }}</td>
            <td style="white-space:nowrap;color:var(--muted)">{{ d.fecha_devolucion|date:"d/m/Y" }}</td>
            <td style="font-weight:600">{{ d.paciente.nombre }} {{ d.paciente.apellido }}</td>
            <td style="font-size:0.72rem;color:var(--muted)">{{ d.motivo|truncatechars:50 }}</td>
            <td><span class="tx-badge" style="background:var(--ruby-ll);color:var(--ruby)">{{ d.metodo_devolucion }}</span></td>
            <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--ruby)">- Bs. {{ d.monto|floatformat:2 }}</td>
          </tr>
          {% empty %}<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted);font-size:0.8rem">Sin devoluciones en el per√≠odo</td></tr>{% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê √öLTIMAS TRANSACCIONES -->
  {% if ultimas_transacciones %}
  <div class="sec-hdr" style="margin-top:8px"><h2>üßæ √öltimas Transacciones</h2></div>
  <div style="overflow-x:auto;background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin-bottom:16px;box-shadow:var(--shadow-sm)">
    <table class="tx-table">
      <thead>
        <tr>
          <th>N¬∞ Recibo</th>
          <th>Fecha</th>
          <th>Paciente</th>
          <th>Concepto</th>
          <th>M√©todo</th>
          <th>Estado</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody>
        {% for t in ultimas_transacciones %}
        <tr>
          <td style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted)">{{ t.numero_recibo }}</td>
          <td style="white-space:nowrap;font-size:0.73rem;color:var(--muted)">{{ t.fecha_pago|date:"d/m/Y H:i" }}</td>
          <td style="font-weight:600;font-size:0.75rem">{{ t.paciente.nombre }} {{ t.paciente.apellido }}</td>
          <td style="font-size:0.7rem;color:var(--muted);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ t.concepto|default:"-"|truncatechars:45 }}</td>
          <td>
            <span class="tx-badge" style="background:var(--emerald-ll);color:var(--emerald-d)">
              {% if t.metodo_pago %}{{ t.metodo_pago.nombre }}{% else %}‚Äî{% endif %}
            </span>
          </td>
          <td>
            {% if t.anulado %}
            <span class="tx-badge" style="background:var(--ruby-ll);color:var(--ruby)">‚ùå Anulado</span>
            {% else %}
            <span class="tx-badge" style="background:var(--emerald-ll);color:var(--emerald-d)">‚úÖ V√°lido</span>
            {% endif %}
          </td>
          <td style="font-family:'DM Mono',monospace;font-weight:700;color:{% if t.anulado %}var(--ruby){% else %}var(--emerald){% endif %}">
            Bs. {{ t.monto|floatformat:2 }}
          </td>
        </tr>
        {% empty %}<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--muted);font-size:0.8rem">Sin transacciones en el per√≠odo</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESUMEN FINAL -->
  <div class="total-footer">
    <div>
      <div class="tf-label">Per√≠odo analizado</div>
      <div class="tf-val" style="color:#6ee7b7;font-size:1rem">{{ fecha_desde|date:"d/m/Y" }} ‚Üí {{ fecha_hasta|date:"d/m/Y" }}</div>
    </div>
    <div style="text-align:center">
      <div class="tf-label">Total Cobrado</div>
      <div class="tf-val" style="color:#6ee7b7">Bs. {{ stats.total_cobrado|default:0|floatformat:2 }}</div>
    </div>
    <div style="text-align:center">
      <div class="tf-label">Devoluciones</div>
      <div class="tf-val" style="color:#fca5a5">- Bs. {{ stats.devoluciones|default:0|floatformat:2 }}</div>
    </div>
    <div style="text-align:right">
      <div class="tf-label">NETO FINAL</div>
      <div class="tf-val" style="color:#6ee7b7;font-size:1.6rem">Bs. {{ stats.neto_final|default:0|floatformat:2 }}</div>
    </div>
  </div>

</div><!-- /fin-wrap -->

{% if grafico_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const COLORS = {
  green: '#059669', greenL: 'rgba(5,150,105,0.15)', greenG: ['#059669','#34d399'],
  red: '#b91c1c', redL: 'rgba(185,28,28,0.12)',
  blue: '#1d4ed8', blueL: 'rgba(29,78,216,0.15)',
  violet: '#6d28d9', violetL: 'rgba(109,40,217,0.15)',
  amber: '#d97706', amberL: 'rgba(217,119,6,0.15)',
  teal: '#0d9488', tealL: 'rgba(13,148,136,0.15)',
  cyan: '#0891b2', cyanL: 'rgba(8,145,178,0.15)',
  rose: '#e11d48', roseL: 'rgba(225,29,72,0.15)',
};

const defaults = Chart.defaults;
defaults.font.family = "'DM Sans', sans-serif";
defaults.color = '#5a6f8a';

// ‚îÄ‚îÄ‚îÄ 1. Ingresos (bar + line) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctx1 = document.getElementById('chart-ingresos');
if(ctx1) new Chart(ctx1, {
  type: 'bar',
  data: {
    labels: {{ grafico_data.labels|safe }},
    datasets: [
      {
        label: 'Cobrado',
        data: {{ grafico_data.cobrado|safe }},
        backgroundColor: 'rgba(5,150,105,0.7)',
        borderColor: COLORS.green,
        borderWidth: 2,
        borderRadius: 6,
        borderSkipped: false,
        order: 2,
      },
      {
        label: 'Pendiente',
        data: {{ grafico_data.pendiente|safe }},
        backgroundColor: 'rgba(185,28,28,0.5)',
        borderColor: COLORS.red,
        borderWidth: 2,
        borderRadius: 6,
        borderSkipped: false,
        order: 2,
      },
      {
        label: 'Neto',
        data: {{ grafico_data.neto|safe }},
        type: 'line',
        borderColor: '#fbbf24',
        backgroundColor: 'rgba(251,191,36,0.08)',
        borderWidth: 2.5,
        pointRadius: 4,
        pointBackgroundColor: '#fbbf24',
        fill: false,
        tension: 0.4,
        order: 1,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top', labels: { font: { size: 10 }, padding: 12, usePointStyle: true } },
      tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: Bs. ${ctx.raw?.toFixed(2) ?? 0}` } }
    },
    scales: {
      y: { beginAtZero: true, ticks: { font: { size: 9 }, callback: v => 'Bs.' + v }, grid: { color: 'rgba(0,0,0,0.04)' } },
      x: { ticks: { font: { size: 9 } }, grid: { display: false } }
    }
  }
});

// ‚îÄ‚îÄ‚îÄ 2. M√©todos doughnut ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctx2 = document.getElementById('chart-metodos');
if(ctx2 && {{ grafico_data.metodos_labels|safe }}.length > 0) new Chart(ctx2, {
  type: 'doughnut',
  data: {
    labels: {{ grafico_data.metodos_labels|safe }},
    datasets: [{
      data: {{ grafico_data.metodos_valores|safe }},
      backgroundColor: [
        '#059669','#7c3aed','#1d4ed8','#0d9488','#d97706','#0891b2','#e11d48','#4f46e5','#b91c1c','#6d28d9'
      ],
      borderWidth: 3,
      borderColor: '#fff',
      hoverOffset: 8,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: { position: 'right', labels: { font: { size: 10 }, padding: 10, usePointStyle: true } },
      tooltip: { callbacks: { label: ctx => ` ${ctx.label}: Bs. ${ctx.raw.toFixed(2)} (${ctx.parsed.toFixed(1)}%)` } }
    },
    cutout: '68%',
  }
});

// ‚îÄ‚îÄ‚îÄ 3. Tipos de cobro (pie) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctx3 = document.getElementById('chart-tipos');
if(ctx3) new Chart(ctx3, {
  type: 'pie',
  data: {
    labels: ['Sesiones', 'Mensualidades', 'Proyectos', 'Adelantos'],
    datasets: [{
      data: [
        {{ stats.pagos_sesiones|default:0 }},
        {{ stats.pagos_mensualidades|default:0 }},
        {{ stats.pagos_proyectos|default:0 }},
        {{ stats.pagos_adelantados|default:0 }}
      ],
      backgroundColor: [COLORS.green, COLORS.violet, COLORS.teal, COLORS.cyan],
      borderWidth: 3, borderColor: '#fff', hoverOffset: 8,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    plugins: {
      legend: { position: 'right', labels: { font: { size: 10 }, padding: 8, usePointStyle: true } },
      tooltip: { callbacks: { label: ctx => ` Bs. ${ctx.raw.toFixed(2)}` } }
    }
  }
});

// ‚îÄ‚îÄ‚îÄ 4. Efectivo vs Digital (bar horizontal) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctx4 = document.getElementById('chart-efectivo-digital');
if(ctx4) new Chart(ctx4, {
  type: 'bar',
  data: {
    labels: ['Efectivo', 'QR', 'Transferencia', 'Tarjeta', 'Cr√©dito'],
    datasets: [{
      label: 'Monto (Bs.)',
      data: [
        {{ stats.efectivo|default:0 }},
        {{ stats.qr|default:0 }},
        {{ stats.transferencia|default:0 }},
        {{ stats.tarjeta|default:0 }},
        {{ stats.credito|default:0 }}
      ],
      backgroundColor: [
        'rgba(5,150,105,0.7)',
        'rgba(109,40,217,0.7)',
        'rgba(29,78,216,0.7)',
        'rgba(13,148,136,0.7)',
        'rgba(217,119,6,0.7)',
      ],
      borderColor: [COLORS.green, COLORS.violet, COLORS.blue, COLORS.teal, COLORS.amber],
      borderWidth: 2,
      borderRadius: 6,
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true, maintainAspectRatio: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => ` Bs. ${ctx.raw.toFixed(2)}` } }
    },
    scales: {
      x: { beginAtZero: true, ticks: { font: { size: 9 }, callback: v => 'Bs.' + v }, grid: { color: 'rgba(0,0,0,0.04)' } },
      y: { ticks: { font: { size: 9 } }, grid: { display: false } }
    }
  }
});

// ‚îÄ‚îÄ‚îÄ 5. Neto (area line) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctx5 = document.getElementById('chart-neto');
if(ctx5) new Chart(ctx5, {
  type: 'line',
  data: {
    labels: {{ grafico_data.labels|safe }},
    datasets: [{
      label: 'Neto',
      data: {{ grafico_data.neto|safe }},
      borderColor: COLORS.green,
      backgroundColor: 'rgba(5,150,105,0.1)',
      borderWidth: 2.5,
      pointRadius: 4,
      pointBackgroundColor: COLORS.green,
      fill: true,
      tension: 0.4,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => ` Bs. ${ctx.raw.toFixed(2)}` } }
    },
    scales: {
      y: { beginAtZero: true, ticks: { font: { size: 9 }, callback: v => 'Bs.' + v }, grid: { color: 'rgba(0,0,0,0.04)' } },
      x: { ticks: { font: { size: 9 } }, grid: { display: false } }
    }
  }
});

// ‚îÄ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportarCSV() {
  const rows = [
    ['Per√≠odo','{{ fecha_desde }}','{{ fecha_hasta }}'],
    ['Total Cobrado','{{ stats.total_cobrado|default:0 }}'],
    ['Por Cobrar','{{ stats.total_pendiente|default:0 }}'],
    ['Adelantos','{{ stats.total_adelantos|default:0 }}'],
    ['Efectivo','{{ stats.efectivo|default:0 }}'],
    ['QR','{{ stats.qr|default:0 }}'],
    ['Transferencia','{{ stats.transferencia|default:0 }}'],
    ['Tarjeta','{{ stats.tarjeta|default:0 }}'],
    ['Cr√©dito','{{ stats.credito|default:0 }}'],
    ['Devoluciones','{{ stats.devoluciones|default:0 }}'],
    ['Neto Final','{{ stats.neto_final|default:0 }}'],
    ['Sesiones Realizadas','{{ stats.sesiones_realizadas|default:0 }}'],
    ['Sin Cobro','{{ stats.sesiones_sin_cobro|default:0 }}'],
    ['Pagos Anulados','{{ stats.pagos_anulados|default:0 }}'],
  ];
  const csv = rows.map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'reporte_financiero_{{ fecha_desde }}_{{ fecha_hasta }}.csv';
  a.click();
}
</script>
{% endif %}
{% endblock %}