{% extends 'base.html' %}
{% block title %}Reporte Financiero Detallado{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap');
  :root {
    --ink:#0f172a; --ink2:#334155; --muted:#64748b; --border:#e2e8f0;
    --surface:#f8fafc; --white:#ffffff;
    --green:#16a34a; --green-l:#dcfce7; --green-ll:#f0fdf4;
    --blue:#2563eb; --blue-l:#dbeafe;
    --amber:#d97706; --amber-l:#fef3c7;
    --red:#dc2626; --red-l:#fee2e2;
    --purple:#7c3aed; --purple-l:#ede9fe;
    --teal:#0d9488; --teal-l:#ccfbf1;
    --r:12px; --shadow:0 1px 3px rgba(0,0,0,.08),0 4px 16px rgba(0,0,0,.06);
  }
  body { font-family:'Outfit',sans-serif; background:var(--surface); }
  @media print {
    .no-print{display:none!important} body{background:white!important;font-size:10px}
    .page-break{page-break-before:always}
    .rpt-header{background:#1e3a2f!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    table{font-size:9px}
  }
  .rpt-header {
    background:linear-gradient(135deg,#1a2f1a 0%,#1e3a2f 50%,#14532d 100%);
    border-radius:16px;padding:24px 28px;margin-bottom:20px;color:white;position:relative;overflow:hidden;
  }
  .rpt-header::after{content:'';position:absolute;top:-30px;right:-30px;width:180px;height:180px;
    background:radial-gradient(circle,rgba(34,197,94,.2) 0%,transparent 70%);border-radius:50%}
  .rpt-header .back{color:#86efac;text-decoration:none;font-size:.75rem;font-weight:600;
    display:inline-flex;align-items:center;gap:4px;margin-bottom:10px}
  .rpt-header h1{font-size:1.5rem;font-weight:800;margin:0 0 4px;letter-spacing:-.02em}
  .rpt-header p{color:#a7f3d0;font-size:.8rem;margin:0}
  .action-btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:6px;font-size:.75rem;font-weight:600;
    padding:7px 14px;border-radius:8px;cursor:pointer;border:none;transition:all .15s;text-decoration:none}
  .btn-white{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:white}
  .btn-white:hover{background:rgba(255,255,255,.25)}
  .btn-green{background:var(--green);color:white}
  .btn-blue{background:var(--blue);color:white}

  .tabs{display:flex;gap:0;background:var(--white);border:1px solid var(--border);
    border-radius:10px;padding:3px;margin-bottom:14px;overflow-x:auto;flex-wrap:wrap}
  .tab{flex:none;font-size:.75rem;font-weight:600;padding:6px 14px;border-radius:7px;
    cursor:pointer;white-space:nowrap;color:var(--muted);text-decoration:none;transition:all .15s}
  .tab.active,.tab:hover{background:var(--green);color:white}

  .filter-bar{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:16px}
  .filter-bar form{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}
  .filter-bar select,.filter-bar input[type=date]{padding:7px 10px;font-size:.78rem;
    border:1px solid var(--border);border-radius:8px;color:var(--ink);font-family:'Outfit',sans-serif}
  .btn-primary{background:var(--green);color:white;border:none;padding:7px 16px;
    border-radius:8px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif}

  /* Hero money cards */
  .money-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px}
  .money-card{border-radius:14px;padding:20px;border:2px solid;background:var(--white);position:relative;overflow:hidden}
  .money-card::before{content:'';position:absolute;top:-20px;right:-20px;width:100px;height:100px;border-radius:50%;opacity:.08;background:currentColor}
  .mc-label{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
  .mc-val{font-size:1.8rem;font-weight:900;font-family:'JetBrains Mono',monospace;line-height:1}
  .mc-sub{font-size:.7rem;margin-top:6px;opacity:.75}
  .mc-badge{position:absolute;top:14px;right:14px;font-size:.62rem;font-weight:700;
    opacity:.6;background:rgba(0,0,0,.08);padding:2px 7px;border-radius:6px}

  /* Stats row */
  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:16px}
  .stat-mini{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
  .sm-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:4px}
  .sm-val{font-size:1.3rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--ink)}
  .sm-sub{font-size:.62rem;color:var(--muted);margin-top:2px}

  /* Tablas detalladas */
  .table-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);
    padding:16px;margin-bottom:16px;overflow-x:auto}
  .table-card h3{font-size:.85rem;font-weight:700;color:var(--ink);margin:0 0 12px;
    display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
  .badge-count{font-size:.65rem;background:var(--green-l);color:var(--green);
    padding:3px 8px;border-radius:6px;font-weight:700}
  
  table{width:100%;border-collapse:collapse;font-size:.78rem}
  thead{background:var(--surface);position:sticky;top:0;z-index:10}
  th{text-align:left;padding:10px 12px;font-weight:700;color:var(--ink2);
    border-bottom:2px solid var(--border);font-size:.7rem;text-transform:uppercase;letter-spacing:.05em}
  td{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--ink)}
  tbody tr:hover{background:var(--surface)}
  .td-mono{font-family:'JetBrains Mono',monospace;font-weight:700}
  .td-right{text-align:right}
  .td-center{text-align:center}
  
  /* Tags */
  .tag{display:inline-block;font-size:.62rem;font-weight:700;padding:3px 8px;border-radius:5px;
    background:var(--green-l);color:var(--green);white-space:nowrap}
  .tag.blue{background:var(--blue-l);color:var(--blue)}
  .tag.purple{background:var(--purple-l);color:var(--purple)}
  .tag.amber{background:var(--amber-l);color:var(--amber)}
  .tag.red{background:var(--red-l);color:var(--red)}
  .tag.teal{background:var(--teal-l);color:var(--teal)}

  /* Charts */
  .chart-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:16px}
  .chart-card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
  @media(max-width:768px){.two-col{grid-template-columns:1fr}}

  /* Method cards */
  .method-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:16px}
  .method-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px}
  .mc2-label{font-size:.65rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
  .mc2-val{font-size:1.1rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--ink)}
  .mc2-count{font-size:.68rem;color:var(--muted);margin-top:3px}
  .mc2-bar{height:4px;background:var(--border);border-radius:10px;margin-top:8px;overflow:hidden}
  .mc2-fill{height:100%;background:var(--green);border-radius:10px;transition:width 1s}

  /* Card list */
  .card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px}
  .card h3{font-size:.8rem;font-weight:700;color:var(--ink);margin:0 0 10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;
    padding:9px 10px;border-radius:8px;background:var(--surface);margin-bottom:6px}
  .li-name{font-size:.78rem;font-weight:700;color:var(--ink)}
  .li-sub{font-size:.65rem;color:var(--muted);margin-top:2px}
  .li-val{font-size:.9rem;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--green)}
  .scroll-list{max-height:260px;overflow-y:auto}

  /* Cierre de caja */
  .cierre-box{background:linear-gradient(135deg,#0f172a,#1e3a2f);border-radius:16px;
    padding:24px;color:white;margin-bottom:20px}
  .cierre-box h2{font-size:1.1rem;font-weight:800;margin:0 0 16px;color:#86efac}
  .cierre-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .cierre-item{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:14px}
  .ci-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:6px}
  .ci-val{font-size:1.3rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:white}
  .ci-sub{font-size:.62rem;color:#64748b;margin-top:3px}
  .ci-highlight{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.3)}
  .ci-highlight .ci-val{color:#86efac}
  .ci-danger{background:rgba(220,38,38,.15);border-color:rgba(220,38,38,.3)}
  .ci-danger .ci-val{color:#fca5a5}

  /* Top pacientes */
  .top-row{display:flex;justify-content:space-between;align-items:center;
    padding:9px 12px;background:var(--surface);border-radius:8px;margin-bottom:6px}
  .tr-rank{font-size:.7rem;font-weight:800;color:var(--muted);width:20px}
  .tr-name{font-size:.8rem;font-weight:700;color:var(--ink);flex:1;padding:0 10px}
  .tr-val{font-size:.82rem;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--green)}

  /* Section header */
  .section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:6px}
  .section-hdr h2{font-size:.95rem;font-weight:800;color:var(--ink);margin:0}

  /* Period badge */
  .period-badge{display:inline-flex;align-items:center;gap:5px;font-size:.7rem;font-weight:700;
    padding:4px 10px;border-radius:20px;background:rgba(34,197,94,.2);
    color:#86efac;border:1px solid rgba(34,197,94,.3)}

  /* Credit section */
  .credit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:16px}
  .credit-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-left:3px solid var(--purple)}
  .cr-label{font-size:.62rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
  .cr-val{font-size:1.1rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--purple)}
  .cr-sub{font-size:.65rem;color:var(--muted);margin-top:3px}

  /* Empty state */
  .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
  .empty-state svg{width:60px;height:60px;margin-bottom:12px;opacity:.3}
  
  /* Collapsible sections */
  .collapsible{cursor:pointer;user-select:none;display:flex;align-items:center;gap:8px}
  .collapsible::before{content:'‚ñº';font-size:.7rem;transition:transform .2s}
  .collapsible.collapsed::before{transform:rotate(-90deg)}
  .collapsible-content{margin-top:12px;transition:max-height .3s}
  .collapsible-content.hidden{display:none}
</style>

<div class="max-w-7xl mx-auto px-3 py-4">

  <!-- Header -->
  <div class="rpt-header no-print">
    <a href="{% url 'facturacion:dashboard_reportes' %}" class="back">‚Üê Volver a Reportes</a>
    <h1>üí∞ Reporte Financiero Detallado</h1>
    <p>An√°lisis completo con listados verificables y trazabilidad de cada transacci√≥n</p>
    <div class="action-btns">
      <button onclick="window.print()" class="btn btn-white">üñ®Ô∏è Imprimir</button>
      <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}export=excel" class="btn btn-white">üìä Excel</a>
      <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}export=pdf" class="btn btn-white">üìÑ PDF</a>
    </div>
  </div>

  <!-- View Tabs -->
  <div class="tabs no-print">
    <a href="?vista=mensual&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'mensual' or not vista %}active{% endif %}">üìÖ Vista Mensual</a>
    <a href="?vista=diaria&fecha_desde={{ fecha_hasta }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'diaria' %}active{% endif %}">üìÜ Cierre Diario</a>
    <a href="?vista=detalle_pagos&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'detalle_pagos' %}active{% endif %}">üí≥ Detalle Pagos</a>
    <a href="?vista=detalle_sesiones&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'detalle_sesiones' %}active{% endif %}">üè• Detalle Sesiones</a>
    <a href="?vista=detalle_proyectos&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'detalle_proyectos' %}active{% endif %}">üìã Detalle Proyectos</a>
    <a href="?vista=detalle_mensualidades&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'detalle_mensualidades' %}active{% endif %}">üìÖ Detalle Mensualidades</a>
    <a href="?vista=analisis_creditos&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'analisis_creditos' %}active{% endif %}">üíé An√°lisis Cr√©ditos</a>
  </div>

  <!-- Filters -->
  <div class="filter-bar no-print">
    <form method="get">
      <input type="hidden" name="vista" value="{{ vista }}">
      <div style="display:flex;flex-direction:column;gap:4px">
        <label style="font-size:.68rem;font-weight:700;color:var(--muted)">Sucursal</label>
        <select name="sucursal" style="min-width:180px">
          <option value="">Todas las sucursales</option>
          {% for s in sucursales %}
          <option value="{{ s.id }}" {% if sucursal_id == s.id|stringformat:"s" %}selected{% endif %}>{{ s.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <label style="font-size:.68rem;font-weight:700;color:var(--muted)">Desde</label>
        <input type="date" name="fecha_desde" value="{{ fecha_desde }}">
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <label style="font-size:.68rem;font-weight:700;color:var(--muted)">Hasta</label>
        <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}">
      </div>
      <button type="submit" class="btn-primary" style="margin-top:20px">üîç Filtrar</button>
    </form>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VISTA: MENSUAL (RESUMEN) -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if vista == 'mensual' or not vista %}

  <!-- Hero Cards -->
  <div class="money-grid">

    <!-- Ingresos Real (solo lo ya ocurrido, igual que total_consumido_actual) -->
    <div class="money-card" style="border-color:var(--green);color:var(--green)">
      <div class="mc-badge">REAL / ACTUAL</div>
      <div class="mc-label">Total Ingresos Real</div>
      <div class="mc-val">Bs. {{ ingresos.total_generado_real|floatformat:2 }}</div>
      <div class="mc-sub">
        Ses. realizadas + mensualidades + proyectos activos/finalizados
      </div>
    </div>

    <!-- Ingresos Proyectado (incluye programadas y planificados) -->
    <div class="money-card" style="border-color:#059669;color:#059669">
      <div class="mc-badge">PROYECTADO</div>
      <div class="mc-label">Total Ingresos Proyectado</div>
      <div class="mc-val">Bs. {{ ingresos.total_generado_proyectado|floatformat:2 }}</div>
      <div class="mc-sub">
        + {{ ingresos.sesiones.cantidad_programadas }} ses. programadas (Bs. {{ ingresos.total_generado_sesiones_prog|floatformat:0 }})
        ¬∑ + {{ ingresos.proyectos.cantidad_planificados }} proy. planificados (Bs. {{ ingresos.total_generado_proy_plan|floatformat:0 }})
      </div>
    </div>

    <div class="money-card" style="border-color:var(--blue);color:var(--blue)">
      <div class="mc-badge">COBRADO BRUTO</div>
      <div class="mc-label">Total Recaudado</div>
      <div class="mc-val">Bs. {{ ingresos.total_cobrado_bruto|floatformat:2 }}</div>
      <div class="mc-sub">Sin restar devoluciones</div>
    </div>
    <div class="money-card" style="border-color:var(--teal);color:var(--teal)">
      <div class="mc-badge">COBRADO NETO</div>
      <div class="mc-label">Recaudado Neto</div>
      <div class="mc-val">Bs. {{ ingresos.total_cobrado_neto|floatformat:2 }}</div>
      <div class="mc-sub">Restando devoluciones</div>
    </div>
    <div class="money-card" style="border-color:var(--red);color:var(--red)">
      <div class="mc-badge">DEVOLUCIONES</div>
      <div class="mc-label">Total Devuelto</div>
      <div class="mc-val">Bs. {{ ingresos.total_devoluciones|floatformat:2 }}</div>
      <div class="mc-sub">{{ ingresos.devoluciones_info.cantidad }} devoluciones</div>
    </div>
    <div class="money-card" style="border-color:var(--amber);color:var(--amber)">
      <div class="mc-badge">PENDIENTE REAL</div>
      <div class="mc-label">Por Cobrar Real</div>
      <div class="mc-val">Bs. {{ ingresos.total_pendiente|floatformat:2 }}</div>
      <div class="mc-sub">Ingresos real ‚àí recaudado neto ¬∑ {{ ingresos.tasa_cobranza|floatformat:1 }}% cobrado</div>
    </div>
    <div class="money-card" style="border-color:#b45309;color:#b45309">
      <div class="mc-badge">PENDIENTE PROY.</div>
      <div class="mc-label">Por Cobrar Proyectado</div>
      <div class="mc-val">Bs. {{ ingresos.total_pendiente_proyectado|floatformat:2 }}</div>
      <div class="mc-sub">Ingresos proyectado ‚àí recaudado neto</div>
    </div>
    <div class="money-card" style="border-color:var(--purple);color:var(--purple)">
      <div class="mc-badge">PROMEDIO</div>
      <div class="mc-label">Ticket Promedio</div>
      <div class="mc-val">Bs. {{ ingresos.promedio_por_item|floatformat:2 }}</div>
      <div class="mc-sub">por item (sobre real)</div>
    </div>
  </div>

  <!-- Secci√≥n de Devoluciones y Anulaciones -->
  {% if ingresos.total_devoluciones > 0 or ingresos.total_anulaciones > 0 %}
  <div class="card" style="background:var(--red-l);border-color:var(--red);margin-bottom:16px">
    <h3 style="color:var(--red);display:flex;align-items:center;justify-content:space-between">
      ‚ö†Ô∏è Devoluciones y Anulaciones
      <span class="badge-count" style="background:var(--red-l);color:var(--red)">
        {{ ingresos.devoluciones_info.cantidad|add:ingresos.anulaciones_info.cantidad }} registros
      </span>
    </h3>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px">
      {% if ingresos.total_devoluciones > 0 %}
      <div style="background:white;border:1px solid var(--red);border-radius:10px;padding:14px">
        <div style="font-size:.68rem;font-weight:700;color:var(--red);margin-bottom:6px">DEVOLUCIONES</div>
        <div style="font-size:1.4rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--red)">
          Bs. {{ ingresos.total_devoluciones|floatformat:2 }}
        </div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:4px">{{ ingresos.devoluciones_info.cantidad }} devoluciones</div>
        
        {% if ingresos.devoluciones_info.por_metodo %}
        <div style="margin-top:8px;font-size:.68rem">
          {% for m in ingresos.devoluciones_info.por_metodo %}
          <div style="display:flex;justify-content:space-between;padding:4px 0;border-top:1px solid var(--border)">
            <span style="color:var(--muted)">{{ m.metodo_devolucion__nombre }}</span>
            <span style="font-weight:700;color:var(--red)">Bs. {{ m.monto|floatformat:2 }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      {% if ingresos.total_anulaciones > 0 %}
      <div style="background:white;border:1px solid var(--amber);border-radius:10px;padding:14px">
        <div style="font-size:.68rem;font-weight:700;color:var(--amber);margin-bottom:6px">ANULACIONES</div>
        <div style="font-size:1.4rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--amber)">
          Bs. {{ ingresos.total_anulaciones|floatformat:2 }}
        </div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:4px">{{ ingresos.anulaciones_info.cantidad }} pagos anulados</div>
        <div style="font-size:.65rem;color:var(--muted);margin-top:6px;font-style:italic">
          * Los pagos anulados no se incluyen en el total cobrado
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Stats Mini -->
  <div class="stats-row">
    <div class="stat-mini">
      <div class="sm-label">Sesiones</div>
      <div class="sm-val">{{ ingresos.sesiones.cantidad_sesiones }}</div>
      <div class="sm-sub">Realiz. + Retraso + Falta</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Proyectos</div>
      <div class="sm-val">{{ ingresos.proyectos.cantidad_proyectos }}</div>
      <div class="sm-sub">{{ ingresos.proyectos.proyectos_activos }} prog ¬∑ {{ ingresos.proyectos.proyectos_finalizados }} fin ¬∑ {{ ingresos.proyectos.proyectos_cancelados }} can</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Mensualidades</div>
      <div class="sm-val">{{ ingresos.mensualidades.cantidad_mensualidades }}</div>
      <div class="sm-sub">{{ ingresos.mensualidades.activas }} act ¬∑ {{ ingresos.mensualidades.vencidas }} ven ¬∑ {{ ingresos.mensualidades.pausadas }} pau ¬∑ {{ ingresos.mensualidades.completadas }} comp</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Generado Sesiones</div>
      <div class="sm-val" style="font-size:1rem">Bs. {{ ingresos.sesiones.total_generado_real|floatformat:0 }}</div>
      <div class="sm-sub">
        real ¬∑ prog: Bs. {{ ingresos.total_generado_sesiones_prog|floatformat:0 }}<br>
        cobrado: Bs. {{ ingresos.sesiones.total_cobrado|floatformat:0 }} ¬∑ pend: Bs. {{ ingresos.sesiones.total_pendiente|floatformat:0 }}
      </div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Generado Proyectos</div>
      <div class="sm-val" style="font-size:1rem">Bs. {{ ingresos.proyectos.total_generado_real|floatformat:0 }}</div>
      <div class="sm-sub">
        real ¬∑ plan: Bs. {{ ingresos.total_generado_proy_plan|floatformat:0 }}<br>
        cobrado neto: Bs. {{ ingresos.proyectos.total_cobrado|floatformat:0 }} ¬∑ pend: Bs. {{ ingresos.proyectos.total_pendiente|floatformat:0 }}
      </div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Generado Mensualidades</div>
      <div class="sm-val" style="font-size:1rem">Bs. {{ ingresos.mensualidades.total_generado_real|floatformat:0 }}</div>
      <div class="sm-sub">cobrado neto: Bs. {{ ingresos.mensualidades.total_cobrado|floatformat:0 }} ¬∑ pend: Bs. {{ ingresos.mensualidades.total_pendiente|floatformat:0 }}</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Cr√©ditos Gen.</div>
      <div class="sm-val" style="font-size:1rem">Bs. {{ ingresos.creditos.generados|floatformat:0 }}</div>
      <div class="sm-sub">{{ ingresos.creditos.generados_cantidad }} pagos adelantados</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Cr√©ditos Usados</div>
      <div class="sm-val" style="font-size:1rem">Bs. {{ ingresos.creditos.utilizados|floatformat:0 }}</div>
      <div class="sm-sub">{{ ingresos.creditos.utilizados_cantidad }} usos ¬∑ saldo: Bs. {{ ingresos.creditos.saldo_neto|floatformat:0 }}</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê EVOLUCI√ìN GR√ÅFICO ‚ïê‚ïê -->
  {% if grafico_data %}
  <div class="two-col">
    <div class="chart-card">
      <h3>üìà Evoluci√≥n de Ingresos (√∫ltimos 6 meses)</h3>
      <canvas id="chart-ingresos" height="200"></canvas>
    </div>
    <div class="chart-card">
      <h3>üè• Sesiones vs Proyectos</h3>
      <canvas id="chart-sesiones" height="200"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê M√âTODO DE PAGO ‚ïê‚ïê -->
  {% if por_metodo %}
  <div class="section-hdr"><h2>üí≥ Desglose por M√©todo de Pago</h2></div>
  <div class="method-grid">
    {% for m in por_metodo %}
    <div class="method-card">
      <div class="mc2-label">{{ m.metodo_pago__nombre|default:"Sin m√©todo" }}</div>
      <div class="mc2-val">Bs. {{ m.monto|floatformat:2 }}</div>
      <div class="mc2-count">{{ m.cantidad }} transacciones</div>
      <div class="mc2-bar">
        <div class="mc2-fill" style="width:{% widthratio m.monto por_metodo.0.monto 100 %}%"></div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê SERVICIOS + TOP PACIENTES ‚ïê‚ïê -->
  <div class="two-col">
    <!-- Por servicio -->
    <div class="card">
      <h3>üèÜ Servicios m√°s rentables</h3>
      <div class="scroll-list">
        {% for s in por_servicio %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ s.nombre }}</div>
            <div class="li-sub">{{ s.sesiones }} sesiones ¬∑ {{ s.proyectos }} proyectos</div>
          </div>
          <div class="li-val">Bs. {{ s.ingresos|floatformat:2 }}</div>
        </div>
        {% empty %}
        <p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>
        {% endfor %}
      </div>
    </div>

    <!-- Top pacientes -->
    <div class="card">
      <h3>üë§ Top Pacientes por Consumo</h3>
      <div class="scroll-list">
        {% for p in top_pacientes %}
        <div class="top-row">
          <span class="tr-rank">{{ forloop.counter }}</span>
          <span class="tr-name">{{ p.nombre }} {{ p.apellido }}</span>
          <span class="tr-val">{{ p.sesiones_count|default:0 }} ses.</span>
        </div>
        {% empty %}
        <p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>
        {% endfor %}
      </div>
    </div>
  </div>

  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VISTA: CIERRE DIARIO -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if vista == 'diaria' and cierre_diario %}
  <div class="cierre-box">
    <h2>üìÜ Cierre de Caja - {{ cierre_diario.dia_semana }}, {{ cierre_diario.fecha_formato }}</h2>
    
    <div class="cierre-grid">
      <!-- Total cobrado -->
      <div class="cierre-item ci-highlight">
        <div class="ci-label">Total Cobrado</div>
        <div class="ci-val">Bs. {{ cierre_diario.monto_total|floatformat:2 }}</div>
        <div class="ci-sub">{{ cierre_diario.pagos_total }} recibos</div>
      </div>
      
      <!-- Efectivo -->
      <div class="cierre-item">
        <div class="ci-label">Efectivo</div>
        <div class="ci-val">Bs. {{ cierre_diario.efectivo_esperado|floatformat:2 }}</div>
        <div class="ci-sub">Esperado en caja</div>
      </div>
      
      <!-- Sesiones -->
      <div class="cierre-item">
        <div class="ci-label">Sesiones</div>
        <div class="ci-val">{{ cierre_diario.sesiones_realizadas }}</div>
        <div class="ci-sub">Bs. {{ cierre_diario.monto_generado_sesiones|floatformat:2 }}</div>
      </div>
      
      <!-- Proyectos -->
      <div class="cierre-item">
        <div class="ci-label">Proyectos</div>
        <div class="ci-val">{{ cierre_diario.proyectos_iniciados }}</div>
        <div class="ci-sub">Bs. {{ cierre_diario.monto_proyectos|floatformat:2 }}</div>
      </div>
      
      <!-- Mensualidades del mes -->
      {% if cierre_diario.mensualidades_dia > 0 %}
      <div class="cierre-item">
        <div class="ci-label">Mensualidades</div>
        <div class="ci-val">{{ cierre_diario.mensualidades_dia }}</div>
        <div class="ci-sub">Bs. {{ cierre_diario.monto_mensualidades|floatformat:2 }}</div>
      </div>
      {% endif %}
      
      <!-- Cr√©ditos generados -->
      <div class="cierre-item">
        <div class="ci-label">Cr√©ditos Gen.</div>
        <div class="ci-val">Bs. {{ cierre_diario.creditos_generados|floatformat:2 }}</div>
        <div class="ci-sub">Pagos adelantados</div>
      </div>
      
      <!-- Cr√©ditos utilizados -->
      <div class="cierre-item">
        <div class="ci-label">Cr√©ditos Usados</div>
        <div class="ci-val">Bs. {{ cierre_diario.creditos_utilizados|floatformat:2 }}</div>
        <div class="ci-sub">D√©bito de cr√©dito</div>
      </div>
      
      <!-- Pacientes atendidos -->
      <div class="cierre-item">
        <div class="ci-label">Pacientes</div>
        <div class="ci-val">{{ cierre_diario.estadisticas.pacientes_unicos }}</div>
        <div class="ci-sub">√önicos atendidos</div>
      </div>
      
      <!-- Ticket promedio -->
      <div class="cierre-item">
        <div class="ci-label">Ticket Prom.</div>
        <div class="ci-val">Bs. {{ cierre_diario.estadisticas.ticket_promedio|floatformat:2 }}</div>
        <div class="ci-sub">Por recibo</div>
      </div>
      
      <!-- Horas trabajadas -->
      <div class="cierre-item">
        <div class="ci-label">Horas</div>
        <div class="ci-val">{{ cierre_diario.estadisticas.horas_trabajadas|floatformat:1 }}</div>
        <div class="ci-sub">Trabajadas</div>
      </div>
      
      <!-- Ingreso por hora -->
      <div class="cierre-item">
        <div class="ci-label">Bs./Hora</div>
        <div class="ci-val">{{ cierre_diario.estadisticas.ingreso_por_hora|floatformat:2 }}</div>
        <div class="ci-sub">Productividad</div>
      </div>
    </div>

    <!-- M√©todos de pago del d√≠a -->
    {% if cierre_diario.por_metodo %}
    <div style="margin-top:20px">
      <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:10px">Detalle por M√©todo</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
        {% for m in cierre_diario.por_metodo %}
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px">
          <div style="font-size:.65rem;color:#94a3b8;margin-bottom:4px">{{ m.metodo_pago__nombre }}</div>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.1rem;color:white">Bs. {{ m.monto|floatformat:2 }}</div>
          <div style="font-size:.62rem;color:#64748b;margin-top:2px">{{ m.cantidad }} trans.</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Por profesional -->
    {% if cierre_diario.estadisticas.por_profesional %}
    <div style="margin-top:16px">
      <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:10px">Por Profesional</div>
      {% for prof in cierre_diario.estadisticas.por_profesional %}
      <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <span style="color:#e2e8f0;font-weight:700;font-size:.8rem">{{ prof.profesional__nombre }} {{ prof.profesional__apellido }}</span>
          <span style="font-size:.65rem;color:#64748b;margin-left:8px">{{ prof.sesiones }} sesiones</span>
        </div>
        <span style="font-family:'JetBrains Mono',monospace;font-weight:900;color:#86efac">Bs. {{ prof.ingresos|floatformat:2 }}</span>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Por servicio -->
    {% if cierre_diario.estadisticas.por_servicio %}
    <div style="margin-top:16px">
      <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:10px">Por Servicio</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
        {% for serv in cierre_diario.estadisticas.por_servicio %}
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px">
          <div style="font-size:.65rem;color:#94a3b8;margin-bottom:4px">{{ serv.servicio__nombre }}</div>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.1rem;color:white">{{ serv.cantidad }}</div>
          <div style="font-size:.62rem;color:#64748b;margin-top:2px">Bs. {{ serv.ingresos|floatformat:2 }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Asistencia -->
    <div style="margin-top:16px">
      <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:10px">Asistencia</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px">
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;text-align:center">
          <div style="font-size:.62rem;color:#94a3b8;margin-bottom:4px">Programadas</div>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.3rem;color:#60a5fa">{{ cierre_diario.estadisticas.programadas_dia }}</div>
        </div>
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;text-align:center">
          <div style="font-size:.62rem;color:#94a3b8;margin-bottom:4px">Retrasos</div>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.3rem;color:#fb923c">{{ cierre_diario.estadisticas.retrasos_dia }}</div>
        </div>
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;text-align:center">
          <div style="font-size:.62rem;color:#94a3b8;margin-bottom:4px">Faltas</div>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.3rem;color:#f87171">{{ cierre_diario.estadisticas.faltas_dia }}</div>
        </div>
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;text-align:center">
          <div style="font-size:.62rem;color:#94a3b8;margin-bottom:4px">Canceladas</div>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.3rem;color:#94a3b8">{{ cierre_diario.estadisticas.canceladas_dia }}</div>
        </div>
      </div>
    </div>

    <!-- Comparativa √∫ltimos 7 d√≠as -->
    {% if cierre_diario.comparativa_dias %}
    <div style="margin-top:16px">
      <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:10px">√öltimos 7 d√≠as</div>
      <div style="overflow-x:auto">
        <table style="width:100%;min-width:600px">
          <thead>
            <tr style="background:rgba(255,255,255,.05)">
              <th style="text-align:left;padding:8px;font-size:.65rem;color:#94a3b8">D√≠a</th>
              <th style="text-align:left;padding:8px;font-size:.65rem;color:#94a3b8">Fecha</th>
              <th style="text-align:center;padding:8px;font-size:.65rem;color:#94a3b8">Sesiones</th>
              <th style="text-align:right;padding:8px;font-size:.65rem;color:#94a3b8">Generado</th>
              <th style="text-align:right;padding:8px;font-size:.65rem;color:#94a3b8">Cobrado</th>
            </tr>
          </thead>
          <tbody>
            {% for dia in cierre_diario.comparativa_dias %}
            <tr style="border-bottom:1px solid rgba(255,255,255,.05)">
              <td style="padding:8px;color:#e2e8f0;font-size:.75rem">{{ dia.dia_semana }}</td>
              <td style="padding:8px;color:#94a3b8;font-size:.72rem">{{ dia.fecha|date:"d/m/Y" }}</td>
              <td style="padding:8px;text-align:center;color:#e2e8f0;font-family:'JetBrains Mono',monospace;font-weight:700">{{ dia.sesiones }}</td>
              <td style="padding:8px;text-align:right;color:#e2e8f0;font-family:'JetBrains Mono',monospace;font-weight:700">Bs. {{ dia.ingresos|floatformat:2 }}</td>
              <td style="padding:8px;text-align:right;color:#86efac;font-family:'JetBrains Mono',monospace;font-weight:900">Bs. {{ dia.cobrado|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Pagos del d√≠a (DETALLE COMPLETO) -->
    {% if cierre_diario.pagos_agrupados %}
    <div style="margin-top:16px" class="page-break">
      <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:10px">
        Recibos del d√≠a ({{ cierre_diario.pagos_agrupados|length }})
      </div>
      {% for rec in cierre_diario.pagos_agrupados %}
      <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px 14px;margin-bottom:8px">
        <!-- Header del recibo -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;flex-wrap:wrap;gap:8px">
          <div>
            <span style="font-family:'JetBrains Mono',monospace;font-size:.85rem;color:#86efac;font-weight:700">{{ rec.recibo }}</span>
            {% if rec.es_masivo %}
            <span style="font-size:.62rem;background:rgba(124,58,237,.3);color:#c4b5fd;padding:2px 6px;border-radius:4px;margin-left:6px">MASIVO</span>
            {% endif %}
            <div style="font-size:.68rem;color:#94a3b8;margin-top:3px">
              {{ rec.paciente.nombre_completo }} ‚Ä¢ {{ rec.metodo_pago.nombre }}
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-family:'JetBrains Mono',monospace;font-weight:900;font-size:1.2rem;color:#86efac">Bs. {{ rec.total|floatformat:2 }}</div>
            <div style="font-size:.65rem;color:#64748b;margin-top:2px">{{ rec.fecha_registro|date:"H:i" }}</div>
          </div>
        </div>
        
        <!-- Detalles del recibo -->
        {% if rec.es_masivo %}
        <div style="border-top:1px solid rgba(255,255,255,.05);padding-top:8px;margin-top:8px">
          <div style="font-size:.65rem;color:#94a3b8;margin-bottom:6px;font-weight:700">DETALLES:</div>
          {% for pago in rec.pagos %}
          <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 8px;background:rgba(255,255,255,.02);border-radius:5px;margin-bottom:4px">
            <div style="font-size:.7rem;color:#e2e8f0">
              {% if pago.sesion %}
                üè• Sesi√≥n {{ pago.sesion.servicio.nombre }} ({{ pago.sesion.fecha|date:"d/m" }})
              {% elif pago.proyecto %}
                üìã Proyecto {{ pago.proyecto.servicio_base.nombre }}
              {% else %}
                üí∞ Pago adelantado
              {% endif %}
            </div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.75rem;color:#86efac;font-weight:700">Bs. {{ pago.monto|floatformat:2 }}</div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <!-- Recibo simple -->
        <div style="border-top:1px solid rgba(255,255,255,.05);padding-top:8px;margin-top:8px">
          {% with pago=rec.pagos.0 %}
          <div style="font-size:.7rem;color:#e2e8f0">
            {% if pago.sesion %}
              üè• Sesi√≥n {{ pago.sesion.servicio.nombre }} ‚Ä¢ {{ pago.sesion.profesional.nombre_completo }}
              <div style="font-size:.65rem;color:#64748b;margin-top:2px">{{ pago.sesion.fecha|date:"d/m/Y" }} a las {{ pago.sesion.hora_inicio }}</div>
            {% elif pago.proyecto %}
              üìã Proyecto {{ pago.proyecto.servicio_base.nombre }} ‚Ä¢ {{ pago.proyecto.profesional_responsable.nombre_completo }}
              <div style="font-size:.65rem;color:#64748b;margin-top:2px">Inicio: {{ pago.proyecto.fecha_inicio|date:"d/m/Y" }}</div>
            {% else %}
              üí∞ Pago adelantado (cr√©dito disponible)
            {% endif %}
          </div>
          {% endwith %}
        </div>
        {% endif %}
        
        <!-- Footer con info adicional -->
        {% if rec.observaciones or rec.numero_transaccion %}
        <div style="border-top:1px solid rgba(255,255,255,.05);padding-top:6px;margin-top:6px;font-size:.65rem;color:#64748b">
          {% if rec.numero_transaccion %}<div>Trans: {{ rec.numero_transaccion }}</div>{% endif %}
          {% if rec.observaciones %}<div>Obs: {{ rec.observaciones }}</div>{% endif %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VISTA: DETALLE PAGOS (TODOS LOS PAGOS) -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if vista == 'detalle_pagos' %}
  <div class="table-card">
    <h3>
      üí≥ Listado Completo de Pagos
      <span class="badge-count">{{ detalle_pagos.count }} registros</span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>N¬∞ Recibo</th>
          <th>Fecha/Hora</th>
          <th>Paciente</th>
          <th>Concepto</th>
          <th>M√©todo</th>
          <th class="td-right">Monto</th>
          <th>Registrado por</th>
          <th class="td-center">Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for pago in detalle_pagos %}
        <tr>
          <td class="td-mono">{{ pago.numero_recibo }}</td>
          <td>
            {{ pago.fecha_pago|date:"d/m/Y" }}<br>
            <small style="color:var(--muted)">{{ pago.fecha_registro|date:"H:i" }}</small>
          </td>
          <td>
            <strong>{{ pago.paciente.nombre_completo }}</strong>
            {% if pago.paciente.telefono_tutor %}
            <br><small style="color:var(--muted)">{{ pago.paciente.telefono_tutor }}</small>
            {% endif %}
          </td>
          <td>
            {% if pago.sesion %}
              <span class="tag blue">SESI√ìN</span> {{ pago.sesion.servicio.nombre }}
              <br><small style="color:var(--muted)">{{ pago.sesion.fecha|date:"d/m/Y" }}</small>
            {% elif pago.proyecto %}
              <span class="tag purple">PROYECTO</span> {{ pago.proyecto.servicio_base.nombre }}
            {% elif pago.mensualidad %}
              <span class="tag teal">MENSUALIDAD</span> {{ pago.mensualidad.servicio.nombre }}
            {% else %}
              <span class="tag amber">ADELANTADO</span> Cr√©dito
            {% endif %}
            {% if pago.concepto %}
            <br><small style="color:var(--muted)">{{ pago.concepto|truncatewords:6 }}</small>
            {% endif %}
          </td>
          <td>
            <span class="tag {% if pago.metodo_pago.nombre == 'Efectivo' %}green{% elif pago.metodo_pago.nombre == 'Uso de Cr√©dito' %}purple{% else %}blue{% endif %}">
              {{ pago.metodo_pago.nombre }}
            </span>
            {% if pago.numero_transaccion %}
            <br><small style="color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.65rem">{{ pago.numero_transaccion }}</small>
            {% endif %}
          </td>
          <td class="td-right td-mono" style="color:var(--green);font-weight:800">Bs. {{ pago.monto|floatformat:2 }}</td>
          <td><small style="color:var(--muted)">{{ pago.registrado_por.username }}</small></td>
          <td class="td-center">
            {% if pago.anulado %}
            <span class="tag red">ANULADO</span>
            {% else %}
            <span class="tag green">V√ÅLIDO</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="empty-state">
            <div style="padding:40px;text-align:center;color:var(--muted)">
              No hay pagos registrados en el per√≠odo seleccionado
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Totales por m√©todo -->
  <div class="section-hdr"><h2>Resumen por M√©todo de Pago</h2></div>
  <div class="method-grid">
    {% for m in detalle_pagos_metodos %}
    <div class="method-card">
      <div class="mc2-label">{{ m.metodo_pago__nombre }}</div>
      <div class="mc2-val">Bs. {{ m.total|floatformat:2 }}</div>
      <div class="mc2-count">{{ m.cantidad }} transacciones</div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VISTA: DETALLE SESIONES -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if vista == 'detalle_sesiones' %}
  <div class="table-card">
    <h3>
      üè• Listado Completo de Sesiones
      <span class="badge-count">{{ detalle_sesiones.count }} sesiones</span>
    </h3>
    <p style="font-size:.72rem;color:var(--muted);margin:-4px 0 10px">Incluye todos los estados. El monto pagado incluye pagos masivos y excluye "Uso de Cr√©dito".</p>
    <!-- Contadores por estado -->
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
      <span class="tag blue">Prog: {{ detalle_sesiones_totales.por_estado.programada }}</span>
      <span class="tag green">Realiz.: {{ detalle_sesiones_totales.por_estado.realizada }}</span>
      <span class="tag amber">Retraso: {{ detalle_sesiones_totales.por_estado.realizada_retraso }}</span>
      <span class="tag red">Falta: {{ detalle_sesiones_totales.por_estado.falta }}</span>
      <span class="tag teal">Permiso: {{ detalle_sesiones_totales.por_estado.permiso }}</span>
      <span class="tag" style="background:var(--border);color:var(--muted)">Cancelada: {{ detalle_sesiones_totales.por_estado.cancelada }}</span>
      <span class="tag purple">Reprog.: {{ detalle_sesiones_totales.por_estado.reprogramada }}</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Paciente</th>
          <th>Servicio</th>
          <th>Profesional</th>
          <th>Sucursal</th>
          <th class="td-center">Estado</th>
          <th class="td-right">Cobrado</th>
          <th class="td-right">Pagado</th>
          <th class="td-center">Estado Pago</th>
        </tr>
      </thead>
      <tbody>
        {% for sesion in detalle_sesiones %}
        <tr>
          <td>
            <strong>{{ sesion.fecha|date:"d/m/Y" }}</strong><br>
            <small style="color:var(--muted)">{{ sesion.hora_inicio }} - {{ sesion.hora_fin }}</small>
          </td>
          <td><strong>{{ sesion.paciente.nombre_completo }}</strong></td>
          <td>
            <span class="tag" style="background-color:{{ sesion.servicio.color }}22;color:{{ sesion.servicio.color }}">
              {{ sesion.servicio.nombre }}
            </span>
            <br><small style="color:var(--muted)">{{ sesion.duracion_minutos }} min</small>
          </td>
          <td>{{ sesion.profesional.nombre_completo }}</td>
          <td><small style="color:var(--muted)">{{ sesion.sucursal.nombre }}</small></td>
          <td class="td-center">
            {% if sesion.estado == 'programada' %}<span class="tag blue">PROGRAMADA</span>
            {% elif sesion.estado == 'realizada' %}<span class="tag green">REALIZADA</span>
            {% elif sesion.estado == 'realizada_retraso' %}<span class="tag amber">RETRASO</span>
            {% elif sesion.estado == 'falta' %}<span class="tag red">FALTA</span>
            {% elif sesion.estado == 'permiso' %}<span class="tag teal">PERMISO</span>
            {% elif sesion.estado == 'cancelada' %}<span class="tag" style="background:var(--border);color:var(--muted)">CANCELADA</span>
            {% elif sesion.estado == 'reprogramada' %}<span class="tag purple">REPROGRAMADA</span>
            {% endif %}
          </td>
          <td class="td-right td-mono" style="font-weight:700">Bs. {{ sesion.monto_cobrado|floatformat:2 }}</td>
          <td class="td-right td-mono" style="color:var(--green);font-weight:800">
            {% if sesion.monto_pagado %}Bs. {{ sesion.monto_pagado|floatformat:2 }}
            {% else %}<span style="color:var(--muted)">-</span>{% endif %}
          </td>
          <td class="td-center">
            {% if sesion.monto_cobrado == 0 %}
            <span class="tag" style="background:var(--border);color:var(--muted)">N/A</span>
            {% elif sesion.monto_pendiente > 0 %}
            <span class="tag amber">PENDIENTE</span><br>
            <small style="color:var(--muted)">Bs. {{ sesion.monto_pendiente|floatformat:2 }}</small>
            {% elif sesion.monto_pagado %}
            <span class="tag green">PAGADO</span>
            {% else %}
            <span class="tag red">SIN PAGO</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" style="padding:40px;text-align:center;color:var(--muted)">No hay sesiones en el per√≠odo seleccionado</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="stats-row">
    <div class="stat-mini">
      <div class="sm-label">Total Generado</div>
      <div class="sm-val" style="font-size:1.1rem">Bs. {{ detalle_sesiones_totales.total_generado|floatformat:2 }}</div>
      <div class="sm-sub">monto_cobrado acumulado</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Total Pagado</div>
      <div class="sm-val" style="font-size:1.1rem;color:var(--green)">Bs. {{ detalle_sesiones_totales.total_pagado|floatformat:2 }}</div>
      <div class="sm-sub">directos + masivos</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Total Pendiente</div>
      <div class="sm-val" style="font-size:1.1rem;color:var(--amber)">Bs. {{ detalle_sesiones_totales.total_pendiente|floatformat:2 }}</div>
      <div class="sm-sub">generado ‚àí pagado</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Tasa Cobranza</div>
      <div class="sm-val" style="font-size:1.1rem">{{ detalle_sesiones_totales.tasa_cobranza|floatformat:1 }}%</div>
      <div class="sm-sub">sobre monto generado</div>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VISTA: DETALLE PROYECTOS -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if vista == 'detalle_proyectos' %}
  <div class="table-card">
    <h3>
      üìã Listado Completo de Proyectos
      <span class="badge-count">{{ detalle_proyectos.count }} proyectos</span>
    </h3>
    <p style="font-size:.72rem;color:var(--muted);margin:-4px 0 10px">Incluye todos los estados. Pagado neto = directos + masivos ‚àí devoluciones.</p>
    <!-- Contadores por estado -->
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
      <span class="tag blue">Planificado: {{ detalle_proyectos_totales.planificados }}</span>
      <span class="tag amber">En Progreso: {{ detalle_proyectos_totales.activos }}</span>
      <span class="tag green">Finalizado: {{ detalle_proyectos_totales.finalizados }}</span>
      <span class="tag red">Cancelado: {{ detalle_proyectos_totales.cancelados }}</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Fecha Inicio</th>
          <th>Paciente</th>
          <th>Servicio</th>
          <th>Profesional</th>
          <th class="td-right">Costo Total</th>
          <th class="td-right">Pagado Neto</th>
          <th class="td-right">Pendiente</th>
          <th class="td-center">Estado</th>
          <th class="td-center">Pago</th>
        </tr>
      </thead>
      <tbody>
        {% for proyecto in detalle_proyectos %}
        <tr>
          <td>
            <strong>{{ proyecto.fecha_inicio|date:"d/m/Y" }}</strong>
            {% if proyecto.fecha_fin %}<br><small style="color:var(--muted)">Fin: {{ proyecto.fecha_fin|date:"d/m/Y" }}</small>{% endif %}
          </td>
          <td><strong>{{ proyecto.paciente.nombre_completo }}</strong></td>
          <td>
            <span class="tag" style="background-color:{{ proyecto.servicio_base.color }}22;color:{{ proyecto.servicio_base.color }}">
              {{ proyecto.servicio_base.nombre }}
            </span>
            {% if proyecto.descripcion %}<br><small style="color:var(--muted)">{{ proyecto.descripcion|truncatewords:8 }}</small>{% endif %}
          </td>
          <td>{{ proyecto.profesional_responsable.nombre_completo }}</td>
          <td class="td-right td-mono" style="font-weight:700">Bs. {{ proyecto.costo_total|floatformat:2 }}</td>
          <td class="td-right td-mono" style="color:var(--green);font-weight:800">
            {% if proyecto.monto_pagado %}Bs. {{ proyecto.monto_pagado|floatformat:2 }}
            {% else %}<span style="color:var(--muted)">-</span>{% endif %}
          </td>
          <td class="td-right td-mono" style="color:var(--amber);font-weight:700">
            {% if proyecto.monto_pendiente > 0 %}Bs. {{ proyecto.monto_pendiente|floatformat:2 }}
            {% else %}<span style="color:var(--muted)">0.00</span>{% endif %}
          </td>
          <td class="td-center">
            {% if proyecto.estado == 'planificado' %}<span class="tag blue">PLANIFICADO</span>
            {% elif proyecto.estado == 'en_progreso' %}<span class="tag amber">EN PROGRESO</span>
            {% elif proyecto.estado == 'finalizado' %}<span class="tag green">FINALIZADO</span>
            {% elif proyecto.estado == 'cancelado' %}<span class="tag red">CANCELADO</span>
            {% endif %}
          </td>
          <td class="td-center">
            {% if proyecto.monto_pendiente > 0 %}<span class="tag amber">PENDIENTE</span>
            {% elif proyecto.monto_pagado %}<span class="tag green">PAGADO</span>
            {% else %}<span class="tag red">SIN PAGO</span>{% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" style="padding:40px;text-align:center;color:var(--muted)">No hay proyectos en el per√≠odo seleccionado</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="stats-row">
    <div class="stat-mini">
      <div class="sm-label">Total Generado</div>
      <div class="sm-val" style="font-size:1.1rem">Bs. {{ detalle_proyectos_totales.total_generado|floatformat:2 }}</div>
      <div class="sm-sub">costo_total acumulado</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Total Pagado Neto</div>
      <div class="sm-val" style="font-size:1.1rem;color:var(--green)">Bs. {{ detalle_proyectos_totales.total_pagado|floatformat:2 }}</div>
      <div class="sm-sub">directos + masivos ‚àí devoluciones</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Total Pendiente</div>
      <div class="sm-val" style="font-size:1.1rem;color:var(--amber)">Bs. {{ detalle_proyectos_totales.total_pendiente|floatformat:2 }}</div>
      <div class="sm-sub">generado ‚àí pagado neto</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Planificados</div>
      <div class="sm-val">{{ detalle_proyectos_totales.planificados }}</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">En Progreso</div>
      <div class="sm-val">{{ detalle_proyectos_totales.activos }}</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Finalizados</div>
      <div class="sm-val">{{ detalle_proyectos_totales.finalizados }}</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Cancelados</div>
      <div class="sm-val">{{ detalle_proyectos_totales.cancelados }}</div>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VISTA: DETALLE MENSUALIDADES -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if vista == 'detalle_mensualidades' %}
  <div class="table-card">
    <h3>
      üìÖ Listado Completo de Mensualidades
      <span class="badge-count">{{ detalle_mensualidades.count }} mensualidades</span>
    </h3>
    <p style="font-size:.72rem;color:var(--muted);margin:-4px 0 10px">Incluye todos los estados. Pagado neto = directos + masivos ‚àí devoluciones.</p>
    <!-- Contadores por estado -->
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
      <span class="tag green">Activa: {{ detalle_mensualidades_totales.activas }}</span>
      <span class="tag amber">Pausada: {{ detalle_mensualidades_totales.pausadas }}</span>
      <span class="tag blue">Completada: {{ detalle_mensualidades_totales.completadas }}</span>
      <span class="tag red">Cancelada: {{ detalle_mensualidades_totales.canceladas }}</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Per√≠odo</th>
          <th>Paciente</th>
          <th>Servicios</th>
          <th>Sucursal</th>
          <th class="td-right">Costo Mensual</th>
          <th class="td-right">Pagado Neto</th>
          <th class="td-right">Pendiente</th>
          <th class="td-center">Estado</th>
          <th class="td-center">Pago</th>
        </tr>
      </thead>
      <tbody>
        {% for mensualidad in detalle_mensualidades %}
        <tr>
          <td>
            <strong>{{ mensualidad.get_mes_display|default:mensualidad.mes }}/{{ mensualidad.anio }}</strong>
          </td>
          <td><strong>{{ mensualidad.paciente.nombre_completo }}</strong></td>
          <td>
            {% for sp in mensualidad.servicios_profesionales.all %}
            <span class="tag teal" style="margin-bottom:2px;display:inline-block">{{ sp.servicio.nombre }}</span>
            <br><small style="color:var(--muted)">{{ sp.profesional.nombre_completo }}</small>
            {% empty %}
            <span style="color:var(--muted)">-</span>
            {% endfor %}
          </td>
          <td><small style="color:var(--muted)">{{ mensualidad.sucursal.nombre }}</small></td>
          <td class="td-right td-mono" style="font-weight:700">Bs. {{ mensualidad.costo_mensual|floatformat:2 }}</td>
          <td class="td-right td-mono" style="color:var(--green);font-weight:800">
            {% if mensualidad.monto_pagado %}Bs. {{ mensualidad.monto_pagado|floatformat:2 }}
            {% else %}<span style="color:var(--muted)">-</span>{% endif %}
          </td>
          <td class="td-right td-mono" style="color:var(--amber);font-weight:700">
            {% if mensualidad.monto_pendiente > 0 %}Bs. {{ mensualidad.monto_pendiente|floatformat:2 }}
            {% else %}<span style="color:var(--muted)">0.00</span>{% endif %}
          </td>
          <td class="td-center">
            {% if mensualidad.estado == 'activa' %}<span class="tag green">ACTIVA</span>
            {% elif mensualidad.estado == 'pausada' %}<span class="tag amber">PAUSADA</span>
            {% elif mensualidad.estado == 'completada' %}<span class="tag blue">COMPLETADA</span>
            {% elif mensualidad.estado == 'cancelada' %}<span class="tag red">CANCELADA</span>
            {% elif mensualidad.estado == 'vencida' %}<span class="tag red">VENCIDA</span>
            {% else %}<span class="tag">{{ mensualidad.estado }}</span>
            {% endif %}
          </td>
          <td class="td-center">
            {% if mensualidad.monto_pendiente > 0 %}<span class="tag amber">PENDIENTE</span>
            {% elif mensualidad.monto_pagado %}<span class="tag green">PAGADO</span>
            {% else %}<span class="tag red">SIN PAGO</span>{% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" style="padding:40px;text-align:center;color:var(--muted)">No hay mensualidades en el per√≠odo seleccionado</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="stats-row">
    <div class="stat-mini">
      <div class="sm-label">Total Generado</div>
      <div class="sm-val" style="font-size:1.1rem">Bs. {{ detalle_mensualidades_totales.total_generado|floatformat:2 }}</div>
      <div class="sm-sub">costo_mensual acumulado</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Total Pagado Neto</div>
      <div class="sm-val" style="font-size:1.1rem;color:var(--green)">Bs. {{ detalle_mensualidades_totales.total_pagado|floatformat:2 }}</div>
      <div class="sm-sub">directos + masivos ‚àí devoluciones</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Total Pendiente</div>
      <div class="sm-val" style="font-size:1.1rem;color:var(--amber)">Bs. {{ detalle_mensualidades_totales.total_pendiente|floatformat:2 }}</div>
      <div class="sm-sub">generado ‚àí pagado neto</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Tasa Cobranza</div>
      <div class="sm-val" style="font-size:1.1rem">{{ detalle_mensualidades_totales.tasa_cobranza|floatformat:1 }}%</div>
      <div class="sm-sub">sobre monto generado</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Activas</div>
      <div class="sm-val">{{ detalle_mensualidades_totales.activas }}</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Pausadas</div>
      <div class="sm-val">{{ detalle_mensualidades_totales.pausadas }}</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Completadas</div>
      <div class="sm-val">{{ detalle_mensualidades_totales.completadas }}</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Canceladas</div>
      <div class="sm-val">{{ detalle_mensualidades_totales.canceladas }}</div>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VISTA: AN√ÅLISIS DE CR√âDITOS -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if vista == 'analisis_creditos' %}
  
  <!-- Resumen cr√©ditos -->
  <div class="credit-grid">
    <div class="credit-card">
      <div class="cr-label">Cr√©ditos Generados</div>
      <div class="cr-val">Bs. {{ analisis_creditos.total_generado|floatformat:2 }}</div>
      <div class="cr-sub">{{ analisis_creditos.cantidad_generados }} pagos adelantados</div>
    </div>
    <div class="credit-card">
      <div class="cr-label">Cr√©ditos Utilizados</div>
      <div class="cr-val">Bs. {{ analisis_creditos.total_utilizado|floatformat:2 }}</div>
      <div class="cr-sub">{{ analisis_creditos.cantidad_utilizados }} usos</div>
    </div>
    <div class="credit-card">
      <div class="cr-label">Saldo Neto</div>
      <div class="cr-val" style="color:{% if analisis_creditos.saldo_neto >= 0 %}var(--green){% else %}var(--red){% endif %}">
        Bs. {{ analisis_creditos.saldo_neto|floatformat:2 }}
      </div>
      <div class="cr-sub">Cr√©dito disponible en sistema</div>
    </div>
  </div>

  <!-- Listado de cr√©ditos generados -->
  <div class="table-card">
    <h3>
      üí∞ Cr√©ditos Generados (Pagos Adelantados)
      <span class="badge-count">{{ analisis_creditos.generados.count }} registros</span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>N¬∞ Recibo</th>
          <th>Fecha</th>
          <th>Paciente</th>
          <th>M√©todo Pago</th>
          <th class="td-right">Monto</th>
          <th>Registrado por</th>
          <th>Observaciones</th>
        </tr>
      </thead>
      <tbody>
        {% for pago in analisis_creditos.generados %}
        <tr>
          <td class="td-mono">{{ pago.numero_recibo }}</td>
          <td>{{ pago.fecha_pago|date:"d/m/Y" }}<br><small style="color:var(--muted)">{{ pago.fecha_registro|date:"H:i" }}</small></td>
          <td><strong>{{ pago.paciente.nombre_completo }}</strong></td>
          <td>
            <span class="tag blue">{{ pago.metodo_pago.nombre }}</span>
          </td>
          <td class="td-right td-mono" style="color:var(--purple);font-weight:800">Bs. {{ pago.monto|floatformat:2 }}</td>
          <td><small style="color:var(--muted)">{{ pago.registrado_por.username }}</small></td>
          <td><small style="color:var(--muted)">{{ pago.concepto|default:"-" }}</small></td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="empty-state">
            <div style="padding:40px;text-align:center;color:var(--muted)">
              No hay cr√©ditos generados en el per√≠odo seleccionado
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Listado de cr√©ditos utilizados -->
  <div class="table-card">
    <h3>
      üíé Cr√©ditos Utilizados
      <span class="badge-count">{{ analisis_creditos.utilizados.count }} registros</span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>N¬∞ Recibo</th>
          <th>Fecha</th>
          <th>Paciente</th>
          <th>Concepto</th>
          <th class="td-right">Monto</th>
          <th>Registrado por</th>
        </tr>
      </thead>
      <tbody>
        {% for pago in analisis_creditos.utilizados %}
        <tr>
          <td class="td-mono">{{ pago.numero_recibo }}</td>
          <td>{{ pago.fecha_pago|date:"d/m/Y" }}<br><small style="color:var(--muted)">{{ pago.fecha_registro|date:"H:i" }}</small></td>
          <td><strong>{{ pago.paciente.nombre_completo }}</strong></td>
          <td>
            {% if pago.sesion %}
              <span class="tag blue">SESI√ìN</span> {{ pago.sesion.servicio.nombre }}
            {% elif pago.proyecto %}
              <span class="tag purple">PROYECTO</span> {{ pago.proyecto.servicio_base.nombre }}
            {% elif pago.mensualidad %}
              <span class="tag teal">MENSUALIDAD</span>
              {% with sp=pago.mensualidad.servicios_profesionales.first %}
                {% if sp %}{{ sp.servicio.nombre }}{% endif %}
              {% endwith %}
            {% else %}
              <span class="tag amber">ADELANTADO</span>
            {% endif %}
          </td>
          <td class="td-right td-mono" style="color:var(--purple);font-weight:800">Bs. {{ pago.monto|floatformat:2 }}</td>
          <td><small style="color:var(--muted)">{{ pago.registrado_por.username }}</small></td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="empty-state">
            <div style="padding:40px;text-align:center;color:var(--muted)">
              No hay cr√©ditos utilizados en el per√≠odo seleccionado
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pacientes con mayor cr√©dito disponible -->
  <div class="card">
    <h3>üë§ Pacientes con Mayor Cr√©dito Disponible</h3>
    <div class="scroll-list">
      {% for p in analisis_creditos.pacientes_con_credito %}
      <div class="list-item">
        <div>
          <div class="li-name">{{ p.nombre }} {{ p.apellido }}</div>
          <div class="li-sub">{{ p.credito_generado|floatformat:2 }} generado ‚Ä¢ {{ p.credito_usado|floatformat:2 }} usado</div>
        </div>
        <div class="li-val" style="color:var(--purple)">Bs. {{ p.credito_disponible|floatformat:2 }}</div>
      </div>
      {% empty %}
      <p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div>

{% if grafico_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const labels = {{ grafico_data.labels|safe }};
const dataIngresos = {{ grafico_data.ingresos|safe }};
const dataSesiones = {{ grafico_data.sesiones|safe }};
const dataProyectos = {{ grafico_data.proyectos|safe }};

// Chart 1: Ingresos
const ctx1 = document.getElementById('chart-ingresos');
if(ctx1) new Chart(ctx1, {
  type:'bar',
  data:{
    labels,
    datasets:[{
      label:'Ingresos Bs.',
      data: dataIngresos,
      backgroundColor:'rgba(22,163,74,.7)',
      borderColor:'#16a34a',
      borderWidth:2,
      borderRadius:6
    }]
  },
  options:{
    responsive:true,maintainAspectRatio:true,
    plugins:{legend:{position:'top',labels:{font:{size:10},padding:12}}},
    scales:{
      y:{beginAtZero:true,ticks:{font:{size:9},callback:v=>'Bs.'+v},grid:{color:'rgba(0,0,0,.04)'}},
      x:{ticks:{font:{size:9}}}
    }
  }
});

// Chart 2: Sesiones vs Proyectos
const ctx2 = document.getElementById('chart-sesiones');
if(ctx2) new Chart(ctx2, {
  type:'bar',
  data:{
    labels,
    datasets:[
      {label:'Sesiones',data:dataSesiones,backgroundColor:'rgba(37,99,235,.7)',borderColor:'#2563eb',borderWidth:2,borderRadius:4},
      {label:'Proyectos',data:dataProyectos,backgroundColor:'rgba(124,58,237,.7)',borderColor:'#7c3aed',borderWidth:2,borderRadius:4}
    ]
  },
  options:{
    responsive:true,maintainAspectRatio:true,
    plugins:{legend:{position:'top',labels:{font:{size:10},padding:12}}},
    scales:{
      y:{beginAtZero:true,ticks:{font:{size:9}},grid:{color:'rgba(0,0,0,.04)'}},
      x:{ticks:{font:{size:9}}}
    }
  }
});
</script>
{% endif %}

<script>
// Collapsible sections
document.querySelectorAll('.collapsible').forEach(el => {
  el.addEventListener('click', () => {
    el.classList.toggle('collapsed');
    const content = el.nextElementSibling;
    if (content) {
      content.classList.toggle('hidden');
    }
  });
});
</script>

{% endblock %}