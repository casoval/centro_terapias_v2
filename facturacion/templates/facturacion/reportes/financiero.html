{% extends 'base.html' %}
{% block title %}Reporte Financiero{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap');
  :root {
    --ink:#0f172a; --ink2:#334155; --muted:#64748b; --border:#e2e8f0;
    --surface:#f8fafc; --white:#ffffff;
    --green:#16a34a; --green-l:#dcfce7; --green-ll:#f0fdf4;
    --blue:#2563eb; --blue-l:#dbeafe;
    --amber:#d97706; --amber-l:#fef3c7;
    --red:#dc2626; --red-l:#fee2e2;
    --purple:#7c3aed; --purple-l:#ede9fe;
    --teal:#0d9488; --teal-l:#ccfbf1;
    --r:12px; --shadow:0 1px 3px rgba(0,0,0,.08),0 4px 16px rgba(0,0,0,.06);
  }
  body { font-family:'Outfit',sans-serif; background:var(--surface); }
  @media print {
    .no-print{display:none!important} body{background:white!important;font-size:11px}
    .page-break{page-break-before:always}
    .rpt-header{background:#1e3a2f!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  }
  .rpt-header {
    background:linear-gradient(135deg,#1a2f1a 0%,#1e3a2f 50%,#14532d 100%);
    border-radius:16px;padding:24px 28px;margin-bottom:20px;color:white;position:relative;overflow:hidden;
  }
  .rpt-header::after{content:'';position:absolute;top:-30px;right:-30px;width:180px;height:180px;
    background:radial-gradient(circle,rgba(34,197,94,.2) 0%,transparent 70%);border-radius:50%}
  .rpt-header .back{color:#86efac;text-decoration:none;font-size:.75rem;font-weight:600;
    display:inline-flex;align-items:center;gap:4px;margin-bottom:10px}
  .rpt-header h1{font-size:1.5rem;font-weight:800;margin:0 0 4px;letter-spacing:-.02em}
  .rpt-header p{color:#a7f3d0;font-size:.8rem;margin:0}
  .print-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.3);color:white;font-size:.75rem;font-weight:600;
    padding:6px 14px;border-radius:8px;cursor:pointer;margin-top:10px;transition:all .15s}
  .print-btn:hover{background:rgba(255,255,255,.25)}

  .tabs{display:flex;gap:0;background:var(--white);border:1px solid var(--border);
    border-radius:10px;padding:3px;margin-bottom:14px;overflow-x:auto}
  .tab{flex:none;font-size:.75rem;font-weight:600;padding:6px 14px;border-radius:7px;
    cursor:pointer;white-space:nowrap;color:var(--muted);text-decoration:none;transition:all .15s}
  .tab.active,.tab:hover{background:var(--green);color:white}

  .filter-bar{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:16px}
  .filter-bar form{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}
  .filter-bar select,.filter-bar input[type=date]{padding:7px 10px;font-size:.78rem;
    border:1px solid var(--border);border-radius:8px;color:var(--ink);font-family:'Outfit',sans-serif}
  .btn-primary{background:var(--green);color:white;border:none;padding:7px 16px;
    border-radius:8px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif}

  /* Hero money cards */
  .money-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px}
  .money-card{border-radius:14px;padding:20px;border:2px solid;position:relative;overflow:hidden}
  .money-card::before{content:'';position:absolute;top:-20px;right:-20px;width:100px;height:100px;border-radius:50%;opacity:.08;background:currentColor}
  .mc-label{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
  .mc-val{font-size:1.8rem;font-weight:900;font-family:'JetBrains Mono',monospace;line-height:1}
  .mc-sub{font-size:.7rem;margin-top:6px;opacity:.75}
  .mc-badge{position:absolute;top:14px;right:14px;font-size:.62rem;font-weight:700;
    opacity:.6;background:rgba(0,0,0,.08);padding:2px 7px;border-radius:6px}

  /* Stats row */
  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:16px}
  .stat-mini{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
  .sm-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:4px}
  .sm-val{font-size:1.3rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--ink)}
  .sm-sub{font-size:.62rem;color:var(--muted);margin-top:2px}

  /* Charts */
  .chart-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:16px}
  .chart-card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
  @media(max-width:768px){.two-col{grid-template-columns:1fr}}

  /* Method cards */
  .method-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:16px}
  .method-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px}
  .mc2-label{font-size:.65rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
  .mc2-val{font-size:1.1rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--ink)}
  .mc2-count{font-size:.68rem;color:var(--muted);margin-top:3px}
  .mc2-bar{height:4px;background:var(--border);border-radius:10px;margin-top:8px;overflow:hidden}
  .mc2-fill{height:100%;background:var(--green);border-radius:10px;transition:width 1s}

  /* Card list */
  .card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px}
  .card h3{font-size:.8rem;font-weight:700;color:var(--ink);margin:0 0 10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;
    padding:9px 10px;border-radius:8px;background:var(--surface);margin-bottom:6px}
  .li-name{font-size:.78rem;font-weight:700;color:var(--ink)}
  .li-sub{font-size:.65rem;color:var(--muted);margin-top:2px}
  .li-val{font-size:.9rem;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--green)}
  .scroll-list{max-height:260px;overflow-y:auto}

  /* Cierre de caja */
  .cierre-box{background:linear-gradient(135deg,#0f172a,#1e3a2f);border-radius:16px;
    padding:24px;color:white;margin-bottom:20px}
  .cierre-box h2{font-size:1.1rem;font-weight:800;margin:0 0 16px;color:#86efac}
  .cierre-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .cierre-item{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:14px}
  .ci-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#94a3b8;margin-bottom:6px}
  .ci-val{font-size:1.3rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:white}
  .ci-sub{font-size:.62rem;color:#64748b;margin-top:3px}
  .ci-highlight{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.3)}
  .ci-highlight .ci-val{color:#86efac}
  .ci-danger{background:rgba(220,38,38,.15);border-color:rgba(220,38,38,.3)}
  .ci-danger .ci-val{color:#fca5a5}

  /* Top pacientes */
  .top-row{display:flex;justify-content:space-between;align-items:center;
    padding:9px 12px;background:var(--surface);border-radius:8px;margin-bottom:6px}
  .tr-rank{font-size:.7rem;font-weight:800;color:var(--muted);width:20px}
  .tr-name{font-size:.8rem;font-weight:700;color:var(--ink);flex:1;padding:0 10px}
  .tr-val{font-size:.82rem;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--green)}

  /* Section header */
  .section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:6px}
  .section-hdr h2{font-size:.95rem;font-weight:800;color:var(--ink);margin:0}
  .badge-count{font-size:.65rem;background:var(--green-l);color:var(--green);
    padding:3px 8px;border-radius:6px;font-weight:700}

  /* Period badge */
  .period-badge{display:inline-flex;align-items:center;gap:5px;font-size:.7rem;font-weight:700;
    padding:4px 10px;border-radius:20px;background:rgba(34,197,94,.2);
    color:#86efac;border:1px solid rgba(34,197,94,.3)}

  /* Credit section */
  .credit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:16px}
  .credit-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-left:3px solid var(--purple)}
  .cr-label{font-size:.62rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
  .cr-val{font-size:1.1rem;font-weight:900;font-family:'JetBrains Mono',monospace;color:var(--purple)}
  .cr-sub{font-size:.65rem;color:var(--muted);margin-top:3px}

  .tag{display:inline-block;font-size:.62rem;font-weight:700;padding:2px 7px;border-radius:5px;
    background:var(--green-l);color:var(--green)}
  .tag.amber{background:var(--amber-l);color:var(--amber)}
  .tag.red{background:var(--red-l);color:var(--red)}
  .tag.blue{background:var(--blue-l);color:var(--blue)}
</style>

<div class="max-w-7xl mx-auto px-3 py-4">

  <!-- Header -->
  <div class="rpt-header no-print">
    <a href="{% url 'facturacion:dashboard_reportes' %}" class="back">‚Üê Volver a Reportes</a>
    <h1>üí∞ Reporte Financiero</h1>
    <p>Ingresos ¬∑ Sesiones ¬∑ Proyectos ¬∑ Cr√©ditos ¬∑ M√©todos de pago</p>
    <button onclick="window.print()" class="print-btn">üñ®Ô∏è Imprimir / PDF</button>
  </div>

  <!-- View Tabs -->
  <div class="tabs no-print">
    <a href="?vista=mensual&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'mensual' or not vista %}active{% endif %}">üìÖ Vista Mensual</a>
    <a href="?vista=diaria&fecha_desde={{ fecha_hasta }}&fecha_hasta={{ fecha_hasta }}&sucursal={{ sucursal_id }}"
       class="tab {% if vista == 'diaria' %}active{% endif %}">üìÜ Cierre Diario</a>
  </div>

  <!-- Filters -->
  <div class="filter-bar no-print">
    <form method="get">
      <input type="hidden" name="vista" value="{{ vista|default:'mensual' }}">
      <input type="date" name="fecha_desde" value="{{ fecha_desde }}">
      <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}">
      <select name="sucursal">
        <option value="">Todas las sucursales</option>
        {% for s in sucursales %}
        <option value="{{ s.id }}" {% if sucursal_id == s.id|stringformat:"s" %}selected{% endif %}>{{ s.nombre }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn-primary">üîç Filtrar</button>
    </form>
  </div>

  <!-- Period badge -->
  <div style="margin-bottom:16px">
    <span class="period-badge">üìÖ {{ fecha_desde }} ‚Äî {{ fecha_hasta }}</span>
    {% if vista == 'diaria' %}<span style="font-size:.72rem;font-weight:700;color:var(--amber);background:var(--amber-l);padding:4px 10px;border-radius:20px;border:1px solid #fcd34d;margin-left:8px">üîí Cierre de Caja</span>{% endif %}
  </div>

  <!-- ‚ïê‚ïê HERO MONEY CARDS ‚ïê‚ïê -->
  {% if ingresos %}
  <div class="money-grid">
    <div class="money-card" style="background:var(--green-l);border-color:#86efac;color:var(--green)">
      <span class="mc-badge" style="color:var(--green)">Neto</span>
      <div class="mc-label">Total Cobrado</div>
      <div class="mc-val">Bs. {{ ingresos.total_cobrado|floatformat:2 }}</div>
      <div class="mc-sub">{{ ingresos.sesiones.cantidad_sesiones|default:0 }} ses. + {{ ingresos.proyectos.cantidad_proyectos|default:0 }} proy.</div>
    </div>
    <div class="money-card" style="background:var(--red-l);border-color:#fca5a5;color:var(--red)">
      <span class="mc-badge" style="color:var(--red)">Pendiente</span>
      <div class="mc-label">Por Cobrar</div>
      <div class="mc-val">Bs. {{ ingresos.total_pendiente|floatformat:2 }}</div>
      <div class="mc-sub">sesiones y proyectos sin cobrar</div>
    </div>
    <div class="money-card" style="background:var(--blue-l);border-color:#93c5fd;color:var(--blue)">
      <span class="mc-badge" style="color:var(--blue)">Generado</span>
      <div class="mc-label">Total Generado</div>
      <div class="mc-val">Bs. {{ ingresos.total_generado|floatformat:2 }}</div>
      <div class="mc-sub">antes de cobranzas</div>
    </div>
    <div class="money-card" style="background:var(--amber-l);border-color:#fcd34d;color:var(--amber)">
      <span class="mc-badge" style="color:var(--amber)">Promedio</span>
      <div class="mc-label">Promedio / √çtem</div>
      <div class="mc-val">Bs. {{ ingresos.promedio_por_item|floatformat:2 }}</div>
      <div class="mc-sub">tasa cobranza: {{ ingresos.tasa_cobranza|floatformat:1 }}%</div>
    </div>
  </div>

  <!-- Breakdown by category -->
  <div class="stats-row">
    <div class="stat-mini">
      <div class="sm-label">Sesiones ‚Äî Generado</div>
      <div class="sm-val" style="color:var(--blue)">Bs. {{ ingresos.sesiones.total_generado|floatformat:0 }}</div>
      <div class="sm-sub">{{ ingresos.sesiones.cantidad_sesiones|default:0 }} sesiones</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Sesiones ‚Äî Cobrado</div>
      <div class="sm-val" style="color:var(--green)">Bs. {{ ingresos.sesiones.total_cobrado|floatformat:0 }}</div>
      <div class="sm-sub">en efectivo/transferencia</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Proyectos ‚Äî Generado</div>
      <div class="sm-val" style="color:var(--purple)">Bs. {{ ingresos.proyectos.total_generado|floatformat:0 }}</div>
      <div class="sm-sub">{{ ingresos.proyectos.cantidad_proyectos|default:0 }} proyectos</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Proyectos ‚Äî Cobrado</div>
      <div class="sm-val" style="color:var(--teal)">Bs. {{ ingresos.proyectos.total_cobrado|floatformat:0 }}</div>
      <div class="sm-sub">{{ ingresos.proyectos.proyectos_finalizados|default:0 }} finalizados</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Sesiones ‚Äî Pendiente</div>
      <div class="sm-val" style="color:var(--red)">Bs. {{ ingresos.sesiones.total_pendiente|floatformat:0 }}</div>
      <div class="sm-sub">por cobrar</div>
    </div>
    <div class="stat-mini">
      <div class="sm-label">Proyectos ‚Äî Pendiente</div>
      <div class="sm-val" style="color:var(--red)">Bs. {{ ingresos.proyectos.total_pendiente|floatformat:0 }}</div>
      <div class="sm-sub">activos: {{ ingresos.proyectos.proyectos_activos|default:0 }}</div>
    </div>
  </div>

  <!-- Credits section -->
  {% if ingresos.creditos %}
  <div class="section-hdr"><h2>üí≥ Movimiento de Cr√©ditos</h2></div>
  <div class="credit-grid">
    <div class="credit-card">
      <div class="cr-label">Cr√©ditos Generados</div>
      <div class="cr-val">Bs. {{ ingresos.creditos.generados|floatformat:2 }}</div>
      <div class="cr-sub">{{ ingresos.creditos.generados_cantidad }} pagos adelantados</div>
    </div>
    <div class="credit-card">
      <div class="cr-label">Cr√©ditos Utilizados</div>
      <div class="cr-val" style="color:var(--amber)">Bs. {{ ingresos.creditos.utilizados|floatformat:2 }}</div>
      <div class="cr-sub">{{ ingresos.creditos.utilizados_cantidad }} usos</div>
    </div>
    <div class="credit-card">
      <div class="cr-label">Saldo Neto Cr√©ditos</div>
      <div class="cr-val" style="color:{% if ingresos.creditos.saldo_neto >= 0 %}var(--green){% else %}var(--red){% endif %}">
        Bs. {{ ingresos.creditos.saldo_neto|floatformat:2 }}</div>
      <div class="cr-sub">generados ‚àí utilizados</div>
    </div>
  </div>
  {% endif %}
  {% endif %}{# end if ingresos #}

  <!-- ‚ïê‚ïê CIERRE DIARIO ‚ïê‚ïê -->
  {% if cierre_diario %}
  <div class="cierre-box">
    <h2>üîí Cierre de Caja ‚Äî {{ fecha_desde }}</h2>
    <div class="cierre-grid">
      <div class="cierre-item ci-highlight">
        <div class="ci-label">Total Cobrado Real</div>
        <div class="ci-val">Bs. {{ cierre_diario.total_cobrado|floatformat:2 }}</div>
        <div class="ci-sub">sin cr√©dito interno</div>
      </div>
      {% for metodo, monto in cierre_diario.por_metodo.items %}
      <div class="cierre-item">
        <div class="ci-label">{{ metodo }}</div>
        <div class="ci-val">Bs. {{ monto|floatformat:2 }}</div>
      </div>
      {% endfor %}
      <div class="cierre-item">
        <div class="ci-label">Generado (Sesiones)</div>
        <div class="ci-val">Bs. {{ cierre_diario.monto_generado_sesiones|floatformat:2 }}</div>
        <div class="ci-sub">{{ cierre_diario.cantidad_sesiones }} sesiones realizadas</div>
      </div>
      <div class="cierre-item ci-danger">
        <div class="ci-label">Pendiente del D√≠a</div>
        <div class="ci-val">Bs. {{ cierre_diario.monto_pendiente_sesiones|floatformat:2 }}</div>
        <div class="ci-sub">sin cobrar a√∫n</div>
      </div>
    </div>
    <!-- Estad√≠sticas del d√≠a -->
    {% if cierre_diario.estadisticas %}
    <div style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px">
      <div class="cierre-item">
        <div class="ci-label">Pacientes Atendidos</div>
        <div class="ci-val">{{ cierre_diario.estadisticas.pacientes_unicos }}</div>
      </div>
      <div class="cierre-item">
        <div class="ci-label">Horas Cl√≠nicas</div>
        <div class="ci-val">{{ cierre_diario.estadisticas.horas_trabajadas|floatformat:1 }}h</div>
      </div>
      <div class="cierre-item">
        <div class="ci-label">Ticket Promedio</div>
        <div class="ci-val">Bs. {{ cierre_diario.estadisticas.ticket_promedio|floatformat:0 }}</div>
      </div>
      <div class="cierre-item">
        <div class="ci-label">Retrasos</div>
        <div class="ci-val">{{ cierre_diario.estadisticas.retrasos_dia }}</div>
      </div>
      <div class="cierre-item">
        <div class="ci-label">Faltas</div>
        <div class="ci-val" style="color:#fca5a5">{{ cierre_diario.estadisticas.faltas_dia }}</div>
      </div>
      <div class="cierre-item">
        <div class="ci-label">Canceladas</div>
        <div class="ci-val" style="color:#94a3b8">{{ cierre_diario.estadisticas.canceladas_dia }}</div>
      </div>
    </div>
    {% endif %}
    <!-- Pagos del d√≠a -->
    {% if cierre_diario.pagos_agrupados %}
    <div style="margin-top:16px">
      <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#64748b;margin-bottom:10px">Recibos del d√≠a</div>
      {% for rec in cierre_diario.pagos_agrupados %}
      <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
        <div>
          <span style="font-family:'JetBrains Mono',monospace;font-size:.8rem;color:#e2e8f0;font-weight:700">{{ rec.pagos.0.numero_recibo }}</span>
          <span style="font-size:.65rem;color:#64748b;margin-left:8px">{{ rec.pagos.0.paciente.nombre_completo }}</span>
          {% if rec.es_masivo %}<span style="font-size:.62rem;background:rgba(124,58,237,.3);color:#c4b5fd;padding:2px 6px;border-radius:4px;margin-left:6px">masivo</span>{% endif %}
        </div>
        <span style="font-family:'JetBrains Mono',monospace;font-weight:900;color:#86efac">Bs. {{ rec.total|floatformat:2 }}</span>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê EVOLUCI√ìN GR√ÅFICO ‚ïê‚ïê -->
  {% if grafico_data %}
  <div class="two-col">
    <div class="chart-card">
      <h3>üìà Evoluci√≥n de Ingresos (√∫ltimos 6 meses)</h3>
      <canvas id="chart-ingresos" height="200"></canvas>
    </div>
    <div class="chart-card">
      <h3>üè• Sesiones vs Proyectos</h3>
      <canvas id="chart-sesiones" height="200"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê M√âTODO DE PAGO ‚ïê‚ïê -->
  {% if por_metodo %}
  <div class="section-hdr"><h2>üí≥ Desglose por M√©todo de Pago</h2></div>
  <div class="method-grid">
    {% with total_metodos=0 %}
    {% for m in por_metodo %}
    <div class="method-card">
      <div class="mc2-label">{{ m.metodo_pago__nombre|default:"Sin m√©todo" }}</div>
      <div class="mc2-val">Bs. {{ m.monto|floatformat:2 }}</div>
      <div class="mc2-count">{{ m.cantidad }} transacciones</div>
      <div class="mc2-bar">
        <div class="mc2-fill" style="width:{% widthratio m.monto por_metodo.0.monto 100 %}%"></div>
      </div>
    </div>
    {% endfor %}
    {% endwith %}
  </div>
  {% endif %}

  <!-- ‚ïê‚ïê SERVICIOS + TOP PACIENTES ‚ïê‚ïê -->
  <div class="two-col">
    <!-- Por servicio -->
    <div class="card">
      <h3>üèÜ Servicios m√°s rentables</h3>
      <div class="scroll-list">
        {% for s in por_servicio %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ s.nombre }}</div>
            <div class="li-sub">{{ s.sesiones }} sesiones ¬∑ {{ s.proyectos }} proyectos</div>
          </div>
          <div class="li-val">Bs. {{ s.ingresos|floatformat:2 }}</div>
        </div>
        {% empty %}
        <p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>
        {% endfor %}
      </div>
    </div>

    <!-- Top pacientes -->
    <div class="card">
      <h3>üë§ Top Pacientes por Consumo</h3>
      <div class="scroll-list">
        {% for p in top_pacientes %}
        <div class="top-row">
          <span class="tr-rank">{{ forloop.counter }}</span>
          <span class="tr-name">{{ p.nombre }} {{ p.apellido }}</span>
          <span class="tr-val">{{ p.sesiones_count|default:0 }} ses.</span>
        </div>
        {% empty %}
        <p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>
        {% endfor %}
      </div>
    </div>
  </div>

</div>

{% if grafico_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const labels = {{ grafico_data.labels|safe }};
const dataIngresos = {{ grafico_data.ingresos|safe }};
const dataSesiones = {{ grafico_data.sesiones|safe }};
const dataProyectos = {{ grafico_data.proyectos|safe }};

// Chart 1: Ingresos
const ctx1 = document.getElementById('chart-ingresos');
if(ctx1) new Chart(ctx1, {
  type:'bar',
  data:{
    labels,
    datasets:[{
      label:'Ingresos Bs.',
      data: dataIngresos,
      backgroundColor:'rgba(22,163,74,.7)',
      borderColor:'#16a34a',
      borderWidth:2,
      borderRadius:6
    }]
  },
  options:{
    responsive:true,maintainAspectRatio:true,
    plugins:{legend:{position:'top',labels:{font:{size:10},padding:12}}},
    scales:{
      y:{beginAtZero:true,ticks:{font:{size:9},callback:v=>'Bs.'+v},grid:{color:'rgba(0,0,0,.04)'}},
      x:{ticks:{font:{size:9}}}
    }
  }
});

// Chart 2: Sesiones vs Proyectos
const ctx2 = document.getElementById('chart-sesiones');
if(ctx2) new Chart(ctx2, {
  type:'bar',
  data:{
    labels,
    datasets:[
      {label:'Sesiones',data:dataSesiones,backgroundColor:'rgba(37,99,235,.7)',borderColor:'#2563eb',borderWidth:2,borderRadius:4},
      {label:'Proyectos',data:dataProyectos,backgroundColor:'rgba(124,58,237,.7)',borderColor:'#7c3aed',borderWidth:2,borderRadius:4}
    ]
  },
  options:{
    responsive:true,maintainAspectRatio:true,
    plugins:{legend:{position:'top',labels:{font:{size:10},padding:12}}},
    scales:{
      y:{beginAtZero:true,ticks:{font:{size:9}},grid:{color:'rgba(0,0,0,.04)'}},
      x:{ticks:{font:{size:9}}}
    }
  }
});
</script>
{% endif %}
{% endblock %}