{% extends 'base.html' %}
{% block title %}Reporte Profesional{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;600&display=swap');
  :root{
    --ink:#0f172a;--ink2:#334155;--muted:#64748b;--border:#e2e8f0;--surface:#f8fafc;--white:#fff;
    --green:#16a34a;--green-l:#dcfce7;--blue:#2563eb;--blue-l:#dbeafe;
    --red:#dc2626;--red-l:#fee2e2;--amber:#d97706;--amber-l:#fef3c7;
    --purple:#7c3aed;--purple-l:#ede9fe;--teal:#0d9488;--teal-l:#ccfbf1;
    --r:12px;
  }
  body{font-family:'Space Grotesk',sans-serif;background:var(--surface)}
  @media print{.no-print{display:none!important} body{background:white!important}}
  .mono{font-family:'Fira Code',monospace}

  .rpt-header{background:linear-gradient(135deg,#052e16 0%,#14532d 50%,#166534 100%);
    border-radius:16px;padding:24px 28px;margin-bottom:20px;color:white;position:relative;overflow:hidden}
  .rpt-header::after{content:'';position:absolute;top:-30px;right:-30px;width:180px;height:180px;
    background:radial-gradient(circle,rgba(34,197,94,.2) 0%,transparent 70%);border-radius:50%}
  .back{color:#86efac;text-decoration:none;font-size:.75rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;margin-bottom:10px}
  .rpt-header h1{font-size:1.5rem;font-weight:800;margin:0 0 4px}
  .rpt-header p{color:#a7f3d0;font-size:.8rem;margin:0}
  .print-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.3);color:white;font-size:.75rem;font-weight:600;
    padding:6px 14px;border-radius:8px;cursor:pointer;margin-top:10px}

  .filter-bar{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:16px}
  .filter-bar form{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}
  .fg{display:flex;flex-direction:column;gap:3px}
  .fg label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
  .fg select,.fg input[type=date]{padding:7px 10px;font-size:.78rem;border:1px solid var(--border);
    border-radius:8px;color:var(--ink);font-family:'Space Grotesk',sans-serif;min-width:150px}
  .btn-primary{background:var(--green);color:white;border:none;padding:7px 16px;border-radius:8px;font-size:.78rem;font-weight:700;cursor:pointer;align-self:flex-end}

  /* Prof card */
  .prof-card{background:linear-gradient(135deg,#052e16,#1a3a2a);border-radius:16px;padding:20px 24px;margin-bottom:16px;color:white;display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .prof-avatar{width:64px;height:64px;border-radius:14px;background:rgba(255,255,255,.15);
    display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;overflow:hidden}
  .prof-info{flex:1;min-width:200px}
  .prof-name{font-size:1.2rem;font-weight:800;margin:0 0 4px}
  .prof-chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
  .chip{display:inline-flex;align-items:center;gap:4px;font-size:.65rem;font-weight:700;
    padding:3px 9px;border-radius:20px;background:rgba(255,255,255,.12);color:rgba(255,255,255,.85)}
  .chip.green{background:rgba(34,197,94,.2);color:#86efac}
  .prof-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-top:12px}
  .pk-item{background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;text-align:center}
  .pk-label{font-size:.58rem;font-weight:700;text-transform:uppercase;opacity:.6;margin-bottom:3px}
  .pk-val{font-size:1.1rem;font-weight:900;font-family:'Fira Code',monospace}

  /* Stats */
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px}
  .kpi-box{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px;position:relative;overflow:hidden}
  .kpi-box .accent{position:absolute;top:0;left:0;width:3px;height:100%;border-radius:12px 0 0 12px}
  .kpi-label{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px}
  .kpi-val{font-size:1.4rem;font-weight:900;color:var(--ink);font-family:'Fira Code',monospace;line-height:1}
  .kpi-sub{font-size:.65rem;color:var(--muted);margin-top:4px}

  /* Rate cards */
  .rate-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:16px}
  .rate-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px}
  .rc-label{font-size:.65rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
  .rc-val{font-size:1.4rem;font-weight:900;font-family:'Fira Code',monospace;margin-bottom:8px}
  .rc-bar{height:6px;background:var(--border);border-radius:10px;overflow:hidden}
  .rc-fill{height:100%;border-radius:10px;transition:width 1s}

  /* Charts */
  .chart-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:16px}
  .chart-card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
  @media(max-width:768px){.two-col{grid-template-columns:1fr}}

  /* Card list */
  .card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:14px}
  .card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:9px 10px;border-radius:8px;background:var(--surface);margin-bottom:6px;flex-wrap:wrap;gap:6px}
  .li-name{font-size:.78rem;font-weight:700;color:var(--ink)}
  .li-sub{font-size:.65rem;color:var(--muted);margin-top:2px}
  .li-val{font-size:.88rem;font-weight:800;font-family:'Fira Code',monospace;color:var(--green)}
  .scroll-list{max-height:240px;overflow-y:auto}

  /* Dia semana */
  .dia-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;background:var(--surface);margin-bottom:5px}
  .dia-nombre{font-size:.75rem;font-weight:700;color:var(--ink2);width:80px}
  .dia-bar-wrap{flex:1;height:16px;background:var(--border);border-radius:8px;overflow:hidden;display:flex}
  .dia-bar-real{height:100%;background:var(--green);border-radius:8px}
  .dia-bar-falta{height:100%;background:var(--red)}
  .dia-count{font-size:.7rem;color:var(--muted);width:40px;text-align:right;font-family:'Fira Code',monospace}

  /* Patient ranking */
  .rank-table{width:100%;border-collapse:collapse;font-size:.75rem}
  .rank-table th{background:var(--surface);font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);padding:8px 10px;text-align:left;border-bottom:2px solid var(--border)}
  .rank-table td{padding:9px 10px;border-bottom:1px solid var(--border)}
  .rank-table tr:hover td{background:var(--green-l)}
  .tasa-bar{height:4px;background:var(--border);border-radius:10px;overflow:hidden;margin-top:3px}
  .tasa-fill{height:100%;border-radius:10px}

  .section-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin:16px 0 12px;display:flex;align-items:center;gap:8px}
  .section-title::after{content:'';flex:1;height:1px;background:var(--border)}
</style>

<div class="max-w-7xl mx-auto px-3 py-4">

  <!-- Header -->
  <div class="rpt-header no-print">
    <a href="{% url 'facturacion:dashboard_reportes' %}" class="back">‚Üê Volver a Reportes</a>
    <h1>üë®‚Äç‚öïÔ∏è Reporte por Profesional</h1>
    <p>Desempe√±o ¬∑ Sesiones ¬∑ Ingresos ¬∑ Puntualidad ¬∑ Pacientes</p>
    <button onclick="window.print()" class="print-btn">üñ®Ô∏è Imprimir / PDF</button>
  </div>

  <!-- Filters -->
  <div class="filter-bar no-print">
    <form method="get">
      <div class="fg">
        <label>Profesional</label>
        <select name="profesional">
          <option value="">‚Äî Seleccionar ‚Äî</option>
          {% for p in profesionales %}
          <option value="{{ p.id }}" {% if profesional and profesional.id == p.id %}selected{% endif %}>{{ p.apellido }}, {{ p.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="fg">
        <label>Sucursal</label>
        <select name="sucursal">
          <option value="">Todas</option>
          {% for s in sucursales %}
          <option value="{{ s.id }}" {% if sucursal_id == s.id|stringformat:"s" %}selected{% endif %}>{{ s.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="fg"><label>Desde</label><input type="date" name="fecha_desde" value="{{ fecha_desde }}"></div>
      <div class="fg"><label>Hasta</label><input type="date" name="fecha_hasta" value="{{ fecha_hasta }}"></div>
      <button type="submit" class="btn-primary">üîç Ver reporte</button>
    </form>
  </div>

  {% if not profesional %}
  <div style="text-align:center;padding:60px 20px;background:var(--white);border-radius:16px;border:1px solid var(--border)">
    <div style="font-size:3rem;margin-bottom:12px">üë®‚Äç‚öïÔ∏è</div>
    <p style="font-size:1rem;font-weight:700;color:var(--ink);margin:0 0 6px">Selecciona un profesional</p>
    <p style="font-size:.82rem;color:var(--muted)">Elige un profesional para ver su reporte de desempe√±o completo.</p>
  </div>

  {% else %}

  <!-- Professional Card -->
  <div class="prof-card">
    <div class="prof-avatar">
      {% if profesional.foto %}<img src="{{ profesional.get_foto_thumbnail }}" style="width:100%;height:100%;object-fit:cover">
      {% else %}{{ profesional.nombre|first }}{{ profesional.apellido|first }}{% endif %}
    </div>
    <div class="prof-info">
      <p class="prof-name">{{ profesional.nombre_completo }}</p>
      <div class="prof-chips">
        <span class="chip {% if profesional.activo %}green{% endif %}">{% if profesional.activo %}Activo{% else %}Inactivo{% endif %}</span>
        <span class="chip">üéØ {{ profesional.especialidad }}</span>
        {% for s in profesional.sucursales.all %}<span class="chip">üè¢ {{ s.nombre }}</span>{% endfor %}
      </div>
      <div style="font-size:.72rem;color:rgba(255,255,255,.65);display:flex;flex-wrap:wrap;gap:10px">
        {% if profesional.telefono %}<span>üìû <b style="color:white">{{ profesional.telefono }}</b></span>{% endif %}
        {% if profesional.email %}<span>‚úâÔ∏è <b style="color:white">{{ profesional.email }}</b></span>{% endif %}
        <span>üìÖ Per√≠odo: <b style="color:white">{{ fecha_desde }} ‚Äî {{ fecha_hasta }}</b></span>
      </div>
    </div>
    {% if datos %}
    <div class="prof-kpis">
      <div class="pk-item"><div class="pk-label">Sesiones</div><div class="pk-val">{{ datos.stats.total_sesiones|default:0 }}</div></div>
      <div class="pk-item"><div class="pk-label">Pacientes</div><div class="pk-val">{{ datos.stats.pacientes_unicos|default:0 }}</div></div>
      <div class="pk-item"><div class="pk-label">Horas</div><div class="pk-val">{{ datos.stats.total_horas_decimal|floatformat:1 }}</div></div>
      <div class="pk-item"><div class="pk-label">Ingresos</div><div class="pk-val" style="font-size:.85rem">Bs. {{ datos.stats.total_generado|floatformat:0 }}</div></div>
    </div>
    {% endif %}
  </div>

  {% if datos %}
  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-box"><div class="accent" style="background:var(--blue)"></div>
      <div class="kpi-label">Total Sesiones</div><div class="kpi-val">{{ datos.stats.total_sesiones|default:0 }}</div><div class="kpi-sub">en el per√≠odo</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--green)"></div>
      <div class="kpi-label">Realizadas</div><div class="kpi-val" style="color:var(--green)">{{ datos.stats.realizadas|default:0 }}</div><div class="kpi-sub">completas</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--amber)"></div>
      <div class="kpi-label">Con Retraso</div><div class="kpi-val" style="color:var(--amber)">{{ datos.stats.retrasos|default:0 }}</div><div class="kpi-sub">llegadas tard√≠as</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--red)"></div>
      <div class="kpi-label">Faltas Pac.</div><div class="kpi-val" style="color:var(--red)">{{ datos.stats.faltas|default:0 }}</div><div class="kpi-sub">inasistencias</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--purple)"></div>
      <div class="kpi-label">Pacientes √önicos</div><div class="kpi-val">{{ datos.stats.pacientes_unicos|default:0 }}</div><div class="kpi-sub">distintos</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--teal)"></div>
      <div class="kpi-label">Horas Trabajadas</div><div class="kpi-val">{{ datos.stats.total_horas_decimal|floatformat:1 }}h</div><div class="kpi-sub">cl√≠nicas efectivas</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--green)"></div>
      <div class="kpi-label">Ingresos Generados</div><div class="kpi-val" style="font-size:1rem">Bs. {{ datos.stats.total_generado|floatformat:0 }}</div><div class="kpi-sub">monto total cobrado</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--amber)"></div>
      <div class="kpi-label">Ingreso / Hora</div><div class="kpi-val" style="font-size:1rem">Bs. {{ datos.stats.ingreso_por_hora|floatformat:0 }}</div><div class="kpi-sub">productividad</div>
    </div>
  </div>

  <!-- Rate cards -->
  <div class="rate-grid">
    <div class="rate-card">
      <div class="rc-label">Tasa Cumplimiento</div>
      <div class="rc-val" style="color:{% if datos.stats.tasa_cumplimiento >= 85 %}var(--green){% elif datos.stats.tasa_cumplimiento >= 60 %}var(--amber){% else %}var(--red){% endif %}">{{ datos.stats.tasa_cumplimiento|floatformat:1 }}%</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ datos.stats.tasa_cumplimiento|floatformat:0 }}%;background:{% if datos.stats.tasa_cumplimiento >= 85 %}var(--green){% elif datos.stats.tasa_cumplimiento >= 60 %}var(--amber){% else %}var(--red){% endif %}"></div></div>
    </div>
    <div class="rate-card">
      <div class="rc-label">Tasa Puntualidad</div>
      <div class="rc-val" style="color:{% if datos.stats.tasa_puntualidad >= 90 %}var(--green){% elif datos.stats.tasa_puntualidad >= 70 %}var(--amber){% else %}var(--red){% endif %}">{{ datos.stats.tasa_puntualidad|floatformat:1 }}%</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ datos.stats.tasa_puntualidad|floatformat:0 }}%;background:{% if datos.stats.tasa_puntualidad >= 90 %}var(--green){% elif datos.stats.tasa_puntualidad >= 70 %}var(--amber){% else %}var(--red){% endif %}"></div></div>
    </div>
    <div class="rate-card">
      <div class="rc-label">Sesiones Programadas</div>
      <div class="rc-val" style="color:var(--blue)">{{ datos.stats.programadas|default:0 }}</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{% widthratio datos.stats.programadas datos.stats.total_sesiones 100 %}%;background:var(--blue)"></div></div>
    </div>
    <div class="rate-card">
      <div class="rc-label">Canceladas</div>
      <div class="rc-val" style="color:var(--muted)">{{ datos.stats.canceladas|default:0 }}</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{% widthratio datos.stats.canceladas datos.stats.total_sesiones 100 %}%;background:#94a3b8"></div></div>
    </div>
  </div>

  <!-- Charts -->
  {% if grafico_data %}
  <div class="two-col">
    <div class="chart-card">
      <h3>üìà Evoluci√≥n mensual</h3>
      <canvas id="chart-evo" height="200"></canvas>
    </div>
    <div class="chart-card">
      <h3>üí∞ Ingresos por mes</h3>
      <canvas id="chart-ing" height="200"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- Por servicio + Por sucursal -->
  <div class="two-col">
    <div class="card">
      <h3>üéØ Por Servicio</h3>
      <div class="scroll-list">
        {% for s in datos.por_servicio %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ s.servicio__nombre }}</div>
            <div class="li-sub">{{ s.realizadas }} realizadas ¬∑ {{ s.horas_decimal|floatformat:1 }}h</div>
          </div>
          <div>
            <div class="li-val">{{ s.cantidad }}</div>
            <div style="font-size:.65rem;color:var(--muted);text-align:right">Bs. {{ s.ingresos|floatformat:0 }}</div>
          </div>
        </div>
        {% empty %}<p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>{% endfor %}
      </div>
    </div>
    <div class="card">
      <h3>üè¢ Por Sucursal</h3>
      <div class="scroll-list">
        {% for s in datos.por_sucursal %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ s.sucursal__nombre }}</div>
            <div class="li-sub">{{ s.realizadas }} realizadas</div>
          </div>
          <div>
            <div class="li-val">{{ s.cantidad }}</div>
            <div style="font-size:.65rem;color:var(--muted);text-align:right">Bs. {{ s.ingresos|floatformat:0 }}</div>
          </div>
        </div>
        {% empty %}<p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>{% endfor %}
      </div>
    </div>
  </div>

  <!-- Por d√≠a de semana -->
  {% if datos.por_dia_semana %}
  <div class="section-title">üìÖ Distribuci√≥n por D√≠a de la Semana</div>
  <div class="card">
    {% with max_dia=datos.por_dia_semana.0.cantidad %}
    {% for dia in datos.por_dia_semana %}
    <div class="dia-row">
      <span class="dia-nombre">{{ dia.nombre }}</span>
      <div class="dia-bar-wrap">
        <div class="dia-bar-real" style="width:{% widthratio dia.realizadas max_dia 100 %}%"></div>
        <div class="dia-bar-falta" style="width:{% widthratio dia.cantidad max_dia 20 %}%"></div>
      </div>
      <span class="dia-count">{{ dia.cantidad }}</span>
    </div>
    {% endfor %}
    {% endwith %}
  </div>
  {% endif %}

  <!-- Top pacientes -->
  {% if datos.top_pacientes %}
  <div class="section-title">üë§ Top Pacientes</div>
  <div class="card">
    <div style="overflow-x:auto">
      <table class="rank-table">
        <thead>
          <tr><th>#</th><th>Paciente</th><th>Sesiones</th><th>Realizadas</th><th>Faltas</th><th>Tasa</th></tr>
        </thead>
        <tbody>
          {% for p in datos.top_pacientes %}
          {% with tasa=p.realizadas|default:0 %}
          <tr>
            <td style="color:var(--muted);font-weight:700">{{ forloop.counter }}</td>
            <td style="font-weight:700">{{ p.paciente__nombre }} {{ p.paciente__apellido }}</td>
            <td class="mono">{{ p.sesiones }}</td>
            <td style="color:var(--green);font-weight:700" class="mono">{{ p.realizadas }}</td>
            <td style="color:var(--red)" class="mono">{{ p.faltas|default:0 }}</td>
            <td>
              {% if p.sesiones > 0 %}
              {% widthratio p.realizadas p.sesiones 100 as tasa_calc %}
              <div style="font-size:.72rem;font-weight:700;color:{% if tasa_calc >= 85 %}var(--green){% elif tasa_calc >= 60 %}var(--amber){% else %}var(--red){% endif %}">{{ tasa_calc }}%</div>
              <div class="tasa-bar"><div class="tasa-fill" style="width:{{ tasa_calc }}%;background:{% if tasa_calc >= 85 %}var(--green){% elif tasa_calc >= 60 %}var(--amber){% else %}var(--red){% endif %}"></div></div>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
  {% endif %}{# end if datos #}

  {% endif %}{# end if profesional #}
</div>

{% if grafico_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const gLabels = {{ grafico_data.labels|safe }};
const gSesiones = {{ grafico_data.sesiones|safe }};
const gRealizadas = {{ grafico_data.realizadas|safe }};
const gIngresos = {{ grafico_data.ingresos|safe }};

const ctx1 = document.getElementById('chart-evo');
if(ctx1) new Chart(ctx1, {
  type:'bar',
  data:{
    labels:gLabels,
    datasets:[
      {label:'Sesiones',data:gSesiones,backgroundColor:'rgba(37,99,235,.6)',borderColor:'#2563eb',borderWidth:2,borderRadius:5},
      {label:'Realizadas',data:gRealizadas,backgroundColor:'rgba(22,163,74,.7)',borderColor:'#16a34a',borderWidth:2,borderRadius:5}
    ]
  },
  options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'top',labels:{font:{size:10}}}},
    scales:{y:{beginAtZero:true,ticks:{font:{size:9}}},x:{ticks:{font:{size:9}}}}}
});

const ctx2 = document.getElementById('chart-ing');
if(ctx2) new Chart(ctx2, {
  type:'line',
  data:{
    labels:gLabels,
    datasets:[{
      label:'Ingresos Bs.',data:gIngresos,
      backgroundColor:'rgba(22,163,74,.15)',borderColor:'#16a34a',borderWidth:2,
      fill:true,tension:.4,pointBackgroundColor:'#16a34a',pointRadius:4
    }]
  },
  options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'top',labels:{font:{size:10}}}},
    scales:{y:{beginAtZero:true,ticks:{font:{size:9},callback:v=>'Bs.'+v}},x:{ticks:{font:{size:9}}}}}
});
</script>
{% endif %}
{% endblock %}