{% extends 'base.html' %}
{% block title %}Reporte Paciente{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&family=Fira+Code:wght@400;600&display=swap');
  :root {
    --ink:#0f172a;--ink2:#334155;--muted:#64748b;--border:#e2e8f0;--surface:#f8fafc;--white:#fff;
    --blue:#2563eb;--blue-l:#dbeafe;--green:#16a34a;--green-l:#dcfce7;
    --red:#dc2626;--red-l:#fee2e2;--amber:#d97706;--amber-l:#fef3c7;
    --purple:#7c3aed;--purple-l:#ede9fe;--teal:#0d9488;--teal-l:#ccfbf1;
    --r:12px;
  }
  body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--surface)}
  @media print{.no-print{display:none!important} body{background:white!important}}
  .mono{font-family:'Fira Code',monospace}

  .rpt-header{background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f2d4a 100%);
    border-radius:16px;padding:24px 28px;margin-bottom:20px;color:white;position:relative;overflow:hidden}
  .rpt-header::after{content:'';position:absolute;top:-30px;right:-30px;width:180px;height:180px;
    background:radial-gradient(circle,rgba(37,99,235,.25) 0%,transparent 70%);border-radius:50%}
  .back{color:#93c5fd;text-decoration:none;font-size:.75rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;margin-bottom:10px}
  .rpt-header h1{font-size:1.5rem;font-weight:800;margin:0 0 4px}
  .rpt-header p{color:#93c5fd;font-size:.8rem;margin:0}
  .print-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.3);color:white;font-size:.75rem;font-weight:600;
    padding:6px 14px;border-radius:8px;cursor:pointer;margin-top:10px}

  .filter-bar{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:16px}
  .filter-bar form{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}
  .fg{display:flex;flex-direction:column;gap:3px}
  .fg label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
  .fg select,.fg input[type=date]{padding:7px 10px;font-size:.78rem;border:1px solid var(--border);
    border-radius:8px;color:var(--ink);font-family:'Plus Jakarta Sans',sans-serif;min-width:160px}
  .btn-primary{background:var(--blue);color:white;border:none;padding:7px 16px;border-radius:8px;
    font-size:.78rem;font-weight:700;cursor:pointer;align-self:flex-end}

  /* Quick tabs */
  .quick-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px}
  .qtab{font-size:.72rem;font-weight:600;padding:5px 12px;border:1px solid var(--border);
    border-radius:8px;background:var(--white);color:var(--muted);text-decoration:none;cursor:pointer;transition:all .15s}
  .qtab:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-l)}

  /* Patient card */
  .pac-card{background:linear-gradient(135deg,#0f172a,#1e3a5f);border-radius:16px;padding:20px 24px;margin-bottom:16px;color:white;display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .pac-avatar{width:64px;height:64px;border-radius:14px;background:rgba(255,255,255,.15);
    display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0}
  .pac-info{flex:1;min-width:200px}
  .pac-name{font-size:1.2rem;font-weight:800;margin:0 0 4px}
  .pac-chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
  .chip{display:inline-flex;align-items:center;gap:4px;font-size:.65rem;font-weight:700;
    padding:3px 9px;border-radius:20px;background:rgba(255,255,255,.12);color:rgba(255,255,255,.85)}
  .chip.green{background:rgba(34,197,94,.2);color:#86efac}
  .chip.red{background:rgba(220,38,38,.2);color:#fca5a5}
  .chip.amber{background:rgba(245,158,11,.2);color:#fcd34d}
  .pac-meta{display:flex;flex-wrap:wrap;gap:10px}
  .pac-meta span{font-size:.72rem;color:rgba(255,255,255,.65)}
  .pac-meta b{color:white}

  /* Financial hero */
  .fin-hero{border-radius:14px;padding:18px 20px;margin-bottom:16px;border:2px solid}
  .fin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:14px}
  .fin-item{background:rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;text-align:center}
  .fi-label{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;opacity:.7;margin-bottom:4px}
  .fi-val{font-size:1rem;font-weight:900;font-family:'Fira Code',monospace}

  /* KPI stats */
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px}
  .kpi-box{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px;
    position:relative;overflow:hidden}
  .kpi-box .accent{position:absolute;top:0;left:0;width:3px;height:100%;border-radius:12px 0 0 12px}
  .kpi-label{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px}
  .kpi-val{font-size:1.4rem;font-weight:900;color:var(--ink);font-family:'Fira Code',monospace;line-height:1}
  .kpi-sub{font-size:.65rem;color:var(--muted);margin-top:4px}

  /* Charts */
  .chart-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:16px}
  .chart-card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
  @media(max-width:768px){.two-col{grid-template-columns:1fr}}

  /* Tables / list cards */
  .card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:14px}
  .card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 10px;display:flex;align-items:center;gap:6px}
  .list-item{display:flex;justify-content:space-between;align-items:center;
    padding:9px 10px;border-radius:8px;background:var(--surface);margin-bottom:6px;flex-wrap:wrap;gap:6px}
  .li-name{font-size:.78rem;font-weight:700;color:var(--ink)}
  .li-sub{font-size:.65rem;color:var(--muted);margin-top:2px}
  .li-val{font-size:.88rem;font-weight:800;font-family:'Fira Code',monospace;color:var(--green)}
  .scroll-list{max-height:240px;overflow-y:auto}

  /* Clinical card */
  .clinical-card{background:var(--teal-l);border:1px solid rgba(13,148,136,.2);border-radius:var(--r);padding:16px;margin-bottom:16px}
  .clinical-card h3{font-size:.8rem;font-weight:700;color:var(--teal);margin:0 0 10px}
  .clin-row{display:flex;gap:8px;margin-bottom:8px}
  .clin-label{font-size:.65rem;font-weight:700;text-transform:uppercase;color:var(--teal);opacity:.7;min-width:100px}
  .clin-val{font-size:.78rem;color:var(--ink2);flex:1}
  .alergia-alert{background:var(--red-l);border:1px solid #fecaca;border-radius:8px;padding:8px 12px;
    font-size:.78rem;color:var(--red);font-weight:600;margin-top:8px}

  /* Projects */
  .proj-card{background:var(--white);border:1px solid var(--border);border-left:3px solid var(--teal);
    border-radius:var(--r);padding:12px 14px;margin-bottom:8px}
  .proj-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .proj-code{font-family:'Fira Code',monospace;font-size:.72rem;color:var(--muted)}
  .proj-name{font-size:.85rem;font-weight:700;color:var(--ink)}
  .proj-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:6px;margin-top:8px}
  .ps-item{background:var(--surface);border-radius:6px;padding:6px 8px;text-align:center}
  .ps-label{font-size:.58rem;text-transform:uppercase;font-weight:700;color:var(--muted);margin-bottom:2px}
  .ps-val{font-size:.85rem;font-weight:900;font-family:'Fira Code',monospace;color:var(--ink)}

  /* Session timeline */
  .session-item{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:8px;position:relative}
  .session-item.realizada{border-left:3px solid var(--green)}
  .session-item.realizada_retraso{border-left:3px solid var(--amber)}
  .session-item.falta{border-left:3px solid var(--red)}
  .session-item.programada{border-left:3px solid var(--blue)}
  .session-item.permiso{border-left:3px solid var(--purple)}
  .session-item.cancelada{border-left:3px solid #94a3b8}
  .s-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:6px}
  .s-date{font-size:.82rem;font-weight:700;color:var(--ink);font-family:'Fira Code',monospace}
  .s-info{font-size:.72rem;color:var(--ink2);margin-bottom:4px}
  .s-badge{display:inline-flex;align-items:center;font-size:.62rem;font-weight:700;padding:2px 8px;border-radius:12px}
  .s-badge.realizada{background:var(--green-l);color:var(--green)}
  .s-badge.realizada_retraso{background:var(--amber-l);color:var(--amber)}
  .s-badge.falta{background:var(--red-l);color:var(--red)}
  .s-badge.programada{background:var(--blue-l);color:var(--blue)}
  .s-badge.permiso{background:var(--purple-l);color:var(--purple)}
  .s-badge.cancelada{background:#f1f5f9;color:#64748b}
  .s-notes{background:var(--green-l);border-left:3px solid var(--green);border-radius:6px;
    padding:6px 10px;font-size:.72rem;color:var(--ink2);margin-top:6px}
  .s-obs{background:var(--surface);border-radius:6px;padding:6px 10px;font-size:.72rem;color:var(--muted);margin-top:4px}
  .s-money{font-family:'Fira Code',monospace;font-size:.75rem;font-weight:700}

  /* Filters timeline */
  .filter-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
  .fchip{font-size:.72rem;font-weight:600;padding:4px 12px;border-radius:8px;
    border:1px solid var(--border);background:var(--white);color:var(--muted);cursor:pointer;transition:all .15s}
  .fchip.active{background:var(--blue);border-color:var(--blue);color:white}

  .section-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;
    color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:8px}
  .section-title::after{content:'';flex:1;height:1px;background:var(--border)}
</style>

<div class="max-w-7xl mx-auto px-3 py-4">

  <!-- Header -->
  <div class="rpt-header no-print">
    <a href="{% url 'facturacion:dashboard_reportes' %}" class="back">‚Üê Volver a Reportes</a>
    <h1>üë§ Reporte por Paciente</h1>
    <p>Historial cl√≠nico ¬∑ Asistencia ¬∑ Financiero ¬∑ Proyectos ¬∑ Evoluci√≥n</p>
    <button onclick="window.print()" class="print-btn">üñ®Ô∏è Imprimir / PDF</button>
  </div>

  <!-- Filters -->
  <div class="filter-bar no-print">
    <form method="get">
      <div class="fg">
        <label>Paciente</label>
        <select name="paciente">
          <option value="">‚Äî Seleccionar paciente ‚Äî</option>
          {% for p in pacientes %}
          <option value="{{ p.id }}" {% if paciente and paciente.id == p.id %}selected{% endif %}>{{ p.apellido }}, {{ p.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="fg">
        <label>Desde</label>
        <input type="date" name="fecha_desde" value="{{ fecha_desde }}">
      </div>
      <div class="fg">
        <label>Hasta</label>
        <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}">
      </div>
      <button type="submit" class="btn-primary">üîç Ver reporte</button>
    </form>
  </div>

  <!-- Quick ranges (JS) -->
  {% if paciente %}
  <div class="quick-tabs no-print">
    <a class="qtab" onclick="setRango(30)">üìÖ 30 d√≠as</a>
    <a class="qtab" onclick="setRango(90)">üìÜ 3 meses</a>
    <a class="qtab" onclick="setRango(180)">üìà 6 meses</a>
    <a class="qtab" onclick="setRango(365)">üìä 1 a√±o</a>
  </div>
  {% endif %}

  {% if not paciente %}
  <!-- Empty state -->
  <div style="text-align:center;padding:60px 20px;background:var(--white);border-radius:16px;border:1px solid var(--border)">
    <div style="font-size:3rem;margin-bottom:12px">üë§</div>
    <p style="font-size:1rem;font-weight:700;color:var(--ink);margin:0 0 6px">Selecciona un paciente</p>
    <p style="font-size:.82rem;color:var(--muted)">Elige un paciente del selector y un per√≠odo de fechas para ver el reporte completo.</p>
  </div>

  {% else %}

  <!-- Patient Card -->
  <div class="pac-card">
    <div class="pac-avatar">
      {% if paciente.foto %}
      <img src="{{ paciente.get_foto_thumbnail }}" style="width:100%;height:100%;object-fit:cover;border-radius:14px">
      {% else %}
      {{ paciente.nombre|first }}{{ paciente.apellido|first }}
      {% endif %}
    </div>
    <div class="pac-info">
      <p class="pac-name">{{ paciente.nombre_completo }}</p>
      <div class="pac-chips">
        <span class="chip {% if paciente.estado == 'activo' %}green{% else %}red{% endif %}">{{ paciente.get_estado_display }}</span>
        <span class="chip">{{ paciente.edad }} a√±os</span>
        <span class="chip">{{ paciente.get_genero_display }}</span>
        {% if paciente.nombre_tutor %}<span class="chip">üë§ {{ paciente.nombre_tutor }} ({{ paciente.get_parentesco_display }})</span>{% endif %}
      </div>
      <div class="pac-meta">
        {% if paciente.telefono_tutor %}<span>üìû <b>{{ paciente.telefono_tutor }}</b></span>{% endif %}
        {% if paciente.email_tutor %}<span>‚úâÔ∏è <b>{{ paciente.email_tutor }}</b></span>{% endif %}
        <span>üìÖ Per√≠odo: <b>{{ fecha_desde }} ‚Äî {{ fecha_hasta }}</b></span>
      </div>
    </div>
  </div>

  <!-- Clinical info -->
  {% if paciente.diagnostico or paciente.alergias or paciente.observaciones_medicas %}
  <div class="clinical-card">
    <h3>üè• Informaci√≥n Cl√≠nica</h3>
    {% if paciente.diagnostico %}
    <div class="clin-row"><span class="clin-label">Diagn√≥stico</span><span class="clin-val">{{ paciente.diagnostico }}</span></div>
    {% endif %}
    {% if paciente.observaciones_medicas %}
    <div class="clin-row"><span class="clin-label">Observaciones</span><span class="clin-val">{{ paciente.observaciones_medicas }}</span></div>
    {% endif %}
    {% if paciente.alergias %}
    <div class="alergia-alert">‚ö†Ô∏è Alergias: {{ paciente.alergias }}</div>
    {% endif %}
  </div>
  {% endif %}

  {% if datos %}
  <!-- Financial Hero (from cuenta_corriente) -->
  {% with cc=paciente.cuenta_corriente %}
  {% if cc %}
  <div class="fin-hero" style="background:{% if cc.saldo_actual >= 0 %}var(--green-l);border-color:#86efac;color:var(--green){% else %}var(--red-l);border-color:#fca5a5;color:var(--red){% endif %}">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div>
        <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px;opacity:.7">Saldo Actual</div>
        <div style="font-size:2rem;font-weight:900;font-family:'Fira Code',monospace;line-height:1">
          Bs. {{ cc.saldo_actual|floatformat:2 }}
        </div>
        <div style="font-size:.72rem;margin-top:4px;opacity:.8">
          {% if cc.saldo_actual >= 0 %}‚úÖ Al d√≠a{% else %}‚ö†Ô∏è Con deuda{% endif %}
          ¬∑ Cr√©dito disponible: Bs. {{ cc.credito_disponible|floatformat:2 }}
        </div>
      </div>
      <div style="font-size:.7rem;opacity:.8;text-align:right">
        Saldo real: <b class="mono">Bs. {{ cc.saldo_real|floatformat:2 }}</b><br>
        Devoluciones: <b class="mono">Bs. {{ cc.total_devoluciones|floatformat:2 }}</b>
      </div>
    </div>
    <div class="fin-grid">
      <div class="fin-item">
        <div class="fi-label">Consumido Actual</div>
        <div class="fi-val">Bs. {{ cc.total_consumido_actual|floatformat:0 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Consumido Real</div>
        <div class="fi-val">Bs. {{ cc.total_consumido_real|floatformat:0 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Total Pagado</div>
        <div class="fi-val">Bs. {{ cc.total_pagado|floatformat:0 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Pag. Sesiones</div>
        <div class="fi-val">Bs. {{ cc.pagos_sesiones|floatformat:0 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Pag. Mensualidades</div>
        <div class="fi-val">Bs. {{ cc.pagos_mensualidades|floatformat:0 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Pag. Proyectos</div>
        <div class="fi-val">Bs. {{ cc.pagos_proyectos|floatformat:0 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Mensualidades</div>
        <div class="fi-val">Bs. {{ cc.total_mensualidades|floatformat:0 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Proyectos</div>
        <div class="fi-val">Bs. {{ cc.total_proyectos_real|floatformat:0 }}</div>
      </div>
    </div>
  </div>
  {% else %}
  <!-- Fallback financial from stats -->
  <div class="fin-hero" style="background:var(--blue-l);border-color:#93c5fd;color:var(--blue)">
    <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;margin-bottom:8px;opacity:.7">Financiero del per√≠odo</div>
    <div class="fin-grid">
      <div class="fin-item">
        <div class="fi-label">Total Cobrado</div>
        <div class="fi-val">Bs. {{ datos.stats.total_cobrado|floatformat:2 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Total Pagado</div>
        <div class="fi-val">Bs. {{ datos.stats.total_pagado|floatformat:2 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Saldo Pendiente</div>
        <div class="fi-val">Bs. {{ datos.stats.saldo_pendiente|floatformat:2 }}</div>
      </div>
      <div class="fin-item">
        <div class="fi-label">Tasa de Pago</div>
        <div class="fi-val">{{ datos.tasa_pago|floatformat:1 }}%</div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endwith %}

  <!-- KPIs Asistencia -->
  <div class="section-title">üìä Estad√≠sticas del Per√≠odo</div>
  <div class="kpi-grid">
    <div class="kpi-box"><div class="accent" style="background:var(--blue)"></div>
      <div class="kpi-label">Total Sesiones</div>
      <div class="kpi-val">{{ datos.stats.total_sesiones|default:0 }}</div>
      <div class="kpi-sub">en el per√≠odo</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--green)"></div>
      <div class="kpi-label">Realizadas</div>
      <div class="kpi-val" style="color:var(--green)">{{ datos.stats.realizadas|default:0 }}</div>
      <div class="kpi-sub">+ {{ datos.stats.retrasos|default:0 }} con retraso</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--red)"></div>
      <div class="kpi-label">Faltas</div>
      <div class="kpi-val" style="color:var(--red)">{{ datos.stats.faltas|default:0 }}</div>
      <div class="kpi-sub">inasistencias</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--amber)"></div>
      <div class="kpi-label">Retrasos</div>
      <div class="kpi-val" style="color:var(--amber)">{{ datos.stats.retrasos|default:0 }}</div>
      <div class="kpi-sub">llegadas tard√≠as</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--purple)"></div>
      <div class="kpi-label">Permisos</div>
      <div class="kpi-val" style="color:var(--purple)">{{ datos.stats.permisos|default:0 }}</div>
      <div class="kpi-sub">justificados</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:#64748b"></div>
      <div class="kpi-label">Canceladas</div>
      <div class="kpi-val">{{ datos.stats.canceladas|default:0 }}</div>
      <div class="kpi-sub">por el centro</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--teal)"></div>
      <div class="kpi-label">Tasa Asistencia</div>
      <div class="kpi-val" style="color:{% if datos.tasa_asistencia >= 85 %}var(--green){% elif datos.tasa_asistencia >= 60 %}var(--amber){% else %}var(--red){% endif %}">{{ datos.tasa_asistencia|floatformat:1 }}%</div>
      <div class="kpi-sub">{% if datos.tasa_asistencia >= 85 %}‚úÖ Excelente{% elif datos.tasa_asistencia >= 60 %}‚ö†Ô∏è Regular{% else %}üî¥ Bajo{% endif %}</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--blue)"></div>
      <div class="kpi-label">Tasa de Pago</div>
      <div class="kpi-val">{{ datos.tasa_pago|floatformat:1 }}%</div>
      <div class="kpi-sub">{{ datos.stats.sesiones_pagadas|default:0 }} pagadas / {{ datos.stats.sesiones_pendientes|default:0 }} pend.</div>
    </div>
  </div>

  <!-- Charts -->
  {% if grafico_data %}
  <div class="two-col">
    <div class="chart-card">
      <h3>üìà Evoluci√≥n mensual de sesiones</h3>
      <canvas id="chart-sesiones" height="200"></canvas>
    </div>
    <div class="chart-card">
      <h3>ü•ß Distribuci√≥n de asistencia</h3>
      <canvas id="chart-asistencia" height="200"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- Por servicio + por profesional -->
  <div class="two-col">
    <div class="card">
      <h3>üéØ Sesiones por Servicio</h3>
      <div class="scroll-list">
        {% for s in datos.por_servicio %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ s.servicio__nombre }}</div>
            <div class="li-sub">{{ s.sesiones_realizadas|default:0 }} realizadas ¬∑ {{ s.sesiones_falta|default:0 }} faltas</div>
          </div>
          <div>
            <div class="li-val">{{ s.cantidad }}</div>
            <div style="font-size:.65rem;color:var(--muted);text-align:right">Bs. {{ s.monto_total|floatformat:0 }}</div>
          </div>
        </div>
        {% empty %}<p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>{% endfor %}
      </div>
    </div>
    <div class="card">
      <h3>üë®‚Äç‚öïÔ∏è Sesiones por Profesional</h3>
      <div class="scroll-list">
        {% for p in datos.por_profesional %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ p.profesional__nombre }} {{ p.profesional__apellido }}</div>
            <div class="li-sub">{{ p.cantidad }} sesiones realizadas</div>
          </div>
          <div class="li-val">Bs. {{ p.monto_total|floatformat:0 }}</div>
        </div>
        {% empty %}<p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>{% endfor %}
      </div>
    </div>
  </div>

  <!-- Proyectos -->
  {% if datos.proyectos %}
  <div class="section-title">üìÅ Proyectos del Paciente</div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin-bottom:16px">
    <!-- Summary -->
    <div class="card" style="border-left:3px solid var(--teal)">
      <h3>üìä Resumen Proyectos</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div class="ps-item"><div class="ps-label">Total</div><div class="ps-val">{{ datos.proyectos_stats.total }}</div></div>
        <div class="ps-item"><div class="ps-label">Activos</div><div class="ps-val" style="color:var(--blue)">{{ datos.proyectos_stats.activos }}</div></div>
        <div class="ps-item"><div class="ps-label">Finalizados</div><div class="ps-val" style="color:var(--green)">{{ datos.proyectos_stats.finalizados }}</div></div>
        <div class="ps-item"><div class="ps-label">Total Bs.</div><div class="ps-val">{{ datos.proyectos_stats.monto_total|floatformat:0 }}</div></div>
      </div>
    </div>
    <!-- Individual projects -->
    {% for proy in datos.proyectos %}
    <div class="proj-card">
      <div class="proj-header">
        <div>
          <div class="proj-code">{{ proy.codigo|default:proy.id }}</div>
          <div class="proj-name">{{ proy.nombre|default:"Proyecto" }}</div>
        </div>
        <span style="font-size:.65rem;font-weight:700;padding:3px 8px;border-radius:12px;
          background:{% if proy.estado == 'finalizado' %}var(--green-l);color:var(--green){% elif proy.estado == 'en_progreso' %}var(--blue-l);color:var(--blue){% else %}var(--amber-l);color:var(--amber){% endif %}">
          {{ proy.get_estado_display|default:proy.estado }}
        </span>
      </div>
      <div class="proj-stats">
        <div class="ps-item"><div class="ps-label">Costo</div><div class="ps-val">Bs. {{ proy.costo_total|floatformat:0 }}</div></div>
        <div class="ps-item"><div class="ps-label">Inicio</div><div class="ps-val" style="font-size:.72rem">{{ proy.fecha_inicio|date:"d/m/y" }}</div></div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Recent Sessions Timeline -->
  <div class="section-title">üìÖ Sesiones Recientes</div>
  <div class="filter-chips no-print">
    <button class="fchip active" onclick="filtrarSesiones('todas',this)">Todas</button>
    <button class="fchip" onclick="filtrarSesiones('realizada',this)">‚úÖ Realizadas</button>
    <button class="fchip" onclick="filtrarSesiones('realizada_retraso',this)">üïê Con Retraso</button>
    <button class="fchip" onclick="filtrarSesiones('falta',this)">‚ùå Faltas</button>
    <button class="fchip" onclick="filtrarSesiones('programada',this)">üìÖ Programadas</button>
  </div>

  <div id="session-list">
    {% for s in datos.sesiones_recientes %}
    <div class="session-item {{ s.estado }}" data-estado="{{ s.estado }}">
      <div class="s-header">
        <div>
          <span class="s-date">{{ s.fecha|date:"d/m/Y" }} {{ s.hora_inicio|time:"H:i" }}</span>
          <span class="s-badge {{ s.estado }}">
            {% if s.estado == 'realizada' %}‚úÖ Realizada
            {% elif s.estado == 'realizada_retraso' %}üïê Con Retraso
            {% elif s.estado == 'falta' %}‚ùå Falta
            {% elif s.estado == 'programada' %}üìÖ Programada
            {% elif s.estado == 'permiso' %}üõ°Ô∏è Permiso
            {% elif s.estado == 'cancelada' %}üö´ Cancelada
            {% else %}{{ s.get_estado_display }}
            {% endif %}
          </span>
        </div>
        {% if s.monto_cobrado %}
        <span class="s-money" style="color:{% if s.total_pagado_sesion is not None and s.total_pagado_sesion >= s.monto_cobrado %}var(--green){% else %}var(--amber){% endif %}">
          Bs. {{ s.monto_cobrado|floatformat:2 }}
        </span>
        {% endif %}
      </div>
      <div class="s-info">
        üéØ <b>{{ s.servicio.nombre }}</b> ¬∑ 
        üë®‚Äç‚öïÔ∏è {{ s.profesional.nombre_completo }} ¬∑ 
        üè¢ {{ s.sucursal.nombre }}
        {% if s.duracion_minutos %} ¬∑ ‚è±Ô∏è {{ s.duracion_minutos }} min{% endif %}
        {% if s.proyecto %} ¬∑ üìÅ {{ s.proyecto.nombre|default:s.proyecto.codigo }}{% endif %}
      </div>
      {% if s.notas_sesion %}
      <div class="s-notes">üìù <b>Nota:</b> {{ s.notas_sesion|truncatechars:150 }}</div>
      {% endif %}
      {% if s.observaciones %}
      <div class="s-obs">{{ s.observaciones|truncatechars:120 }}</div>
      {% endif %}
    </div>
    {% empty %}
    <div style="text-align:center;padding:30px;color:var(--muted);font-size:.82rem">Sin sesiones en el per√≠odo seleccionado</div>
    {% endfor %}
  </div>
  {% endif %}{# end if datos #}

  {% endif %}{# end if paciente #}
</div>

{% if grafico_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Sesiones chart
const ctx1 = document.getElementById('chart-sesiones');
if(ctx1) new Chart(ctx1, {
  type:'bar',
  data:{
    labels: {{ grafico_data.labels|safe }},
    datasets:[
      {label:'Realizadas',data:{{ grafico_data.realizadas|safe }},backgroundColor:'rgba(22,163,74,.7)',borderColor:'#16a34a',borderWidth:2,borderRadius:5},
      {label:'Faltas',data:{{ grafico_data.faltas|safe }},backgroundColor:'rgba(220,38,38,.5)',borderColor:'#dc2626',borderWidth:2,borderRadius:5},
      {label:'Retrasos',data:{{ grafico_data.retrasos|safe }},backgroundColor:'rgba(217,119,6,.5)',borderColor:'#d97706',borderWidth:2,borderRadius:5}
    ]
  },
  options:{responsive:true,maintainAspectRatio:true,
    plugins:{legend:{position:'top',labels:{font:{size:10},padding:12}}},
    scales:{y:{beginAtZero:true,ticks:{font:{size:9}}},x:{ticks:{font:{size:9}}}}}
});

// Asistencia donut
const totReal = {{ datos.stats.realizadas|default:0 }};
const totRet = {{ datos.stats.retrasos|default:0 }};
const totFalta = {{ datos.stats.faltas|default:0 }};
const totPerm = {{ datos.stats.permisos|default:0 }};
const totCan = {{ datos.stats.canceladas|default:0 }};
const ctx2 = document.getElementById('chart-asistencia');
if(ctx2 && (totReal+totRet+totFalta+totPerm+totCan) > 0) new Chart(ctx2, {
  type:'doughnut',
  data:{
    labels:['Realizadas','Con Retraso','Faltas','Permisos','Canceladas'],
    datasets:[{data:[totReal,totRet,totFalta,totPerm,totCan],
      backgroundColor:['#16a34a','#d97706','#dc2626','#7c3aed','#94a3b8'],
      borderWidth:2,borderColor:'#fff',hoverOffset:6}]
  },
  options:{responsive:true,maintainAspectRatio:true,cutout:'65%',
    plugins:{legend:{position:'right',labels:{font:{size:10},padding:10}}}}
});
</script>
{% endif %}

<script>
function filtrarSesiones(estado, btn){
  document.querySelectorAll('.fchip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.session-item').forEach(item=>{
    item.style.display = (estado==='todas'||item.dataset.estado===estado)?'':'none';
  });
}
function setRango(dias){
  const hoy = new Date();
  const desde = new Date(hoy - dias*86400000);
  const fmt = d => d.toISOString().split('T')[0];
  const url = new URL(window.location.href);
  url.searchParams.set('fecha_desde', fmt(desde));
  url.searchParams.set('fecha_hasta', fmt(hoy));
  window.location.href = url.toString();
}
</script>
{% endblock %}