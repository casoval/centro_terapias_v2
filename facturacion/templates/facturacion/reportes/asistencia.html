{% extends 'base.html' %}
{% block title %}Reporte de Asistencia{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap');

  :root {
    --ink: #0a0f1e;
    --ink2: #1a2035;
    --ink3: #2a3050;
    --muted: #5b6787;
    --muted2: #8896b0;
    --border: #dce3f0;
    --border2: #eef1f8;
    --surface: #f4f6fc;
    --surface2: #ebeef7;
    --white: #ffffff;

    /* Palette */
    --indigo: #4338ca;
    --indigo-d: #3730a3;
    --indigo-l: #e0e7ff;
    --indigo-ll: #f5f3ff;
    --emerald: #059669;
    --emerald-l: #d1fae5;
    --emerald-ll: #ecfdf5;
    --amber: #d97706;
    --amber-l: #fef3c7;
    --amber-ll: #fffbeb;
    --ruby: #be123c;
    --ruby-l: #ffe4e6;
    --ruby-ll: #fff1f2;
    --violet: #7c3aed;
    --violet-l: #ede9fe;
    --teal: #0d9488;
    --teal-l: #ccfbf1;
    --sky: #0284c7;
    --sky-l: #e0f2fe;
    --slate: #475569;
    --slate-l: #f1f5f9;

    --shadow-sm: 0 1px 3px rgba(10,15,30,0.06), 0 1px 2px rgba(10,15,30,0.04);
    --shadow: 0 4px 14px rgba(10,15,30,0.08);
    --shadow-lg: 0 12px 32px rgba(10,15,30,0.12);

    --r: 12px;
    --r-lg: 16px;
    --r-xl: 20px;
  }

  * { box-sizing: border-box; }
  body { font-family: 'Sora', sans-serif; background: var(--surface); color: var(--ink); }

  @media print {
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    body { background: white !important; font-size: 10px; }
    .page-break { page-break-before: always; }
    .hero { background: #0a0f1e !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
  .print-only { display: none; }

  /* â”€â”€â”€ LAYOUT â”€â”€â”€ */
  .wrap { max-width: 1380px; margin: 0 auto; padding: 16px 20px 40px; }

  /* â”€â”€â”€ HERO â”€â”€â”€ */
  .hero {
    background: linear-gradient(135deg, #0a0f1e 0%, #121830 40%, #1a2348 70%, #0f1628 100%);
    border-radius: var(--r-xl); padding: 28px 32px 24px; margin-bottom: 18px;
    color: white; position: relative; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .hero::before {
    content: ''; position: absolute; top: -70px; right: -30px;
    width: 320px; height: 320px;
    background: radial-gradient(circle, rgba(67,56,202,0.22) 0%, transparent 60%);
    border-radius: 50%;
  }
  .hero::after {
    content: ''; position: absolute; bottom: -50px; left: 25%;
    width: 250px; height: 250px;
    background: radial-gradient(circle, rgba(5,150,105,0.1) 0%, transparent 60%);
    border-radius: 50%;
  }
  .hero-nav { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px; position: relative; z-index: 1; }
  .back-link { color: rgba(255,255,255,0.5); font-size: 0.72rem; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: color 0.15s; }
  .back-link:hover { color: rgba(255,255,255,0.9); }
  .hero-actions { display: flex; gap: 8px; }
  .btn-ghost { display: inline-flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.13); color: rgba(255,255,255,0.8); font-size: 0.72rem; font-weight: 600; padding: 7px 14px; border-radius: 8px; cursor: pointer; font-family: 'Sora', sans-serif; transition: all 0.15s; }
  .btn-ghost:hover { background: rgba(255,255,255,0.14); }
  .hero-body { margin-top: 18px; position: relative; z-index: 1; }
  .hero-eyebrow { font-size: 0.62rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: #a5b4fc; margin-bottom: 6px; }
  .hero-title { font-size: 2rem; font-weight: 800; line-height: 1.1; margin: 0 0 6px; letter-spacing: -0.025em; }
  .hero-sub { font-size: 0.77rem; color: rgba(255,255,255,0.4); margin: 0 0 16px; }
  .hero-pills { display: flex; gap: 7px; flex-wrap: wrap; }
  .hero-pill { font-size: 0.66rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.55); }
  .hero-pill.on { background: rgba(67,56,202,0.25); border-color: rgba(99,102,241,0.4); color: #a5b4fc; }

  /* â”€â”€â”€ FILTER BAR â”€â”€â”€ */
  .filter-bar { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 14px 16px; margin-bottom: 14px; box-shadow: var(--shadow-sm); }
  .filter-bar form { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end; }
  .fg { display: flex; flex-direction: column; }
  .fg label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); margin-bottom: 4px; }
  .filter-bar select, .filter-bar input[type="date"] { padding: 8px 10px; font-size: 0.77rem; border: 1px solid var(--border); border-radius: 8px; color: var(--ink); font-family: 'Sora', sans-serif; background: var(--surface); outline: none; transition: border-color 0.15s; }
  .filter-bar select:focus, .filter-bar input:focus { border-color: var(--indigo); }
  .btn-primary { background: var(--indigo); color: white; border: none; padding: 8px 18px; border-radius: 8px; font-size: 0.77rem; font-weight: 700; cursor: pointer; font-family: 'Sora', sans-serif; transition: background 0.15s; display: inline-flex; align-items: center; gap: 5px; }
  .btn-primary:hover { background: var(--indigo-d); }

  /* â”€â”€â”€ PERIOD RAIL â”€â”€â”€ */
  .period-rail { display: flex; gap: 0; background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 3px; margin-bottom: 14px; overflow-x: auto; box-shadow: var(--shadow-sm); }
  .ptab { flex: none; font-size: 0.72rem; font-weight: 600; padding: 6px 14px; border-radius: 9px; cursor: pointer; white-space: nowrap; color: var(--muted); text-decoration: none; transition: all 0.15s; }
  .ptab.active { background: var(--indigo); color: white; box-shadow: 0 2px 6px rgba(67,56,202,0.3); }
  .ptab:hover:not(.active) { background: var(--surface); color: var(--ink); }

  /* â”€â”€â”€ PERIOD BADGE â”€â”€â”€ */
  .period-info { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
  .pbadge { display: inline-flex; align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 700; padding: 5px 11px; border-radius: 20px; }
  .pbadge-indigo { background: var(--indigo-ll); border: 1px solid #c7d2fe; color: var(--indigo-d); }
  .pbadge-green { background: var(--emerald-ll); border: 1px solid #a7f3d0; color: #065f46; }

  /* â”€â”€â”€ SEC HEADER â”€â”€â”€ */
  .sec-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 6px; }
  .sec-hdr h2 { font-size: 0.95rem; font-weight: 700; color: var(--ink); margin: 0; display: flex; align-items: center; gap: 6px; }
  .sec-tag { font-size: 0.63rem; font-weight: 700; padding: 3px 9px; border-radius: 20px; }

  /* â”€â”€â”€ SEMÃFORO BIG â”€â”€â”€ */
  .semaforo { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 16px; }
  .sem { border-radius: var(--r-lg); padding: 16px 14px; border: 2px solid; text-align: center; position: relative; overflow: hidden; transition: transform 0.18s, box-shadow 0.18s; }
  .sem:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
  .sem::before { content: ''; position: absolute; bottom: -20px; right: -20px; width: 80px; height: 80px; border-radius: 50%; opacity: 0.08; background: currentColor; }
  .sem-icon { font-size: 1.5rem; margin-bottom: 7px; }
  .sem-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; margin-bottom: 5px; opacity: 0.75; }
  .sem-val { font-size: 2.1rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; line-height: 1; }
  .sem-sub { font-size: 0.62rem; margin-top: 5px; opacity: 0.65; }

  /* â”€â”€â”€ RATE CARDS â”€â”€â”€ */
  .rate-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
  .rate-card { border-radius: var(--r-lg); padding: 20px; border: 2px solid; position: relative; overflow: hidden; }
  .rc-label { font-size: 0.62rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; margin-bottom: 8px; opacity: 0.7; }
  .rc-val { font-size: 2.4rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; line-height: 1; }
  .rc-sub { font-size: 0.68rem; margin-top: 6px; opacity: 0.65; }
  .rc-bar { height: 5px; background: rgba(0,0,0,0.1); border-radius: 10px; margin-top: 10px; overflow: hidden; }
  .rc-fill { height: 100%; border-radius: 10px; transition: width 1.3s ease; }
  .rc-bench { font-size: 0.62rem; margin-top: 4px; opacity: 0.5; font-style: italic; }

  /* â”€â”€â”€ CHARTS â”€â”€â”€ */
  .chart-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r-lg); padding: 18px 20px; box-shadow: var(--shadow-sm); }
  .chart-card .cc-title { font-size: 0.82rem; font-weight: 700; color: var(--ink); margin: 0 0 3px; }
  .chart-card .cc-sub { font-size: 0.65rem; color: var(--muted); margin: 0 0 14px; }

  /* â”€â”€â”€ GRIDS â”€â”€â”€ */
  .g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  .g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 14px; }
  .g12 { display: grid; grid-template-columns: 1fr 2fr; gap: 14px; margin-bottom: 14px; }
  @media (max-width: 900px) { .g2, .g3, .g12 { grid-template-columns: 1fr; } }

  /* â”€â”€â”€ CARD â”€â”€â”€ */
  .card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r-lg); padding: 16px 18px; box-shadow: var(--shadow-sm); }
  .card h3 { font-size: 0.82rem; font-weight: 700; color: var(--ink); margin: 0 0 12px; display: flex; align-items: center; gap: 6px; }
  .scroll-list { max-height: 290px; overflow-y: auto; padding-right: 3px; }
  .scroll-list::-webkit-scrollbar { width: 3px; }
  .scroll-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

  /* â”€â”€â”€ RANKING ROWS â”€â”€â”€ */
  .rank-row {
    display: flex; align-items: center; gap: 10px;
    padding: 11px 13px; border-radius: var(--r); margin-bottom: 6px;
    border: 1px solid; transition: transform 0.12s, box-shadow 0.12s;
  }
  .rank-row:hover { transform: translateX(3px); box-shadow: var(--shadow-sm); }
  .rr-num { font-size: 0.72rem; font-weight: 800; color: var(--muted2); min-width: 22px; font-family: 'JetBrains Mono', monospace; }
  .rr-body { flex: 1; }
  .rr-name { font-size: 0.8rem; font-weight: 700; color: var(--ink); }
  .rr-stats { display: flex; gap: 8px; font-size: 0.62rem; color: var(--muted); margin-top: 3px; flex-wrap: wrap; }
  .rr-bar { height: 3px; background: rgba(0,0,0,0.06); border-radius: 10px; margin-top: 5px; overflow: hidden; }
  .rr-fill { height: 100%; border-radius: 10px; transition: width 1.1s ease; }
  .rr-pct { font-size: 1.05rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; white-space: nowrap; }
  .rank-best { background: var(--emerald-ll); border-color: #a7f3d0; }
  .rank-good { background: var(--sky-l); border-color: #bae6fd; }
  .rank-mid { background: var(--amber-ll); border-color: #fde68a; }
  .rank-bad { background: var(--ruby-ll); border-color: #fecdd3; }

  /* â”€â”€â”€ HEATMAP ROW â”€â”€â”€ */
  .hmap-row { margin-bottom: 10px; }
  .hmap-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .hmap-label { font-size: 0.75rem; font-weight: 600; color: var(--ink); }
  .hmap-total { font-size: 0.78rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--indigo); }
  .hmap-track { display: flex; height: 18px; border-radius: 8px; overflow: hidden; gap: 1px; }
  .hmap-seg { min-width: 2px; transition: flex 0.8s ease; }
  .hmap-legend { display: flex; gap: 10px; font-size: 0.6rem; color: var(--muted); margin-top: 3px; flex-wrap: wrap; }
  .hmap-legend span { display: flex; align-items: center; gap: 3px; }

  /* â”€â”€â”€ PROFESSIONAL CARD â”€â”€â”€ */
  .prof-card { background: var(--white); border: 1.5px solid var(--border); border-radius: var(--r-lg); padding: 16px; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; transition: transform 0.18s, box-shadow 0.18s; }
  .prof-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
  .prof-card .pc-accent { position: absolute; top: 0; left: 0; right: 0; height: 3px; border-radius: var(--r-lg) var(--r-lg) 0 0; }
  .pc-name { font-size: 0.82rem; font-weight: 700; color: var(--ink); margin-bottom: 4px; }
  .pc-subs { font-size: 0.65rem; color: var(--muted); margin-bottom: 10px; }
  .pc-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .pc-stat { background: var(--surface); border-radius: 8px; padding: 7px 8px; text-align: center; }
  .pc-stat-val { font-size: 1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .pc-stat-label { font-size: 0.58rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-top: 2px; }
  .pc-rate-wrap { margin-top: 10px; }
  .pc-rate-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .pc-rate-label { font-size: 0.63rem; color: var(--muted); }
  .pc-rate-val { font-size: 0.63rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .pc-bar { height: 5px; background: var(--border); border-radius: 10px; overflow: hidden; }
  .pc-fill { height: 100%; border-radius: 10px; transition: width 1.2s ease; }

  /* â”€â”€â”€ SERVICE TABLE â”€â”€â”€ */
  .svc-table { width: 100%; border-collapse: collapse; font-size: 0.77rem; }
  .svc-table thead th { background: var(--surface2); color: var(--muted); font-size: 0.61rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; padding: 10px 12px; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
  .svc-table tbody tr { border-bottom: 1px solid var(--border2); transition: background 0.1s; }
  .svc-table tbody tr:hover { background: var(--indigo-ll); }
  .svc-table td { padding: 10px 12px; }
  .svc-table .mono { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
  .svc-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 0.62rem; font-weight: 700; padding: 3px 8px; border-radius: 20px; }

  /* â”€â”€â”€ SUCURSAL CARDS â”€â”€â”€ */
  .suc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; margin-bottom: 16px; }
  .suc-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r-lg); padding: 16px; box-shadow: var(--shadow-sm); }
  .suc-card .sc2-name { font-size: 0.85rem; font-weight: 700; color: var(--ink); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
  .suc-card .sc2-subs { font-size: 0.65rem; color: var(--muted); margin-bottom: 10px; }
  .suc-card .sc2-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border2); }
  .suc-card .sc2-row:last-child { border-bottom: none; }
  .suc-card .sc2-key { font-size: 0.68rem; color: var(--muted); }
  .suc-card .sc2-v { font-size: 0.78rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .suc-card .sc2-rate { margin-top: 8px; }

  /* â”€â”€â”€ REPROG TABLE â”€â”€â”€ */
  .reprog-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 13px; background: var(--violet-l); border: 1px solid #ddd6fe; border-radius: var(--r); margin-bottom: 6px; }
  .rp-name { font-size: 0.8rem; font-weight: 700; color: var(--ink); }
  .rp-detail { font-size: 0.63rem; color: var(--muted); margin-top: 2px; }
  .rp-badge { display: inline-block; font-size: 0.6rem; font-weight: 700; padding: 2px 7px; border-radius: 10px; }

  /* â”€â”€â”€ DELAY TABLE â”€â”€â”€ */
  .delay-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 13px; background: var(--amber-ll); border: 1px solid #fde68a; border-radius: var(--r); margin-bottom: 6px; }
  .dl-name { font-size: 0.8rem; font-weight: 700; color: var(--ink); }
  .dl-detail { font-size: 0.63rem; color: var(--muted); margin-top: 2px; }
  .dl-val { font-size: 1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--amber); }

  /* â”€â”€â”€ WORST PATIENTS â”€â”€â”€ */
  .worst-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; margin-bottom: 8px; }
  .worst-card { background: var(--white); border: 1px solid #fecdd3; border-radius: var(--r); padding: 12px 14px; display: flex; justify-content: space-between; align-items: center; }
  .wc-name { font-size: 0.82rem; font-weight: 700; color: var(--ink); }
  .wc-stats { display: flex; gap: 8px; font-size: 0.63rem; margin-top: 3px; flex-wrap: wrap; }
  .wc-pct { font-size: 1.3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
  .wc-sub { font-size: 0.6rem; text-align: right; margin-top: 2px; }

  /* â”€â”€â”€ TREND INSIGHT â”€â”€â”€ */
  .insight-box { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; border-radius: var(--r); border: 1px solid; margin-bottom: 8px; }
  .ib-icon { font-size: 1.1rem; flex-shrink: 0; }
  .ib-title { font-size: 0.78rem; font-weight: 700; margin-bottom: 2px; }
  .ib-text { font-size: 0.7rem; }
  .ib-good { background: var(--emerald-ll); border-color: #a7f3d0; }
  .ib-good .ib-title { color: #065f46; }
  .ib-good .ib-text { color: var(--emerald); }
  .ib-warn { background: var(--amber-ll); border-color: #fde68a; }
  .ib-warn .ib-title { color: #92400e; }
  .ib-warn .ib-text { color: var(--amber); }
  .ib-info { background: var(--indigo-ll); border-color: #c7d2fe; }
  .ib-info .ib-title { color: var(--indigo-d); }
  .ib-info .ib-text { color: var(--indigo); }

  /* â”€â”€â”€ HOURLY HEATMAP â”€â”€â”€ */
  .hour-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 3px; margin-top: 8px; }
  .hour-cell { border-radius: 4px; aspect-ratio: 1; position: relative; cursor: default; }
  .hour-cell:hover::after { content: attr(data-tip); position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%); background: rgba(10,15,30,0.9); color: white; font-size: 0.6rem; white-space: nowrap; padding: 3px 7px; border-radius: 4px; z-index: 10; pointer-events: none; }
  .hour-labels { display: grid; grid-template-columns: repeat(12, 1fr); gap: 3px; margin-top: 3px; }
  .hour-lbl { font-size: 0.55rem; color: var(--muted); text-align: center; font-family: 'JetBrains Mono', monospace; }

  /* â”€â”€â”€ DIVIDER â”€â”€â”€ */
  .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

  /* â”€â”€â”€ TOTAL BAR â”€â”€â”€ */
  .total-bar { background: var(--ink); color: white; border-radius: var(--r-lg); padding: 16px 22px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-top: 8px; }
  .tb-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; color: rgba(255,255,255,0.4); margin-bottom: 3px; }
  .tb-val { font-size: 1.3rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

  /* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
  .empty-state { background: var(--white); border: 1px solid var(--border); border-radius: var(--r-xl); padding: 60px 40px; text-align: center; box-shadow: var(--shadow-sm); }

  /* â”€â”€â”€ ANIM â”€â”€â”€ */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .sem, .rate-card, .prof-card { animation: fadeUp 0.35s ease both; }
  .sem:nth-child(2) { animation-delay: 0.06s; }
  .sem:nth-child(3) { animation-delay: 0.12s; }
  .sem:nth-child(4) { animation-delay: 0.18s; }
  .sem:nth-child(5) { animation-delay: 0.24s; }
  .sem:nth-child(6) { animation-delay: 0.3s; }
  .sem:nth-child(7) { animation-delay: 0.36s; }

  @media (max-width: 640px) {
    .semaforo { grid-template-columns: repeat(3, 1fr); }
    .rate-grid { grid-template-columns: 1fr 1fr; }
  }
</style>

<div class="wrap">

  <!-- â•â• HERO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="hero no-print">
    <div class="hero-nav">
      <a href="{% url 'facturacion:dashboard_reportes' %}" class="back-link">â† Volver a Reportes</a>
      <div class="hero-actions">
        <button onclick="window.print()" class="btn-ghost">ğŸ–¨ï¸ Imprimir</button>
        <button onclick="exportCSV()" class="btn-ghost">ğŸ“¥ CSV</button>
      </div>
    </div>
    <div class="hero-body">
      <div class="hero-eyebrow">Centro de AnÃ¡lisis de Asistencia</div>
      <h1 class="hero-title">ğŸ“… Reporte de Asistencia</h1>
      <p class="hero-sub">Cumplimiento Â· Puntualidad Â· Faltas Â· Retrasos Â· Reprogramaciones Â· Por Paciente Â· Profesional Â· Servicio Â· Sucursal</p>
      <div class="hero-pills">
        <span class="hero-pill on">âœ… Realizadas</span>
        <span class="hero-pill on">â° Retrasos</span>
        <span class="hero-pill on">âŒ Faltas</span>
        <span class="hero-pill on">ğŸ“ Permisos</span>
        <span class="hero-pill on">ğŸ”„ Reprogramadas</span>
        <span class="hero-pill on">ğŸš« Canceladas</span>
        <span class="hero-pill on">ğŸ‘¨â€âš•ï¸ Profesionales</span>
        <span class="hero-pill on">ğŸ¢ Sucursales</span>
      </div>
    </div>
  </div>

  <!-- Print Header -->
  <div class="print-only" style="margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #e2e8f0;">
    <h1 style="font-size:1.3rem;font-weight:800;margin:0 0 4px;">Reporte de Asistencia</h1>
    <p style="color:#64748b;font-size:0.78rem;margin:0">PerÃ­odo: {{ fecha_desde|date:"d/m/Y" }} â€” {{ fecha_hasta|date:"d/m/Y" }} Â· Generado: {% now "d/m/Y H:i" %} Â· {{ request.user.get_full_name|default:request.user.username }}</p>
  </div>

  <!-- â•â• PERIOD TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="period-rail no-print">
    <a href="?rango=hoy&tipo={{ tipo }}"            class="ptab {% if rango == 'hoy' %}active{% endif %}">ğŸ“… Hoy</a>
    <a href="?rango=ayer&tipo={{ tipo }}"           class="ptab {% if rango == 'ayer' %}active{% endif %}">â—€ Ayer</a>
    <a href="?rango=semana&tipo={{ tipo }}"         class="ptab {% if rango == 'semana' %}active{% endif %}">ğŸ—“ Esta Semana</a>
    <a href="?rango=semana_anterior&tipo={{ tipo }}" class="ptab {% if rango == 'semana_anterior' %}active{% endif %}">Sem. Ant.</a>
    <a href="?rango=mes&tipo={{ tipo }}"            class="ptab {% if rango == 'mes' %}active{% endif %}">ğŸ“… Este Mes</a>
    <a href="?rango=mes_anterior&tipo={{ tipo }}"   class="ptab {% if rango == 'mes_anterior' %}active{% endif %}">Mes Ant.</a>
    <a href="?rango=trimestre&tipo={{ tipo }}"      class="ptab {% if rango == 'trimestre' %}active{% endif %}">ğŸ“Š Trimestre</a>
    <a href="?rango=anio&tipo={{ tipo }}"           class="ptab {% if rango == 'anio' %}active{% endif %}">ğŸ“ˆ AÃ±o</a>
  </div>

  <!-- â•â• FILTER BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="filter-bar no-print">
    <form method="get" id="main-form">
      <div class="fg">
        <label>Vista</label>
        <select name="tipo" id="sel-tipo" onchange="toggleEntidad(this.value)">
          <option value="general" {% if tipo == 'general' %}selected{% endif %}>Vista General</option>
          <option value="paciente" {% if tipo == 'paciente' %}selected{% endif %}>Por Paciente</option>
          <option value="profesional" {% if tipo == 'profesional' %}selected{% endif %}>Por Profesional</option>
          <option value="servicio" {% if tipo == 'servicio' %}selected{% endif %}>Por Servicio</option>
          <option value="sucursal" {% if tipo == 'sucursal' %}selected{% endif %}>Por Sucursal</option>
        </select>
      </div>
      <div class="fg" id="fg-entidad" style="{% if tipo == 'general' %}display:none{% endif %}">
        <label>Seleccionar</label>
        <select name="entidad_id" id="sel-entidad">
          <option value="">â€” Todos â€”</option>
          {% if tipo == 'paciente' %}
            {% for p in pacientes %}<option value="{{ p.id }}" {% if entidad and entidad.id == p.id %}selected{% endif %}>{{ p.nombre_completo }}</option>{% endfor %}
          {% elif tipo == 'profesional' %}
            {% for p in profesionales %}<option value="{{ p.id }}" {% if entidad and entidad.id == p.id %}selected{% endif %}>{{ p.nombre_completo }}</option>{% endfor %}
          {% elif tipo == 'servicio' %}
            {% for s in servicios %}<option value="{{ s.id }}" {% if entidad and entidad.id == s.id %}selected{% endif %}>{{ s.nombre }}</option>{% endfor %}
          {% elif tipo == 'sucursal' %}
            {% for s in sucursales %}<option value="{{ s.id }}" {% if entidad and entidad.id == s.id %}selected{% endif %}>{{ s.nombre }}</option>{% endfor %}
          {% endif %}
        </select>
      </div>
      <div class="fg">
        <label>Desde</label>
        <input type="date" name="fecha_desde" value="{{ fecha_desde }}">
      </div>
      <div class="fg">
        <label>Hasta</label>
        <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}">
      </div>
      <div class="fg">
        <label>Sucursal</label>
        <select name="sucursal">
          <option value="">Todas</option>
          {% for s in sucursales %}<option value="{{ s.id }}" {% if sucursal_filtro == s.id|stringformat:"s" %}selected{% endif %}>{{ s.nombre }}</option>{% endfor %}
        </select>
      </div>
      <div class="fg">
        <label>Profesional</label>
        <select name="profesional">
          <option value="">Todos</option>
          {% for p in profesionales %}<option value="{{ p.id }}" {% if prof_filtro == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }} {{ p.apellido }}</option>{% endfor %}
        </select>
      </div>
      <button type="submit" class="btn-primary">ğŸ” Generar Reporte</button>
    </form>
  </div>

  <!-- Period info -->
  <div class="period-info">
    <span class="pbadge pbadge-indigo">ğŸ“… {{ fecha_desde|date:"d/m/Y" }} â€” {{ fecha_hasta|date:"d/m/Y" }}</span>
    {% if tipo != 'general' %}<span class="pbadge pbadge-green">ğŸ” Vista: {{ tipo|capfirst }}{% if entidad %} â€” {{ entidad.nombre_completo|default:entidad.nombre }}{% endif %}</span>{% endif %}
  </div>

  {% if stats %}

  <!-- â•â• INSIGHTS AUTOMÃTICOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if tasas.asistencia >= 90 %}
  <div class="insight-box ib-good">
    <span class="ib-icon">ğŸ¯</span>
    <div><div class="ib-title">Excelente tasa de asistencia</div>
    <div class="ib-text">{{ tasas.asistencia|floatformat:1 }}% â€” El cumplimiento estÃ¡ por encima del umbral Ã³ptimo (â‰¥90%). Â¡Muy bien!</div></div>
  </div>
  {% elif tasas.asistencia < 70 %}
  <div class="insight-box ib-warn">
    <span class="ib-icon">âš ï¸</span>
    <div><div class="ib-title">Asistencia por debajo del objetivo</div>
    <div class="ib-text">{{ tasas.asistencia|floatformat:1 }}% â€” Se recomienda revisar causas de ausentismo y aplicar estrategias de seguimiento activo.</div></div>
  </div>
  {% endif %}
  {% if tasas.faltas > 20 %}
  <div class="insight-box ib-warn">
    <span class="ib-icon">ğŸš¨</span>
    <div><div class="ib-title">Alta tasa de faltas sin aviso</div>
    <div class="ib-text">{{ tasas.faltas|floatformat:1 }}% de faltas â€” Supera el 20% recomendado. Revisar pacientes con mayor frecuencia de ausentismo.</div></div>
  </div>
  {% endif %}
  {% if stats.reprogramadas > 0 %}
  <div class="insight-box ib-info">
    <span class="ib-icon">ğŸ”„</span>
    <div><div class="ib-title">{{ stats.reprogramadas }} sesiÃ³n(es) reprogramada(s)</div>
    <div class="ib-text">
      {% if reprogramaciones_pendientes %}{{ reprogramaciones_pendientes }} aÃºn pendientes de realizar.{% else %}Ver detalle en la secciÃ³n de reprogramaciones.{% endif %}
    </div></div>
  </div>
  {% endif %}

  <!-- â•â• SEMÃFORO GRANDE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="sec-hdr"><h2>ğŸš¦ Estado de Sesiones del PerÃ­odo</h2></div>
  <div class="semaforo">
    <div class="sem" style="background:#f8fafc;border-color:var(--border);color:var(--ink3)">
      <div class="sem-icon">ğŸ“Š</div>
      <div class="sem-label" style="color:var(--muted)">Total</div>
      <div class="sem-val">{{ stats.total }}</div>
      <div class="sem-sub" style="color:var(--muted)">sesiones</div>
    </div>
    <div class="sem" style="background:var(--emerald-ll);border-color:#6ee7b7;color:var(--emerald)">
      <div class="sem-icon">âœ…</div>
      <div class="sem-label">Realizadas</div>
      <div class="sem-val">{{ stats.realizadas }}</div>
      <div class="sem-sub">{{ tasas.asistencia|floatformat:1 }}% del total</div>
    </div>
    <div class="sem" style="background:var(--indigo-ll);border-color:#a5b4fc;color:var(--indigo)">
      <div class="sem-icon">ğŸ•</div>
      <div class="sem-label">Con Retraso</div>
      <div class="sem-val">{{ stats.retrasos }}</div>
      <div class="sem-sub">{{ tasas.retrasos|default:0|floatformat:1 }}% del total</div>
    </div>
    <div class="sem" style="background:var(--ruby-ll);border-color:#fca5a5;color:var(--ruby)">
      <div class="sem-icon">âŒ</div>
      <div class="sem-label">Faltas</div>
      <div class="sem-val">{{ stats.faltas }}</div>
      <div class="sem-sub">{{ tasas.faltas|floatformat:1 }}% sin aviso</div>
    </div>
    <div class="sem" style="background:var(--violet-l);border-color:#c4b5fd;color:var(--violet)">
      <div class="sem-icon">ğŸ“</div>
      <div class="sem-label">Permisos</div>
      <div class="sem-val">{{ stats.permisos }}</div>
      <div class="sem-sub">con aviso previo</div>
    </div>
    <div class="sem" style="background:#f1f5f9;border-color:var(--border);color:var(--slate)">
      <div class="sem-icon">ğŸš«</div>
      <div class="sem-label">Canceladas</div>
      <div class="sem-val">{{ stats.canceladas }}</div>
      <div class="sem-sub">{{ tasas.cancelaciones|floatformat:1 }}%</div>
    </div>
    <div class="sem" style="background:var(--sky-l);border-color:#bae6fd;color:var(--sky)">
      <div class="sem-icon">ğŸ”„</div>
      <div class="sem-label">Reprogramadas</div>
      <div class="sem-val">{{ stats.reprogramadas|default:0 }}</div>
      <div class="sem-sub">pendientes de realizar</div>
    </div>
    <div class="sem" style="background:var(--amber-ll);border-color:#fde68a;color:var(--amber)">
      <div class="sem-icon">ğŸ—“ï¸</div>
      <div class="sem-label">Programadas</div>
      <div class="sem-val">{{ stats.programadas|default:0 }}</div>
      <div class="sem-sub">futuras pendientes</div>
    </div>
  </div>

  <!-- â•â• RATE INDICATORS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="rate-grid">
    <div class="rate-card" style="background:var(--indigo-ll);border-color:#a5b4fc;color:var(--indigo-d)">
      <div class="rc-label">Tasa de Asistencia</div>
      <div class="rc-val">{{ tasas.asistencia|floatformat:1 }}%</div>
      <div class="rc-sub">Realizadas sobre total programadas</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ tasas.asistencia|floatformat:0 }}%;background:var(--indigo)"></div></div>
      <div class="rc-bench">Objetivo: â‰¥ 85%</div>
    </div>
    <div class="rate-card" style="background:var(--emerald-ll);border-color:#6ee7b7;color:#065f46">
      <div class="rc-label">Puntualidad</div>
      <div class="rc-val">{{ tasas.puntualidad|floatformat:1 }}%</div>
      <div class="rc-sub">Realizadas sin retraso</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ tasas.puntualidad|floatformat:0 }}%;background:var(--emerald)"></div></div>
      <div class="rc-bench">Objetivo: â‰¥ 90%</div>
    </div>
    <div class="rate-card" style="background:var(--ruby-ll);border-color:#fca5a5;color:var(--ruby)">
      <div class="rc-label">Tasa de Faltas</div>
      <div class="rc-val">{{ tasas.faltas|floatformat:1 }}%</div>
      <div class="rc-sub">Ausentismo sin aviso previo</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ tasas.faltas|floatformat:0 }}%;background:var(--ruby)"></div></div>
      <div class="rc-bench">Objetivo: â‰¤ 10%</div>
    </div>
    <div class="rate-card" style="background:var(--violet-l);border-color:#c4b5fd;color:var(--violet)">
      <div class="rc-label">Permisos / Ausencia Justif.</div>
      <div class="rc-val">{{ tasas.permisos|default:0|floatformat:1 }}%</div>
      <div class="rc-sub">Ausencias notificadas</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ tasas.permisos|default:0|floatformat:0 }}%;background:var(--violet)"></div></div>
      <div class="rc-bench">Diferenciado de faltas</div>
    </div>
    <div class="rate-card" style="background:#f1f5f9;border-color:var(--border);color:var(--slate)">
      <div class="rc-label">Cancelaciones</div>
      <div class="rc-val">{{ tasas.cancelaciones|floatformat:1 }}%</div>
      <div class="rc-sub">Sesiones canceladas en perÃ­odo</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ tasas.cancelaciones|floatformat:0 }}%;background:var(--slate)"></div></div>
      <div class="rc-bench">Objetivo: â‰¤ 5%</div>
    </div>
    <div class="rate-card" style="background:var(--sky-l);border-color:#bae6fd;color:var(--sky)">
      <div class="rc-label">Reprogramaciones</div>
      <div class="rc-val">{{ tasas.reprogramaciones|default:0|floatformat:1 }}%</div>
      <div class="rc-sub">Sesiones que cambiaron fecha</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ tasas.reprogramaciones|default:0|floatformat:0 }}%;background:var(--sky)"></div></div>
      <div class="rc-bench">RevisiÃ³n si > 15%</div>
    </div>
  </div>

  <!-- â•â• CHARTS ROW 1 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if grafico_data %}
  <div class="sec-hdr"><h2>ğŸ“ˆ EvoluciÃ³n Temporal</h2></div>
  <div class="g2" style="margin-bottom:14px">
    <div class="chart-card">
      <div class="cc-title">EvoluciÃ³n de Asistencia</div>
      <div class="cc-sub">Realizadas Â· Retrasos Â· Faltas Â· Permisos por perÃ­odo</div>
      <canvas id="chart-evolucion" height="155"></canvas>
    </div>
    <div class="chart-card">
      <div class="cc-title">DistribuciÃ³n de Estados</div>
      <div class="cc-sub">Porcentaje de cada estado en el perÃ­odo</div>
      <canvas id="chart-estados" height="155"></canvas>
    </div>
  </div>

  <div class="g2" style="margin-bottom:14px">
    <div class="chart-card">
      <div class="cc-title">Tasas del PerÃ­odo</div>
      <div class="cc-sub">Asistencia Â· Puntualidad Â· Faltas Â· Cancelaciones</div>
      <canvas id="chart-tasas" height="130"></canvas>
    </div>
    <div class="chart-card">
      <div class="cc-title">Comparativa Realizadas vs. No Realizadas</div>
      <div class="cc-sub">Cumplimiento real vs pÃ©rdidas de sesiÃ³n</div>
      <canvas id="chart-cumplimiento" height="130"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- â•â• POR DÃA Y POR SERVICIO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="sec-hdr"><h2>ğŸ“… DistribuciÃ³n por DÃ­a y Servicio</h2></div>
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <h3>ğŸ“… Por DÃ­a de la Semana</h3>
      <div class="scroll-list">
        {% for dia in por_dia_semana %}
        <div class="hmap-row">
          <div class="hmap-header">
            <span class="hmap-label">{{ dia.nombre }}</span>
            <span class="hmap-total">{{ dia.total }}</span>
          </div>
          <div class="hmap-track">
            {% if dia.total > 0 %}
            <div class="hmap-seg" style="background:#059669;flex:{{ dia.realizadas }}" title="{{ dia.realizadas }} realizadas"></div>
            <div class="hmap-seg" style="background:#4338ca;flex:{{ dia.retrasos|default:0 }}" title="{{ dia.retrasos|default:0 }} con retraso"></div>
            <div class="hmap-seg" style="background:#be123c;flex:{{ dia.faltas }}" title="{{ dia.faltas }} faltas"></div>
            <div class="hmap-seg" style="background:#7c3aed;flex:{{ dia.permisos|default:0 }}" title="{{ dia.permisos|default:0 }} permisos"></div>
            <div class="hmap-seg" style="background:#94a3b8;flex:{{ dia.canceladas|default:0 }}" title="{{ dia.canceladas|default:0 }} canceladas"></div>
            {% else %}
            <div class="hmap-seg" style="background:var(--border);flex:1"></div>
            {% endif %}
          </div>
          <div class="hmap-legend">
            <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#059669"></span>âœ… {{ dia.realizadas }}</span>
            {% if dia.retrasos %}<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#4338ca"></span>â° {{ dia.retrasos }}</span>{% endif %}
            <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#be123c"></span>âŒ {{ dia.faltas }}</span>
            {% if dia.permisos %}<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#7c3aed"></span>ğŸ“ {{ dia.permisos }}</span>{% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="card">
      <h3>ğŸ©º Por Servicio</h3>
      <div class="scroll-list">
        {% for s in por_servicio %}
        <div class="hmap-row">
          <div class="hmap-header">
            <span class="hmap-label">{{ s.servicio__nombre }}</span>
            <span class="hmap-total">{{ s.total }}</span>
          </div>
          <div class="hmap-track">
            {% if s.total > 0 %}
            <div class="hmap-seg" style="background:#059669;flex:{{ s.realizadas }}"></div>
            <div class="hmap-seg" style="background:#4338ca;flex:{{ s.retrasos|default:0 }}"></div>
            <div class="hmap-seg" style="background:#be123c;flex:{{ s.faltas }}"></div>
            <div class="hmap-seg" style="background:#7c3aed;flex:{{ s.permisos|default:0 }}"></div>
            <div class="hmap-seg" style="background:#94a3b8;flex:{{ s.canceladas|default:0 }}"></div>
            {% else %}
            <div class="hmap-seg" style="background:var(--border);flex:1"></div>
            {% endif %}
          </div>
          <div class="hmap-legend">
            <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#059669"></span>âœ… {{ s.realizadas }}</span>
            <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#be123c"></span>âŒ {{ s.faltas }}</span>
            {% if s.tasa_asistencia %}<span style="font-weight:700;color:var(--indigo)">{{ s.tasa_asistencia|floatformat:1 }}%</span>{% endif %}
          </div>
        </div>
        {% empty %}<p style="font-size:0.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>{% endfor %}
      </div>
    </div>
  </div>

  <!-- â•â• POR HORA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if por_hora %}
  <div class="sec-hdr"><h2>ğŸ• DistribuciÃ³n por Hora del DÃ­a</h2></div>
  <div class="card" style="margin-bottom:14px">
    <h3>Mapa de Calor â€” Sesiones por Franja Horaria</h3>
    <div class="chart-card" style="border:none;padding:0;box-shadow:none;margin-bottom:0">
      <canvas id="chart-horas" height="55"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- â•â• PROFESIONALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if tipo == 'general' and por_profesional %}
  <div class="sec-hdr" style="margin-top:6px">
    <h2>ğŸ‘¨â€âš•ï¸ Rendimiento por Profesional</h2>
    <span class="sec-tag" style="background:var(--indigo-ll);color:var(--indigo-d)">{{ por_profesional|length }} profesionales</span>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:16px">
    {% for p in por_profesional %}
    <div class="prof-card">
      <div class="pc-accent" style="background:{% cycle '#4338ca' '#059669' '#0d9488' '#7c3aed' '#d97706' '#0284c7' %}"></div>
      <div class="pc-name">{{ p.profesional__nombre }} {{ p.profesional__apellido }}</div>
      <div class="pc-subs">{{ p.servicios|default:"â€”" }} Â· {{ p.sesiones }} sesiones asignadas</div>
      <div class="pc-stats">
        <div class="pc-stat">
          <div class="pc-stat-val" style="color:var(--emerald)">{{ p.realizadas }}</div>
          <div class="pc-stat-label">Realizadas</div>
        </div>
        <div class="pc-stat">
          <div class="pc-stat-val" style="color:var(--indigo)">{{ p.retrasos|default:0 }}</div>
          <div class="pc-stat-label">Retrasos</div>
        </div>
        <div class="pc-stat">
          <div class="pc-stat-val" style="color:var(--ruby)">{{ p.faltas|default:0 }}</div>
          <div class="pc-stat-label">Faltas pac.</div>
        </div>
        <div class="pc-stat">
          <div class="pc-stat-val" style="color:var(--slate)">{{ p.canceladas|default:0 }}</div>
          <div class="pc-stat-label">Canceladas</div>
        </div>
      </div>
      <div class="pc-rate-wrap">
        <div class="pc-rate-header">
          <span class="pc-rate-label">Tasa de asistencia pacientes</span>
          <span class="pc-rate-val" style="color:{% if p.tasa_asistencia >= 85 %}var(--emerald){% elif p.tasa_asistencia >= 70 %}var(--indigo){% else %}var(--ruby){% endif %}">{{ p.tasa_asistencia|default:0|floatformat:1 }}%</span>
        </div>
        <div class="pc-bar"><div class="pc-fill" style="width:{{ p.tasa_asistencia|default:0 }}%;background:{% if p.tasa_asistencia >= 85 %}var(--emerald){% elif p.tasa_asistencia >= 70 %}var(--indigo){% else %}var(--ruby){% endif %}"></div></div>
      </div>
      {% if p.promedio_retraso_min %}
      <div style="margin-top:8px;font-size:0.65rem;color:var(--amber);font-weight:600">â° Retraso prom.: {{ p.promedio_retraso_min|floatformat:0 }} min</div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Tabla detallada profesionales -->
  <div style="overflow-x:auto;background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin-bottom:16px;box-shadow:var(--shadow-sm)">
    <table class="svc-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Profesional</th>
          <th>Sesiones</th>
          <th>Realizadas</th>
          <th>Retrasos</th>
          <th>Faltas pac.</th>
          <th>Permisos</th>
          <th>Canceladas</th>
          <th>Reprog.</th>
          <th>Tasa Asist.</th>
          <th>Puntualidad</th>
        </tr>
      </thead>
      <tbody>
        {% for p in por_profesional %}
        <tr>
          <td class="mono" style="color:var(--muted2)">{{ forloop.counter }}</td>
          <td style="font-weight:700">{{ p.profesional__nombre }} {{ p.profesional__apellido }}</td>
          <td class="mono">{{ p.sesiones }}</td>
          <td class="mono" style="color:var(--emerald)">{{ p.realizadas }}</td>
          <td class="mono" style="color:var(--indigo)">{{ p.retrasos|default:0 }}</td>
          <td class="mono" style="color:var(--ruby)">{{ p.faltas|default:0 }}</td>
          <td class="mono" style="color:var(--violet)">{{ p.permisos|default:0 }}</td>
          <td class="mono" style="color:var(--slate)">{{ p.canceladas|default:0 }}</td>
          <td class="mono" style="color:var(--sky)">{{ p.reprogramadas|default:0 }}</td>
          <td>
            <span class="svc-badge" style="background:{% if p.tasa_asistencia >= 85 %}var(--emerald-ll);color:#065f46{% elif p.tasa_asistencia >= 70 %}var(--indigo-ll);color:var(--indigo-d){% else %}var(--ruby-ll);color:var(--ruby){% endif %}">{{ p.tasa_asistencia|default:0|floatformat:1 }}%</span>
          </td>
          <td>
            <span class="svc-badge" style="background:{% if p.puntualidad >= 90 %}var(--emerald-ll);color:#065f46{% else %}var(--amber-ll);color:#92400e{% endif %}">{{ p.puntualidad|default:0|floatformat:1 }}%</span>
          </td>
        </tr>
        {% empty %}<tr><td colspan="11" style="text-align:center;padding:20px;color:var(--muted)">Sin datos</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- â•â• SUCURSALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if tipo == 'general' and por_sucursal %}
  <div class="sec-hdr">
    <h2>ğŸ¢ Asistencia por Sucursal</h2>
    <span class="sec-tag" style="background:var(--teal-l);color:#0f766e">{{ por_sucursal|length }} sucursales</span>
  </div>
  <div class="suc-grid">
    {% for s in por_sucursal %}
    <div class="suc-card">
      <div class="sc2-name">ğŸ¢ {{ s.nombre }}</div>
      <div class="sc2-subs">{{ s.sesiones }} sesiones en el perÃ­odo</div>
      <div class="sc2-row">
        <span class="sc2-key">âœ… Realizadas</span>
        <span class="sc2-v" style="color:var(--emerald)">{{ s.realizadas }}</span>
      </div>
      <div class="sc2-row">
        <span class="sc2-key">â° Con retraso</span>
        <span class="sc2-v" style="color:var(--indigo)">{{ s.retrasos|default:0 }}</span>
      </div>
      <div class="sc2-row">
        <span class="sc2-key">âŒ Faltas</span>
        <span class="sc2-v" style="color:var(--ruby)">{{ s.faltas|default:0 }}</span>
      </div>
      <div class="sc2-row">
        <span class="sc2-key">ğŸ“ Permisos</span>
        <span class="sc2-v" style="color:var(--violet)">{{ s.permisos|default:0 }}</span>
      </div>
      <div class="sc2-row">
        <span class="sc2-key">ğŸš« Canceladas</span>
        <span class="sc2-v" style="color:var(--slate)">{{ s.canceladas|default:0 }}</span>
      </div>
      <div class="sc2-rate">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <span style="font-size:0.63rem;color:var(--muted)">Tasa asistencia</span>
          <span style="font-size:0.72rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:{% if s.tasa_asistencia >= 85 %}var(--emerald){% elif s.tasa_asistencia >= 70 %}var(--indigo){% else %}var(--ruby){% endif %}">{{ s.tasa_asistencia|default:0|floatformat:1 }}%</span>
        </div>
        <div style="height:5px;background:var(--border);border-radius:10px;overflow:hidden"><div style="height:100%;border-radius:10px;width:{{ s.tasa_asistencia|default:0 }}%;background:{% if s.tasa_asistencia >= 85 %}var(--emerald){% elif s.tasa_asistencia >= 70 %}var(--indigo){% else %}var(--ruby){% endif %};transition:width 1.2s ease"></div></div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- GrÃ¡fico comparativa sucursales -->
  {% if por_sucursal %}
  <div class="chart-card" style="margin-bottom:14px">
    <div class="cc-title">Comparativa de Asistencia por Sucursal</div>
    <div class="cc-sub">Realizadas vs Faltas vs Canceladas</div>
    <canvas id="chart-sucursales" height="80"></canvas>
  </div>
  {% endif %}
  {% endif %}

  <!-- â•â• RANKING TOP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if tipo == 'general' and ranking %}
  <div class="sec-hdr" style="margin-top:4px">
    <h2>ğŸ† Top 15 â€” Mejor Asistencia de Pacientes</h2>
    <span class="sec-tag" style="background:var(--emerald-ll);color:#065f46">Pacientes destacados</span>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:8px;margin-bottom:16px">
    {% for item in ranking %}
    <div class="rank-row {% if item.tasa >= 90 %}rank-best{% elif item.tasa >= 75 %}rank-good{% elif item.tasa >= 60 %}rank-mid{% else %}rank-bad{% endif %}">
      <span class="rr-num">{{ forloop.counter }}</span>
      <div class="rr-body">
        <div class="rr-name">{{ item.nombre_completo }}</div>
        <div class="rr-stats">
          <span style="color:var(--emerald)">âœ… {{ item.realizadas }}</span>
          {% if item.retrasos > 0 %}<span style="color:var(--indigo)">â° {{ item.retrasos }}</span>{% endif %}
          <span style="color:var(--ruby)">âŒ {{ item.faltas }}</span>
          {% if item.permisos > 0 %}<span style="color:var(--violet)">ğŸ“ {{ item.permisos }}</span>{% endif %}
          <span style="color:var(--muted)">Total: {{ item.total }}</span>
        </div>
        <div class="rr-bar"><div class="rr-fill" style="width:{{ item.tasa|floatformat:0 }}%;background:{% if item.tasa >= 90 %}var(--emerald){% elif item.tasa >= 75 %}var(--sky){% elif item.tasa >= 60 %}var(--amber){% else %}var(--ruby){% endif %}"></div></div>
      </div>
      <div class="rr-pct" style="color:{% if item.tasa >= 90 %}var(--emerald){% elif item.tasa >= 75 %}var(--sky){% elif item.tasa >= 60 %}var(--amber){% else %}var(--ruby){% endif %}">{{ item.tasa|floatformat:1 }}%</div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- â•â• PEORES ASISTENCIAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if tipo == 'general' and peores_asistencia %}
  <div class="page-break">
    <div style="background:var(--ruby-ll);border:2px solid #fecdd3;border-radius:var(--r-xl);padding:18px 20px;margin-bottom:16px">
      <div class="sec-hdr">
        <div>
          <h2 style="color:var(--ruby)">âš ï¸ Pacientes con Mayor Tasa de Faltas</h2>
          <p style="font-size:0.7rem;color:#9f1239;margin:4px 0 0">Requieren seguimiento activo â€” tasa de faltas superior al 20%</p>
        </div>
        <span class="sec-tag" style="background:var(--ruby);color:white">{{ peores_asistencia|length }} casos</span>
      </div>
      <div class="worst-grid">
        {% for item in peores_asistencia %}
        <div class="worst-card">
          <div>
            <div class="wc-name">{{ item.nombre_completo }}</div>
            <div class="wc-stats">
              <span style="color:var(--ruby);font-weight:700">âŒ {{ item.faltas }} faltas</span>
              <span style="color:var(--emerald)">âœ… {{ item.realizadas }}</span>
              {% if item.permisos > 0 %}<span style="color:var(--violet)">ğŸ“ {{ item.permisos }}</span>{% endif %}
              <span style="color:var(--muted)">Total: {{ item.total }}</span>
            </div>
            {% if item.desde %}
            <div style="font-size:0.62rem;color:var(--muted);margin-top:3px">Desde: {{ item.desde|date:"d/m/Y" }}</div>
            {% endif %}
          </div>
          <div style="text-align:right">
            <div class="wc-pct" style="color:var(--ruby)">{{ item.tasa_faltas|floatformat:1 }}%</div>
            <div class="wc-sub" style="color:#9f1239">de faltas</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- â•â• RETRASOS DETALLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if retrasos_detalle %}
  <div class="sec-hdr" style="margin-top:4px">
    <h2>â° Pacientes con Mayor Retraso Promedio</h2>
    <span class="sec-tag" style="background:var(--amber-ll);color:#92400e">{{ retrasos_detalle|length }} pacientes</span>
  </div>
  <div style="margin-bottom:16px">
    {% for r in retrasos_detalle %}
    <div class="delay-row">
      <div>
        <div class="dl-name">{{ r.nombre_completo }}</div>
        <div class="dl-detail">{{ r.sesiones_con_retraso }} sesiÃ³n(es) con retraso Â· Ãšltima: {{ r.ultima_fecha|date:"d/m/Y" }}</div>
      </div>
      <div style="text-align:right">
        <div class="dl-val">{{ r.promedio_minutos|floatformat:0 }} min</div>
        <div style="font-size:0.62rem;color:var(--amber)">retraso promedio</div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- â•â• REPROGRAMACIONES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if reprogramaciones %}
  <div class="sec-hdr">
    <h2>ğŸ”„ Detalle de Reprogramaciones</h2>
    <span class="sec-tag" style="background:var(--sky-l);color:#0369a1">{{ reprogramaciones|length }} reprogramaciones</span>
  </div>
  <div style="margin-bottom:16px">
    {% for r in reprogramaciones %}
    <div class="reprog-row">
      <div>
        <div class="rp-name">{{ r.paciente.nombre }} {{ r.paciente.apellido }}</div>
        <div class="rp-detail">
          Original: {{ r.fecha|date:"d/m/Y" }} {{ r.hora_inicio|time:"H:i" }} â†’
          Nueva: {{ r.fecha_reprogramada|date:"d/m/Y" }}{% if r.hora_reprogramada %} {{ r.hora_reprogramada|time:"H:i" }}{% endif %}
          Â· {{ r.servicio.nombre }} Â· {{ r.profesional.nombre }}
        </div>
        {% if r.motivo_reprogramacion %}
        <div style="font-size:0.63rem;color:var(--violet);margin-top:2px">Motivo: {{ r.motivo_reprogramacion|truncatechars:60 }}</div>
        {% endif %}
      </div>
      {% if r.reprogramacion_realizada %}
      <span class="rp-badge" style="background:var(--emerald-l);color:var(--emerald)">âœ… Realizada</span>
      {% else %}
      <span class="rp-badge" style="background:var(--amber-l);color:var(--amber)">â³ Pendiente</span>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- â•â• SERVICIOS TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if tipo == 'general' %}
  <div class="sec-hdr"><h2>ğŸ©º EstadÃ­sticas Detalladas por Servicio</h2></div>
  <div style="overflow-x:auto;background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin-bottom:16px;box-shadow:var(--shadow-sm)">
    <table class="svc-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Servicio</th>
          <th>Total</th>
          <th>Realizadas</th>
          <th>Con retraso</th>
          <th>Faltas</th>
          <th>Permisos</th>
          <th>Canceladas</th>
          <th>Reprog.</th>
          <th>Asistencia</th>
        </tr>
      </thead>
      <tbody>
        {% for s in por_servicio %}
        <tr>
          <td class="mono" style="color:var(--muted2)">{{ forloop.counter }}</td>
          <td style="font-weight:700">{{ s.servicio__nombre }}</td>
          <td class="mono">{{ s.total }}</td>
          <td class="mono" style="color:var(--emerald)">{{ s.realizadas }}</td>
          <td class="mono" style="color:var(--indigo)">{{ s.retrasos|default:0 }}</td>
          <td class="mono" style="color:var(--ruby)">{{ s.faltas }}</td>
          <td class="mono" style="color:var(--violet)">{{ s.permisos|default:0 }}</td>
          <td class="mono" style="color:var(--slate)">{{ s.canceladas|default:0 }}</td>
          <td class="mono" style="color:var(--sky)">{{ s.reprogramadas|default:0 }}</td>
          <td>
            <span class="svc-badge" style="background:{% if s.tasa_asistencia >= 85 %}var(--emerald-ll);color:#065f46{% elif s.tasa_asistencia >= 70 %}var(--indigo-ll);color:var(--indigo-d){% else %}var(--ruby-ll);color:var(--ruby){% endif %}">{{ s.tasa_asistencia|default:0|floatformat:1 }}%</span>
          </td>
        </tr>
        {% empty %}<tr><td colspan="10" style="text-align:center;padding:20px;color:var(--muted)">Sin datos</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- â•â• TOTAL BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="total-bar">
    <div>
      <div class="tb-label">PerÃ­odo analizado</div>
      <div class="tb-val" style="color:#a5b4fc;font-size:1rem">{{ fecha_desde|date:"d/m/Y" }} â†’ {{ fecha_hasta|date:"d/m/Y" }}</div>
    </div>
    <div style="text-align:center">
      <div class="tb-label">Total Sesiones</div>
      <div class="tb-val" style="color:white">{{ stats.total }}</div>
    </div>
    <div style="text-align:center">
      <div class="tb-label">Tasa Asistencia</div>
      <div class="tb-val" style="color:#6ee7b7">{{ tasas.asistencia|floatformat:1 }}%</div>
    </div>
    <div style="text-align:center">
      <div class="tb-label">Puntualidad</div>
      <div class="tb-val" style="color:#6ee7b7">{{ tasas.puntualidad|floatformat:1 }}%</div>
    </div>
    <div style="text-align:right">
      <div class="tb-label">Faltas / No realizadas</div>
      <div class="tb-val" style="color:#fca5a5">{{ stats.faltas }} / {{ stats.no_realizadas|default:0 }}</div>
    </div>
  </div>

  {% else %}
  <!-- â•â• EMPTY STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="empty-state">
    <div style="font-size:3rem;margin-bottom:14px">ğŸ“…</div>
    <h3 style="font-size:1.1rem;font-weight:700;color:var(--ink);margin:0 0 8px">Configura los filtros para generar el reporte</h3>
    <p style="font-size:0.8rem;color:var(--muted);margin:0 0 16px">Selecciona el tipo de vista, rango de fechas y aplica los filtros necesarios.</p>
    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;font-size:0.72rem;color:var(--muted)">
      <span style="background:var(--emerald-ll);color:var(--emerald);padding:4px 10px;border-radius:20px;font-weight:600">âœ… Vista General</span>
      <span style="background:var(--indigo-ll);color:var(--indigo);padding:4px 10px;border-radius:20px;font-weight:600">ğŸ‘¤ Por Paciente</span>
      <span style="background:var(--sky-l);color:var(--sky);padding:4px 10px;border-radius:20px;font-weight:600">ğŸ‘¨â€âš•ï¸ Por Profesional</span>
      <span style="background:var(--teal-l);color:var(--teal);padding:4px 10px;border-radius:20px;font-weight:600">ğŸ©º Por Servicio</span>
      <span style="background:var(--amber-ll);color:var(--amber);padding:4px 10px;border-radius:20px;font-weight:600">ğŸ¢ Por Sucursal</span>
    </div>
  </div>
  {% endif %}

</div><!-- /wrap -->

{% if grafico_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
Chart.defaults.font.family = "'Sora', sans-serif";
Chart.defaults.color = '#5b6787';

const PALETTE = {
  green: '#059669', greenA: 'rgba(5,150,105,0.15)',
  indigo: '#4338ca', indigoA: 'rgba(67,56,202,0.15)',
  ruby: '#be123c', rubyA: 'rgba(190,18,60,0.12)',
  violet: '#7c3aed', violetA: 'rgba(124,58,237,0.12)',
  slate: '#475569', slateA: 'rgba(71,85,105,0.1)',
  sky: '#0284c7', skyA: 'rgba(2,132,199,0.12)',
  amber: '#d97706',
};

// â”€â”€â”€ 1. EvoluciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctx1 = document.getElementById('chart-evolucion');
if(ctx1) new Chart(ctx1, {
  type: 'line',
  data: {
    labels: {{ grafico_data.labels|safe }},
    datasets: [
      { label: 'Realizadas', data: {{ grafico_data.realizadas|safe }}, borderColor: PALETTE.green, backgroundColor: PALETTE.greenA, tension: 0.4, fill: true, borderWidth: 2.5, pointRadius: 4, pointBackgroundColor: PALETTE.green },
      { label: 'Con Retraso', data: {{ grafico_data.retrasos|safe }}, borderColor: PALETTE.indigo, backgroundColor: PALETTE.indigoA, tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3 },
      { label: 'Faltas', data: {{ grafico_data.faltas|safe }}, borderColor: PALETTE.ruby, backgroundColor: PALETTE.rubyA, tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3 },
      { label: 'Permisos', data: {{ grafico_data.permisos|safe }}, borderColor: PALETTE.violet, backgroundColor: PALETTE.violetA, tension: 0.4, fill: true, borderWidth: 1.5, pointRadius: 3, borderDash: [4,3] },
      { label: 'Canceladas', data: {{ grafico_data.canceladas|safe }}, borderColor: PALETTE.slate, backgroundColor: PALETTE.slateA, tension: 0.4, fill: true, borderWidth: 1.5, pointRadius: 2, borderDash: [3,3] },
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { position: 'top', labels: { font: { size: 10 }, padding: 12, usePointStyle: true } } },
    scales: {
      y: { beginAtZero: true, ticks: { font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
      x: { ticks: { font: { size: 9 } }, grid: { display: false } }
    }
  }
});

// â”€â”€â”€ 2. Estados doughnut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctx2 = document.getElementById('chart-estados');
if(ctx2) new Chart(ctx2, {
  type: 'doughnut',
  data: {
    labels: ['Realizadas', 'Con Retraso', 'Faltas', 'Permisos', 'Canceladas', 'Reprogramadas', 'Programadas'],
    datasets: [{
      data: [
        {{ stats.realizadas|default:0 }},
        {{ stats.retrasos|default:0 }},
        {{ stats.faltas|default:0 }},
        {{ stats.permisos|default:0 }},
        {{ stats.canceladas|default:0 }},
        {{ stats.reprogramadas|default:0 }},
        {{ stats.programadas|default:0 }},
      ],
      backgroundColor: [PALETTE.green, PALETTE.indigo, PALETTE.ruby, PALETTE.violet, PALETTE.slate, PALETTE.sky, PALETTE.amber],
      borderWidth: 3, borderColor: '#fff', hoverOffset: 8,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: true, cutout: '65%',
    plugins: {
      legend: { position: 'right', labels: { font: { size: 10 }, padding: 8, usePointStyle: true } },
      tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} (${(ctx.raw / {{ stats.total|default:1 }} * 100).toFixed(1)}%)` } }
    }
  }
});

// â”€â”€â”€ 3. Tasas bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctx3 = document.getElementById('chart-tasas');
if(ctx3) new Chart(ctx3, {
  type: 'bar',
  data: {
    labels: ['Asistencia', 'Puntualidad', 'Faltas', 'Permisos', 'Cancelaciones', 'Reprog.'],
    datasets: [{
      label: 'Tasa %',
      data: [
        {{ tasas.asistencia|floatformat:1 }},
        {{ tasas.puntualidad|floatformat:1 }},
        {{ tasas.faltas|floatformat:1 }},
        {{ tasas.permisos|default:0|floatformat:1 }},
        {{ tasas.cancelaciones|floatformat:1 }},
        {{ tasas.reprogramaciones|default:0|floatformat:1 }},
      ],
      backgroundColor: [PALETTE.green, '#34d399', PALETTE.ruby, PALETTE.violet, PALETTE.slate, PALETTE.sky],
      borderRadius: 6, borderSkipped: false,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.raw}%` } } },
    scales: {
      y: { beginAtZero: true, max: 100, ticks: { font: { size: 9 }, callback: v => v + '%' }, grid: { color: 'rgba(0,0,0,0.04)' } },
      x: { ticks: { font: { size: 9 } }, grid: { display: false } }
    }
  }
});

// â”€â”€â”€ 4. Cumplimiento stacked â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctx4 = document.getElementById('chart-cumplimiento');
if(ctx4) new Chart(ctx4, {
  type: 'bar',
  data: {
    labels: {{ grafico_data.labels|safe }},
    datasets: [
      { label: 'Realizadas', data: {{ grafico_data.realizadas|safe }}, backgroundColor: PALETTE.green, borderRadius: { topLeft: 0, topRight: 0, bottomLeft: 4, bottomRight: 4 }, stack: 'a' },
      { label: 'Con Retraso', data: {{ grafico_data.retrasos|safe }}, backgroundColor: PALETTE.indigo, stack: 'a' },
      { label: 'Faltas', data: {{ grafico_data.faltas|safe }}, backgroundColor: PALETTE.ruby, stack: 'a' },
      { label: 'Otros', data: {{ grafico_data.otros|safe }}, backgroundColor: PALETTE.slate, borderRadius: { topLeft: 4, topRight: 4, bottomLeft: 0, bottomRight: 0 }, stack: 'a' },
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { position: 'top', labels: { font: { size: 9 }, padding: 8, usePointStyle: true } } },
    scales: {
      y: { beginAtZero: true, stacked: true, ticks: { font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
      x: { stacked: true, ticks: { font: { size: 9 } }, grid: { display: false } }
    }
  }
});

// â”€â”€â”€ 5. Horas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctxH = document.getElementById('chart-horas');
if(ctxH) new Chart(ctxH, {
  type: 'bar',
  data: {
    labels: {{ por_hora_labels|safe|default:'[]' }},
    datasets: [{
      label: 'Sesiones',
      data: {{ por_hora_data|safe|default:'[]' }},
      backgroundColor: ctx => {
        const v = ctx.parsed?.y ?? 0;
        const max = Math.max(...{{ por_hora_data|safe|default:'[1]' }});
        const ratio = v / max;
        return `rgba(67,56,202,${0.15 + ratio * 0.75})`;
      },
      borderRadius: 6, borderSkipped: false,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: true,
    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.raw} sesiones` } } },
    scales: {
      y: { beginAtZero: true, ticks: { font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
      x: { ticks: { font: { size: 9 } }, grid: { display: false } }
    }
  }
});

// â”€â”€â”€ 6. Sucursales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctxS = document.getElementById('chart-sucursales');
if(ctxS) {
  const sucLabels = [{% for s in por_sucursal %}"{{ s.nombre }}"{% if not forloop.last %},{% endif %}{% endfor %}];
  const sucReal = [{% for s in por_sucursal %}{{ s.realizadas|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];
  const sucFaltas = [{% for s in por_sucursal %}{{ s.faltas|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];
  const sucCancel = [{% for s in por_sucursal %}{{ s.canceladas|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];
  new Chart(ctxS, {
    type: 'bar',
    data: {
      labels: sucLabels,
      datasets: [
        { label: 'Realizadas', data: sucReal, backgroundColor: PALETTE.green, borderRadius: 5, borderSkipped: false },
        { label: 'Faltas', data: sucFaltas, backgroundColor: PALETTE.ruby, borderRadius: 5, borderSkipped: false },
        { label: 'Canceladas', data: sucCancel, backgroundColor: PALETTE.slate, borderRadius: 5, borderSkipped: false },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'top', labels: { font: { size: 10 }, padding: 12, usePointStyle: true } } },
      scales: {
        y: { beginAtZero: true, ticks: { font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
        x: { ticks: { font: { size: 9 } }, grid: { display: false } }
      }
    }
  });
}

// â”€â”€â”€ Export CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const rows = [
    ['Reporte de Asistencia'],
    ['PerÃ­odo','{{ fecha_desde }}','{{ fecha_hasta }}'],
    ['',''],
    ['RESUMEN',''],
    ['Total Sesiones','{{ stats.total|default:0 }}'],
    ['Realizadas','{{ stats.realizadas|default:0 }}'],
    ['Con Retraso','{{ stats.retrasos|default:0 }}'],
    ['Faltas','{{ stats.faltas|default:0 }}'],
    ['Permisos','{{ stats.permisos|default:0 }}'],
    ['Canceladas','{{ stats.canceladas|default:0 }}'],
    ['Reprogramadas','{{ stats.reprogramadas|default:0 }}'],
    ['',''],
    ['TASAS',''],
    ['Tasa Asistencia','{{ tasas.asistencia|floatformat:2 }}%'],
    ['Puntualidad','{{ tasas.puntualidad|floatformat:2 }}%'],
    ['Tasa Faltas','{{ tasas.faltas|floatformat:2 }}%'],
    ['Cancelaciones','{{ tasas.cancelaciones|floatformat:2 }}%'],
  ];
  const csv = rows.map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'reporte_asistencia_{{ fecha_desde }}_{{ fecha_hasta }}.csv';
  a.click();
}
</script>
{% endif %}

<script>
function toggleEntidad(tipo) {
  const fg = document.getElementById('fg-entidad');
  fg.style.display = (tipo === 'general') ? 'none' : 'flex';
}
function aplicarRango(rango) {
  const hoy = new Date();
  let desde, hasta = hoy.toISOString().split('T')[0];
  if(rango==='semana'){ const d=new Date(hoy); d.setDate(hoy.getDate()-hoy.getDay()+1); desde=d.toISOString().split('T')[0]; }
  else if(rango==='mes'){ desde=new Date(hoy.getFullYear(),hoy.getMonth(),1).toISOString().split('T')[0]; }
  else if(rango==='mes_anterior'){ const i=new Date(hoy.getFullYear(),hoy.getMonth()-1,1); const f=new Date(hoy.getFullYear(),hoy.getMonth(),0); desde=i.toISOString().split('T')[0]; hasta=f.toISOString().split('T')[0]; }
  else if(rango==='trimestre'){ const d=new Date(hoy); d.setMonth(hoy.getMonth()-3); desde=d.toISOString().split('T')[0]; }
  else return;
  document.querySelector('[name="fecha_desde"]').value=desde;
  document.querySelector('[name="fecha_hasta"]').value=hasta;
}
</script>
{% endblock %}