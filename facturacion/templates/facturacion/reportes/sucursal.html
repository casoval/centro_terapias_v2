{% extends 'base.html' %}
{% block title %}Reporte Sucursal{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Fira+Code:wght@400;600&display=swap');
  :root{
    --ink:#0f172a;--ink2:#334155;--muted:#64748b;--border:#e2e8f0;--surface:#f8fafc;--white:#fff;
    --green:#16a34a;--green-l:#dcfce7;--blue:#2563eb;--blue-l:#dbeafe;
    --red:#dc2626;--red-l:#fee2e2;--amber:#d97706;--amber-l:#fef3c7;
    --purple:#7c3aed;--purple-l:#ede9fe;--teal:#0d9488;--teal-l:#ccfbf1;
    --violet:#6d28d9;--violet-l:#ede9fe;
    --r:12px;
  }
  body{font-family:'Nunito',sans-serif;background:var(--surface)}
  @media print{.no-print{display:none!important} body{background:white!important}}
  .mono{font-family:'Fira Code',monospace}

  .rpt-header{background:linear-gradient(135deg,#2e1065 0%,#4c1d95 50%,#3b0764 100%);
    border-radius:16px;padding:24px 28px;margin-bottom:20px;color:white;position:relative;overflow:hidden}
  .rpt-header::after{content:'';position:absolute;top:-30px;right:-30px;width:180px;height:180px;
    background:radial-gradient(circle,rgba(167,139,250,.25) 0%,transparent 70%);border-radius:50%}
  .back{color:#c4b5fd;text-decoration:none;font-size:.75rem;font-weight:700;display:inline-flex;align-items:center;gap:4px;margin-bottom:10px}
  .rpt-header h1{font-size:1.5rem;font-weight:900;margin:0 0 4px}
  .rpt-header p{color:#c4b5fd;font-size:.8rem;margin:0}
  .print-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.3);color:white;font-size:.75rem;font-weight:700;
    padding:6px 14px;border-radius:8px;cursor:pointer;margin-top:10px}

  .filter-bar{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:16px}
  .filter-bar form{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}
  .fg{display:flex;flex-direction:column;gap:3px}
  .fg label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
  .fg select,.fg input[type=date]{padding:7px 10px;font-size:.78rem;border:1px solid var(--border);
    border-radius:8px;color:var(--ink);font-family:'Nunito',sans-serif;min-width:150px}
  .btn-primary{background:var(--violet);color:white;border:none;padding:7px 16px;border-radius:8px;font-size:.78rem;font-weight:700;cursor:pointer;align-self:flex-end}

  /* Sucursal card */
  .suc-card{background:linear-gradient(135deg,#2e1065,#3b0764);border-radius:16px;padding:20px 24px;margin-bottom:16px;color:white;display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .suc-avatar{width:64px;height:64px;border-radius:14px;background:rgba(255,255,255,.15);
    display:flex;align-items:center;justify-content:center;font-size:2rem;flex-shrink:0}
  .suc-info{flex:1;min-width:200px}
  .suc-name{font-size:1.2rem;font-weight:900;margin:0 0 4px}
  .suc-chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
  .chip{display:inline-flex;align-items:center;gap:4px;font-size:.65rem;font-weight:700;
    padding:3px 9px;border-radius:20px;background:rgba(255,255,255,.12);color:rgba(255,255,255,.85)}
  .chip.green{background:rgba(34,197,94,.2);color:#86efac}
  .suc-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-top:12px}
  .sk-item{background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;text-align:center}
  .sk-label{font-size:.58rem;font-weight:700;text-transform:uppercase;opacity:.6;margin-bottom:3px}
  .sk-val{font-size:1.1rem;font-weight:900;font-family:'Fira Code',monospace}

  /* Stats */
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px}
  .kpi-box{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:12px;position:relative;overflow:hidden}
  .kpi-box .accent{position:absolute;top:0;left:0;width:3px;height:100%;border-radius:12px 0 0 12px}
  .kpi-label{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px}
  .kpi-val{font-size:1.4rem;font-weight:900;color:var(--ink);font-family:'Fira Code',monospace;line-height:1}
  .kpi-sub{font-size:.65rem;color:var(--muted);margin-top:4px}

  /* Rate cards */
  .rate-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:16px}
  .rate-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px}
  .rc-label{font-size:.65rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
  .rc-val{font-size:1.4rem;font-weight:900;font-family:'Fira Code',monospace;margin-bottom:8px}
  .rc-bar{height:6px;background:var(--border);border-radius:10px;overflow:hidden}
  .rc-fill{height:100%;border-radius:10px;transition:width 1s}

  /* Charts */
  .chart-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:16px}
  .chart-card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
  @media(max-width:768px){.two-col{grid-template-columns:1fr}}

  .card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:14px}
  .card h3{font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:9px 10px;border-radius:8px;background:var(--surface);margin-bottom:6px;flex-wrap:wrap;gap:6px}
  .li-name{font-size:.78rem;font-weight:700;color:var(--ink)}
  .li-sub{font-size:.65rem;color:var(--muted);margin-top:2px}
  .li-val{font-size:.88rem;font-weight:800;font-family:'Fira Code',monospace;color:var(--green)}
  .scroll-list{max-height:240px;overflow-y:auto}

  /* Comparativa */
  .comp-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;
    margin-bottom:5px;background:var(--surface)}
  .comp-item.current{background:var(--violet-l);border:1px solid rgba(109,40,217,.2)}
  .comp-name{font-size:.78rem;font-weight:700;color:var(--ink);min-width:120px}
  .comp-bar-wrap{flex:1;height:14px;background:var(--border);border-radius:8px;overflow:hidden}
  .comp-bar{height:100%;border-radius:8px;background:var(--violet)}
  .comp-val{font-size:.72rem;font-weight:700;font-family:'Fira Code',monospace;color:var(--ink2);min-width:40px;text-align:right}

  /* Prof ranking */
  .prof-table{width:100%;border-collapse:collapse;font-size:.75rem}
  .prof-table th{background:var(--surface);font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);padding:8px 10px;text-align:left;border-bottom:2px solid var(--border)}
  .prof-table td{padding:9px 10px;border-bottom:1px solid var(--border)}
  .prof-table tr:hover td{background:var(--violet-l)}
  .tasa-bar{height:4px;background:var(--border);border-radius:10px;overflow:hidden;margin-top:3px}
  .tasa-fill{height:100%;border-radius:10px}

  .section-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin:16px 0 12px;display:flex;align-items:center;gap:8px}
  .section-title::after{content:'';flex:1;height:1px;background:var(--border)}

  /* Empty */
  .suc-chips-grid{display:flex;flex-wrap:wrap;gap:8px}
  .suc-chip-link{font-size:.8rem;font-weight:700;padding:8px 14px;border-radius:10px;background:var(--white);
    border:1px solid var(--border);color:var(--ink2);text-decoration:none;transition:all .15s}
  .suc-chip-link:hover{border-color:var(--violet);color:var(--violet);background:var(--violet-l)}
</style>

<div class="max-w-7xl mx-auto px-3 py-4">

  <!-- Header -->
  <div class="rpt-header no-print">
    <a href="{% url 'facturacion:dashboard_reportes' %}" class="back">‚Üê Volver a Reportes</a>
    <h1>üè¢ Reporte por Sucursal</h1>
    <p>Operaciones ¬∑ Ingresos ¬∑ Profesionales ¬∑ Comparativa entre sedes</p>
    <button onclick="window.print()" class="print-btn">üñ®Ô∏è Imprimir / PDF</button>
  </div>

  <!-- Filters -->
  <div class="filter-bar no-print">
    <form method="get">
      <div class="fg">
        <label>Sucursal</label>
        <select name="sucursal">
          <option value="">‚Äî Seleccionar ‚Äî</option>
          {% for s in sucursales %}
          <option value="{{ s.id }}" {% if sucursal and sucursal.id == s.id %}selected{% endif %}>{{ s.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="fg"><label>Desde</label><input type="date" name="fecha_desde" value="{{ fecha_desde }}"></div>
      <div class="fg"><label>Hasta</label><input type="date" name="fecha_hasta" value="{{ fecha_hasta }}"></div>
      <button type="submit" class="btn-primary">üîç Ver reporte</button>
    </form>
  </div>

  {% if not sucursal %}
  <div style="background:var(--white);border:1px solid var(--border);border-radius:16px;padding:30px">
    <p style="font-size:.82rem;font-weight:700;color:var(--ink);margin:0 0 14px">Selecciona una sucursal para comenzar</p>
    <div class="suc-chips-grid">
      {% for s in sucursales %}
      <a href="?sucursal={{ s.id }}&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}" class="suc-chip-link">üè¢ {{ s.nombre }}</a>
      {% endfor %}
    </div>
  </div>

  {% else %}

  <!-- Sucursal Card -->
  <div class="suc-card">
    <div class="suc-avatar">üè¢</div>
    <div class="suc-info">
      <p class="suc-name">{{ sucursal.nombre }}</p>
      <div class="suc-chips">
        <span class="chip {% if sucursal.activa %}green{% endif %}">{% if sucursal.activa %}Activa{% else %}Inactiva{% endif %}</span>
        {% if sucursal.telefono %}<span class="chip">üìû {{ sucursal.telefono }}</span>{% endif %}
      </div>
      <div style="font-size:.72rem;color:rgba(255,255,255,.65)">
        {% if sucursal.direccion %}üìç <b style="color:white">{{ sucursal.direccion }}</b>{% endif %}
        ¬∑ Per√≠odo: <b style="color:white">{{ fecha_desde }} ‚Äî {{ fecha_hasta }}</b>
      </div>
    </div>
    {% if datos %}
    <div class="suc-kpis">
      <div class="sk-item"><div class="sk-label">Sesiones</div><div class="sk-val">{{ datos.stats.total_sesiones|default:0 }}</div></div>
      <div class="sk-item"><div class="sk-label">Ingresos</div><div class="sk-val" style="font-size:.85rem">Bs. {{ datos.stats.ingresos_total|floatformat:0 }}</div></div>
      <div class="sk-item"><div class="sk-label">Profesionales</div><div class="sk-val">{{ datos.stats.profesionales_activos|default:0 }}</div></div>
      <div class="sk-item"><div class="sk-label">Pacientes</div><div class="sk-val">{{ datos.stats.pacientes_activos|default:0 }}</div></div>
    </div>
    {% endif %}
  </div>

  {% if datos %}
  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-box"><div class="accent" style="background:var(--blue)"></div>
      <div class="kpi-label">Total Sesiones</div><div class="kpi-val">{{ datos.stats.total_sesiones|default:0 }}</div><div class="kpi-sub">en el per√≠odo</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--green)"></div>
      <div class="kpi-label">Realizadas</div><div class="kpi-val" style="color:var(--green)">{{ datos.stats.realizadas|default:0 }}</div><div class="kpi-sub">+ {{ datos.stats.retrasos|default:0 }} con retraso</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--red)"></div>
      <div class="kpi-label">Faltas</div><div class="kpi-val" style="color:var(--red)">{{ datos.stats.faltas|default:0 }}</div><div class="kpi-sub">inasistencias</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--violet)"></div>
      <div class="kpi-label">Ingresos Total</div><div class="kpi-val" style="font-size:.9rem">Bs. {{ datos.stats.ingresos_total|floatformat:0 }}</div><div class="kpi-sub">monto generado</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--teal)"></div>
      <div class="kpi-label">Profesionales</div><div class="kpi-val">{{ datos.stats.profesionales_activos|default:0 }}</div><div class="kpi-sub">activos</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--blue)"></div>
      <div class="kpi-label">Pacientes</div><div class="kpi-val">{{ datos.stats.pacientes_activos|default:0 }}</div><div class="kpi-sub">√∫nicos</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--amber)"></div>
      <div class="kpi-label">Horas Cl√≠nicas</div><div class="kpi-val">{{ datos.stats.total_horas_decimal|floatformat:1 }}h</div><div class="kpi-sub">efectivas</div>
    </div>
    <div class="kpi-box"><div class="accent" style="background:var(--green)"></div>
      <div class="kpi-label">Ingreso Promedio</div><div class="kpi-val" style="font-size:.9rem">Bs. {{ datos.stats.ingreso_promedio|floatformat:0 }}</div><div class="kpi-sub">por sesi√≥n</div>
    </div>
  </div>

  <!-- Rate cards -->
  <div class="rate-grid">
    <div class="rate-card">
      <div class="rc-label">Tasa de Ocupaci√≥n</div>
      <div class="rc-val" style="color:{% if datos.stats.tasa_ocupacion >= 85 %}var(--green){% elif datos.stats.tasa_ocupacion >= 60 %}var(--amber){% else %}var(--red){% endif %}">{{ datos.stats.tasa_ocupacion|floatformat:1 }}%</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{{ datos.stats.tasa_ocupacion|floatformat:0 }}%;background:{% if datos.stats.tasa_ocupacion >= 85 %}var(--green){% elif datos.stats.tasa_ocupacion >= 60 %}var(--amber){% else %}var(--red){% endif %}"></div></div>
    </div>
    <div class="rate-card">
      <div class="rc-label">Cancelaciones</div>
      <div class="rc-val" style="color:var(--muted)">{{ datos.stats.canceladas|default:0 }}</div>
      <div class="rc-bar"><div class="rc-fill" style="width:{% widthratio datos.stats.canceladas datos.stats.total_sesiones 100 %}%;background:#94a3b8"></div></div>
    </div>
  </div>

  <!-- Charts -->
  {% if grafico_data %}
  <div class="two-col">
    <div class="chart-card">
      <h3>üìà Evoluci√≥n mensual de sesiones</h3>
      <canvas id="chart-sesiones" height="200"></canvas>
    </div>
    <div class="chart-card">
      <h3>üí∞ Evoluci√≥n de ingresos</h3>
      <canvas id="chart-ingresos" height="200"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- Por servicio + top profesionales -->
  <div class="two-col">
    <div class="card">
      <h3>üéØ Servicios m√°s demandados</h3>
      <div class="scroll-list">
        {% for s in datos.por_servicio %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ s.servicio__nombre }}</div>
            <div class="li-sub">{{ s.realizadas }} realizadas</div>
          </div>
          <div>
            <div class="li-val">{{ s.cantidad }}</div>
            <div style="font-size:.65rem;color:var(--muted);text-align:right">Bs. {{ s.ingresos|floatformat:0 }}</div>
          </div>
        </div>
        {% empty %}<p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>{% endfor %}
      </div>
    </div>
    <div class="card">
      <h3>üë§ Top Pacientes</h3>
      <div class="scroll-list">
        {% for p in datos.top_pacientes %}
        <div class="list-item">
          <div>
            <div class="li-name">{{ p.paciente__nombre }} {{ p.paciente__apellido }}</div>
            <div class="li-sub">{{ p.realizadas }} realizadas</div>
          </div>
          <div class="li-val">{{ p.sesiones }}</div>
        </div>
        {% empty %}<p style="font-size:.75rem;color:var(--muted);text-align:center;padding:20px">Sin datos</p>{% endfor %}
      </div>
    </div>
  </div>

  <!-- Top profesionales table -->
  {% if datos.top_profesionales %}
  <div class="section-title">üë®‚Äç‚öïÔ∏è Profesionales Activos</div>
  <div class="card">
    <div style="overflow-x:auto">
      <table class="prof-table">
        <thead><tr><th>#</th><th>Profesional</th><th>Sesiones</th><th>Realizadas</th><th>Ingresos</th><th>Tasa</th></tr></thead>
        <tbody>
          {% for p in datos.top_profesionales %}
          <tr>
            <td style="color:var(--muted);font-weight:700">{{ forloop.counter }}</td>
            <td style="font-weight:700">{{ p.profesional__nombre }} {{ p.profesional__apellido }}</td>
            <td class="mono">{{ p.sesiones }}</td>
            <td style="color:var(--green);font-weight:700" class="mono">{{ p.realizadas }}</td>
            <td class="mono">Bs. {{ p.ingresos|floatformat:0 }}</td>
            <td>
              {% if p.sesiones > 0 %}
              {% widthratio p.realizadas p.sesiones 100 as tpct %}
              <div style="font-size:.72rem;font-weight:700;color:{% if tpct >= 85 %}var(--green){% elif tpct >= 60 %}var(--amber){% else %}var(--red){% endif %}">{{ tpct }}%</div>
              <div class="tasa-bar"><div class="tasa-fill" style="width:{{ tpct }}%;background:{% if tpct >= 85 %}var(--green){% elif tpct >= 60 %}var(--amber){% else %}var(--red){% endif %}"></div></div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Comparativa con otras sucursales -->
  {% if comparativa %}
  <div class="section-title">üèÜ Comparativa entre Sucursales</div>
  {% with max_ses=comparativa.0.sesiones %}
  <div class="two-col">
    <div class="card">
      <h3>Por Sesiones</h3>
      {% for suc in comparativa %}
      <div class="comp-item {% if suc.es_actual %}current{% endif %}">
        <span class="comp-name">{{ suc.nombre }}</span>
        <div class="comp-bar-wrap">
          <div class="comp-bar" style="width:{% widthratio suc.sesiones max_ses 100 %}%;{% if suc.es_actual %}background:var(--violet){% else %}background:var(--muted){% endif %}"></div>
        </div>
        <span class="comp-val">{{ suc.sesiones }}</span>
      </div>
      {% endfor %}
    </div>
    <div class="card">
      <h3>Por Ingresos</h3>
      {% with max_ing=comparativa.0.ingresos %}
      {% for suc in comparativa %}
      <div class="comp-item {% if suc.es_actual %}current{% endif %}">
        <span class="comp-name">{{ suc.nombre }}</span>
        <div class="comp-bar-wrap">
          <div class="comp-bar" style="width:{% widthratio suc.ingresos max_ing 100 %}%;{% if suc.es_actual %}background:var(--green){% else %}background:var(--muted){% endif %}"></div>
        </div>
        <span class="comp-val" style="font-size:.65rem">{{ suc.ingresos|floatformat:0 }}</span>
      </div>
      {% endfor %}
      {% endwith %}
    </div>
  </div>
  {% endwith %}
  {% endif %}

  {% endif %}{# end if datos #}

  {% endif %}{# end if sucursal #}
</div>

{% if grafico_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const gLabels = {{ grafico_data.labels|safe }};
const gSesiones = {{ grafico_data.sesiones|safe }};
const gRealizadas = {{ grafico_data.realizadas|safe }};
const gIngresos = {{ grafico_data.ingresos|safe }};

const ctx1 = document.getElementById('chart-sesiones');
if(ctx1) new Chart(ctx1, {
  type:'bar',
  data:{labels:gLabels,datasets:[
    {label:'Total',data:gSesiones,backgroundColor:'rgba(109,40,217,.5)',borderColor:'#6d28d9',borderWidth:2,borderRadius:5},
    {label:'Realizadas',data:gRealizadas,backgroundColor:'rgba(22,163,74,.7)',borderColor:'#16a34a',borderWidth:2,borderRadius:5}
  ]},
  options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'top',labels:{font:{size:10}}}},
    scales:{y:{beginAtZero:true,ticks:{font:{size:9}}},x:{ticks:{font:{size:9}}}}}
});

const ctx2 = document.getElementById('chart-ingresos');
if(ctx2) new Chart(ctx2, {
  type:'line',
  data:{labels:gLabels,datasets:[{
    label:'Ingresos Bs.',data:gIngresos,
    backgroundColor:'rgba(109,40,217,.1)',borderColor:'#6d28d9',borderWidth:2,
    fill:true,tension:.4,pointBackgroundColor:'#6d28d9',pointRadius:4
  }]},
  options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'top',labels:{font:{size:10}}}},
    scales:{y:{beginAtZero:true,ticks:{font:{size:9},callback:v=>'Bs.'+v}},x:{ticks:{font:{size:9}}}}}
});
</script>
{% endif %}
{% endblock %}