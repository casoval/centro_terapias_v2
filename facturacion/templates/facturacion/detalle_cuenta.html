{% extends 'base.html' %}
{% load static %}

{% block title %}Cuenta Corriente - {{ paciente.nombre_completo }}{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<style>
    /* Loading spinner para botones */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
    }
    .btn-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spinner 0.6s linear infinite;
    }
    @keyframes spinner {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- Header con Info del Paciente -->
    <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-300 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs">üí∞</span>
                    <p class="text-[10px] text-blue-600 font-bold uppercase tracking-wider">Cuenta Corriente</p>
                </div>
                <h1 class="text-2xl font-black text-gray-900 leading-none mb-2">{{ paciente.nombre_completo }}</h1>
                <div class="flex items-center gap-4 text-gray-600 text-xs">
                    <div class="flex items-center gap-1.5">
                        <span>üë§</span>
                        <span class="font-semibold">{{ paciente.nombre_tutor }}</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span>üì±</span>
                        <span class="font-semibold">{{ paciente.telefono_tutor }}</span>
                    </div>
                </div>
            </div>
            <a href="{% url 'facturacion:cuentas_corrientes' %}" 
               class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm">
                ‚Üê Volver
            </a>
        </div>
        
        <!-- RESUMEN B√ÅSICO (siempre visible, sin queries pesadas) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            
            <div class="bg-white border-2 border-blue-200 rounded-lg p-2 shadow-sm">
                <h2 class="text-[9px] font-bold text-blue-600 uppercase mb-1.5 flex items-center gap-1">
                    <span>üìã</span> Sesiones
                </h2>
                <p class="text-xs text-gray-500">
                    {{ contadores_sesiones.todas }} registradas
                </p>
            </div>

            <div class="bg-white border-2 border-purple-200 rounded-lg p-2 shadow-sm">
                <h2 class="text-[9px] font-bold text-purple-600 uppercase mb-1.5 flex items-center gap-1">
                    <span>üì¶</span> Proyectos
                </h2>
                <p class="text-xs text-gray-500">
                    {{ stats.proyectos_activos }} activos
                </p>
            </div>

            <div class="bg-white border-2 border-indigo-200 rounded-lg p-2 shadow-sm">
                <h2 class="text-[9px] font-bold text-indigo-600 uppercase mb-1.5 flex items-center gap-1">
                    <span>üíµ</span> Pagos
                </h2>
                <p class="text-xs text-gray-500">
                    {{ contadores_validos.todos }} registrados
                </p>
            </div>

            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-2 shadow-sm">
                <h2 class="text-[9px] font-bold text-gray-600 uppercase mb-1.5 flex items-center gap-1">
                    <span>üí∞</span> Cr√©dito Actual
                </h2>
                <p class="text-base font-black {% if cuenta.saldo > 0 %}text-green-700{% elif cuenta.saldo < 0 %}text-red-700{% else %}text-gray-700{% endif %}">
                    Bs. {{ cuenta.saldo|floatformat:2 }}
                </p>
            </div>

        </div>
    </div>

    <!-- PROYECTOS DEL PACIENTE -->
    {% if proyectos_paciente %}
    <div class="bg-white border-2 border-purple-200 rounded-lg overflow-hidden shadow-sm mb-6">
        <div class="bg-purple-600 px-4 py-2 flex items-center justify-between">
            <h2 class="text-sm font-bold text-white flex items-center gap-2">
                <span class="text-lg">üì¶</span>
                Proyectos del Paciente ({{ proyectos_paciente.count }})
            </h2>
            <a href="{% url 'agenda:crear_proyecto' %}?paciente={{ paciente.id }}" 
               class="text-[10px] bg-white text-purple-700 px-2 py-1 rounded font-bold hover:bg-purple-50 transition">
                ‚ûï Nuevo Proyecto
            </a>
        </div>
        
        <div class="p-3">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for proyecto in proyectos_paciente %}
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 hover:shadow-md transition flex flex-col h-full">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-mono text-[10px] text-purple-700 font-bold uppercase">{{ proyecto.codigo }}</p>
                            <h3 class="font-bold text-gray-900 text-sm leading-tight">{{ proyecto.nombre }}</h3>
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap ml-2
                            {% if proyecto.estado == 'planificado' %}bg-yellow-100 text-yellow-700
                            {% elif proyecto.estado == 'en_progreso' %}bg-green-100 text-green-700
                            {% elif proyecto.estado == 'finalizado' %}bg-purple-100 text-purple-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ proyecto.get_estado_display }}
                        </span>
                    </div>
                    
                    <div class="space-y-1.5 mb-3">
                        <div class="flex justify-between text-[11px]">
                            <span class="text-gray-500 font-medium">Tipo:</span>
                            <span class="font-bold text-gray-800">{{ proyecto.get_tipo_display }}</span>
                        </div>
                        <div class="flex justify-between text-[11px]">
                            <span class="text-gray-500 font-medium">Servicio:</span>
                            <span class="font-bold text-gray-800">{{ proyecto.servicio_base.nombre }}</span>
                        </div>
                    </div>

                    <div class="bg-white/60 rounded-md p-2 mb-3 border border-purple-100">
                        <div class="grid grid-cols-3 gap-1 text-center mb-2">
                            <div>
                                <p class="text-[8px] text-gray-500 uppercase font-bold">Costo</p>
                                <p class="text-xs font-black text-blue-700">{{ proyecto.costo_total }}</p>
                            </div>
                            <div>
                                <p class="text-[8px] text-gray-500 uppercase font-bold">Pagado</p>
                                <p class="text-xs font-black text-green-700">{{ proyecto.total_pagado }}</p>
                            </div>
                            <div>
                                <p class="text-[8px] text-gray-500 uppercase font-bold">Saldo</p>
                                <p class="text-xs font-black text-red-700">{{ proyecto.saldo_pendiente }}</p>
                            </div>
                        </div>
                        
                        <div class="px-1">
                            {% widthratio proyecto.total_pagado proyecto.costo_total 100 as porcentaje %}
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div class="h-1.5 rounded-full {% if porcentaje >= 100 %}bg-green-500{% elif porcentaje >= 50 %}bg-yellow-500{% else %}bg-red-500{% endif %}" 
                                     style="width: {{ porcentaje }}%"></div>
                            </div>
                            <p class="text-[9px] text-gray-500 text-center mt-1 font-bold">{{ porcentaje }}% pagado</p>
                        </div>
                    </div>
                    
                    <div class="mt-auto flex gap-2">
                        <a href="{% url 'agenda:detalle_proyecto' proyecto.id %}" 
                           class="flex-1 bg-white border border-purple-400 text-purple-700 py-1.5 rounded text-[10px] font-bold text-center hover:bg-purple-100 transition">
                            üìã Detalle
                        </a>
                        {% if proyecto.saldo_pendiente > 0 %}
                        <a href="{% url 'facturacion:registrar_pago' %}?proyecto={{ proyecto.id }}" 
                           class="flex-1 bg-green-600 text-white py-1.5 rounded text-[10px] font-bold text-center hover:bg-green-700 transition shadow-sm">
                            üíµ Pagar
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 4 Tabs -->
    <div class="mb-4">
        <div class="border-b-2 border-gray-200">
            <nav class="flex gap-1">
                <button onclick="mostrarTab('sesiones')" 
                        id="tab-sesiones"
                        class="tab-btn px-4 py-2.5 font-bold text-sm border-b-4 rounded-t-lg transition-all
                               border-blue-600 text-blue-600 bg-blue-50">
                    <span>üìã</span> Sesiones ({{ sesiones.paginator.count }})
                </button>
                <button onclick="mostrarTab('pagos-validos')" 
                        id="tab-pagos-validos"
                        class="tab-btn px-4 py-2.5 font-bold text-sm border-b-4 rounded-t-lg transition-all
                               border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                    <span>üí∞</span> Pagos al Contado ({{ pagos_validos.paginator.count }})
                </button>
                <button onclick="mostrarTab('pagos-credito')" 
                        id="tab-pagos-credito"
                        class="tab-btn px-4 py-2.5 font-bold text-sm border-b-4 rounded-t-lg transition-all
                               border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                    <span>üè¶</span> Pagos con Cr√©dito ({{ pagos_credito.paginator.count }})
                </button>
                <button onclick="mostrarTab('pagos-anulados')" 
                        id="tab-pagos-anulados"
                        class="tab-btn px-4 py-2.5 font-bold text-sm border-b-4 rounded-t-lg transition-all
                               border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                    <span>üö´</span> Pagos Anulados ({{ pagos_anulados.paginator.count }})
                </button>
            </nav>
        </div>
    </div>

    <!-- ‚úÖ Tab: Sesiones - CON LAZY LOADING -->
    <div id="content-sesiones" class="tab-content">
        
        <!-- Filtro de Sesiones -->
        <div class="mb-4 flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-200">
            <label class="text-sm font-bold text-gray-700">Filtrar por:</label>
            <select id="filtro-sesiones" 
                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
                    onchange="aplicarFiltroSesiones(this.value)">
                <option value="todas" {% if filtro_sesiones == 'todas' %}selected{% endif %}>
                    ‚úÖ Todas ({{ contadores_sesiones.todas }})
                </option>
                <option value="contado" {% if filtro_sesiones == 'contado' %}selected{% endif %}>
                    üíµ Pagado al contado ({{ contadores_sesiones.contado }})
                </option>
                <option value="credito" {% if filtro_sesiones == 'credito' %}selected{% endif %}>
                    üè¶ Pagado con cr√©dito ({{ contadores_sesiones.credito }})
                </option>
                <option value="pendiente" {% if filtro_sesiones == 'pendiente' %}selected{% endif %}>
                    ‚è≥ Pendiente ({{ contadores_sesiones.pendiente }})
                </option>
            </select>
        </div>

        <!-- ‚úÖ TARJETA DE TOTALES - LAZY LOADING -->
        {% if totales_sesiones %}
            <!-- Ya calculado - Mostrar datos -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-300 rounded-lg p-2.5 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-[10px] font-bold text-blue-800 uppercase flex items-center gap-1.5">
                        <span class="text-sm">üìä</span>
                        Resumen de Pagos - Sesiones
                    </h3>
                    <button onclick="ocultarTotalesSesiones()" 
                            class="text-[10px] bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded font-bold transition">
                        üóô Ocultar
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <!-- Pagado CON DESGLOSE -->
                    <div class="bg-white/70 rounded-lg p-2 border border-green-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">‚úÖ Pagado</p>
                        <p class="text-base font-black text-green-700 mb-1">
                            Bs. {{ totales_sesiones.pagado|floatformat:2 }}
                        </p>
                        <div class="pt-1 border-t border-green-100 space-y-0.5">
                            <div class="flex justify-between items-center">
                                <span class="text-[8px] text-gray-500 font-medium">üíµ Al contado:</span>
                                <span class="text-[9px] font-bold text-blue-600">
                                    Bs. {{ totales_sesiones.pagado_contado|floatformat:2 }}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[8px] text-gray-500 font-medium">üè¶ Con cr√©dito:</span>
                                <span class="text-[9px] font-bold text-purple-600">
                                    Bs. {{ totales_sesiones.pagado_credito|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pendiente -->
                    <div class="bg-white/70 rounded-lg p-2 border border-red-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">‚è≥ Pendiente</p>
                        <p class="text-base font-black text-red-700">
                            Bs. {{ totales_sesiones.pendiente|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- TOTAL GENERAL -->
                    <div class="bg-blue-600 rounded-lg p-2 border-2 border-blue-800 shadow-md">
                        <p class="text-[9px] text-blue-100 font-bold uppercase mb-0.5">üí∞ TOTAL GENERAL</p>
                        <p class="text-base font-black text-white">
                            Bs. {{ totales_sesiones.general|floatformat:2 }}
                        </p>
                        <p class="text-[8px] text-blue-200 mt-0.5 italic">
                            = Pagado + Pendiente
                        </p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No calculado a√∫n - Mostrar bot√≥n -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4 text-center">
                <p class="text-sm text-gray-600 mb-3">
                    üìä Las estad√≠sticas detalladas de sesiones no est√°n cargadas
                </p>
                <button onclick="cargarTotalesSesiones(this)" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition shadow-md">
                    üîÑ Calcular Totales de Sesiones
                </button>
                <p class="text-[10px] text-gray-500 mt-2">
                    ‚ö° Esto puede tardar unos segundos seg√∫n la cantidad de sesiones
                </p>
            </div>
        {% endif %}
            
        <div class="bg-white border rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-[10px]">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Fecha</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Servicio</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Tipo</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Profesional</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Sucursal</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Estado</th>
                            <th class="px-2 py-1.5 text-right text-[10px] font-bold text-gray-700">Costo</th>
                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-700">Estado de Pago</th>
                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for sesion in sesiones %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 py-1.5">
                                <p class="font-medium">{{ sesion.fecha|date:"d/m/Y" }}</p>
                                <p class="text-[9px] text-gray-500">{{ sesion.hora_inicio|time:"H:i" }}</p>
                            </td>
                            <td class="px-2 py-1.5">
                                <div class="flex items-center gap-2">
                                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: {{ sesion.servicio.color }}"></span>
                                    <span class="font-medium">{{ sesion.servicio.nombre }}</span>
                                </div>
                            </td>
                            <td class="px-2 py-1.5">
                                {% if sesion.proyecto %}
                                    <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold">
                                        üì¶ Proyecto
                                    </span>
                                    <p class="text-xs text-purple-600 mt-0.5">{{ sesion.proyecto.codigo }}</p>
                                {% else %}
                                    <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-bold">
                                        üìã Normal
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-1.5 text-gray-700">
                                {{ sesion.profesional.nombre }} {{ sesion.profesional.apellido }}
                            </td>
                            <td class="px-2 py-1.5">
                                <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 font-medium">
                                    üìç {{ sesion.sucursal.nombre }}
                                </span>
                            </td>
                            <td class="px-2 py-1.5">
                                <span class="text-xs px-2 py-1 rounded font-bold
                                    {% if sesion.estado == 'realizada' %}bg-green-100 text-green-700
                                    {% elif sesion.estado == 'realizada_retraso' %}bg-yellow-100 text-yellow-700
                                    {% elif sesion.estado == 'programada' %}bg-blue-100 text-blue-700
                                    {% elif sesion.estado == 'falta' %}bg-red-100 text-red-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ sesion.get_estado_display }}
                                </span>
                            </td>
                            <td class="px-2 py-1.5 text-right">
                                <p class="font-bold text-gray-900">Bs. {{ sesion.monto_cobrado|floatformat:2 }}</p>
                            </td>
                            
                            <!-- ‚úÖ COLUMNA MEJORADA: ESTADO DE PAGO CON DESGLOSE CONTADO/CR√âDITO -->
                            <td class="px-2 py-1.5">
                                {% if sesion.monto_cobrado == 0 %}
                                    <!-- Sesi√≥n sin costo -->
                                    <div class="text-center">
                                        <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-500 font-medium">
                                            Sin Costo
                                        </span>
                                    </div>
                                {% else %}
                                    {% with total_pagado=sesion.total_pagado saldo=sesion.saldo_pendiente num_pagos=sesion.pagos.count pagos_contado=sesion.total_pagado_contado pagos_credito=sesion.total_pagado_credito %}
                                        
                                        {% if saldo == 0 %}
                                            <!-- ‚úÖ PAGADO COMPLETO -->
                                            <div class="text-center">
                                                <div class="flex items-center justify-center gap-1 mb-0.5">
                                                    <span class="text-xs px-2 py-0.5 rounded bg-green-50 text-green-700 font-medium border border-green-200">
                                                        ‚úì Pagado
                                                    </span>
                                                    {% if num_pagos > 1 %}
                                                        <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-blue-100 text-blue-700 font-bold border border-blue-200">
                                                            {{ num_pagos }}√ó
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <p class="text-[10px] font-bold text-gray-900 mb-1">
                                                    Bs. {{ total_pagado|floatformat:2 }}
                                                </p>
                                                
                                                <!-- ‚úÖ DESGLOSE VERTICAL -->
                                                {% if pagos_contado > 0 or pagos_credito > 0 %}
                                                <div class="pt-1 border-t border-green-100 space-y-0.5">
                                                    {% if pagos_contado > 0 %}
                                                    <div class="flex justify-between items-center text-[9px] gap-2">
                                                        <span class="text-gray-500">üíµ Contado:</span>
                                                        <span class="font-bold text-blue-600">{{ pagos_contado|floatformat:2 }}</span>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if pagos_credito > 0 %}
                                                    <div class="flex justify-between items-center text-[9px] gap-2">
                                                        <span class="text-gray-500">üè¶ Cr√©dito:</span>
                                                        <span class="font-bold text-purple-600">{{ pagos_credito|floatformat:2 }}</span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                        {% elif saldo > 0 %}
                                            <!-- ‚ö†Ô∏è PAGO PARCIAL O PENDIENTE -->
                                            <div class="text-center">
                                                {% if total_pagado > 0 %}
                                                    <div class="flex items-center justify-center gap-1 mb-0.5">
                                                        <span class="text-xs px-2 py-0.5 rounded bg-yellow-50 text-yellow-700 font-medium border border-yellow-200">
                                                            Parcial
                                                        </span>
                                                        {% if num_pagos > 1 %}
                                                            <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-orange-100 text-orange-700 font-bold border border-orange-200">
                                                                {{ num_pagos }}√ó
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="text-[10px] space-y-0.5 mb-1">
                                                        <p class="text-green-600 font-bold">
                                                            ‚úì {{ total_pagado|floatformat:2 }}
                                                        </p>
                                                        <p class="text-red-600 font-medium">
                                                            Debe {{ saldo|floatformat:2 }}
                                                        </p>
                                                    </div>
                                                    
                                                    <!-- ‚úÖ DESGLOSE VERTICAL -->
                                                    {% if pagos_contado > 0 or pagos_credito > 0 %}
                                                    <div class="pt-1 border-t border-yellow-100 space-y-0.5">
                                                        {% if pagos_contado > 0 %}
                                                        <div class="flex justify-between items-center text-[9px] gap-2">
                                                            <span class="text-gray-500">üíµ Contado:</span>
                                                            <span class="font-bold text-blue-600">{{ pagos_contado|floatformat:2 }}</span>
                                                        </div>
                                                        {% endif %}
                                                        
                                                        {% if pagos_credito > 0 %}
                                                        <div class="flex justify-between items-center text-[9px] gap-2">
                                                            <span class="text-gray-500">üè¶ Cr√©dito:</span>
                                                            <span class="font-bold text-purple-600">{{ pagos_credito|floatformat:2 }}</span>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <!-- Mini barra de progreso -->
                                                    {% widthratio total_pagado sesion.monto_cobrado 100 as porcentaje %}
                                                    <div class="mt-1 w-full bg-gray-200 rounded-full h-1 overflow-hidden">
                                                        <div class="h-1 rounded-full bg-gradient-to-r from-yellow-400 to-yellow-500" 
                                                            style="width: {{ porcentaje }}%"></div>
                                                    </div>
                                                {% else %}
                                                    <span class="text-xs px-2 py-0.5 rounded bg-red-50 text-red-700 font-medium border border-red-200 block mb-0.5">
                                                        Pendiente
                                                    </span>
                                                    <p class="text-[10px] text-red-600 font-medium">
                                                        {{ saldo|floatformat:2 }}
                                                    </p>
                                                {% endif %}
                                            </div>
                                            
                                        {% elif saldo < 0 %}
                                            <!-- üí∞ SOBREPAGO -->
                                            <div class="text-center">
                                                <div class="flex items-center justify-center gap-1 mb-0.5">
                                                    <span class="text-xs px-2 py-0.5 rounded bg-blue-50 text-blue-700 font-medium border border-blue-200">
                                                        Sobrepago
                                                    </span>
                                                    {% if num_pagos > 1 %}
                                                        <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-purple-100 text-purple-700 font-bold border border-purple-200">
                                                            {{ num_pagos }}√ó
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="text-[10px] space-y-0.5 mb-1">
                                                    <p class="text-gray-600">
                                                        Costo {{ sesion.monto_cobrado|floatformat:2 }}
                                                    </p>
                                                    <p class="text-blue-600 font-medium">
                                                        +{{ saldo|floatformat:2|slice:"1:" }} cr√©dito
                                                    </p>
                                                </div>
                                                
                                                <!-- ‚úÖ DESGLOSE VERTICAL -->
                                                {% if pagos_contado > 0 or pagos_credito > 0 %}
                                                <div class="pt-1 border-t border-blue-100 space-y-0.5">
                                                    {% if pagos_contado > 0 %}
                                                    <div class="flex justify-between items-center text-[9px] gap-2">
                                                        <span class="text-gray-500">üíµ Contado:</span>
                                                        <span class="font-bold text-blue-600">{{ pagos_contado|floatformat:2 }}</span>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if pagos_credito > 0 %}
                                                    <div class="flex justify-between items-center text-[9px] gap-2">
                                                        <span class="text-gray-500">üè¶ Cr√©dito:</span>
                                                        <span class="font-bold text-purple-600">{{ pagos_credito|floatformat:2 }}</span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </td>
                            
                            <td class="px-3 py-2 text-center">
                                <div class="flex gap-1 justify-center">
                                    {% if not sesion.pagado and sesion.requiere_pago %}
                                    <a href="{% url 'facturacion:registrar_pago' %}?sesion={{ sesion.id }}" 
                                    class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                    title="Registrar pago">
                                        üíµ
                                    </a>
                                    {% endif %}
                                    <button hx-get="{% url 'facturacion:api_detalle_sesion' sesion.id %}"
                                            hx-target="#modal-content"
                                            hx-swap="innerHTML"
                                            onclick="abrirModal()"
                                            class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
                                            title="Ver detalle">
                                        üëÅÔ∏è
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="px-3 py-8 text-center text-gray-500">
                                No hay sesiones registradas
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Paginaci√≥n sesiones -->
        {% if sesiones.has_other_pages %}
        <div class="mt-4 flex justify-center">
            <nav class="flex gap-2 text-xs">
                {% if sesiones.has_previous %}
                    <a href="?page_sesiones={{ sesiones.previous_page_number }}" 
                    class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ‚Üê Anterior
                    </a>
                {% endif %}
                
                <span class="px-4 py-2 bg-gray-100 border rounded font-medium">
                    P√°gina {{ sesiones.number }} de {{ sesiones.paginator.num_pages }}
                </span>
                
                {% if sesiones.has_next %}
                    <a href="?page_sesiones={{ sesiones.next_page_number }}" 
                    class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Siguiente ‚Üí
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    
        <!-- ‚úÖ LEYENDA DISCRETA DE ESTADOS -->
        <div class="mt-3 bg-gray-50 border border-gray-200 rounded-lg p-3">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-xs font-semibold text-gray-600 flex items-center gap-1.5">
                    <span class="text-sm">‚ÑπÔ∏è</span>
                    Gu√≠a de Indicadores
                </h3>
                <button onclick="toggleLeyenda()" class="text-[10px] text-blue-600 hover:text-blue-800 font-medium">
                    Ver/Ocultar
                </button>
            </div>
            
            <div id="leyenda-content" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 text-[10px]">
                <div class="flex items-center gap-1.5">
                    <span class="px-2 py-0.5 rounded bg-green-50 text-green-700 font-medium border border-green-200">‚úì Pagado</span>
                </div>
                
                <div class="flex items-center gap-1.5">
                    <span class="px-2 py-0.5 rounded bg-yellow-50 text-yellow-700 font-medium border border-yellow-200">Parcial</span>
                </div>
                
                <div class="flex items-center gap-1.5">
                    <span class="px-2 py-0.5 rounded bg-red-50 text-red-700 font-medium border border-red-200">Pendiente</span>
                </div>
                
                <div class="flex items-center gap-1.5">
                    <span class="px-2 py-0.5 rounded bg-blue-50 text-blue-700 font-medium border border-blue-200">Sobrepago</span>
                </div>
                
                <div class="flex items-center gap-1.5">
                    <span class="px-1.5 py-0.5 rounded-full bg-blue-100 text-blue-700 font-bold border border-blue-200 text-[9px]">3√ó</span>
                    <span class="text-gray-600">= m√∫ltiples pagos</span>
                </div>
            </div>
            
            <p class="text-[10px] text-gray-500 mt-2 pt-2 border-t border-gray-200">
                <strong>Nota:</strong> El n√∫mero con "√ó" indica cu√°ntos pagos se realizaron para esa sesi√≥n.
            </p>
        </div>

        <script>
        function toggleLeyenda() {
            const content = document.getElementById('leyenda-content');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        }
        </script>
    </div>
    
    <!-- ‚úÖ Tab: Pagos V√°lidos - CON AGRUPACI√ìN DE MASIVOS -->
    <div id="content-pagos-validos" class="tab-content hidden">
        
        <!-- ‚úÖ MEN√ö DESPLEGABLE FILTRO PAGOS V√ÅLIDOS -->
        <div class="mb-4 flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-200">
            <label class="text-sm font-bold text-gray-700">Filtrar por:</label>
            <select id="filtro-validos" 
                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 font-medium"
                    onchange="aplicarFiltroValidos(this.value)">
                <option value="todos" {% if filtro_validos == 'todos' %}selected{% endif %}>
                    ‚úÖ Todos ({{ contadores_validos.todos }})
                </option>
                <option value="sesiones" {% if filtro_validos == 'sesiones' %}selected{% endif %}>
                    üìã Sesiones ({{ contadores_validos.sesiones }})
                </option>
                <option value="proyectos" {% if filtro_validos == 'proyectos' %}selected{% endif %}>
                    üì¶ Proyectos ({{ contadores_validos.proyectos }})
                </option>
                <option value="adelantos" {% if filtro_validos == 'adelantos' %}selected{% endif %}>
                    üí∞ Adelantos ({{ contadores_validos.adelantos }})
                </option>
            </select>
        </div>

        <!-- ‚úÖ TARJETA DE TOTALES - PAGOS V√ÅLIDOS (CON LAZY LOADING) -->
        {% if totales_validos %}
            <!-- Ya calculado - Mostrar datos -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg p-2.5 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-[10px] font-bold text-green-800 uppercase flex items-center gap-1.5">
                        <span class="text-sm">üìä</span>
                        Resumen de Pagos V√°lidos
                    </h3>
                    <button onclick="ocultarTotalesValidos()" 
                            class="text-[10px] bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded font-bold transition">
                        üóô Ocultar
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                    <!-- Sesiones Normales -->
                    <div class="bg-white/70 rounded-lg p-2 border border-blue-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üìã Sesiones</p>
                        <p class="text-sm font-black text-blue-700">
                            Bs. {{ totales_validos.sesiones|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- Proyectos -->
                    <div class="bg-white/70 rounded-lg p-2 border border-purple-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üì¶ Proyectos</p>
                        <p class="text-sm font-black text-purple-700">
                            Bs. {{ totales_validos.proyectos|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- Adelantos -->
                    <div class="bg-white/70 rounded-lg p-2 border border-yellow-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üí≥ Adelantos</p>
                        <p class="text-sm font-black text-yellow-700">
                            Bs. {{ totales_validos.adelantos|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- TOTAL GENERAL -->
                    <div class="bg-green-600 rounded-lg p-2 border-2 border-green-800 shadow-md">
                        <p class="text-[9px] text-green-100 font-bold uppercase mb-0.5">üí∞ TOTAL</p>
                        <p class="text-sm font-black text-white">
                            Bs. {{ totales_validos.general|floatformat:2 }}
                        </p>
                        <p class="text-[7px] text-green-200 mt-0.5 italic">
                            = Œ£ Tipos
                        </p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No calculado a√∫n - Mostrar bot√≥n -->
            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-4 text-center">
                <p class="text-sm text-gray-600 mb-3">
                    üìä Las estad√≠sticas de pagos v√°lidos no est√°n cargadas
                </p>
                <button onclick="cargarTotalesValidos(this)" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold transition shadow-md">
                    üîÑ Calcular Totales de Pagos V√°lidos
                </button>
                <p class="text-[10px] text-gray-500 mt-2">
                    ‚ö° Esto puede tardar unos segundos
                </p>
            </div>
        {% endif %}

        <div class="bg-white border rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-[10px]">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Recibo</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Fecha</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Concepto</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Tipo</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">M√©todo</th>
                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-700">Estado Sesi√≥n</th>
                            <th class="px-2 py-1.5 text-right text-[10px] font-bold text-gray-700">Monto</th>
                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% regroup pagos_validos by numero_recibo as pagos_agrupados %}
                        
                        {% for grupo in pagos_agrupados %}
                            {% with primer_pago=grupo.list.0 total_items=grupo.list|length %}
                            
                            {% if total_items > 1 %}
                                <!-- ‚úÖ PAGO MASIVO - FILA AGRUPADA -->
                                <tr class="hover:bg-gray-50 bg-blue-50">
                                    <td class="px-2 py-1.5">
                                        <div class="flex items-center gap-2">
                                            <button onclick="toggleDetallePago('{{ grupo.grouper }}')" 
                                                    class="text-blue-600 hover:text-blue-800 font-bold">
                                                <span id="icon-{{ grupo.grouper }}" class="text-sm">‚ñ∂</span>
                                            </button>
                                            <div>
                                                <p class="font-mono text-xs font-bold text-blue-900">{{ grupo.grouper }}</p>
                                                <span class="inline-block text-[10px] px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 font-bold border border-orange-200">
                                                    üìÅ {{ total_items }} √≠tems
                                                </span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-2 py-1.5">
                                        <p class="font-medium">{{ primer_pago.fecha_pago|date:"d/m/Y" }}</p>
                                        <p class="text-xs text-gray-500">{{ primer_pago.fecha_registro|date:"H:i" }}</p>
                                    </td>
                                    <td class="px-2 py-1.5 text-gray-700">
                                        <p class="font-medium text-blue-900">Pago Masivo</p>
                                        <p class="text-[10px] text-gray-600">
                                            {% with sesiones=grupo.list|length %}
                                                {{ sesiones }} transaccion{{ sesiones|pluralize:"es" }}
                                            {% endwith %}
                                        </p>
                                    </td>
                                    <td class="px-2 py-1.5">
                                        <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold border border-purple-200">
                                            üìÅ M√∫ltiple
                                        </span>
                                    </td>
                                    <td class="px-2 py-1.5">
                                        <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-medium">
                                            {{ primer_pago.metodo_pago.nombre }}
                                        </span>
                                    </td>
                                    <td class="px-2 py-1.5 text-center">
                                        <span class="text-xs text-gray-400">-</span>
                                    </td>
                                    <td class="px-2 py-1.5 text-right">
                                        <p class="font-black text-green-700 text-base">
                                            Bs. <span id="total-fila-{{ grupo.grouper }}">0.00</span>
                                        </p>
                                        <p class="text-[10px] text-gray-500">
                                            Total del recibo
                                        </p>
                                    </td>
                                    <td class="px-2 py-1.5 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button hx-get="{% url 'facturacion:api_detalle_pago' primer_pago.id %}"
                                                    hx-target="#modal-content"
                                                    hx-swap="innerHTML"
                                                    onclick="abrirModal()"
                                                    class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
                                                    title="Ver detalle">
                                                üëÅÔ∏è
                                            </button>
                                            
                                            <a href="{% url 'facturacion:generar_recibo_pdf' primer_pago.id %}" 
                                            class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                            title="Imprimir recibo"
                                            target="_blank">
                                                üñ®Ô∏è
                                            </a>
                                            
                                            <button onclick="confirmarAnulacion({{ primer_pago.id }}, '{{ grupo.grouper }}')"
                                                    class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700"
                                                    title="Anular pago">
                                                ‚úó
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- ‚úÖ DETALLES DESPLEGABLES DEL PAGO MASIVO -->
                                <tr id="detalle-{{ grupo.grouper }}" class="hidden bg-blue-50">
                                    <td colspan="8" class="px-3 py-0">
                                        <div class="bg-white border-2 border-blue-200 rounded-lg m-2 overflow-hidden">
                                            <div class="bg-blue-100 px-2 py-1.5 border-b border-blue-200">
                                                <p class="text-xs font-bold text-blue-900">
                                                    üìã Detalle de {{ total_items }} transacciones del recibo {{ grupo.grouper }}
                                                </p>
                                            </div>
                                            
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full text-xs">
                                                    <thead class="bg-gray-50 border-b">
                                                        <tr>
                                                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-600">#</th>
                                                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-600">Concepto</th>
                                                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-600">Tipo</th>
                                                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-600">Estado</th>
                                                            <th class="px-2 py-1.5 text-right text-[10px] font-bold text-gray-600">Monto</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="divide-y divide-gray-100">
                                                        {% for pago in grupo.list %}
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="px-2 py-1.5">
                                                                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 font-bold text-[10px]">
                                                                    {{ forloop.counter }}
                                                                </span>
                                                            </td>
                                                            <td class="px-2 py-1.5">
                                                                {% if pago.sesion %}
                                                                    <p class="font-medium text-gray-900">{{ pago.sesion.servicio.nombre }}</p>
                                                                    <p class="text-[10px] text-gray-500">
                                                                        {{ pago.sesion.fecha|date:"d/m/Y" }} - {{ pago.sesion.hora_inicio|time:"H:i" }}
                                                                    </p>
                                                                {% elif pago.proyecto %}
                                                                    <p class="font-medium text-purple-900">{{ pago.proyecto.nombre }}</p>
                                                                    <p class="text-[10px] text-purple-600">{{ pago.proyecto.codigo }}</p>
                                                                {% else %}
                                                                    <p class="font-medium text-blue-900">Pago Adelantado</p>
                                                                {% endif %}
                                                            </td>
                                                            <td class="px-2 py-1.5">
                                                                {% if pago.proyecto %}
                                                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 font-bold">
                                                                        üì¶ Proyecto
                                                                    </span>
                                                                {% elif pago.sesion %}
                                                                    {% if pago.sesion.proyecto %}
                                                                        <span class="text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 font-bold">
                                                                            üì¶ Proyecto
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-bold">
                                                                            üìã Sesi√≥n
                                                                        </span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold">
                                                                        üí≥ Adelanto
                                                                    </span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="px-2 py-1.5 text-center">
                                                                {% if pago.sesion %}
                                                                    <span class="text-[10px] px-1.5 py-0.5 rounded font-bold
                                                                        {% if pago.sesion.estado == 'realizada' %}bg-green-100 text-green-700
                                                                        {% elif pago.sesion.estado == 'realizada_retraso' %}bg-yellow-100 text-yellow-700
                                                                        {% elif pago.sesion.estado == 'programada' %}bg-blue-100 text-blue-700
                                                                        {% elif pago.sesion.estado == 'falta' %}bg-red-100 text-red-700
                                                                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                                                                        {{ pago.sesion.get_estado_display }}
                                                                    </span>
                                                                {% else %}
                                                                    <span class="text-xs text-gray-400">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="px-2 py-1.5 text-right font-bold text-gray-900">
                                                                Bs. {{ pago.monto|floatformat:2 }}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                    <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                                                        <tr>
                                                            <td colspan="4" class="px-2 py-1.5 text-right">
                                                                <span class="text-xs font-bold text-gray-700">Subtotal {{ total_items }} √≠tems:</span>
                                                            </td>
                                                            <td class="px-2 py-1.5 text-right">
                                                                <span class="text-sm font-black text-green-700">
                                                                    Bs. <span id="total-{{ grupo.grouper }}">0.00</span>
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                            
                                            {% if primer_pago.observaciones %}
                                            <div class="bg-yellow-50 border-t border-yellow-200 px-2 py-1.5">
                                                <p class="text-[10px] font-bold text-yellow-800 mb-1">üìù Observaciones:</p>
                                                <p class="text-xs text-gray-700">{{ primer_pago.observaciones }}</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                
                                <script>
                                    // Calcular total para recibo {{ grupo.grouper }}
                                    (function() {
                                        let total = 0;
                                        {% for pago in grupo.list %}
                                            total += parseFloat({{ pago.monto }});
                                        {% endfor %}
                                        
                                        const elem = document.getElementById('total-{{ grupo.grouper }}');
                                        if (elem) {
                                            elem.textContent = total.toFixed(2);
                                        }
                                        
                                        // ‚úÖ AGREGAR ESTA L√çNEA:
                                        const filaElem = document.getElementById('total-fila-{{ grupo.grouper }}');
                                        if (filaElem) {
                                            filaElem.textContent = total.toFixed(2);
                                        }
                                    })();
                                </script>
                            
                            {% else %}
                                <!-- ‚úÖ PAGO INDIVIDUAL - FILA NORMAL -->
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1.5 font-mono text-xs font-bold">
                                        {{ primer_pago.numero_recibo }}
                                    </td>
                                    <td class="px-2 py-1.5">
                                        <p class="font-medium">{{ primer_pago.fecha_pago|date:"d/m/Y" }}</p>
                                        <p class="text-xs text-gray-500">{{ primer_pago.fecha_registro|date:"H:i" }}</p>
                                    </td>
                                    <td class="px-2 py-1.5 text-gray-700">
                                        {{ primer_pago.concepto|truncatewords:8 }}
                                        {% if primer_pago.sesion %}
                                            <br><span class="text-xs text-gray-500">üéØ {{ primer_pago.sesion.servicio.nombre }}</span>
                                        {% elif primer_pago.proyecto %}
                                            <br><span class="text-xs text-purple-600">üì¶ {{ primer_pago.proyecto.codigo }}</span>
                                        {% else %}
                                            <br><span class="text-xs text-blue-600">üí∞ Pago adelantado</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-2 py-1.5">
                                        {% if primer_pago.proyecto %}
                                            <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold">
                                                üì¶ Proyecto
                                            </span>
                                        {% elif primer_pago.sesion %}
                                            {% if primer_pago.sesion.proyecto %}
                                                <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold">
                                                    üì¶ Proyecto
                                                </span>
                                            {% else %}
                                                <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-bold">
                                                    üìã Normal
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-xs px-2 py-1 rounded bg-green-100 text-green-700 font-bold">
                                                üí≥ Adelanto
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-3 py-2">
                                        <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-medium">
                                            {{ primer_pago.metodo_pago.nombre }}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        {% if primer_pago.sesion %}
                                            <span class="text-xs px-2 py-1 rounded font-bold
                                                {% if primer_pago.sesion.estado == 'realizada' %}bg-green-100 text-green-700
                                                {% elif primer_pago.sesion.estado == 'realizada_retraso' %}bg-yellow-100 text-yellow-700
                                                {% elif primer_pago.sesion.estado == 'programada' %}bg-blue-100 text-blue-700
                                                {% elif primer_pago.sesion.estado == 'falta' %}bg-red-100 text-red-700
                                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                                {{ primer_pago.sesion.get_estado_display }}
                                            </span>
                                        {% else %}
                                            <span class="text-xs text-gray-400">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-3 py-2 text-right font-bold text-green-700">
                                        Bs. {{ primer_pago.monto|floatformat:2 }}
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button hx-get="{% url 'facturacion:api_detalle_pago' primer_pago.id %}"
                                                    hx-target="#modal-content"
                                                    hx-swap="innerHTML"
                                                    onclick="abrirModal()"
                                                    class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
                                                    title="Ver detalle">
                                                üëÅÔ∏è
                                            </button>
                                            
                                            <a href="{% url 'facturacion:generar_recibo_pdf' primer_pago.id %}" 
                                            class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                            title="Imprimir recibo"
                                            target="_blank">
                                                üñ®Ô∏è
                                            </a>
                                            
                                            <button onclick="confirmarAnulacion({{ primer_pago.id }}, '{{ primer_pago.numero_recibo }}')"
                                                    class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700"
                                                    title="Anular pago">
                                                ‚úó
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                            
                            {% endwith %}
                        {% endfor %}
                        
                        {% if not pagos_agrupados %}
                        <tr>
                            <td colspan="8" class="px-3 py-8 text-center text-gray-500">
                                No hay pagos v√°lidos registrados
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Paginaci√≥n -->
        {% if pagos_validos.has_other_pages %}
        <div class="mt-4 flex justify-center">
            <nav class="flex gap-2 text-xs">
                {% if pagos_validos.has_previous %}
                    <a href="?page_validos={{ pagos_validos.previous_page_number }}" 
                    onclick="mostrarTab('pagos-validos')"
                    class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ‚Üê Anterior
                    </a>
                {% endif %}
                
                <span class="px-4 py-2 bg-gray-100 border rounded font-medium">
                    P√°gina {{ pagos_validos.number }} de {{ pagos_validos.paginator.num_pages }}
                </span>
                
                {% if pagos_validos.has_next %}
                    <a href="?page_validos={{ pagos_validos.next_page_number }}" 
                    onclick="mostrarTab('pagos-validos')"
                    class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Siguiente ‚Üí
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>

    <script>
    function toggleDetallePago(numeroRecibo) {
        const detalleRow = document.getElementById('detalle-' + numeroRecibo);
        const icon = document.getElementById('icon-' + numeroRecibo);
        
        if (detalleRow.classList.contains('hidden')) {
            detalleRow.classList.remove('hidden');
            icon.textContent = '‚ñº';
        } else {
            detalleRow.classList.add('hidden');
            icon.textContent = '‚ñ∂';
        }
    }
    </script>

    <!-- ‚úÖ Tab: Pagos con Cr√©dito - CON COLUMNA TIPO -->
    <div id="content-pagos-credito" class="tab-content hidden">
        
        <!-- ‚úÖ MEN√ö DESPLEGABLE FILTRO PAGOS CR√âDITO -->
        <div class="mb-4 flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-200">
            <label class="text-sm font-bold text-gray-700">Filtrar por:</label>
            <select id="filtro-credito" 
                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium"
                    onchange="aplicarFiltroCredito(this.value)">
                <option value="todos" {% if filtro_credito == 'todos' %}selected{% endif %}>
                    ‚úÖ Todos ({{ contadores_credito.todos }})
                </option>
                <option value="sesiones" {% if filtro_credito == 'sesiones' %}selected{% endif %}>
                    üìã Sesiones ({{ contadores_credito.sesiones }})
                </option>
                <option value="proyectos" {% if filtro_credito == 'proyectos' %}selected{% endif %}>
                    üì¶ Proyectos ({{ contadores_credito.proyectos }})
                </option>
            </select>
        </div>

        <!-- ‚úÖ TARJETA DE TOTALES - CR√âDITO (CON LAZY LOADING) -->
        {% if totales_credito %}
            <!-- Ya calculado - Mostrar datos -->
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 border-2 border-purple-300 rounded-lg p-2.5 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-[10px] font-bold text-purple-800 uppercase flex items-center gap-1.5">
                        <span class="text-sm">üìä</span>
                        Resumen de Uso de Cr√©dito
                    </h3>
                    <button onclick="ocultarTotalesCredito()" 
                            class="text-[10px] bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded font-bold transition">
                        üóô Ocultar
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <!-- Sesiones Normales -->
                    <div class="bg-white/70 rounded-lg p-2 border border-blue-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üìã Sesiones</p>
                        <p class="text-base font-black text-blue-700">
                            Bs. {{ totales_credito.sesiones|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- Proyectos -->
                    <div class="bg-white/70 rounded-lg p-2 border border-purple-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üì¶ Proyectos</p>
                        <p class="text-base font-black text-purple-700">
                            Bs. {{ totales_credito.proyectos|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- TOTAL GENERAL -->
                    <div class="bg-purple-600 rounded-lg p-2 border-2 border-purple-800 shadow-md">
                        <p class="text-[9px] text-purple-100 font-bold uppercase mb-0.5">üí∞ TOTAL</p>
                        <p class="text-base font-black text-white">
                            Bs. {{ totales_credito.general|floatformat:2 }}
                        </p>
                        <p class="text-[8px] text-purple-200 mt-0.5 italic">
                            = Œ£ Tipos
                        </p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No calculado a√∫n - Mostrar bot√≥n -->
            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-4 text-center">
                <p class="text-sm text-gray-600 mb-3">
                    üìä Las estad√≠sticas de uso de cr√©dito no est√°n cargadas
                </p>
                <button onclick="cargarTotalesCredito(this)" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold transition shadow-md">
                    üîÑ Calcular Totales de Cr√©dito
                </button>
                <p class="text-[10px] text-gray-500 mt-2">
                    ‚ö° Esto puede tardar unos segundos
                </p>
            </div>
        {% endif %}
        
        <!-- Alerta informativa -->     
        <div class="bg-white border rounded-lg overflow-hidden">
            <div class="bg-purple-50 border-b-2 border-purple-300 p-4">
                <p class="text-sm text-purple-700 font-medium">
                    ‚ÑπÔ∏è Estos pagos representan el uso del saldo a favor del paciente. No generan recibo f√≠sico.
                </p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-[10px]">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Referencia</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Fecha</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Concepto</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Tipo</th>
                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-700">Estado Sesi√≥n</th>
                            <th class="px-2 py-1.5 text-right text-[10px] font-bold text-gray-700">Monto</th>
                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for pago in pagos_credito %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 py-1.5 font-mono text-xs">
                                <span class="text-purple-700 font-bold">{{ pago.numero_recibo }}</span>
                            </td>
                            <td class="px-2 py-1.5">
                                <p class="font-medium">{{ pago.fecha_pago|date:"d/m/Y" }}</p>
                                <p class="text-xs text-gray-500">{{ pago.fecha_registro|date:"H:i" }}</p>
                            </td>
                            <td class="px-2 py-1.5 text-gray-700">
                                {{ pago.concepto|truncatewords:10 }}
                                {% if pago.sesion %}
                                    <br><span class="text-xs text-gray-500">üéØ {{ pago.sesion.servicio.nombre }}</span>
                                {% elif pago.proyecto %}
                                    <br><span class="text-xs text-purple-600">üì¶ {{ pago.proyecto.codigo }}</span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-1.5">
                                {% if pago.proyecto %}
                                    <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold">
                                        üì¶ Proyecto
                                    </span>
                                {% elif pago.sesion %}
                                    {% if pago.sesion.proyecto %}
                                        <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold">
                                            üì¶ Proyecto
                                        </span>
                                    {% else %}
                                        <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-bold">
                                            üìù Normal
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 font-bold">
                                        ‚ûñ N/A
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-1.5 text-center">
                                {% if pago.sesion %}
                                    <span class="text-xs px-2 py-1 rounded font-bold
                                        {% if pago.sesion.estado == 'realizada' %}bg-green-100 text-green-700
                                        {% elif pago.sesion.estado == 'realizada_retraso' %}bg-yellow-100 text-yellow-700
                                        {% elif pago.sesion.estado == 'programada' %}bg-blue-100 text-blue-700
                                        {% elif pago.sesion.estado == 'falta' %}bg-red-100 text-red-700
                                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                                        {{ pago.sesion.get_estado_display }}
                                    </span>
                                {% else %}
                                    <span class="text-xs text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-1.5 text-right font-bold text-purple-700">
                                Bs. {{ pago.monto|floatformat:2 }}
                            </td>
                            <td class="px-2 py-1.5 text-center">
                                <div class="flex gap-1 justify-center">
                                    <button hx-get="{% url 'facturacion:api_detalle_pago' pago.id %}"
                                            hx-target="#modal-content"
                                            hx-swap="innerHTML"
                                            onclick="abrirModal()"
                                            class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
                                            title="Ver detalle">
                                        üëÅÔ∏è
                                    </button>
                                    
                                    <button onclick="confirmarAnulacion({{ pago.id }}, '{{ pago.numero_recibo }}')"
                                            class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700"
                                            title="Anular pago">
                                        ‚úó
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-3 py-8 text-center text-gray-500">
                                No hay pagos con cr√©dito registrados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ‚úÖ‚úÖ‚úÖ AGREGAR ESTO: PAGINACI√ìN CR√âDITO ‚úÖ‚úÖ‚úÖ -->
        {% if pagos_credito.has_other_pages %}
        <div class="mt-4 flex justify-center">
            <nav class="flex gap-2 text-xs">
                {% if pagos_credito.has_previous %}
                    <a href="?page_credito={{ pagos_credito.previous_page_number }}" 
                    onclick="mostrarTab('pagos-credito')"
                    class="px-2 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ‚Üê Anterior
                    </a>
                {% endif %}
                
                <span class="px-4 py-2 bg-gray-100 border rounded font-medium">
                    P√°gina {{ pagos_credito.number }} de {{ pagos_credito.paginator.num_pages }}
                </span>
                
                {% if pagos_credito.has_next %}
                    <a href="?page_credito={{ pagos_credito.next_page_number }}" 
                    onclick="mostrarTab('pagos-credito')"
                    class="px-2 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Siguiente ‚Üí
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}

    </div>

    <!-- ‚úÖ Tab: Pagos Anulados - CON COLUMNA TIPO -->
    <div id="content-pagos-anulados" class="tab-content hidden">
        
        <!-- ‚úÖ MEN√ö DESPLEGABLE FILTRO PAGOS ANULADOS -->
        <div class="mb-4 flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-200">
            <label class="text-sm font-bold text-gray-700">Filtrar por:</label>
            <select id="filtro-anulados" 
                    class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 font-medium"
                    onchange="aplicarFiltroAnulados(this.value)">
                <option value="todos" {% if filtro_anulados == 'todos' %}selected{% endif %}>
                    ‚úÖ Todos ({{ contadores_anulados.todos }})
                </option>
                <option value="sesiones" {% if filtro_anulados == 'sesiones' %}selected{% endif %}>
                    üìã Sesiones ({{ contadores_anulados.sesiones }})
                </option>
                <option value="proyectos" {% if filtro_anulados == 'proyectos' %}selected{% endif %}>
                    üì¶ Proyectos ({{ contadores_anulados.proyectos }})
                </option>
                <option value="adelantos" {% if filtro_anulados == 'adelantos' %}selected{% endif %}>
                    üí∞ Adelantos ({{ contadores_anulados.adelantos }})
                </option>
            </select>
        </div>

        <!-- ‚úÖ TARJETA DE TOTALES - ANULADOS (CON LAZY LOADING) -->
        {% if totales_anulados %}
            <!-- Ya calculado - Mostrar datos -->
            <div class="bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-300 rounded-lg p-2.5 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-[10px] font-bold text-red-800 uppercase flex items-center gap-1.5">
                        <span class="text-sm">üìä</span>
                        Resumen de Pagos Anulados
                    </h3>
                    <button onclick="ocultarTotalesAnulados()" 
                            class="text-[10px] bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded font-bold transition">
                        üóô Ocultar
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                    <!-- Sesiones Normales -->
                    <div class="bg-white/70 rounded-lg p-2 border border-blue-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üìã Sesiones</p>
                        <p class="text-sm font-black text-blue-700 line-through">
                            Bs. {{ totales_anulados.sesiones|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- Proyectos -->
                    <div class="bg-white/70 rounded-lg p-2 border border-purple-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üì¶ Proyectos</p>
                        <p class="text-sm font-black text-purple-700 line-through">
                            Bs. {{ totales_anulados.proyectos|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- Adelantos -->
                    <div class="bg-white/70 rounded-lg p-2 border border-yellow-200">
                        <p class="text-[9px] text-gray-600 font-bold uppercase mb-0.5">üí≥ Adelantos</p>
                        <p class="text-sm font-black text-yellow-700 line-through">
                            Bs. {{ totales_anulados.adelantos|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- TOTAL GENERAL -->
                    <div class="bg-red-600 rounded-lg p-2 border-2 border-red-800 shadow-md">
                        <p class="text-[9px] text-red-100 font-bold uppercase mb-0.5">üí∞ TOTAL</p>
                        <p class="text-sm font-black text-white line-through">
                            Bs. {{ totales_anulados.general|floatformat:2 }}
                        </p>
                        <p class="text-[7px] text-red-200 mt-0.5 italic">
                            = Œ£ Tipos
                        </p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No calculado a√∫n - Mostrar bot√≥n -->
            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4 text-center">
                <p class="text-sm text-gray-600 mb-3">
                    üìä Las estad√≠sticas de pagos anulados no est√°n cargadas
                </p>
                <button onclick="cargarTotalesAnulados(this)" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition shadow-md">
                    üîÑ Calcular Totales de Pagos Anulados
                </button>
                <p class="text-[10px] text-gray-500 mt-2">
                    ‚ö° Esto puede tardar unos segundos
                </p>
            </div>
        {% endif %}
        
        <!-- Alerta de anulados -->
        
        <div class="bg-white border rounded-lg overflow-hidden">
            <div class="bg-red-50 border-b-2 border-red-300 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm text-red-700 font-medium">
                            ‚ö†Ô∏è Estos pagos fueron anulados y no tienen validez. Se muestran solo para auditor√≠a.
                        </p>
                    </div>
                    
                    {% if request.user.is_staff and stats.pagos_anulados > 0 %}
                    <div class="ml-4">
                        <a href="{% url 'facturacion:limpiar_pagos_anulados' %}" 
                           class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition shadow-lg hover:shadow-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            üóëÔ∏è Limpiar Anulados
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full text-[10px]">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Recibo</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Fecha Original</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Concepto</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Tipo</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">M√©todo</th>
                            <th class="px-2 py-1.5 text-right text-[10px] font-bold text-gray-700">Monto</th>
                            <th class="px-2 py-1.5 text-left text-[10px] font-bold text-gray-700">Motivo Anulaci√≥n</th>
                            <th class="px-2 py-1.5 text-center text-[10px] font-bold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for pago in pagos_anulados %}
                        <tr class="hover:bg-gray-50 opacity-60">
                            <td class="px-2 py-1.5 font-mono text-xs">
                                <span class="text-red-700 font-bold line-through">{{ pago.numero_recibo }}</span>
                            </td>
                            <td class="px-2 py-1.5">
                                <p class="font-medium text-gray-500 line-through">{{ pago.fecha_pago|date:"d/m/Y" }}</p>
                                <p class="text-xs text-red-600">Anulado: {{ pago.fecha_anulacion|date:"d/m/Y H:i" }}</p>
                            </td>
                            <td class="px-2 py-1.5 text-gray-500">
                                {{ pago.concepto|truncatewords:8 }}
                                {% if pago.sesion %}
                                    <br><span class="text-xs">üéØ {{ pago.sesion.servicio.nombre }}</span>
                                {% elif pago.proyecto %}
                                    <br><span class="text-xs text-purple-600">üì¶ {{ pago.proyecto.codigo }}</span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-1.5">
                                {% if pago.proyecto %}
                                    <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold opacity-50">
                                        üì¶ Proyecto
                                    </span>
                                {% elif pago.sesion %}
                                    {% if pago.sesion.proyecto %}
                                        <span class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 font-bold opacity-50">
                                            üì¶ Proyecto
                                        </span>
                                    {% else %}
                                        <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-bold opacity-50">
                                            üìù Normal
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-xs px-2 py-1 rounded bg-green-100 text-green-700 font-bold opacity-50">
                                        üí≥ Adelanto
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-1.5">
                                <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600 font-medium">
                                    {{ pago.metodo_pago.nombre }}
                                </span>
                            </td>
                            <td class="px-2 py-1.5 text-right font-bold text-gray-500 line-through">
                                Bs. {{ pago.monto|floatformat:2 }}
                            </td>
                            <td class="px-2 py-1.5">
                                <p class="text-xs text-red-700 font-medium">{{ pago.motivo_anulacion|truncatewords:10 }}</p>
                                <p class="text-xs text-gray-500">Por: {{ pago.anulado_por.get_full_name|default:pago.anulado_por.username }}</p>
                            </td>
                            <td class="px-2 py-1.5 text-center">
                                <button hx-get="{% url 'facturacion:api_detalle_pago' pago.id %}"
                                        hx-target="#modal-content"
                                        hx-swap="innerHTML"
                                        onclick="abrirModal()"
                                        class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
                                        title="Ver detalle">
                                    üëÅÔ∏è
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="px-3 py-8 text-center text-gray-500">
                                ‚úÖ No hay pagos anulados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ‚úÖ‚úÖ‚úÖ AGREGAR ESTO: PAGINACI√ìN ANULADOS ‚úÖ‚úÖ‚úÖ -->
        {% if pagos_anulados.has_other_pages %}
        <div class="mt-4 flex justify-center">
            <nav class="flex gap-2 text-xs">
                {% if pagos_anulados.has_previous %}
                    <a href="?page_anulados={{ pagos_anulados.previous_page_number }}" 
                    onclick="mostrarTab('pagos-anulados')"
                    class="px-2 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ‚Üê Anterior
                    </a>
                {% endif %}
                
                <span class="px-4 py-2 bg-gray-100 border rounded font-medium">
                    P√°gina {{ pagos_anulados.number }} de {{ pagos_anulados.paginator.num_pages }}
                </span>
                
                {% if pagos_anulados.has_next %}
                    <a href="?page_anulados={{ pagos_anulados.next_page_number }}" 
                    onclick="mostrarTab('pagos-anulados')"
                    class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Siguiente ‚Üí
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>

</div>

<!-- Modal Universal -->
<div id="modal-universal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-900">üìã Detalles</h3>
            <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
        </div>
        <div id="modal-content" class="p-6">
            <!-- Contenido din√°mico cargado por HTMX -->
        </div>
    </div>
</div>

<!-- Modal Anular Pago -->
<div id="modal-anular" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-bold text-gray-900 mb-4">‚ö†Ô∏è Anular Pago</h3>
        <p class="text-gray-700 mb-4">¬øEst√°s seguro de anular el recibo <strong id="recibo-numero"></strong>?</p>
        
        <form id="form-anular" method="post">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Motivo de anulaci√≥n *</label>
                <textarea name="motivo" 
                          required
                          rows="3"
                          class="w-full px-3 py-2 border rounded-lg"
                          placeholder="Especifica el motivo..."></textarea>
            </div>
            
            <div class="flex gap-3">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold">
                    Confirmar Anulaci√≥n
                </button>
                <button type="button" onclick="cerrarModalAnular()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Manejo de Tabs
function mostrarTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.add('hidden');
    });
    
    document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50');
        el.classList.add('border-transparent', 'text-gray-500');
    });
    
    const contenido = document.getElementById('content-' + tab);
    if (contenido) {
        contenido.classList.remove('hidden');
    }
    
    const boton = document.getElementById('tab-' + tab);
    if (boton) {
        boton.classList.remove('border-transparent', 'text-gray-500');
        boton.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
    }
}

// ‚úÖ ACTUALIZADO: Detectar qu√© tab mostrar al cargar seg√∫n par√°metros
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Priorizar seg√∫n filtros o paginaci√≥n
    if (urlParams.has('filtro_anulados') || urlParams.has('page_anulados')) {
        mostrarTab('pagos-anulados');
    } else if (urlParams.has('filtro_credito') || urlParams.has('page_credito')) {
        mostrarTab('pagos-credito');
    } else if (urlParams.has('filtro_validos') || urlParams.has('page_validos')) {
        mostrarTab('pagos-validos');
    } else if (urlParams.has('filtro_sesiones') || urlParams.has('page_sesiones')) {
        mostrarTab('sesiones');
    } else {
        mostrarTab('sesiones'); // Tab por defecto
    }
});

// Modal Universal
function abrirModal() {
    document.getElementById('modal-universal').classList.remove('hidden');
    document.getElementById('modal-universal').classList.add('flex');
}

function cerrarModal() {
    document.getElementById('modal-universal').classList.add('hidden');
    document.getElementById('modal-universal').classList.remove('flex');
}

// Modal Anular
function confirmarAnulacion(pagoId, numeroRecibo) {
    document.getElementById('recibo-numero').textContent = numeroRecibo;
    document.getElementById('form-anular').action = '/facturacion/pago/' + pagoId + '/anular/';
    document.getElementById('modal-anular').classList.remove('hidden');
    document.getElementById('modal-anular').classList.add('flex');
}

function cerrarModalAnular() {
    document.getElementById('modal-anular').classList.add('hidden');
    document.getElementById('modal-anular').classList.remove('flex');
}

// ‚úÖ FUNCIONES PARA FILTROS DIN√ÅMICOS
function aplicarFiltroSesiones(filtro) {
    const url = new URL(window.location.href);
    url.searchParams.set('filtro_sesiones', filtro);
    url.searchParams.delete('page_sesiones'); // Reset paginaci√≥n
    window.location.href = url.toString();
}

function aplicarFiltroValidos(filtro) {
    const url = new URL(window.location.href);
    url.searchParams.set('filtro_validos', filtro);
    url.searchParams.delete('page_validos'); // Reset paginaci√≥n
    window.location.href = url.toString();
}

function aplicarFiltroCredito(filtro) {
    const url = new URL(window.location.href);
    url.searchParams.set('filtro_credito', filtro);
    url.searchParams.delete('page_credito'); // Reset paginaci√≥n
    window.location.href = url.toString();
}

function aplicarFiltroAnulados(filtro) {
    const url = new URL(window.location.href);
    url.searchParams.set('filtro_anulados', filtro);
    url.searchParams.delete('page_anulados'); // Reset paginaci√≥n
    window.location.href = url.toString();
}

// ==================== FUNCIONES DE LAZY LOADING ====================

function cargarTotalesSesiones(btn) {
    btn.classList.add('btn-loading');
    const url = new URL(window.location.href);
    url.searchParams.set('ver_totales_sesiones', '1');
    window.location.href = url.toString();
}

function ocultarTotalesSesiones() {
    const url = new URL(window.location.href);
    url.searchParams.delete('ver_totales_sesiones');
    window.location.href = url.toString();
}

function cargarTotalesValidos(btn) {
    btn.classList.add('btn-loading');
    const url = new URL(window.location.href);
    url.searchParams.set('ver_totales_validos', '1');
    window.location.href = url.toString();
}

function ocultarTotalesValidos() {
    const url = new URL(window.location.href);
    url.searchParams.delete('ver_totales_validos');
    window.location.href = url.toString();
}

function cargarTotalesCredito(btn) {
    btn.classList.add('btn-loading');
    const url = new URL(window.location.href);
    url.searchParams.set('ver_totales_credito', '1');
    window.location.href = url.toString();
}

function ocultarTotalesCredito() {
    const url = new URL(window.location.href);
    url.searchParams.delete('ver_totales_credito');
    window.location.href = url.toString();
}

function cargarTotalesAnulados(btn) {
    btn.classList.add('btn-loading');
    const url = new URL(window.location.href);
    url.searchParams.set('ver_totales_anulados', '1');
    window.location.href = url.toString();
}

function ocultarTotalesAnulados() {
    const url = new URL(window.location.href);
    url.searchParams.delete('ver_totales_anulados');
    window.location.href = url.toString();
}
</script>
{% endblock %}