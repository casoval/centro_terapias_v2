{% extends 'base.html' %}
{% load static %}

{% block title %}Cuenta Corriente - {{ paciente.nombre_completo }}{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<style>
    /* ==================== LOADING SPINNER ==================== */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
    }
    .btn-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spinner 0.6s linear infinite;
    }
    @keyframes spinner {
        to { transform: rotate(360deg); }
    }
    
    /* ==================== MEN√öS DESPLEGABLES MEJORADOS ==================== */
    .detalle-desplegable {
        max-height: 0 !important;
        overflow: hidden !important;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                    opacity 0.3s ease !important;
        opacity: 0 !important;
    }
    .detalle-desplegable.abierto {
        max-height: 50000px !important;
        opacity: 1 !important;
        overflow: visible !important;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                    opacity 0.3s ease !important;
    }
    .icono-flecha {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: inline-block !important;
    }
    .icono-flecha.rotado {
        transform: rotate(180deg) !important;
    }
    
    /* Hover para botones de desplegar */
    .btn-desplegable {
        padding: 0.25rem;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }
    .btn-desplegable:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }
    
    /* ==================== SOMBRAS DIFERENCIADAS POR TARJETA ==================== */
    .tarjeta-estado-actual {
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
    }
    .tarjeta-proyeccion {
        box-shadow: 0 4px 6px -1px rgba(147, 51, 234, 0.3), 0 2px 4px -1px rgba(147, 51, 234, 0.06);
    }
    .tarjeta-credito {
        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -1px rgba(16, 185, 129, 0.06);
    }
    
    /* ==================== STICKY HEADERS ==================== */
    .tarjeta-header-sticky {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* ==================== BADGES INFORMATIVOS ==================== */
    .badge-info {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 600;
        background-color: rgba(59, 130, 246, 0.1);
        color: rgb(37, 99, 235);
        border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .badge-warning {
        background-color: rgba(245, 158, 11, 0.1);
        color: rgb(217, 119, 6);
        border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .badge-success {
        background-color: rgba(16, 185, 129, 0.1);
        color: rgb(5, 150, 105);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    /* ==================== RESPONSIVE MEJORAS OPTIMIZADAS ==================== */
    @media (max-width: 640px) {
        /* Reducir espaciado general */
        .grid-responsive {
            gap: 0.5rem !important;
        }
        
        /* Compactar padding de tarjetas */
        .tarjeta-mobile-compact .p-3 {
            padding: 0.5rem !important;
        }
        
        /* Reducir tama√±os de texto */
        .texto-responsive {
            font-size: 0.75rem !important;
        }
        
        /* Header de tarjetas m√°s compacto */
        .tarjeta-header-sticky {
            padding: 0.5rem 0.75rem !important;
        }
        
        /* T√≠tulos m√°s peque√±os en m√≥vil */
        .tarjeta-header-sticky h3 {
            font-size: 0.75rem !important;
        }
        
        .tarjeta-header-sticky p {
            font-size: 0.625rem !important;
        }
        
        /* N√∫meros grandes m√°s compactos */
        .text-lg {
            font-size: 1rem !important;
        }
        
        .text-xl {
            font-size: 1.125rem !important;
        }
        
        /* Reducir padding de items internos */
        .space-y-2 > * + * {
            margin-top: 0.375rem !important;
        }
        
        .space-y-1 > * + * {
            margin-top: 0.25rem !important;
        }
        
        /* Iconos m√°s peque√±os */
        .icono-flecha {
            width: 1rem !important;
            height: 1rem !important;
        }
        
        /* Badges m√°s compactos */
        .badge-info,
        .badge-warning,
        .badge-success {
            font-size: 0.5rem !important;
            padding: 0.125rem 0.375rem !important;
        }
        
        /* Tablas m√°s compactas */
        .tabla-scroll-container table {
            font-size: 0.625rem !important;
        }
        
        .tabla-scroll-container th,
        .tabla-scroll-container td {
            padding: 0.25rem 0.375rem !important;
        }
        
        /* Reducir m√°rgenes del contenedor principal */
        .max-w-7xl {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        /* Header del paciente m√°s compacto */
        .bg-gradient-to-r.from-blue-50 {
            padding: 0.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Botones m√°s peque√±os */
        button, .btn-desplegable {
            padding: 0.25rem !important;
        }
        
        /* Texto de botones m√°s peque√±o */
        a.bg-white {
            font-size: 0.625rem !important;
            padding: 0.375rem 0.625rem !important;
        }
    }
    
    /* Optimizaci√≥n para pantallas muy peque√±as (menos de 375px) */
    @media (max-width: 375px) {
        .text-lg {
            font-size: 0.875rem !important;
        }
        
        .text-xl {
            font-size: 1rem !important;
        }
        
        h1 {
            font-size: 1rem !important;
        }
        
        .max-w-7xl {
            padding-left: 0.25rem !important;
            padding-right: 0.25rem !important;
        }
    }
    
    @media (min-width: 768px) and (max-width: 1023px) {
        .grid-cols-1.md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }
    
    /* ==================== TABLA SCROLL HORIZONTAL ==================== */
    .tabla-scroll-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .tabla-scroll-container::-webkit-scrollbar {
        height: 8px;
    }
    
    .tabla-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .tabla-scroll-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    .tabla-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* ==================== ANIMACIONES SUAVES ==================== */
    .transition-smooth {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ==================== MEJORAS DE ACCESIBILIDAD ==================== */
    .btn-desplegable:focus {
        outline: 2px solid rgba(59, 130, 246, 0.5);
        outline-offset: 2px;
    }
    
    /* ==================== COMPACTACI√ìN GLOBAL ==================== */
    /* ==================== FILTROS ULTRA COMPACTADOS ==================== */
    .bg-blue-50.border.border-blue-200.rounded-lg.p-4,
    .bg-purple-50.border.border-purple-200.rounded-lg.p-4,
    .bg-green-50.border.border-green-200.rounded-lg.p-4 {
        padding: 0.5rem !important;
        background: #f8fafc !important;
        border-radius: 8px !important;
    }
    
    .bg-blue-50 label,
    .bg-purple-50 label,
    .bg-green-50 label {
        margin-bottom: 0.2rem !important;
        font-size: 0.7rem !important;
        font-weight: 600 !important;
        color: #475569 !important;
    }
    
    .bg-blue-50 select,
    .bg-blue-50 input[type="date"],
    .bg-blue-50 input[type="checkbox"],
    .bg-purple-50 select,
    .bg-purple-50 input[type="date"],
    .bg-green-50 select,
    .bg-green-50 input[type="date"] {
        padding: 0.35rem 0.5rem !important;
        font-size: 0.75rem !important;
        border-radius: 6px !important;
        border: 1px solid #cbd5e1 !important;
    }
    
    .bg-blue-50 .grid,
    .bg-purple-50 .grid,
    .bg-green-50 .grid {
        gap: 0.6rem !important;
    }
    
    .bg-blue-50 button,
    .bg-purple-50 button,
    .bg-green-50 button {
        padding: 0.4rem 0.8rem !important;
        font-size: 0.75rem !important;
        font-weight: 600 !important;
        border-radius: 6px !important;
    }
    
    /* T√≠tulo de secci√≥n de filtros */
    .bg-blue-50 h4,
    .bg-purple-50 h4,
    .bg-green-50 h4 {
        font-size: 0.8rem !important;
        font-weight: 700 !important;
        color: #1e293b !important;
        margin-bottom: 0.5rem !important;
    }
    
    /* Compactar tarjetas principales */
    .tarjeta-estado-actual,
    .tarjeta-proyeccion,
    .tarjeta-credito {
        margin-bottom: 0.5rem !important;
    }
    
    .bg-gradient-to-r {
        padding: 0.5rem 0.75rem !important;
    }
    
    .bg-gradient-to-r h3 {
        font-size: 0.75rem !important;
    }
    
    .bg-gradient-to-r p {
        font-size: 0.65rem !important;
    }
    
    /* Compactar contenido interno de tarjetas */
    .bg-white.rounded-lg.p-3 {
        padding: 0.5rem !important;
    }
    
    .space-y-2 > * + * {
        margin-top: 0.25rem !important;
    }
    
    .space-y-1 > * + * {
        margin-top: 0.125rem !important;
    }
    
    /* Compactar textos dentro de tarjetas */
    .text-xs {
        font-size: 0.65rem !important;
    }
    
    .text-sm {
        font-size: 0.75rem !important;
    }
    
    .text-lg {
        font-size: 1rem !important;
    }
    
    .text-xl {
        font-size: 1.125rem !important;
    }
    
    .text-4xl {
        font-size: 1.5rem !important;
    }
    
    /* Compactar badges */
    .badge-info,
    .badge-warning,
    .badge-success,
    .px-2.py-1,
    .px-3.py-1 {
        padding: 0.2rem 0.5rem !important;
        font-size: 0.7rem !important;
        font-weight: 600 !important;
        border-radius: 4px !important;
        text-transform: uppercase !important;
        letter-spacing: 0.025em !important;
    }
    
    /* Estilos espec√≠ficos para badges por color */
    .badge-success,
    .bg-green-100 {
        background: #dcfce7 !important;
        color: #166534 !important;
        border: 1px solid #bbf7d0 !important;
    }
    
    .badge-warning,
    .bg-yellow-100,
    .bg-amber-100 {
        background: #fef3c7 !important;
        color: #92400e !important;
        border: 1px solid #fde68a !important;
    }
    
    .badge-danger,
    .bg-red-100 {
        background: #fee2e2 !important;
        color: #991b1b !important;
        border: 1px solid #fecaca !important;
    }
    
    .badge-info,
    .bg-blue-100 {
        background: #dbeafe !important;
        color: #1e40af !important;
        border: 1px solid #bfdbfe !important;
    }
    
    .bg-gray-100 {
        background: #f1f5f9 !important;
        color: #475569 !important;
        border: 1px solid #cbd5e1 !important;
    }
    
    /* Compactar botones desplegables */
    .btn-desplegable svg {
        width: 0.75rem !important;
        height: 0.75rem !important;
    }
    
    /* Compactar secciones desplegables */
    .bg-blue-50.rounded-lg.p-2,
    .bg-purple-50.rounded-lg.p-2 {
        padding: 0.375rem !important;
    }
    
    /* ==================== TABLAS ULTRA COMPACTADAS ==================== */
    /* Compactar tablas */
    table th,
    table td {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.75rem !important;
        line-height: 1.3 !important;
    }
    
    table th {
        font-weight: 700 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.03em !important;
        color: #475569 !important;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
        border-bottom: 2px solid #cbd5e1 !important;
    }
    
    table td {
        border-bottom: 1px solid #f1f5f9 !important;
    }
    
    table tbody tr:hover {
        background-color: #f8fafc !important;
    }
    
    table tbody tr:nth-child(even) {
        background-color: #fafbfc !important;
    }
    
    /* Badges en tablas m√°s compactos */
    table .badge-info,
    table .badge-warning,
    table .badge-success,
    table .px-2.py-1,
    table .px-3.py-1 {
        padding: 0.15rem 0.4rem !important;
        font-size: 0.65rem !important;
        font-weight: 600 !important;
        border-radius: 4px !important;
        text-transform: uppercase !important;
        letter-spacing: 0.02em !important;
    }
    
    /* Compactar paginaci√≥n */
    .flex.items-center.justify-between.mt-4 {
        margin-top: 0.5rem !important;
    }
    
    .flex.items-center.justify-between.mt-4 a,
    .flex.items-center.justify-between.mt-4 span {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.7rem !important;
    }
    
    /* Reducir gaps generales */
    .gap-1.5 {
        gap: 0.5rem !important;
    }
    
    .gap-3 {
        gap: 0.375rem !important;
    }
    
    /* Compactar header de paciente */
    .bg-gradient-to-r.from-blue-50 {
        padding: 0.75rem !important;
        margin-bottom: 0.75rem !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.3), 0 4px 6px -2px rgba(102, 126, 234, 0.05) !important;
    }
    
    .bg-gradient-to-r.from-blue-50 h1 {
        color: white !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.15) !important;
        font-size: 1.5rem !important;
        font-weight: 800 !important;
        letter-spacing: -0.02em !important;
    }
    
    .bg-gradient-to-r.from-blue-50 p {
        color: rgba(255, 255, 255, 0.95) !important;
        font-size: 0.8rem !important;
        font-weight: 600 !important;
    }
    
    .bg-gradient-to-r.from-blue-50 .text-blue-600 {
        color: rgba(255, 255, 255, 0.9) !important;
        font-weight: 700 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
    }
    
    .bg-gradient-to-r.from-blue-50 .text-gray-600 {
        color: rgba(255, 255, 255, 0.85) !important;
    }
    
    .bg-gradient-to-r.from-blue-50 .text-gray-600 span:first-child {
        filter: brightness(1.2) !important;
    }
    
    .bg-gradient-to-r.from-blue-50 a {
        background: rgba(255, 255, 255, 0.95) !important;
        color: #667eea !important;
        font-weight: 700 !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }
    
    .bg-gradient-to-r.from-blue-50 a:hover {
        background: white !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    /* Compactar contador de registros */
    .bg-gradient-to-br {
        padding: 0.5rem !important;
    }

    /* ==================== TABLAS OPTIMIZADAS PARA M√ìVIL ==================== */
    @media (max-width: 640px) {
        /* Ocultar columnas menos importantes en m√≥vil */
        .hide-on-mobile {
            display: none !important;
        }
        
        /* Hacer texto de tabla m√°s peque√±o */
        table {
            font-size: 0.65rem !important;
        }
        
        th {
            font-size: 0.65rem !important;
            padding: 0.3rem 0.4rem !important;
            font-weight: 700 !important;
        }
        
        td {
            font-size: 0.65rem !important;
            padding: 0.3rem 0.4rem !important;
        }
        
        /* Reducir ancho de columnas */
        th:first-child,
        td:first-child {
            padding-left: 0.3rem !important;
        }
        
        th:last-child,
        td:last-child {
            padding-right: 0.3rem !important;
        }
        
        /* Botones de acci√≥n m√°s compactos */
        .btn-sm {
            font-size: 0.6rem !important;
            padding: 0.2rem 0.35rem !important;
        }
        
        /* Paginaci√≥n m√°s compacta */
        .pagination {
            font-size: 0.65rem !important;
        }
        
        .pagination a,
        .pagination span {
            padding: 0.3rem 0.6rem !important;
            font-size: 0.65rem !important;
        }
        
        /* Filtros m√°s compactos en m√≥vil */
        .bg-blue-50 label,
        .bg-purple-50 label,
        .bg-green-50 label {
            font-size: 0.65rem !important;
        }
        
        .bg-blue-50 select,
        .bg-blue-50 input,
        .bg-purple-50 select,
        .bg-purple-50 input,
        .bg-green-50 select,
        .bg-green-50 input {
            font-size: 0.7rem !important;
            padding: 0.3rem 0.4rem !important;
        }
        
        .bg-blue-50 button,
        .bg-purple-50 button,
        .bg-green-50 button {
            font-size: 0.7rem !important;
            padding: 0.35rem 0.6rem !important;
        }
        
        /* Badges m√°s compactos en m√≥vil */
        .badge-info,
        .badge-warning,
        .badge-success {
            font-size: 0.6rem !important;
            padding: 0.15rem 0.35rem !important;
        }
    }

    /* ==================== FIXES PARA CONTENIDO QUE SE DESBORDA ==================== */

    /* ==================== ULTRA FIXES - PREVENIR OVERFLOW A TODA COSTA ==================== */
    
    @media (max-width: 640px) {
        /* FORZAR que nada sea m√°s ancho que la pantalla */
        html, body {
            max-width: 100vw !important;
            overflow-x: hidden !important;
            position: relative !important;
        }
        
        /* Todos los contenedores principales */
        .max-w-7xl,
        .container,
        main,
        nav,
        header,
        section,
        div[class*="grid"],
        div[class*="flex"] {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        /* Las 3 tarjetas principales */
        .grid-cols-1 {
            grid-template-columns: 1fr !important;
        }
        
        /* Forzar flex-wrap en todos los flex containers */
        [class*="flex"] {
            flex-wrap: wrap !important;
        }
        
        /* Reducir padding lateral de TODOS los elementos */
        .px-4, .px-3 {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        .px-2 {
            padding-left: 0.375rem !important;
            padding-right: 0.375rem !important;
        }
        
        /* Hacer los montos m√°s peque√±os */
        .font-black {
            font-size: 0.875rem !important;
        }
        
        /* SVG icons m√°s peque√±os */
        svg {
            width: 0.875rem !important;
            height: 0.875rem !important;
        }
        
        /* Botones m√°s compactos */
        button,
        a[class*="btn"],
        [class*="button"] {
            padding: 0.25rem 0.5rem !important;
            font-size: 0.625rem !important;
        }
        
        /* Headers de tarjetas */
        .bg-gradient-to-r.from-blue-600,
        .bg-gradient-to-r.from-purple-600,
        .bg-gradient-to-r.from-green-600 {
            padding: 0.5rem !important;
        }
        
        /* Espacios internos de tarjetas */
        .space-y-2 > * + * {
            margin-top: 0.25rem !important;
        }
        
        .space-y-1 > * + * {
            margin-top: 0.125rem !important;
        }
        
        /* Gaps del grid */
        .gap-1.5 {
            gap: 0.5rem !important;
        }
        
        .gap-3 {
            gap: 0.375rem !important;
        }
        
        .gap-2 {
            gap: 0.25rem !important;
        }
        
        /* M√°rgenes verticales */
        .mb-4, .my-4 {
            margin-bottom: 0.5rem !important;
        }
        
        .mb-3, .my-3 {
            margin-bottom: 0.375rem !important;
        }
        
        .mb-2, .my-2 {
            margin-bottom: 0.25rem !important;
        }
        
        /* Reducir border-radius para ahorrar espacio */
        .rounded-lg {
            border-radius: 0.375rem !important;
        }
        
        .rounded-md {
            border-radius: 0.25rem !important;
        }
        
        /* Hacer el header del paciente m√°s compacto */
        h1 {
            font-size: 0.875rem !important;
            line-height: 1.2 !important;
        }
        
        /* Textos descriptivos */
        .text-xs {
            font-size: 0.625rem !important;
        }
        
        .text-sm {
            font-size: 0.6875rem !important;
        }
        
        .text-base {
            font-size: 0.75rem !important;
        }
        
        /* N√∫meros importantes siguen siendo legibles pero m√°s peque√±os */
        .text-lg {
            font-size: 0.875rem !important;
        }
        
        .text-xl {
            font-size: 1rem !important;
        }
        
        /* Emojis m√°s peque√±os si ocupan mucho */
        span:first-child {
            font-size: 0.875em !important;
        }
    }
    
    /* Para pantallas MUY peque√±as (< 360px como algunos Android) */
    @media (max-width: 360px) {
        .max-w-7xl {
            padding-left: 0.25rem !important;
            padding-right: 0.25rem !important;
        }
        
        .px-2, .px-3, .px-4 {
            padding-left: 0.25rem !important;
            padding-right: 0.25rem !important;
        }
        
        h1 {
            font-size: 0.75rem !important;
        }
        
        .font-black {
            font-size: 0.75rem !important;
        }
        
        button, a {
            font-size: 0.5rem !important;
            padding: 0.125rem 0.25rem !important;
        }
    }

    
    /* Prevenir overflow horizontal */
    body {
        overflow-x: hidden !important;
        max-width: 100vw !important;
    }
    
    /* Asegurar que ning√∫n elemento sea m√°s ancho que la pantalla */
    * {
        box-sizing: border-box !important;
    }
    
    /* Word break para textos largos */
    .text-gray-700,
    .text-gray-900,
    .font-bold,
    td, th, p, span, div {
        word-break: break-word !important;
        overflow-wrap: break-word !important;
    }
    
    /* Contenedores principales no deben desbordar */
    .max-w-7xl,
    .container,
    .bg-gradient-to-r {
        max-width: 100% !important;
        overflow-x: hidden !important;
    }
    
    /* Tarjetas responsive */
    .bg-blue-50,
    .bg-purple-50,
    .bg-green-50,
    .bg-white {
        max-width: 100% !important;
        overflow: hidden !important;
    }
    
    /* Tablas siempre con scroll si es necesario */
    .tabla-scroll-container {
        max-width: 100% !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }
    
    table {
        min-width: 100% !important;
        table-layout: auto !important;
    }
    
    /* Flex items no deben crecer m√°s all√° del contenedor */
    .flex {
        flex-wrap: wrap !important;
    }
    
    .flex.justify-between {
        gap: 0.5rem !important;
    }
    
    /* Textos que puedan ser muy largos */
    .break-all {
        word-break: break-all !important;
    }
    
    .truncate {
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }

    
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4 py-2 sm:py-4">
    
    <!-- Header con Info del Paciente -->
    <div class="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-300 rounded-lg p-2.5 sm:p-3 mb-2 sm:mb-3">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 mb-2 sm:mb-3">
            <div>
                <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs">üí∞</span>
                    <p class="text-[10px] text-blue-600 font-bold uppercase tracking-wider">Cuenta Corriente</p>
                </div>
                <h1 class="text-base sm:text-lg font-black text-gray-900 leading-none mb-1 sm:mb-2">{{ paciente.nombre_completo }}</h1>
                <div class="flex items-center gap-3 text-gray-600 text-[11px]">
                    <div class="flex items-center gap-1">
                        <span>üë§</span>
                        <span class="font-semibold">{{ paciente.nombre_tutor }}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span>üì±</span>
                        <span class="font-semibold">{{ paciente.telefono_tutor }}</span>
                    </div>
                </div>
            </div>
            <a href="{% url 'facturacion:cuentas_corrientes' %}" 
               class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-2 sm:px-3 py-1 sm:py-1.5 rounded-md text-[10px] sm:text-[10px] font-bold transition shadow-sm">
                ‚Üê Volver
            </a>
        </div>
    </div>

    <!-- ============================
         BANNER DE DEUDAS PENDIENTES
         ============================ -->
    {% if deuda_total > 0 %}
    <div class="flex flex-wrap items-center gap-2 mb-2 sm:mb-3 px-3 py-2 bg-red-50 border border-red-300 rounded-lg shadow-sm">
        <!-- √çcono + t√≠tulo -->
        <div class="flex items-center gap-1.5 shrink-0">
            <span class="text-base leading-none">‚ö†Ô∏è</span>
            <span class="text-[11px] font-black text-red-700 uppercase tracking-wide">Deuda pendiente</span>
        </div>

        <!-- Separador -->
        <div class="hidden sm:block w-px h-4 bg-red-300"></div>

        <!-- Chips por tipo -->
        <div class="flex flex-wrap gap-1.5 flex-1">
            {% if deuda_sesiones_cantidad > 0 %}
            <a href="{% url 'facturacion:registrar_pago' %}?sesion={{ deuda_sesiones_primera_id|default:'' }}"
               class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 border border-red-300 text-red-800 text-[10px] font-bold hover:bg-red-200 transition cursor-pointer"
               title="{{ deuda_sesiones_cantidad }} sesi√≥n(es) con saldo pendiente">
                üóì {{ deuda_sesiones_cantidad }} sesi√≥n{{ deuda_sesiones_cantidad|pluralize:"es" }}
                <span class="font-black">¬∑ Bs. {{ deuda_sesiones_monto|floatformat:2 }}</span>
            </a>
            {% endif %}
            {% if deuda_mensualidades_cantidad > 0 %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-orange-100 border border-orange-300 text-orange-800 text-[10px] font-bold"
                  title="{{ deuda_mensualidades_cantidad }} mensualidad(es) con saldo pendiente">
                üìÖ {{ deuda_mensualidades_cantidad }} mensualidad{{ deuda_mensualidades_cantidad|pluralize:"es" }}
                <span class="font-black">¬∑ Bs. {{ deuda_mensualidades_monto|floatformat:2 }}</span>
            </span>
            {% endif %}
            {% if deuda_proyectos_cantidad > 0 %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-100 border border-yellow-300 text-yellow-800 text-[10px] font-bold"
                  title="{{ deuda_proyectos_cantidad }} proyecto(s) con saldo pendiente">
                üì¶ {{ deuda_proyectos_cantidad }} proyecto{{ deuda_proyectos_cantidad|pluralize:"s" }}
                <span class="font-black">¬∑ Bs. {{ deuda_proyectos_monto|floatformat:2 }}</span>
            </span>
            {% endif %}
        </div>

        <!-- Total destacado -->
        <div class="ml-auto shrink-0 flex items-center gap-1 bg-red-600 text-white px-2.5 py-1 rounded-lg shadow-sm">
            <span class="text-[10px] font-bold uppercase">Total:</span>
            <span class="text-sm font-black">Bs. {{ deuda_total|floatformat:2 }}</span>
        </div>
    </div>
    {% endif %}

    <!-- ========================================
         TRES TARJETAS: ESTADO ACTUAL | PROYECCI√ìN TOTAL | CR√âDITO
         ======================================== -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3 md:gap-1.5 mb-2 sm:mb-4 grid-responsive">
        
        <!-- TARJETA 1: ESTADO ACTUAL -->
        <div class="bg-blue-50 border border-blue-300 rounded-lg overflow-hidden tarjeta-estado-actual tarjeta-mobile-compact">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-2 py-1.5 tarjeta-header-sticky">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-white flex items-center gap-1.5">
                            <span class="text-base">üìä</span>
                            Estado Actual
                        </h3>
                        <p class="text-[9px] text-blue-100 mt-0.5">Solo servicios ya realizados</p>
                    </div>
                    <button onclick="toggleDetalle('tarjeta-estado-actual-body')" 
                            class="text-white hover:bg-blue-800 transition-smooth btn-desplegable rounded-full p-0.5"
                            title="Expandir/Contraer detalles"
                            aria-label="Expandir o contraer detalles de estado actual">
                        <svg class="w-4 h-4 icono-flecha" id="icono-tarjeta-estado-actual-body" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-2 space-y-1.5">
                <!-- RESUMEN VISIBLE SIEMPRE -->
                <div class="space-y-1.5">
                    <!-- Total Consumido Actual -->
                    <div class="flex justify-between items-center pb-1 border-b border-blue-300">
                        <span class="text-[10px] text-gray-700 font-bold">Total Consumido:</span>
                        <span class="text-sm font-black text-gray-900">Bs. {{ cuenta.total_consumido_actual|floatformat:2 }}</span>
                    </div>
                    
                    <!-- Total Pagado -->
                    <div class="flex justify-between items-center pb-1 border-b border-blue-300">
                        <span class="text-[10px] text-gray-700 font-bold">Total Pagado:</span>
                        <span class="text-sm font-black text-green-600">Bs. {{ cuenta.total_pagado|floatformat:2 }}</span>
                    </div>
                    
                    <!-- Saldo Actual -->
                    <div class="bg-gradient-to-r from-gray-100 to-gray-200 px-2 py-1.5 rounded-lg border {% if cuenta.saldo_actual < 0 %}border-red-400{% elif cuenta.saldo_actual == 0 %}border-gray-400{% else %}border-green-400{% endif %} transition-smooth hover:shadow-md">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="text-[10px] font-bold text-gray-900">SALDO:</span>
                            <span class="text-base font-black {% if cuenta.saldo_actual < 0 %}text-red-600{% elif cuenta.saldo_actual == 0 %}text-gray-600{% else %}text-green-600{% endif %}">
                                Bs. {{ cuenta.saldo_actual|floatformat:2 }}
                            </span>
                        </div>
                        <div class="text-center">
                            {% if cuenta.saldo_actual < 0 %}
                                <span class="px-2 py-0.5 text-[9px] font-black rounded-full bg-red-100 text-red-800 border border-red-300">
                                    DEBE
                                </span>
                            {% elif cuenta.saldo_actual == 0 %}
                                <span class="px-2 py-0.5 text-[9px] font-black rounded-full bg-gray-100 text-gray-800 border border-gray-300">
                                    AL D√çA
                                </span>
                            {% else %}
                                <span class="px-2 py-0.5 text-[9px] font-black rounded-full bg-green-100 text-green-800 border border-green-300">
                                    A FAVOR
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- DETALLES DESPLEGABLES -->
                <div id="tarjeta-estado-actual-body" class="detalle-desplegable">
                
                <!-- Desglose Detallado de Consumo -->
                <div class="bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b-2 border-blue-200">
                        <p class="text-[10px] font-bold text-blue-700 uppercase flex items-center gap-1">
                            <span>üìã</span> Detalle del Consumo:
                        </p>
                        <span class="text-lg font-black text-blue-700">Bs. {{ cuenta.total_consumido_actual|floatformat:2 }}</span>
                    </div>
                    
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-xs bg-gray-50 px-2 py-0.5 rounded">
                            <span class="text-gray-700">‚Ä¢ Sesiones realizadas/falta:</span>
                            <span class="font-bold text-gray-900">Bs. {{ cuenta.total_sesiones_normales_real|floatformat:2 }}</span>
                        </div>
                        <div class="text-[10px] text-gray-500 ml-4">
                            ({{ cuenta.num_sesiones_realizadas_pendientes }} sesi√≥n{{ cuenta.num_sesiones_realizadas_pendientes|pluralize:"es" }} pendiente{{ cuenta.num_sesiones_realizadas_pendientes|pluralize }} de pago completo)
                        </div>
                        
                        <!-- MENSUALIDADES CON SUB-MEN√ö DESPLEGABLE -->
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-xs bg-gray-50 px-2 py-0.5 rounded">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-700">üí≥ Mensualidades activas:</span>
                                    <button onclick="toggleDetalle('detalle-mensualidades')" 
                                            class="text-blue-600 hover:text-blue-800 transition-smooth btn-desplegable"
                                            title="Click para ver desglose detallado"
                                            aria-label="Ver desglose de mensualidades">
                                        <svg class="w-3 h-3 icono-flecha" id="icono-detalle-mensualidades" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="font-bold text-gray-900">Bs. {{ cuenta.total_mensualidades|floatformat:2 }}</span>
                            </div>
                            <div class="text-[10px] text-gray-500 ml-4">
                                ({{ cuenta.num_mensualidades_activas }} mensualidad{{ cuenta.num_mensualidades_activas|pluralize:"es" }} activa{{ cuenta.num_mensualidades_activas|pluralize }})
                            </div>
                            
                            <!-- Desglose por Estado (DESPLEGABLE) -->
                            <div id="detalle-mensualidades" class="detalle-desplegable ml-4 mt-2">
                                <div class="bg-blue-50 rounded-lg p-2 space-y-1 border border-blue-200">
                                    <p class="text-[10px] font-bold text-blue-700 uppercase mb-0.5">
                                        Desglose por Estado:
                                    </p>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-emerald-50 px-2 py-0.5 rounded border-l-2 border-emerald-500">
                                        <span class="text-gray-700">‚úÖ Activas:</span>
                                        <span class="font-bold text-emerald-700">
                                            {{ stats_mensualidades.activas.cantidad }} (Bs. {{ stats_mensualidades.activas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-amber-50 px-2 py-0.5 rounded border-l-2 border-amber-500">
                                        <span class="text-gray-700">‚è∏Ô∏è Pausadas:</span>
                                        <span class="font-bold text-amber-700">
                                            {{ stats_mensualidades.pausadas.cantidad }} (Bs. {{ stats_mensualidades.pausadas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-purple-50 px-2 py-0.5 rounded border-l-2 border-purple-500">
                                        <span class="text-gray-700">üéâ Completadas:</span>
                                        <span class="font-bold text-purple-700">
                                            {{ stats_mensualidades.completadas.cantidad }} (Bs. {{ stats_mensualidades.completadas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-red-50 px-2 py-0.5 rounded border-l-2 border-red-500">
                                        <span class="text-gray-700">‚ùå Canceladas:</span>
                                        <span class="font-bold text-red-700">
                                            {{ stats_mensualidades.canceladas.cantidad }} (Bs. {{ stats_mensualidades.canceladas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PROYECTOS CON SUB-MEN√ö DESPLEGABLE (SOLO EN PROGRESO/FINALIZADOS) -->
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-xs bg-gray-50 px-2 py-0.5 rounded">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-700">üì¶ Proyectos en progreso:</span>
                                    <button onclick="toggleDetalle('detalle-proyectos-actual')" 
                                            class="text-blue-600 hover:text-blue-800 transition-smooth btn-desplegable"
                                            title="Click para ver desglose detallado"
                                            aria-label="Ver desglose de proyectos">
                                        <svg class="w-3 h-3 icono-flecha" id="icono-detalle-proyectos-actual" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="font-bold text-gray-900">Bs. {{ cuenta.total_proyectos_real|floatformat:2 }}</span>
                            </div>
                            
                            <!-- Desglose por Estado (DESPLEGABLE) - SIN PLANIFICADOS -->
                            <div id="detalle-proyectos-actual" class="detalle-desplegable ml-4 mt-2">
                                <div class="bg-purple-50 rounded-lg p-2 space-y-1 border border-purple-200">
                                    <p class="text-[10px] font-bold text-purple-700 uppercase mb-0.5">
                                        Desglose por Estado:
                                    </p>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-emerald-50 px-2 py-0.5 rounded border-l-2 border-emerald-500">
                                        <span class="text-gray-700">üîÑ En Progreso:</span>
                                        <span class="font-bold text-emerald-700">
                                            {{ stats_proyectos.en_progreso.cantidad }} (Bs. {{ stats_proyectos.en_progreso.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-purple-50 px-2 py-0.5 rounded border-l-2 border-purple-500">
                                        <span class="text-gray-700">‚úÖ Finalizados:</span>
                                        <span class="font-bold text-purple-700">
                                            {{ stats_proyectos.finalizados.cantidad }} (Bs. {{ stats_proyectos.finalizados.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-red-50 px-2 py-0.5 rounded border-l-2 border-red-500">
                                        <span class="text-gray-700">‚ùå Cancelados:</span>
                                        <span class="font-bold text-red-700">
                                            {{ stats_proyectos.cancelados.cantidad }} (Bs. {{ stats_proyectos.cancelados.total|floatformat:2 }})
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Total Pagado CON MEN√ö DESPLEGABLE -->
                <div class="flex justify-between items-center pb-2 border-b border-blue-300">
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-700 font-bold">Total Pagado:</span>
                        <button onclick="toggleDetalle('detalle-pagado-actual')" 
                                class="text-blue-600 hover:text-blue-800 transition-smooth btn-desplegable"
                                title="Click para ver desglose de pagos"
                                aria-label="Ver desglose de pagos">
                            <svg class="w-4 h-4 icono-flecha" id="icono-detalle-pagado-actual" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                    </div>
                    <span class="text-lg sm:text-xl font-black text-green-600">Bs. {{ cuenta.total_pagado|floatformat:2 }}</span>
                </div>
                
                <!-- Desglose Detallado de Pagos (DESPLEGABLE) -->
                <div id="detalle-pagado-actual" class="detalle-desplegable">
                    <div class="bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                        <p class="text-[10px] font-bold text-green-700 uppercase mb-2 flex items-center gap-1">
                            <span>üíµ</span> Detalle de Pagos (Efectivo/QR/Transferencia):
                        </p>
                        
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-0.5 rounded">
                                <span class="text-gray-700">‚Ä¢ Pagos a sesiones:</span>
                                <span class="font-bold text-green-700">Bs. {{ cuenta.pagos_sesiones|floatformat:2 }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-0.5 rounded">
                                <span class="text-gray-700">‚Ä¢ Pagos a mensualidades:</span>
                                <span class="font-bold text-green-700">Bs. {{ cuenta.pagos_mensualidades|floatformat:2 }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-0.5 rounded">
                                <span class="text-gray-700">‚Ä¢ Pagos a proyectos:</span>
                                <span class="font-bold text-green-700">Bs. {{ cuenta.pagos_proyectos|floatformat:2 }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-xs bg-blue-50 px-2 py-0.5 rounded border border-blue-200">
                                <span class="text-blue-700 font-medium">‚Ä¢ Pagos adelantados:</span>
                                <span class="font-bold text-blue-700">Bs. {{ cuenta.pagos_sin_asignar|floatformat:2 }}</span>
                            </div>
                            
                            {% if cuenta.total_devoluciones > 0 %}
                            <div class="flex justify-between items-center text-xs text-red-600 mt-1">
                                <span>‚Ä¢ Devoluciones realizadas:</span>
                                <span class="font-bold">- Bs. {{ cuenta.total_devoluciones|default:"0.00" }}</span>
                            </div>

                            <div class="pl-3 text-[10px] text-red-500 flex flex-col gap-0.5 mt-0.5 mb-2 border-l-2 border-red-100 ml-1">
                                
                                <div class="flex justify-between">
                                    <span class="pl-2">‚Ü≥ Mensualidades:</span>
                                    <span>- Bs. {{ dev_mensualidad|default:"0.00"|floatformat:2 }}</span>
                                </div>

                                <div class="flex justify-between">
                                    <span class="pl-2">‚Ü≥ Proyectos:</span>
                                    <span>- Bs. {{ dev_proyecto|default:"0.00"|floatformat:2 }}</span>
                                </div>

                                <div class="flex justify-between">
                                    <span class="pl-2">‚Ü≥ Cr√©dito (Adelantos):</span>
                                    <span>- Bs. {{ dev_credito|default:"0.00"|floatformat:2 }}</span>
                                </div>
                                
                            </div>
                            {% endif %}
                            
                            <div class="h-px bg-gray-300 my-1"></div>
                            
                            <div class="flex justify-between items-center text-xs bg-gray-100 px-2 py-0.5 rounded">
                                <span class="text-gray-900 font-bold">TOTAL PAGOS EFECTIVOS:</span>
                                <span class="font-black text-green-600">Bs. {{ cuenta.total_pagado|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‚úÖ DEUDAS PENDIENTES -->
                {% if deuda_total > 0 %}
                <div class="bg-white rounded-lg p-3 border-2 border-orange-300 shadow-sm">
                    <div class="flex justify-between items-center pb-2 border-b border-orange-300 mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-orange-700 font-bold">‚ö†Ô∏è Deudas Pendientes:</span>
                            <button onclick="toggleDetalle('detalle-deudas-actual')" 
                                    class="text-orange-600 hover:text-orange-800 transition">
                                <svg class="w-4 h-4 icono-flecha" id="icono-detalle-deudas-actual" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                        <span class="text-base sm:text-lg font-black text-orange-600">Bs. {{ deuda_total|floatformat:2 }}</span>
                    </div>
                    
                    <!-- Desglose de Deudas (DESPLEGABLE) -->
                    <div id="detalle-deudas-actual" class="detalle-desplegable">
                        <div class="space-y-1">
                            {% if deuda_sesiones_cantidad > 0 %}
                            <div class="flex justify-between items-center text-xs bg-orange-50 px-2 py-1 rounded border-l-2 border-orange-400">
                                <span class="text-gray-700">üßò Sesiones normales:</span>
                                <span class="font-bold text-orange-700">
                                    {{ deuda_sesiones_cantidad }} sesi√≥n{{ deuda_sesiones_cantidad|pluralize:"es" }} - Bs. {{ deuda_sesiones_monto|floatformat:2 }}
                                </span>
                            </div>
                            {% endif %}
                            
                            {% if deuda_mensualidades_cantidad > 0 %}
                            <div class="flex justify-between items-center text-xs bg-orange-50 px-2 py-1 rounded border-l-2 border-orange-400">
                                <span class="text-gray-700">üí≥ Mensualidades:</span>
                                <span class="font-bold text-orange-700">
                                    {{ deuda_mensualidades_cantidad }} mensualidad{{ deuda_mensualidades_cantidad|pluralize:"es" }} - Bs. {{ deuda_mensualidades_monto|floatformat:2 }}
                                </span>
                            </div>
                            {% endif %}
                            
                            {% if deuda_proyectos_cantidad > 0 %}
                            <div class="flex justify-between items-center text-xs bg-orange-50 px-2 py-1 rounded border-l-2 border-orange-400">
                                <span class="text-gray-700">üì¶ Proyectos activos:</span>
                                <span class="font-bold text-orange-700">
                                    {{ deuda_proyectos_cantidad }} proyecto{{ deuda_proyectos_cantidad|pluralize:"s" }} - Bs. {{ deuda_proyectos_monto|floatformat:2 }}
                                </span>
                            </div>
                            {% endif %}
                            
                            <div class="h-px bg-orange-200 my-1"></div>
                            
                            <div class="flex justify-between items-center text-xs bg-orange-100 px-2 py-1 rounded">
                                <span class="text-gray-900 font-bold">TOTAL DEUDA:</span>
                                <span class="font-black text-orange-600">Bs. {{ deuda_total|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                </div><!-- Fin detalle desplegable Tarjeta 1 -->
            </div>
        </div>

        <!-- TARJETA 2: PROYECCI√ìN TOTAL -->
        <div class="bg-purple-50 border border-purple-300 rounded-lg overflow-hidden tarjeta-proyeccion tarjeta-mobile-compact">
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-2 py-1.5 tarjeta-header-sticky">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-white flex items-center gap-1.5">
                            <span class="text-base">üîÆ</span>
                            Proyecci√≥n Total
                        </h3>
                        <p class="text-[9px] text-purple-100 mt-0.5">Incluye compromisos futuros</p>
                    </div>
                    <button onclick="toggleDetalle('tarjeta-proyeccion-body')" 
                            class="text-white hover:bg-purple-800 transition-smooth btn-desplegable rounded-full p-0.5"
                            title="Expandir/Contraer detalles"
                            aria-label="Expandir o contraer detalles de proyecci√≥n">
                        <svg class="w-4 h-4 icono-flecha" id="icono-tarjeta-proyeccion-body" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-2 space-y-1.5">
                <!-- RESUMEN VISIBLE SIEMPRE -->
                <div class="space-y-1.5">
                    <!-- Total Consumido Real -->
                    <div class="flex justify-between items-center pb-1 border-b border-purple-300">
                        <span class="text-[10px] text-gray-700 font-bold">Total Proyectado:</span>
                        <span class="text-sm font-black text-gray-900">Bs. {{ cuenta.total_consumido_real|floatformat:2 }}</span>
                    </div>
                    
                    <!-- Total Pagado -->
                    <div class="flex justify-between items-center pb-1 border-b border-purple-300">
                        <span class="text-[10px] text-gray-700 font-bold">Total Pagado:</span>
                        <span class="text-sm font-black text-green-600">Bs. {{ cuenta.total_pagado|floatformat:2 }}</span>
                    </div>
                    
                    <!-- Saldo Proyectado -->
                    <div class="bg-gradient-to-r from-gray-100 to-gray-200 px-2 py-1.5 rounded-lg border {% if cuenta.saldo_real < 0 %}border-red-400{% elif cuenta.saldo_real == 0 %}border-gray-400{% else %}border-green-400{% endif %} transition-smooth hover:shadow-md">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="text-[10px] font-bold text-gray-900">SALDO PROYECTADO:</span>
                            <span class="text-base font-black {% if cuenta.saldo_real < 0 %}text-red-600{% elif cuenta.saldo_real == 0 %}text-gray-600{% else %}text-green-600{% endif %}">
                                Bs. {{ cuenta.saldo_real|floatformat:2 }}
                            </span>
                        </div>
                        <div class="text-center">
                            {% if cuenta.saldo_real < 0 %}
                                <span class="px-2 py-0.5 text-[9px] font-black rounded-full bg-red-100 text-red-800 border border-red-300">
                                    DEBE
                                </span>
                            {% elif cuenta.saldo_real == 0 %}
                                <span class="px-2 py-0.5 text-[9px] font-black rounded-full bg-gray-100 text-gray-800 border border-gray-300">
                                    AL D√çA
                                </span>
                            {% else %}
                                <span class="px-2 py-0.5 text-[9px] font-black rounded-full bg-green-100 text-green-800 border border-green-300">
                                    A FAVOR
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- DETALLES DESPLEGABLES -->
                <div id="tarjeta-proyeccion-body" class="detalle-desplegable">
                
                <!-- Desglose Detallado -->
                <div class="bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b-2 border-purple-200">
                        <p class="text-[10px] font-bold text-purple-700 uppercase flex items-center gap-1">
                            <span>üìã</span> Detalle Proyectado:
                        </p>
                        <span class="text-base sm:text-lg font-black text-purple-700">Bs. {{ cuenta.total_consumido_real|floatformat:2 }}</span>
                    </div>
                    
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-xs bg-gray-50 px-2 py-1 rounded">
                            <span class="text-gray-700">‚Ä¢ Sesiones (realizadas):</span>
                            <span class="font-bold text-gray-900">Bs. {{ cuenta.total_sesiones_normales_real|floatformat:2 }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs bg-purple-50 px-2 py-1 rounded border border-purple-200">
                            <span class="text-purple-700">‚Ä¢ Sesiones programadas:</span>
                            <span class="font-bold text-purple-700">Bs. {{ cuenta.total_sesiones_programadas|floatformat:2 }}</span>
                        </div>
                        <div class="text-[10px] text-gray-500 ml-4">
                            ({{ cuenta.num_sesiones_programadas_pendientes }} sesi√≥n{{ cuenta.num_sesiones_programadas_pendientes|pluralize:"es" }} programada{{ cuenta.num_sesiones_programadas_pendientes|pluralize }})
                        </div>
                        
                        <!-- MENSUALIDADES CON SUB-MEN√ö DESPLEGABLE -->
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-xs bg-gray-50 px-2 py-1 rounded">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-700">üí≥ Mensualidades:</span>
                                    <button onclick="toggleDetalle('detalle-mensualidades-proyeccion')" 
                                            class="text-purple-600 hover:text-purple-800 transition-smooth btn-desplegable"
                                            title="Click para ver desglose detallado"
                                            aria-label="Ver desglose de mensualidades">
                                        <svg class="w-3 h-3 icono-flecha" id="icono-detalle-mensualidades-proyeccion" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="font-bold text-gray-900">Bs. {{ cuenta.total_mensualidades|floatformat:2 }}</span>
                            </div>
                            
                            <!-- Desglose por Estado (DESPLEGABLE) -->
                            <div id="detalle-mensualidades-proyeccion" class="detalle-desplegable ml-4 mt-2">
                                <div class="bg-blue-50 rounded-lg p-2 space-y-1 border border-blue-200">
                                    <p class="text-[10px] font-bold text-blue-700 uppercase mb-0.5">
                                        Desglose por Estado:
                                    </p>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-emerald-50 px-2 py-1 rounded border-l-2 border-emerald-500">
                                        <span class="text-gray-700">‚úÖ Activas:</span>
                                        <span class="font-bold text-emerald-700">
                                            {{ stats_mensualidades.activas.cantidad }} (Bs. {{ stats_mensualidades.activas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-amber-50 px-2 py-1 rounded border-l-2 border-amber-500">
                                        <span class="text-gray-700">‚è∏Ô∏è Pausadas:</span>
                                        <span class="font-bold text-amber-700">
                                            {{ stats_mensualidades.pausadas.cantidad }} (Bs. {{ stats_mensualidades.pausadas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-purple-50 px-2 py-1 rounded border-l-2 border-purple-500">
                                        <span class="text-gray-700">üéâ Completadas:</span>
                                        <span class="font-bold text-purple-700">
                                            {{ stats_mensualidades.completadas.cantidad }} (Bs. {{ stats_mensualidades.completadas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-red-50 px-2 py-1 rounded border-l-2 border-red-500">
                                        <span class="text-gray-700">‚ùå Canceladas:</span>
                                        <span class="font-bold text-red-700">
                                            {{ stats_mensualidades.canceladas.cantidad }} (Bs. {{ stats_mensualidades.canceladas.total|floatformat:2 }})
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PROYECTOS EN PROGRESO CON SUB-MEN√ö -->
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-xs bg-gray-50 px-2 py-1 rounded">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-700">üì¶ Proyectos (en progreso):</span>
                                    <button onclick="toggleDetalle('detalle-proyectos-progreso-proyeccion')" 
                                            class="text-purple-600 hover:text-purple-800 transition-smooth btn-desplegable"
                                            title="Click para ver desglose detallado"
                                            aria-label="Ver desglose de proyectos">
                                        <svg class="w-3 h-3 icono-flecha" id="icono-detalle-proyectos-progreso-proyeccion" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="font-bold text-gray-900">Bs. {{ cuenta.total_proyectos_real|floatformat:2 }}</span>
                            </div>
                            
                            <!-- Desglose de Proyectos en Progreso -->
                            <div id="detalle-proyectos-progreso-proyeccion" class="detalle-desplegable ml-4 mt-2">
                                <div class="bg-purple-50 rounded-lg p-2 space-y-1 border border-purple-200">
                                    <p class="text-[10px] font-bold text-purple-700 uppercase mb-0.5">
                                        Estados (excl. Planificados):
                                    </p>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-emerald-50 px-2 py-1 rounded border-l-2 border-emerald-500">
                                        <span class="text-gray-700">üîÑ En Progreso:</span>
                                        <span class="font-bold text-emerald-700">
                                            {{ stats_proyectos.en_progreso.cantidad }} (Bs. {{ stats_proyectos.en_progreso.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-purple-50 px-2 py-1 rounded border-l-2 border-purple-500">
                                        <span class="text-gray-700">‚úÖ Finalizados:</span>
                                        <span class="font-bold text-purple-700">
                                            {{ stats_proyectos.finalizados.cantidad }} (Bs. {{ stats_proyectos.finalizados.total|floatformat:2 }})
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-red-50 px-2 py-1 rounded border-l-2 border-red-500">
                                        <span class="text-gray-700">‚ùå Cancelados:</span>
                                        <span class="font-bold text-red-700">
                                            {{ stats_proyectos.cancelados.cantidad }} (Bs. {{ stats_proyectos.cancelados.total|floatformat:2 }})
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PROYECTOS PLANIFICADOS CON SUB-MEN√ö (SOLO PLANIFICADOS) -->
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-xs bg-purple-50 px-2 py-1 rounded border border-purple-200">
                                <div class="flex items-center gap-2">
                                    <span class="text-purple-700">üì¶ Proyectos planificados:</span>
                                    <button onclick="toggleDetalle('detalle-proyectos-planificados-proyeccion')" 
                                            class="text-purple-600 hover:text-purple-800 transition-smooth btn-desplegable"
                                            title="Click para ver desglose detallado"
                                            aria-label="Ver desglose de proyectos planificados">
                                        <svg class="w-3 h-3 icono-flecha" id="icono-detalle-proyectos-planificados-proyeccion" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                <span class="font-bold text-purple-700">Bs. {{ cuenta.total_proyectos_planificados|floatformat:2 }}</span>
                            </div>
                            
                            <!-- Desglose de Proyectos Planificados -->
                            <div id="detalle-proyectos-planificados-proyeccion" class="detalle-desplegable ml-4 mt-2">
                                <div class="bg-amber-50 rounded-lg p-2 space-y-1 border border-amber-200">
                                    <p class="text-[10px] font-bold text-amber-700 uppercase mb-0.5">
                                        Solo Planificados:
                                    </p>
                                    
                                    <div class="flex justify-between items-center text-[10px] bg-amber-50 px-2 py-1 rounded border-l-2 border-amber-500">
                                        <span class="text-gray-700">üìã Planificados:</span>
                                        <span class="font-bold text-amber-700">
                                            {{ stats_proyectos.planificados.cantidad }} (Bs. {{ stats_proyectos.planificados.total|floatformat:2 }})
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Total Pagado CON MEN√ö DESPLEGABLE -->
                <div class="flex justify-between items-center pb-2 border-b border-purple-300">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-700 font-bold">Total Pagado:</span>
                        <button onclick="toggleDetalle('detalle-pagado-proyeccion')" 
                                class="text-purple-600 hover:text-purple-800 transition-smooth btn-desplegable"
                                title="Click para ver desglose de pagos"
                                aria-label="Ver desglose de pagos">
                            <svg class="w-4 h-4 icono-flecha" id="icono-detalle-pagado-proyeccion" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                    </div>
                    <span class="text-lg sm:text-xl font-black text-green-600">Bs. {{ cuenta.total_pagado|floatformat:2 }}</span>
                </div>
                
                <!-- Desglose Detallado de Pagos (DESPLEGABLE) -->
                <div id="detalle-pagado-proyeccion" class="detalle-desplegable">
                    <div class="bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                        <p class="text-[10px] font-bold text-green-700 uppercase mb-2 flex items-center gap-1">
                            <span>üíµ</span> Detalle de Pagos (Efectivo/QR/Transferencia):
                        </p>
                        
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-1 rounded">
                                <span class="text-gray-700">‚Ä¢ Pagos a sesiones:</span>
                                <span class="font-bold text-green-700">Bs. {{ cuenta.pagos_sesiones|floatformat:2 }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-1 rounded">
                                <span class="text-gray-700">‚Ä¢ Pagos a mensualidades:</span>
                                <span class="font-bold text-green-700">Bs. {{ cuenta.pagos_mensualidades|floatformat:2 }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-1 rounded">
                                <span class="text-gray-700">‚Ä¢ Pagos a proyectos:</span>
                                <span class="font-bold text-green-700">Bs. {{ cuenta.pagos_proyectos|floatformat:2 }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-xs bg-blue-50 px-2 py-1 rounded border border-blue-200">
                                <span class="text-blue-700 font-medium">‚Ä¢ Pagos adelantados:</span>
                                <span class="font-bold text-blue-700">Bs. {{ cuenta.pagos_sin_asignar|floatformat:2 }}</span>
                            </div>
                            
                            {% if cuenta.total_devoluciones > 0 %}
                            <div class="flex justify-between items-center text-xs text-red-600 mt-1">
                                <span>‚Ä¢ Devoluciones realizadas:</span>
                                <span class="font-bold">- Bs. {{ cuenta.total_devoluciones|default:"0.00" }}</span>
                            </div>

                            <div class="pl-3 text-[10px] text-red-500 flex flex-col gap-0.5 mt-0.5 mb-2 border-l-2 border-red-100 ml-1">
                                
                                <div class="flex justify-between">
                                    <span class="pl-2">‚Ü≥ Mensualidades:</span>
                                    <span>- Bs. {{ dev_mensualidad|default:"0.00"|floatformat:2 }}</span>
                                </div>

                                <div class="flex justify-between">
                                    <span class="pl-2">‚Ü≥ Proyectos:</span>
                                    <span>- Bs. {{ dev_proyecto|default:"0.00"|floatformat:2 }}</span>
                                </div>

                                <div class="flex justify-between">
                                    <span class="pl-2">‚Ü≥ Cr√©dito (Adelantos):</span>
                                    <span>- Bs. {{ dev_credito|default:"0.00"|floatformat:2 }}</span>
                                </div>
                                
                            </div>
                            {% endif %}
                            
                            <div class="h-px bg-gray-300 my-1"></div>
                            
                            <div class="flex justify-between items-center text-xs bg-gray-100 px-2 py-1 rounded">
                                <span class="text-gray-900 font-bold">TOTAL PAGOS EFECTIVOS:</span>
                                <span class="font-black text-green-600">Bs. {{ cuenta.total_pagado|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‚úÖ DEUDAS PENDIENTES -->
                {% if deuda_total_proyectada > 0 %}
                <div class="bg-white rounded-lg p-3 border-2 border-orange-300 shadow-sm">
                    <div class="flex justify-between items-center pb-2 border-b border-orange-300 mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-orange-700 font-bold">‚ö†Ô∏è Deudas Pendientes:</span>
                            <button onclick="toggleDetalle('detalle-deudas-proyeccion')" 
                                    class="text-orange-600 hover:text-orange-800 transition">
                                <svg class="w-4 h-4 icono-flecha" id="icono-detalle-deudas-proyeccion" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                        <span class="text-base sm:text-lg font-black text-orange-600">Bs. {{ deuda_total_proyectada|floatformat:2 }}</span>
                    </div>
                    
                    <!-- Desglose de Deudas (DESPLEGABLE) -->
                    <div id="detalle-deudas-proyeccion" class="detalle-desplegable">
                        <div class="space-y-1">
                            
                            <!-- ‚úÖ SESIONES REALIZADAS/FALTA CON DEUDA -->
                            {% if deuda_sesiones_cantidad > 0 %}
                            <div class="bg-orange-50 px-2 py-1 rounded border-l-2 border-orange-400">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-gray-700 font-semibold">üßò Sesiones realizadas/falta:</span>
                                    <span class="font-bold text-orange-700">
                                        Bs. {{ deuda_sesiones_monto|floatformat:2 }}
                                    </span>
                                </div>
                                
                                <!-- Desglose: Totales vs Parciales -->
                                {% if deuda_sesiones_cantidad_total > 0 or deuda_sesiones_cantidad_parcial > 0 %}
                                <div class="ml-3 mt-1 space-y-0.5 text-[10px] text-gray-600">
                                    {% if deuda_sesiones_cantidad_total > 0 %}
                                    <div class="flex justify-between">
                                        <span class="pl-2">‚Ü≥ Sin pagar (deuda total):</span>
                                        <span class="font-medium">{{ deuda_sesiones_cantidad_total }} - Bs. {{ deuda_sesiones_total_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if deuda_sesiones_cantidad_parcial > 0 %}
                                    <div class="flex justify-between">
                                        <span class="pl-2">‚Ü≥ Pago parcial (deuda parcial):</span>
                                        <span class="font-medium">{{ deuda_sesiones_cantidad_parcial }} - Bs. {{ deuda_sesiones_parcial_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- ‚úÖ SESIONES PROGRAMADAS CON DEUDA -->
                            {% if deuda_sesiones_programadas_cantidad > 0 %}
                            <div class="bg-purple-50 px-2 py-1 rounded border-l-2 border-purple-400">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-purple-700 font-semibold">üìÖ Sesiones programadas:</span>
                                    <span class="font-bold text-purple-700">
                                        Bs. {{ deuda_sesiones_programadas_monto|floatformat:2 }}
                                    </span>
                                </div>
                                
                                <!-- Desglose: Totales vs Parciales -->
                                {% if deuda_sesiones_programadas_cantidad_total > 0 or deuda_sesiones_programadas_cantidad_parcial > 0 %}
                                <div class="ml-3 mt-1 space-y-0.5 text-[10px] text-purple-600">
                                    {% if deuda_sesiones_programadas_cantidad_total > 0 %}
                                    <div class="flex justify-between">
                                        <span class="pl-2">‚Ü≥ Sin pagar (deuda total):</span>
                                        <span class="font-medium">{{ deuda_sesiones_programadas_cantidad_total }} - Bs. {{ deuda_sesiones_programadas_total_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if deuda_sesiones_programadas_cantidad_parcial > 0 %}
                                    <div class="flex justify-between">
                                        <span class="pl-2">‚Ü≥ Pago parcial (deuda parcial):</span>
                                        <span class="font-medium">{{ deuda_sesiones_programadas_cantidad_parcial }} - Bs. {{ deuda_sesiones_programadas_parcial_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- ‚úÖ MENSUALIDADES CON DEUDA -->
                            {% if deuda_mensualidades_cantidad > 0 %}
                            <div class="bg-orange-50 px-2 py-1 rounded border-l-2 border-orange-400">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-gray-700 font-semibold">üí≥ Mensualidades:</span>
                                    <span class="font-bold text-orange-700">
                                        Bs. {{ deuda_mensualidades_monto|floatformat:2 }}
                                    </span>
                                </div>
                                
                                <!-- Desglose: Totales vs Parciales -->
                                {% if deuda_mensualidades_cantidad_total > 0 or deuda_mensualidades_cantidad_parcial > 0 %}
                                <div class="ml-3 mt-1 space-y-0.5 text-[10px] text-gray-600">
                                    {% if deuda_mensualidades_cantidad_total > 0 %}
                                    <div class="flex justify-between">
                                        <span class="pl-2">‚Ü≥ Sin pagar (deuda total):</span>
                                        <span class="font-medium">{{ deuda_mensualidades_cantidad_total }} - Bs. {{ deuda_mensualidades_total_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if deuda_mensualidades_cantidad_parcial > 0 %}
                                    <div class="flex justify-between">
                                        <span class="pl-2">‚Ü≥ Pago parcial (deuda parcial):</span>
                                        <span class="font-medium">{{ deuda_mensualidades_cantidad_parcial }} - Bs. {{ deuda_mensualidades_parcial_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- ‚úÖ PROYECTOS CON DEUDA -->
                            {% if deuda_proyectos_cantidad > 0 or deuda_proyectos_planificados_cantidad > 0 %}
                            <div class="bg-orange-50 px-2 py-1 rounded border-l-2 border-orange-400">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-gray-700 font-semibold">üì¶ Proyectos:</span>
                                    <span class="font-bold text-orange-700">
                                        {% with total_monto_proyectos=deuda_proyectos_monto|add:deuda_proyectos_planificados_monto %}
                                        Bs. {{ total_monto_proyectos|floatformat:2 }}
                                        {% endwith %}
                                    </span>
                                </div>
                                
                                <!-- Desglose por estado y tipo de deuda -->
                                <div class="ml-3 mt-1 space-y-0.5 text-[10px] text-gray-600">
                                    <!-- Proyectos en progreso/finalizados -->
                                    {% if deuda_proyectos_cantidad > 0 %}
                                    <div class="flex justify-between font-medium text-gray-700">
                                        <span class="pl-2">‚Ä¢ En progreso/finalizados:</span>
                                        <span>Bs. {{ deuda_proyectos_monto|floatformat:2 }}</span>
                                    </div>
                                    {% if deuda_proyectos_cantidad_total > 0 %}
                                    <div class="flex justify-between pl-4">
                                        <span>‚Ü≥ Sin pagar:</span>
                                        <span>{{ deuda_proyectos_cantidad_total }} - Bs. {{ deuda_proyectos_total_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if deuda_proyectos_cantidad_parcial > 0 %}
                                    <div class="flex justify-between pl-4">
                                        <span>‚Ü≥ Pago parcial:</span>
                                        <span>{{ deuda_proyectos_cantidad_parcial }} - Bs. {{ deuda_proyectos_parcial_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    
                                    <!-- Proyectos planificados -->
                                    {% if deuda_proyectos_planificados_cantidad > 0 %}
                                    <div class="flex justify-between font-medium text-purple-700 mt-1">
                                        <span class="pl-2">‚Ä¢ Planificados:</span>
                                        <span>Bs. {{ deuda_proyectos_planificados_monto|floatformat:2 }}</span>
                                    </div>
                                    {% if deuda_proyectos_planificados_cantidad_total > 0 %}
                                    <div class="flex justify-between pl-4 text-purple-600">
                                        <span>‚Ü≥ Sin pagar:</span>
                                        <span>{{ deuda_proyectos_planificados_cantidad_total }} - Bs. {{ deuda_proyectos_planificados_total_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if deuda_proyectos_planificados_cantidad_parcial > 0 %}
                                    <div class="flex justify-between pl-4 text-purple-600">
                                        <span>‚Ü≥ Pago parcial:</span>
                                        <span>{{ deuda_proyectos_planificados_cantidad_parcial }} - Bs. {{ deuda_proyectos_planificados_parcial_monto|floatformat:2 }}</span>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="h-px bg-orange-200 my-1"></div>
                            
                            <div class="flex justify-between items-center text-xs bg-orange-100 px-2 py-1 rounded">
                                <span class="text-gray-900 font-bold">TOTAL DEUDA PROYECTADA:</span>
                                <span class="font-black text-orange-600">Bs. {{ deuda_total_proyectada|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                </div><!-- Fin detalle desplegable Tarjeta 2 -->
            </div>
        </div>

        <!-- TARJETA 3: CR√âDITO DISPONIBLE -->
        <div class="{% if cuenta.pagos_adelantados > 0 %}bg-green-50 border-green-300{% else %}bg-gray-50 border-gray-300{% endif %} border rounded-lg overflow-hidden tarjeta-credito tarjeta-mobile-compact">
            <div class="bg-gradient-to-r {% if cuenta.pagos_adelantados > 0 %}from-green-600 to-green-700{% else %}from-gray-600 to-gray-700{% endif %} px-2 py-1.5 tarjeta-header-sticky">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-white flex items-center gap-1.5">
                            <span class="text-base">üíµ</span>
                            Cr√©dito Disponible
                        </h3>
                        <p class="text-[9px] {% if cuenta.pagos_adelantados > 0 %}text-green-100{% else %}text-gray-100{% endif %} mt-0.5">Saldo a favor del paciente</p>
                    </div>
                    <button onclick="toggleDetalle('tarjeta-credito-body')" 
                            class="text-white {% if cuenta.pagos_adelantados > 0 %}hover:bg-green-800{% else %}hover:bg-gray-800{% endif %} transition-smooth btn-desplegable rounded-full p-0.5"
                            title="Expandir/Contraer detalles"
                            aria-label="Expandir o contraer detalles de cr√©dito">
                        <svg class="w-4 h-4 icono-flecha" id="icono-tarjeta-credito-body" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-2 space-y-1.5">
                <!-- RESUMEN VISIBLE SIEMPRE -->
                <div class="space-y-1.5">
                    <!-- Cr√©dito Total -->
                    <div class="flex justify-between items-center pb-1 border-b {% if cuenta.pagos_adelantados > 0 %}border-green-300{% else %}border-gray-300{% endif %}">
                        <span class="text-[10px] text-gray-700 font-bold">Cr√©dito Total:</span>
                        <span class="text-base font-black {% if cuenta.pagos_adelantados > 0 %}text-green-600{% else %}text-gray-600{% endif %}">
                            Bs. {{ cuenta.pagos_adelantados|floatformat:2 }}
                        </span>
                    </div>
                    
                    <!-- Info adicional -->
                    {% if cuenta.pagos_adelantados > 0 %}
                    <div class="bg-green-100 border border-green-300 rounded-lg p-1.5 transition-smooth hover:bg-green-50">
                        <p class="text-[9px] text-green-800 font-medium">
                            ‚úÖ Paciente tiene <strong>Bs. {{ cuenta.pagos_adelantados|floatformat:2 }}</strong> disponible.
                        </p>
                    </div>
                    {% else %}
                    <div class="bg-gray-100 border border-gray-300 rounded-lg p-1.5">
                        <p class="text-[9px] text-gray-600 font-medium">
                            ‚ÑπÔ∏è Sin cr√©dito disponible.
                        </p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- DETALLES DESPLEGABLES -->
                <div id="tarjeta-credito-body" class="detalle-desplegable">
                
                <!-- Desglose del Cr√©dito -->
                <div class="bg-white rounded-lg p-3 space-y-2 border border-gray-200">
                    <p class="text-[10px] font-bold {% if cuenta.pagos_adelantados > 0 %}text-green-700{% else %}text-gray-700{% endif %} uppercase mb-2 flex items-center gap-1">
                        <span>üí∞</span> Desglose del Cr√©dito:
                    </p>
                    
                    <div class="space-y-1">
                        <!-- INGRESOS (Pagos recibidos) -->
                        <p class="text-xs font-semibold text-gray-700 mt-2">+ Ingresos:</p>
                        
                        <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-1 rounded ml-2">
                            <span class="text-gray-700">‚Ä¢ Pagos adelantados (sin asignar):</span>
                            <span class="font-bold text-green-700">Bs. {{ cuenta.pagos_sin_asignar|floatformat:2 }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs bg-green-50 px-2 py-1 rounded ml-2">
                            <span class="text-gray-700">‚Ä¢ Excedentes en sesiones:</span>
                            <span class="font-bold text-green-700">Bs. {{ cuenta.excedentes_sesiones|floatformat:2 }}</span>
                        </div>
                        
                        <!-- EGRESOS (Uso de cr√©dito) -->
                        <p class="text-xs font-semibold text-red-700 mt-2">- Uso de Cr√©dito:</p>
                        
                        <div class="flex justify-between items-center text-xs bg-red-50 px-2 py-1 rounded ml-2 border border-red-200">
                            <span class="text-red-700">‚Ä¢ Pagos a sesiones con cr√©dito:</span>
                            <span class="font-bold text-red-700">Bs. {{ cuenta.pagos_sesiones_credito|floatformat:2 }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs bg-red-50 px-2 py-1 rounded ml-2 border border-red-200">
                            <span class="text-red-700">üí≥ Pagos a mensualidades con cr√©dito:</span>
                            <span class="font-bold text-red-700">Bs. {{ cuenta.pagos_mensualidades_credito|floatformat:2 }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs bg-red-50 px-2 py-1 rounded ml-2 border border-red-200">
                            <span class="text-red-700">üì¶ Pagos a proyectos con cr√©dito:</span>
                            <span class="font-bold text-red-700">Bs. {{ cuenta.pagos_proyectos_credito|floatformat:2 }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs bg-red-100 px-2 py-1 rounded ml-2 border border-red-300">
                            <span class="text-red-800 font-bold">TOTAL CR√âDITO USADO:</span>
                            <span class="font-black text-red-800">Bs. {{ cuenta.uso_credito|floatformat:2 }}</span>
                        </div>
                        
                        <!-- SALDO FINAL -->
                        <div class="h-px bg-gray-300 my-1"></div>
                        
                        <div class="flex justify-between items-center text-xs bg-blue-50 px-2 py-1 rounded border border-blue-300">
                            <span class="text-blue-900 font-black">CR√âDITO DISPONIBLE:</span>
                            <span class="font-black text-blue-700 text-base">Bs. {{ cuenta.pagos_adelantados|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
                
                </div><!-- Fin detalle desplegable Tarjeta 3 -->
            </div>
        </div>

    </div>

    <!-- ========================================
         TABS PRINCIPALES
         ======================================== -->
    <div class="bg-white border-2 border-gray-300 rounded-lg shadow-md overflow-hidden">
        
        <!-- Navegaci√≥n de Tabs -->
        <div class="border-b border-gray-200 bg-gray-50">
            <nav class="flex -mb-px overflow-x-auto">
                <button id="tab-registros-cobros" onclick="cambiarPestana('registros-cobros'); mostrarTab('registros-cobros')"
                        class="tab-btn px-6 py-3 text-sm font-bold border-b whitespace-nowrap border-blue-600 text-blue-600 bg-blue-50">
                    üìã Registros de Cobros
                </button>
                <button id="tab-pagos-validos" onclick="cambiarPestana('pagos-validos'); mostrarTab('pagos-validos')"
                        class="tab-btn px-6 py-3 text-sm font-bold border-b whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    üíµ Pagos al Contado
                </button>
                <button id="tab-pagos-credito" onclick="cambiarPestana('pagos-credito'); mostrarTab('pagos-credito')" 
                        class="tab-btn px-6 py-3 text-sm font-bold border-b whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    üí≥ Pagos con Cr√©dito
                </button>
                <button id="tab-pagos-anulados" onclick="cambiarPestana('pagos-anulados'); mostrarTab('pagos-anulados')"
                        class="tab-btn px-6 py-3 text-sm font-bold border-b whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    ‚ùå Pagos Anulados
                </button>
            </nav>
        </div>

        <!-- ========================================
             TAB 1: REGISTROS DE COBROS
             ======================================== -->
        <div id="content-registros-cobros" class="tab-content">
            <div class="p-4">
                
                <!-- ==================== CONTADOR DE REGISTROS ENCONTRADOS ==================== -->
                <div class="mb-2">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-300 rounded-lg p-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg">
                                    üìä
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-gray-600 uppercase tracking-wide">
                                        Registros Encontrados
                                    </div>
                                    <div class="text-[10px] text-gray-500 mt-0.5">
                                        Seg√∫n filtros aplicados
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-blue-700" id="contador-total-registros">
                                    {{ registros_cobros.paginator.count|default:0 }}
                                </div>
                                <div class="text-[10px] text-gray-600 font-medium mt-0.5">
                                    registro{{ registros_cobros.paginator.count|pluralize }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== FILTROS MEJORADOS ==================== -->
                <div class="mb-2 bg-blue-50 border border-blue-200 rounded-lg p-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                        
                        <!-- Filtro por Tipo de Concepto -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üìã Tipo:
                            </label>
                            <select id="filtro_tipo_concepto" 
                                    name="tipo_concepto"
                                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="todos" {% if request.GET.tipo_concepto == 'todos' or not request.GET.tipo_concepto %}selected{% endif %}>
                                    Todos
                                </option>
                                <option value="sesiones" {% if request.GET.tipo_concepto == 'sesiones' %}selected{% endif %}>
                                    üßò Sesiones Normales
                                </option>
                                <option value="proyectos" {% if request.GET.tipo_concepto == 'proyectos' %}selected{% endif %}>
                                    üì¶ Proyectos
                                </option>
                                <option value="mensualidades" {% if request.GET.tipo_concepto == 'mensualidades' %}selected{% endif %}>
                                    üí≥ Mensualidades
                                </option>
                            </select>
                        </div>
                        
                        <!-- Filtro por Estado del Servicio (din√°mico seg√∫n tipo) -->
                        <div id="contenedor-filtro-estado-servicio">
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üîÑ Estado:
                            </label>
                            <select id="filtro_estado_servicio" 
                                    name="estado_servicio"
                                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="todos">Todos</option>
                                
                                {# Opciones para SESIONES #}
                                <optgroup label="--- Sesiones ---" id="optgroup-sesiones" {% if request.GET.tipo_concepto != 'sesiones' and request.GET.tipo_concepto != 'todos' %}style="display: none;"{% endif %}>
                                    <option value="programada" {% if request.GET.estado_servicio == 'programada' %}selected{% endif %}>
                                        üìÖ Programada
                                    </option>
                                    <option value="realizada" {% if request.GET.estado_servicio == 'realizada' %}selected{% endif %}>
                                        ‚úÖ Realizada
                                    </option>
                                    <option value="realizada_retraso" {% if request.GET.estado_servicio == 'realizada_retraso' %}selected{% endif %}>
                                        ‚è∞ Realizada con Retraso
                                    </option>
                                    <option value="falta" {% if request.GET.estado_servicio == 'falta' %}selected{% endif %}>
                                        ‚ùå Falta sin Aviso
                                    </option>
                                    <option value="permiso" {% if request.GET.estado_servicio == 'permiso' %}selected{% endif %}>
                                        üîî Permiso (con aviso)
                                    </option>
                                    <option value="cancelada" {% if request.GET.estado_servicio == 'cancelada' %}selected{% endif %}>
                                        üö´ Cancelada
                                    </option>
                                    <option value="reprogramada" {% if request.GET.estado_servicio == 'reprogramada' %}selected{% endif %}>
                                        üîÑ Reprogramada
                                    </option>
                                </optgroup>
                                
                                {# Opciones para PROYECTOS #}
                                <optgroup label="--- Proyectos ---" id="optgroup-proyectos" {% if request.GET.tipo_concepto != 'proyectos' and request.GET.tipo_concepto != 'todos' %}style="display: none;"{% endif %}>
                                    <option value="planificado" {% if request.GET.estado_servicio == 'planificado' %}selected{% endif %}>
                                        üìã Planificado
                                    </option>
                                    <option value="en_progreso" {% if request.GET.estado_servicio == 'en_progreso' %}selected{% endif %}>
                                        üîÑ En Progreso
                                    </option>
                                    <option value="finalizado" {% if request.GET.estado_servicio == 'finalizado' %}selected{% endif %}>
                                        ‚úÖ Finalizado
                                    </option>
                                    <option value="cancelado" {% if request.GET.estado_servicio == 'cancelado' %}selected{% endif %}>
                                        üö´ Cancelado
                                    </option>
                                </optgroup>
                                
                                {# Opciones para MENSUALIDADES #}
                                <optgroup label="--- Mensualidades ---" id="optgroup-mensualidades" {% if request.GET.tipo_concepto != 'mensualidades' and request.GET.tipo_concepto != 'todos' %}style="display: none;"{% endif %}>
                                    <option value="activa" {% if request.GET.estado_servicio == 'activa' %}selected{% endif %}>
                                        ‚úÖ Activa
                                    </option>
                                    <option value="vencida" {% if request.GET.estado_servicio == 'vencida' %}selected{% endif %}>
                                        ‚è∞ Vencida
                                    </option>
                                    <option value="pausada" {% if request.GET.estado_servicio == 'pausada' %}selected{% endif %}>
                                        ‚è∏Ô∏è Pausada
                                    </option>
                                    <option value="completada" {% if request.GET.estado_servicio == 'completada' %}selected{% endif %}>
                                        ‚úÖ Completada
                                    </option>
                                    <option value="cancelada_mens" {% if request.GET.estado_servicio == 'cancelada_mens' %}selected{% endif %}>
                                        üö´ Cancelada
                                    </option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- Filtro por Estado de Pago -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üí∞ Pago:
                            </label>
                            <select id="filtro_estado_pago" 
                                    name="estado_pago"
                                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="todos" {% if request.GET.estado_pago == 'todos' or not request.GET.estado_pago %}selected{% endif %}>
                                    Todos
                                </option>
                                <option value="pendiente" {% if request.GET.estado_pago == 'pendiente' %}selected{% endif %}>
                                    ‚ö†Ô∏è Pendiente de Pago
                                </option>
                                <option value="pagado" {% if request.GET.estado_pago == 'pagado' %}selected{% endif %}>
                                    ‚úÖ Pagado Completamente
                                </option>
                            </select>
                        </div>
                        
                        <!-- Mostrar Programadas/Planificados -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üëÅÔ∏è Ver:
                            </label>
                            <div class="flex items-center h-7 px-2 py-1 bg-white border border-gray-300 rounded">
                                <input type="checkbox" 
                                       id="mostrar_programadas" 
                                       name="mostrar_programadas"
                                       {% if request.GET.mostrar_programadas != 'false' %}checked{% endif %}
                                       class="w-3 h-3 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="mostrar_programadas" class="ml-1.5 text-[10px] text-gray-700">
                                    Programadas
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtros de Fechas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-1.5 mt-1.5">
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üìÖ Desde:
                            </label>
                            <input type="date" 
                                   id="fecha_desde_registros" 
                                   name="fecha_desde" 
                                   value="{{ request.GET.fecha_desde_registros }}"
                                   class="w-full px-1.5 py-0.5 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üìÖ Hasta:
                            </label>
                            <input type="date" 
                                   id="fecha_hasta_registros" 
                                   name="fecha_hasta" 
                                   value="{{ request.GET.fecha_hasta_registros }}"
                                   class="w-full px-1.5 py-0.5 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="grid grid-cols-2 gap-1.5 mt-1.5">
                        <button onclick="aplicarFiltrosRegistrosMejorados()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-[10px] font-bold transition-colors shadow-sm hover:shadow-md">
                            üîç Aplicar
                        </button>
                        <button onclick="limpiarFiltrosRegistros()" 
                                class="w-full bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-[10px] font-bold transition-colors shadow-sm hover:shadow-md">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>

                <!-- ==================== TABLA DE REGISTROS ==================== -->
                <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-600">
                            <tr>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Servicio
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Fecha
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Estado Servicio
                                </th>
                                <th class="px-2 py-1.5 text-right text-[10px] font-bold text-white uppercase tracking-wider">
                                    <div>Costo</div>
                                    <!-- Suma total din√°mica -->
                                    <div class="text-yellow-300 font-black text-xs mt-0.5">
                                        Total: Bs. <span id="suma-total-registros">{{ suma_total_registros|floatformat:2|default:"0.00" }}</span>
                                    </div>
                                </th>
                                <th class="px-2 py-1.5 text-center text-[10px] font-bold text-white uppercase tracking-wider">
                                    <div class="mb-0.5">Estado de Pago</div>
                                    <!-- Sumas din√°micas de pagos -->
                                    <div class="space-y-0.5">
                                        <div class="text-green-300 font-black text-[10px]">
                                            ‚úÖ Pagado: Bs. <span id="suma-pagado-registros">{{ suma_pagado_registros|floatformat:2|default:"0.00" }}</span>
                                        </div>
                                        <div class="text-orange-300 font-black text-[10px]">
                                            ‚ö†Ô∏è Pendiente: Bs. <span id="suma-pendientes-registros">{{ suma_pendientes_registros|floatformat:2|default:"0.00" }}</span>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-2 py-1.5 text-center text-[10px] font-bold text-white uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for registro in registros_cobros %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <!-- Tipo -->
                                <td class="px-2 py-1.5 whitespace-nowrap">
                                    {% if registro.tipo == 'sesion' %}
                                        <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-purple-100 text-purple-700 border border-purple-300">
                                            üßò Sesi√≥n
                                        </span>
                                    {% elif registro.tipo == 'proyecto' %}
                                        <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700 border border-blue-300">
                                            üì¶ Proyecto
                                        </span>
                                    {% elif registro.tipo == 'mensualidad' %}
                                        <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-indigo-100 text-indigo-700 border border-indigo-300">
                                            üí≥ Mensualidad
                                        </span>
                                    {% endif %}
                                </td>
                                
                                <!-- Servicio -->
                                <td class="px-2 py-1.5">
                                    <div class="text-sm font-medium text-gray-900">
                                        {% if registro.tipo == 'sesion' %}
                                            {{ registro.objeto.servicio.nombre }}
                                            <div class="text-xs text-gray-500">
                                                {{ registro.objeto.profesional.nombre }}
                                            </div>
                                        {% elif registro.tipo == 'proyecto' %}
                                            {{ registro.objeto.nombre }}
                                            <div class="text-xs text-gray-500">
                                                {{ registro.objeto.codigo }}
                                            </div>
                                        {% elif registro.tipo == 'mensualidad' %}
                                            {{ registro.objeto.servicios_simple|default:"M√∫ltiples servicios" }}
                                            <div class="text-xs text-gray-500">
                                                {{ registro.objeto.periodo_display }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                                
                                <!-- Fecha -->
                                <td class="px-2 py-1.5 whitespace-nowrap text-sm text-gray-900">
                                    {% if registro.tipo == 'sesion' %}
                                        {{ registro.objeto.fecha|date:"d/m/Y" }}
                                        <div class="text-xs text-gray-500">
                                            {{ registro.objeto.hora_inicio|time:"H:i" }}
                                        </div>
                                    {% elif registro.tipo == 'proyecto' %}
                                        {{ registro.objeto.fecha_inicio|date:"d/m/Y" }}
                                        {% if registro.objeto.fecha_fin_real %}
                                            <div class="text-xs text-gray-500">
                                                Fin: {{ registro.objeto.fecha_fin_real|date:"d/m/Y" }}
                                            </div>
                                        {% endif %}
                                    {% elif registro.tipo == 'mensualidad' %}
                                        {{ registro.objeto.mes|stringformat:"02d" }}/{{ registro.objeto.anio }}
                                    {% endif %}
                                </td>
                                
                                <!-- Estado del Servicio -->
                                <td class="px-2 py-1.5 whitespace-nowrap">
                                    {% if registro.tipo == 'sesion' %}
                                        {% if registro.objeto.estado == 'programada' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700">
                                                üìÖ Programada
                                            </span>
                                        {% elif registro.objeto.estado == 'realizada' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-green-100 text-green-700">
                                                ‚úÖ Realizada
                                            </span>
                                        {% elif registro.objeto.estado == 'realizada_retraso' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-yellow-100 text-yellow-700">
                                                ‚è∞ Con Retraso
                                            </span>
                                        {% elif registro.objeto.estado == 'falta' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-red-100 text-red-700">
                                                ‚ùå Falta
                                            </span>
                                        {% elif registro.objeto.estado == 'permiso' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-orange-100 text-orange-700">
                                                üîî Permiso
                                            </span>
                                        {% elif registro.objeto.estado == 'cancelada' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-gray-100 text-gray-700">
                                                üö´ Cancelada
                                            </span>
                                        {% elif registro.objeto.estado == 'reprogramada' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-purple-100 text-purple-700">
                                                üîÑ Reprogramada
                                            </span>
                                        {% endif %}
                                    {% elif registro.tipo == 'proyecto' %}
                                        {% if registro.objeto.estado == 'planificado' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-amber-100 text-amber-700">
                                                üìã Planificado
                                            </span>
                                        {% elif registro.objeto.estado == 'en_progreso' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700">
                                                üîÑ En Progreso
                                            </span>
                                        {% elif registro.objeto.estado == 'finalizado' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-green-100 text-green-700">
                                                ‚úÖ Finalizado
                                            </span>
                                        {% elif registro.objeto.estado == 'cancelado' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-gray-100 text-gray-700">
                                                üö´ Cancelado
                                            </span>
                                        {% endif %}
                                    {% elif registro.tipo == 'mensualidad' %}
                                        {% if registro.objeto.estado == 'activa' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-green-100 text-green-700">
                                                ‚úÖ Activa
                                            </span>
                                        {% elif registro.objeto.estado == 'vencida' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-red-100 text-red-700">
                                                ‚è∞ Vencida
                                            </span>
                                        {% elif registro.objeto.estado == 'pausada' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-yellow-100 text-yellow-700">
                                                ‚è∏Ô∏è Pausada
                                            </span>
                                        {% elif registro.objeto.estado == 'completada' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700">
                                                ‚úÖ Completada
                                            </span>
                                        {% elif registro.objeto.estado == 'cancelada' %}
                                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-gray-100 text-gray-700">
                                                üö´ Cancelada
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                
                                <!-- Costo -->
                                <td class="px-2 py-1.5 whitespace-nowrap text-right">
                                    <span class="text-sm font-bold text-gray-900">Bs. {{ registro.costo|floatformat:2 }}</span>
                                    {% if registro.tipo == 'sesion' and registro.objeto.monto_original and registro.objeto.monto_original != registro.objeto.monto_cobrado %}
                                        <div class="text-[10px] text-orange-500 font-semibold line-through">
                                            Bs. {{ registro.objeto.monto_original|floatformat:2 }}
                                        </div>
                                        <div class="text-[9px] text-orange-400 font-medium">precio inicial</div>
                                    {% elif registro.tipo == 'proyecto' and registro.objeto.costo_original and registro.objeto.costo_original != registro.objeto.costo_total %}
                                        <div class="text-[10px] text-orange-500 font-semibold line-through">
                                            Bs. {{ registro.objeto.costo_original|floatformat:2 }}
                                        </div>
                                        <div class="text-[9px] text-orange-400 font-medium">precio inicial</div>
                                    {% elif registro.tipo == 'mensualidad' and registro.objeto.costo_original and registro.objeto.costo_original != registro.objeto.costo_mensual %}
                                        <div class="text-[10px] text-orange-500 font-semibold line-through">
                                            Bs. {{ registro.objeto.costo_original|floatformat:2 }}
                                        </div>
                                        <div class="text-[9px] text-orange-400 font-medium">precio inicial</div>
                                    {% endif %}
                                </td>
                                
                                <!-- Estado de Pago -->
                                <td class="px-2 py-1.5 whitespace-nowrap text-center">
                                    {% if registro.pagado_completo %}
                                        <span class="px-3 py-1 text-[10px] font-bold rounded-full bg-green-100 text-green-800 border border-green-300">
                                            ‚úÖ Pagado
                                        </span>
                                        <div class="text-xs text-gray-500 mt-1">
                                            Bs. {{ registro.pagado|floatformat:2 }}
                                        </div>
                                        {% if registro.tipo == 'sesion' %}
                                            {# Pagos directos #}
                                            {% for pago in registro.objeto.pagos.all %}
                                                {% if not pago.anulado %}
                                                    <div class="text-[10px] text-blue-600 font-semibold mt-0.5">
                                                        {{ pago.metodo_pago.nombre }} - Bs. {{ pago.monto|floatformat:2 }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                            {# Pagos masivos #}
                                            {% for detalle in registro.pagos_masivos %}
                                                <div class="text-[10px] text-purple-600 font-semibold mt-0.5">
                                                    üí∞ {{ detalle.pago.metodo_pago.nombre }} - Bs. {{ detalle.monto|floatformat:2 }}
                                                </div>
                                            {% endfor %}
                                        {% elif registro.tipo == 'proyecto' %}
                                            {# Pagos directos #}
                                            {% for pago in registro.objeto.pagos.all %}
                                                {% if not pago.anulado %}
                                                    <div class="text-[10px] text-blue-600 font-semibold mt-0.5">
                                                        {{ pago.metodo_pago.nombre }} - Bs. {{ pago.monto|floatformat:2 }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                            {# Pagos masivos #}
                                            {% for detalle in registro.pagos_masivos %}
                                                <div class="text-[10px] text-purple-600 font-semibold mt-0.5">
                                                    üí∞ {{ detalle.pago.metodo_pago.nombre }} - Bs. {{ detalle.monto|floatformat:2 }}
                                                </div>
                                            {% endfor %}
                                        {% elif registro.tipo == 'mensualidad' %}
                                            {# Pagos directos #}
                                            {% for pago in registro.objeto.pagos.all %}
                                                {% if not pago.anulado %}
                                                    <div class="text-[10px] text-blue-600 font-semibold mt-0.5">
                                                        {{ pago.metodo_pago.nombre }} - Bs. {{ pago.monto|floatformat:2 }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                            {# Pagos masivos #}
                                            {% for detalle in registro.pagos_masivos %}
                                                <div class="text-[10px] text-purple-600 font-semibold mt-0.5">
                                                    üí∞ {{ detalle.pago.metodo_pago.nombre }} - Bs. {{ detalle.monto|floatformat:2 }}
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    {% else %}
                                        <span class="px-3 py-1 text-[10px] font-bold rounded-full bg-orange-100 text-orange-800 border border-orange-300">
                                            ‚ö†Ô∏è Pendiente
                                        </span>
                                        <div class="text-xs text-gray-500 mt-1">
                                            Pagado: Bs. {{ registro.pagado|floatformat:2 }}
                                        </div>
                                        <div class="text-[10px] font-bold text-orange-600">
                                            Debe: Bs. {{ registro.saldo|floatformat:2 }}
                                        </div>
                                        {% if registro.pagado > 0 %}
                                            {% if registro.tipo == 'sesion' %}
                                                {# Pagos directos #}
                                                {% for pago in registro.objeto.pagos.all %}
                                                    {% if not pago.anulado %}
                                                        <div class="text-[10px] text-blue-600 font-semibold mt-0.5">
                                                            {{ pago.metodo_pago.nombre }} - Bs. {{ pago.monto|floatformat:2 }}
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                                {# Pagos masivos #}
                                                {% for detalle in registro.pagos_masivos %}
                                                    <div class="text-[10px] text-purple-600 font-semibold mt-0.5">
                                                        üí∞ {{ detalle.pago.metodo_pago.nombre }} - Bs. {{ detalle.monto|floatformat:2 }}
                                                    </div>
                                                {% endfor %}
                                            {% elif registro.tipo == 'proyecto' %}
                                                {# Pagos directos #}
                                                {% for pago in registro.objeto.pagos.all %}
                                                    {% if not pago.anulado %}
                                                        <div class="text-[10px] text-blue-600 font-semibold mt-0.5">
                                                            {{ pago.metodo_pago.nombre }} - Bs. {{ pago.monto|floatformat:2 }}
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                                {# Pagos masivos #}
                                                {% for detalle in registro.pagos_masivos %}
                                                    <div class="text-[10px] text-purple-600 font-semibold mt-0.5">
                                                        üí∞ {{ detalle.pago.metodo_pago.nombre }} - Bs. {{ detalle.monto|floatformat:2 }}
                                                    </div>
                                                {% endfor %}
                                            {% elif registro.tipo == 'mensualidad' %}
                                                {# Pagos directos #}
                                                {% for pago in registro.objeto.pagos.all %}
                                                    {% if not pago.anulado %}
                                                        <div class="text-[10px] text-blue-600 font-semibold mt-0.5">
                                                            {{ pago.metodo_pago.nombre }} - Bs. {{ pago.monto|floatformat:2 }}
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                                {# Pagos masivos #}
                                                {% for detalle in registro.pagos_masivos %}
                                                    <div class="text-[10px] text-purple-600 font-semibold mt-0.5">
                                                        üí∞ {{ detalle.pago.metodo_pago.nombre }} - Bs. {{ detalle.monto|floatformat:2 }}
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </td>
                                
                                <!-- Acciones -->
                                <td class="px-2 py-1.5 whitespace-nowrap text-center">
                                    <div class="flex flex-col gap-2">
                                        <!-- Bot√≥n Pagar (solo si no est√° pagado completamente) -->
                                        {% if not registro.pagado_completo %}
                                            {% if registro.tipo == 'sesion' %}
                                                <a href="{% url 'facturacion:registrar_pago' %}?sesion={{ registro.objeto.id }}" 
                                                   class="inline-block bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-[10px] font-bold transition-colors">
                                                    üíµ Pagar
                                                </a>
                                            {% elif registro.tipo == 'proyecto' %}
                                                <a href="{% url 'facturacion:registrar_pago' %}?proyecto={{ registro.objeto.id }}" 
                                                   class="inline-block bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-[10px] font-bold transition-colors">
                                                    üíµ Pagar
                                                </a>
                                            {% elif registro.tipo == 'mensualidad' %}
                                                <a href="{% url 'facturacion:registrar_pago' %}?mensualidad={{ registro.objeto.id }}" 
                                                   class="inline-block bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-[10px] font-bold transition-colors">
                                                    üíµ Pagar
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <!-- Bot√≥n Ver Detalle -->
                                        {% if registro.tipo == 'sesion' %}
                                            <button 
                                                hx-get="{% url 'facturacion:detalle_sesion_partial' registro.objeto.id %}"
                                                hx-target="#modal-detalle-sesion-content-{{ registro.objeto.id }}"
                                                hx-swap="innerHTML"
                                                onclick="document.getElementById('modal-detalle-sesion-{{ registro.objeto.id }}').classList.remove('hidden'); document.getElementById('modal-detalle-sesion-{{ registro.objeto.id }}').classList.add('flex');"
                                                class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-[10px] font-bold transition-colors">
                                                üìÑ Ver Detalle
                                            </button>
                                        {% elif registro.tipo == 'mensualidad' %}
                                            <a href="{% url 'agenda:detalle_mensualidad' registro.objeto.id %}" 
                                               class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-[10px] font-bold transition-colors">
                                                üìÑ Ver Detalle
                                            </a>
                                        {% elif registro.tipo == 'proyecto' %}
                                            <a href="{% url 'agenda:detalle_proyecto' registro.objeto.id %}" 
                                               class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-[10px] font-bold transition-colors">
                                                üìÑ Ver Detalle
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                    <div class="text-4xl mb-3">üì≠</div>
                                    <p class="text-base font-medium">No hay registros de cobros</p>
                                    <p class="text-sm text-gray-400 mt-1">Intenta cambiar los filtros</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginaci√≥n -->
                {% if registros_cobros.has_other_pages %}
                <div class="mt-4 px-2 py-1.5 bg-gray-50 border rounded-lg flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Mostrando {{ registros_cobros.start_index }} - {{ registros_cobros.end_index }} de {{ registros_cobros.paginator.count }}
                    </div>
                    <div class="flex gap-2">
                        {% if registros_cobros.has_previous %}
                            <a href="?page={{ registros_cobros.previous_page_number }}{{ filtros_url }}" 
                               class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50 text-sm font-medium transition-colors shadow-sm">
                                ‚Üê Anterior
                            </a>
                        {% endif %}
                        {% if registros_cobros.has_next %}
                            <a href="?page={{ registros_cobros.next_page_number }}{{ filtros_url }}" 
                               class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50 text-sm font-medium transition-colors shadow-sm">
                                Siguiente ‚Üí
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Modales para detalle de sesiones -->
                {% for registro in registros_cobros %}
                    {% if registro.tipo == 'sesion' %}
                    <!-- Modal Detalle Sesi√≥n {{ registro.objeto.id }} -->
                    <div id="modal-detalle-sesion-{{ registro.objeto.id }}" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg rounded-md bg-white">
                            <div class="flex justify-between items-center mb-4 pb-3 border-b">
                                <h3 class="text-lg font-bold text-gray-900">üìã Detalle de Sesi√≥n</h3>
                                <button onclick="document.getElementById('modal-detalle-sesion-{{ registro.objeto.id }}').classList.add('hidden'); document.getElementById('modal-detalle-sesion-{{ registro.objeto.id }}').classList.remove('flex');" 
                                        class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                    √ó
                                </button>
                            </div>
                            
                            <!-- Contenido cargado con HTMX -->
                            <div id="modal-detalle-sesion-content-{{ registro.objeto.id }}" class="overflow-y-auto max-h-[70vh]">
                                <div class="text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    <p class="text-sm text-gray-600 mt-2">Cargando detalle...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- ========================================
             TAB 2: PAGOS AL CONTADO
             ======================================== -->
        <div id="content-pagos-validos" class="tab-content hidden">
            <div class="p-4">
                
                <!-- ==================== CONTADOR DE REGISTROS ENCONTRADOS ==================== -->
                <div class="mb-2">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-300 rounded-lg p-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg">
                                    üíµ
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-gray-600 uppercase tracking-wide">
                                        Registros Encontrados
                                    </div>
                                    <div class="text-[10px] text-gray-500 mt-0.5">
                                        Seg√∫n filtros aplicados
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-green-700">
                                    {{ pagos_validos.paginator.count|default:0 }}
                                </div>
                                <div class="text-[10px] text-gray-600 font-medium mt-0.5">
                                    registro{{ pagos_validos.paginator.count|pluralize }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros Mejorados -->
                <div class="mb-2 bg-green-50 border border-green-200 rounded-lg p-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-1.5">
                        
                        <!-- Filtro por tipo -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üìã Filtrar por:
                            </label>
                            <select id="filtro_tipo_validos"
                                    name="filtro_tipo_validos"
                                     
                                    class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-green-500">
                                <option value="todos" {% if filtro_tipo_validos == 'todos' or not filtro_tipo_validos %}selected{% endif %}>
                                    üìã Todos
                                </option>
                                <option value="sesiones" {% if filtro_tipo_validos == 'sesiones' %}selected{% endif %}>
                                    üßò Sesiones Normales
                                </option>
                                <option value="proyectos" {% if filtro_tipo_validos == 'proyectos' %}selected{% endif %}>
                                    üì¶ Proyectos
                                </option>
                                <option value="mensualidades" {% if filtro_tipo_validos == 'mensualidades' %}selected{% endif %}>
                                    üí≥ Mensualidades
                                </option>
                                <option value="adelantados" {% if filtro_tipo_validos == 'adelantados' %}selected{% endif %}>
                                    üíµ Pagos Adelantados
                                </option>
                                <option value="devoluciones" {% if filtro_tipo_validos == 'devoluciones' %}selected{% endif %}>
                                    üîÑ Devoluciones
                                </option>
                            </select>
                        </div>

                        <!-- Filtro por m√©todo de pago -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üí≥ M√©todo de Pago:
                            </label>
                            <select id="filtro_metodo_validos"
                                    name="filtro_metodo_validos"
                                     
                                    class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-green-500">
                                <option value="todos" {% if filtro_metodo_validos == 'todos' or not filtro_metodo_validos %}selected{% endif %}>
                                    Todos
                                </option>
                                <option value="efectivo" {% if filtro_metodo_validos == 'efectivo' %}selected{% endif %}>
                                    üíµ Efectivo
                                </option>
                                <option value="qr" {% if filtro_metodo_validos == 'qr' %}selected{% endif %}>
                                    üì± QR
                                </option>
                                <option value="transferencia" {% if filtro_metodo_validos == 'transferencia' %}selected{% endif %}>
                                    üè¶ Transferencia
                                </option>
                                <option value="sin cobro" {% if filtro_metodo_validos == 'sin cobro' %}selected{% endif %}>
                                    üéÅ Sin Cobro
                                </option>
                            </select>
                        </div>

                        <!-- Filtro de fechas -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">üìÖ Fecha desde:</label>
                            <input type="date" id="fecha_desde_validos" name="fecha_desde" 
                                   value="{{ request.GET.fecha_desde_validos }}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">üìÖ Fecha hasta:</label>
                            <input type="date" id="fecha_hasta_validos" name="fecha_hasta" 
                                   value="{{ request.GET.fecha_hasta_validos }}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-green-500">
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="mt-1.5 flex gap-2">
                        <button onclick="aplicarFiltrosValidos()" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-bold transition-colors">
                            üîç Aplicar Filtros
                        </button>
                        <button onclick="limpiarFiltrosValidos()" 
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-sm font-bold transition-colors">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>

                <!-- Tabla de Pagos -->
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gradient-to-r from-green-700 to-green-800">
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Recibo
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Concepto
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Fecha
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    M√©todo
                                </th>
                                <th class="px-2 py-1.5 text-right text-[10px] font-bold text-white uppercase tracking-wider">
                                    <!-- ‚úÖ Mostrar desglose de totales compacto -->
                                    <div class="text-yellow-300 font-black text-xs">
                                        <div class="text-[9px]">Pagos: {{ suma_pagos_validos|floatformat:2|default:"0.00" }}</div>
                                        <div class="text-red-300 text-[9px]">Devol: -{{ suma_devoluciones|floatformat:2|default:"0.00" }}</div>
                                        <div class="border-t border-yellow-300 pt-0.5 mt-0.5 text-[10px]">
                                            Pago Neto: {{ suma_total_validos|floatformat:2|default:"0.00" }}
                                        </div>
                                    </div>
                                </th>
                                <th class="px-2 py-1.5 text-center text-[10px] font-bold text-white uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in pagos_validos %}
                            <!-- ‚úÖ Diferenciar entre pago y devoluci√≥n -->
                            {% if item.tipo == 'pago' %}
                                <!-- MOSTRAR PAGO -->
                                <tr class="hover:bg-gray-50 {% if item.es_masivo %}border-l-4 border-l-blue-500 bg-blue-50{% endif %}">
                                    <td class="px-2 py-1.5 whitespace-nowrap">
                                        <div class="flex items-center gap-2">
                                            <!-- Bot√≥n expandir/contraer para pagos masivos -->
                                            {% if item.es_masivo %}
                                            <button 
                                                onclick="toggleDetallePagoMasivo('detalle-masivo-{{ item.objeto.id }}')"
                                                class="btn-desplegable text-blue-600 hover:text-blue-800 transition-colors focus:outline-none"
                                                title="Ver detalles del pago masivo">
                                                <svg class="icono-flecha w-5 h-5 transition-transform duration-300" id="icono-detalle-masivo-{{ item.objeto.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            {% endif %}
                                            <span class="text-sm font-bold text-gray-900">{{ item.numero }}</span>
                                        </div>
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap">
                                        {% if item.es_masivo %}
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs">üì¶ Pago Masivo</span>
                                                <span class="px-2 py-0.5 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700 border border-blue-300">
                                                    {{ item.cantidad_detalles }} √≠tems
                                                </span>
                                            </div>
                                        {% elif item.objeto.sesion %}
                                            <span class="text-xs">üßò Sesi√≥n Normal</span>
                                        {% elif item.objeto.proyecto %}
                                            <span class="text-xs">üì¶ Proyecto</span>
                                        {% elif item.objeto.mensualidad %}
                                            <span class="text-xs">üí≥ Mensualidad</span>
                                        {% else %}
                                            <span class="text-xs">üíµ Pago Adelantado</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-2 py-1.5">
                                        <div class="text-sm text-gray-900">{{ item.concepto|truncatewords:8 }}</div>
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap text-sm text-gray-900">
                                        {{ item.fecha|date:"d/m/Y" }}
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap text-sm text-gray-900">
                                        {{ item.metodo }}
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap text-right text-sm font-bold text-green-600">
                                        Bs. {{ item.monto|floatformat:2 }}
                                    </td>
                                    <td class="px-2 py-1.5 text-center whitespace-nowrap">
                                        <div class="flex justify-center gap-2">
                                            <!-- Bot√≥n Ver Detalle -->
                                            <button 
                                                hx-get="{% url 'facturacion:detalle_pago_partial' item.objeto.id %}"
                                                hx-target="#modal-detalle-pago-content-{{ item.objeto.id }}"
                                                hx-swap="innerHTML"
                                                onclick="document.getElementById('modal-detalle-pago-{{ item.objeto.id }}').classList.remove('hidden'); document.getElementById('modal-detalle-pago-{{ item.objeto.id }}').classList.add('flex');"
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-[10px] font-bold">
                                                üëÅÔ∏è Ver Detalle
                                            </button>
                                            <!-- Bot√≥n PDF -->
                                            <a href="{% url 'facturacion:generar_recibo_pdf' item.objeto.id %}" 
                                               target="_blank"
                                               class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-md text-[10px] font-bold">
                                                üìÑ PDF
                                            </a>
                                            <!-- Bot√≥n Anular -->
                                            <button onclick="confirmarAnulacion({{ item.objeto.id }}, '{{ item.numero }}')" 
                                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-[10px] font-bold">
                                                ‚ùå Anular
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- ‚úÖ NUEVO: Fila expandible con detalles del pago masivo -->
                                {% if item.es_masivo %}
                                <tr id="detalle-masivo-{{ item.objeto.id }}" class="detalle-desplegable bg-gradient-to-r from-blue-50 to-indigo-50" style="border-left: 4px solid #3b82f6; display: none;">
                                    <td colspan="7" class="px-0 py-0">
                                        <div class="px-6 py-4">
                                            <div class="bg-white rounded-lg shadow-md border-2 border-blue-300 overflow-hidden">
                                                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2">
                                                    <h4 class="text-sm font-bold text-white flex items-center gap-2">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                        </svg>
                                                        Desglose del Pago Masivo ({{ item.cantidad_detalles }} √≠tem{{ item.cantidad_detalles|pluralize }})
                                                    </h4>
                                                </div>
                                                <div class="p-3">
                                                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                                                        <thead class="bg-blue-100">
                                                            <tr>
                                                                <th class="px-2 py-1 text-left text-[10px] font-bold text-blue-900 uppercase tracking-wider">Tipo</th>
                                                                <th class="px-2 py-1 text-left text-[10px] font-bold text-blue-900 uppercase tracking-wider">Descripci√≥n</th>
                                                                <th class="px-2 py-1 text-right text-[10px] font-bold text-blue-900 uppercase tracking-wider">Monto</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="bg-white divide-y divide-gray-200">
                                                            {% for detalle in item.objeto.detalles_masivos.all %}
                                                            <tr class="hover:bg-blue-50 transition-colors">
                                                                <td class="px-2 py-1 whitespace-nowrap">
                                                                    {% if detalle.tipo == 'sesion' %}
                                                                        <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-purple-100 text-purple-700 border border-purple-300">
                                                                            üßò Sesi√≥n
                                                                        </span>
                                                                    {% elif detalle.tipo == 'proyecto' %}
                                                                        <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700 border border-blue-300">
                                                                            üì¶ Proyecto
                                                                        </span>
                                                                    {% elif detalle.tipo == 'mensualidad' %}
                                                                        <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-indigo-100 text-indigo-700 border border-indigo-300">
                                                                            üí≥ Mensualidad
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="px-2 py-1 text-gray-900">
                                                                    {{ detalle.concepto }}
                                                                </td>
                                                                <td class="px-2 py-1 text-right font-bold text-green-600">
                                                                    Bs. {{ detalle.monto|floatformat:2 }}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                        <tfoot class="bg-blue-50 border-t-2 border-blue-200">
                                                            <tr>
                                                                <td colspan="2" class="px-2 py-1 text-right font-bold text-blue-900">
                                                                    TOTAL PAGADO:
                                                                </td>
                                                                <td class="px-2 py-1 text-right font-bold text-green-700 text-base">
                                                                    Bs. {{ item.monto|floatformat:2 }}
                                                                </td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            {% else %}
                                <!-- ‚úÖ MOSTRAR DEVOLUCI√ìN -->
                                <tr class="hover:bg-red-50 bg-red-50">
                                    <td class="px-2 py-1.5 whitespace-nowrap text-sm font-bold text-red-700">
                                        {{ item.numero }}
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap">
                                        {% if item.objeto.proyecto %}
                                            <span class="text-xs text-red-700">üîô Devoluci√≥n Proyecto</span>
                                        {% elif item.objeto.mensualidad %}
                                            <span class="text-xs text-red-700">üîô Devoluci√≥n Mensualidad</span>
                                        {% else %}
                                            <span class="text-xs text-red-700">üîô Devoluci√≥n Cr√©dito</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-2 py-1.5">
                                        <div class="text-sm text-red-700">{{ item.concepto|truncatewords:8 }}</div>
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap text-sm text-red-700">
                                        {{ item.fecha|date:"d/m/Y" }}
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap text-sm text-red-700">
                                        {{ item.metodo }}
                                    </td>
                                    <td class="px-2 py-1.5 whitespace-nowrap text-right text-sm font-bold text-red-600">
                                        -Bs. {{ item.objeto.monto|floatformat:2 }}
                                    </td>
                                    <td class="px-2 py-1.5 text-center whitespace-nowrap">
                                        <div class="flex justify-center gap-2">
                                            <!-- Bot√≥n PDF de Devoluci√≥n -->
                                            <a href="{% url 'facturacion:generar_devolucion_pdf' item.objeto.id %}" 
                                               target="_blank"
                                               class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-sm hover:shadow-md transition-all flex items-center gap-1">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                                </svg>
                                                PDF
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    <p class="text-sm">No hay pagos ni devoluciones registrados</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginaci√≥n -->
                {% if pagos_validos.has_other_pages %}
                <div class="px-2 py-1.5 bg-gray-50 border-t flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Mostrando {{ pagos_validos.start_index }} - {{ pagos_validos.end_index }} de {{ pagos_validos.paginator.count }}
                    </div>
                    <div class="flex gap-2">
                        {% if pagos_validos.has_previous %}
                            <a href="?page_validos={{ pagos_validos.previous_page_number }}{% if filtro_validos != 'todos' %}&filtro_validos={{ filtro_validos }}{% endif %}{% if request.GET.fecha_desde_validos %}&fecha_desde_validos={{ request.GET.fecha_desde_validos }}{% endif %}{% if request.GET.fecha_hasta_validos %}&fecha_hasta_validos={{ request.GET.fecha_hasta_validos }}{% endif %}" 
                               class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">Anterior</a>
                        {% endif %}
                        {% if pagos_validos.has_next %}
                            <a href="?page_validos={{ pagos_validos.next_page_number }}{% if filtro_validos != 'todos' %}&filtro_validos={{ filtro_validos }}{% endif %}{% if request.GET.fecha_desde_validos %}&fecha_desde_validos={{ request.GET.fecha_desde_validos }}{% endif %}{% if request.GET.fecha_hasta_validos %}&fecha_hasta_validos={{ request.GET.fecha_hasta_validos }}{% endif %}" 
                               class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">Siguiente</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Modales para detalle de pagos -->
                {% for item in pagos_validos %}
                    {% if item.tipo == 'pago' %}
                    <!-- Modal Detalle Pago {{ item.objeto.id }} -->
                    <div id="modal-detalle-pago-{{ item.objeto.id }}" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg rounded-md bg-white">
                            <div class="flex justify-between items-center mb-4 pb-3 border-b">
                                <h3 class="text-lg font-bold text-gray-900">üíµ Detalle de Pago</h3>
                                <button onclick="document.getElementById('modal-detalle-pago-{{ item.objeto.id }}').classList.add('hidden'); document.getElementById('modal-detalle-pago-{{ item.objeto.id }}').classList.remove('flex');" 
                                        class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                    √ó
                                </button>
                            </div>
                            
                            <!-- Contenido cargado con HTMX -->
                            <div id="modal-detalle-pago-content-{{ item.objeto.id }}" class="overflow-y-auto max-h-[70vh]">
                                <div class="text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                                    <p class="text-sm text-gray-600 mt-2">Cargando detalle del pago...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- ========================================
             TAB 3: PAGOS CON CR√âDITO
             ======================================== -->
        <div id="content-pagos-credito" class="tab-content hidden">
            <div class="p-4">
                
                <!-- ==================== CONTADOR DE REGISTROS ENCONTRADOS ==================== -->
                <div class="mb-2">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-300 rounded-lg p-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg">
                                    üí≥
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-gray-600 uppercase tracking-wide">
                                        Registros Encontrados
                                    </div>
                                    <div class="text-[10px] text-gray-500 mt-0.5">
                                        Seg√∫n filtros aplicados
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-blue-700">
                                    {{ pagos_credito.paginator.count|default:0 }}
                                </div>
                                <div class="text-[10px] text-gray-600 font-medium mt-0.5">
                                    registro{{ pagos_credito.paginator.count|pluralize }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros Mejorados -->
                <div class="mb-2 bg-blue-50 border border-blue-200 rounded-lg p-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-1.5">
                        
                        <!-- Filtro por tipo -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üìã Tipo:
                            </label>
                            <select id="filtro_tipo_credito"
                                    name="filtro_tipo_credito"
                                     
                                    class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-blue-500">
                                <option value="todos" {% if filtro_tipo_credito == 'todos' or not filtro_tipo_credito %}selected{% endif %}>
                                    üìã Todos
                                </option>
                                <option value="sesiones" {% if filtro_tipo_credito == 'sesiones' %}selected{% endif %}>
                                    üßò Sesiones Normales
                                </option>
                                <option value="proyectos" {% if filtro_tipo_credito == 'proyectos' %}selected{% endif %}>
                                    üì¶ Proyectos
                                </option>
                                <option value="mensualidades" {% if filtro_tipo_credito == 'mensualidades' %}selected{% endif %}>
                                    üí≥ Mensualidades
                                </option>
                                <option value="adelantados" {% if filtro_tipo_credito == 'adelantados' %}selected{% endif %}>
                                    üí∞ Adelantados
                                </option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">üìÖ Fecha desde:</label>
                            <input type="date" id="fecha_desde_credito" name="fecha_desde" 
                                   value="{{ request.GET.fecha_desde_credito }}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">üìÖ Fecha hasta:</label>
                            <input type="date" id="fecha_hasta_credito" name="fecha_hasta" 
                                   value="{{ request.GET.fecha_hasta_credito }}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="mt-1.5 flex gap-2">
                        <button onclick="aplicarFiltrosCredito()" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-bold transition-colors">
                            üîç Aplicar Filtros
                        </button>
                        <button onclick="limpiarFiltrosCredito()" 
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-sm font-bold transition-colors">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>

                <!-- Tabla de Pagos con Cr√©dito -->
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-600">
                            <tr>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Recibo
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Concepto
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Fecha
                                </th>
                                <th class="px-2 py-1.5 text-right text-[10px] font-bold text-white uppercase tracking-wider">
                                    <div>Monto</div>
                                    <!-- Suma total din√°mica -->
                                    <div class="text-yellow-300 font-black text-sm mt-1">
                                        Total: Bs. <span id="suma-total-credito">{{ suma_total_credito|floatformat:2|default:"0.00" }}</span>
                                    </div>
                                </th>
                                <th class="px-2 py-1.5 text-center text-[10px] font-bold text-white uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for pago in pagos_credito %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-2 py-1.5 whitespace-nowrap text-sm font-bold text-gray-900">
                                    {{ pago.numero_recibo }}
                                </td>
                                <td class="px-2 py-1.5 whitespace-nowrap">
                                    {% if pago.sesion %}
                                        <span class="text-xs">üßò Sesi√≥n Normal</span>
                                    {% elif pago.proyecto %}
                                        <span class="text-xs">üì¶ Proyecto</span>
                                    {% elif pago.mensualidad %}
                                        <span class="text-xs">üí≥ Mensualidad</span>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-1.5">
                                    <div class="text-sm text-gray-900">{{ pago.concepto|truncatewords:8 }}</div>
                                </td>
                                <td class="px-2 py-1.5 whitespace-nowrap text-sm text-gray-900">
                                    {{ pago.fecha_pago|date:"d/m/Y" }}
                                </td>
                                <td class="px-2 py-1.5 whitespace-nowrap text-right text-sm font-bold text-blue-600">
                                    Bs. {{ pago.monto|floatformat:2 }}
                                </td>
                                <td class="px-2 py-1.5 text-center whitespace-nowrap">
                                    <button 
                                        hx-get="{% url 'facturacion:detalle_pago_partial' pago.id %}"
                                        hx-target="#modal-detalle-pago-credito-content-{{ pago.id }}"
                                        hx-swap="innerHTML"
                                        onclick="document.getElementById('modal-detalle-pago-credito-{{ pago.id }}').classList.remove('hidden'); document.getElementById('modal-detalle-pago-credito-{{ pago.id }}').classList.add('flex');"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-[10px] font-bold">
                                        üëÅÔ∏è Ver Detalle
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                    <p class="text-sm">No hay pagos con cr√©dito</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginaci√≥n -->
                {% if pagos_credito.has_other_pages %}
                <div class="px-2 py-1.5 bg-gray-50 border-t flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Mostrando {{ pagos_credito.start_index }} - {{ pagos_credito.end_index }} de {{ pagos_credito.paginator.count }}
                    </div>
                    <div class="flex gap-2">
                        {% if pagos_credito.has_previous %}
                            <a href="?page_credito={{ pagos_credito.previous_page_number }}{% if request.GET.fecha_desde_credito %}&fecha_desde_credito={{ request.GET.fecha_desde_credito }}{% endif %}{% if request.GET.fecha_hasta_credito %}&fecha_hasta_credito={{ request.GET.fecha_hasta_credito }}{% endif %}" 
                               class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">Anterior</a>
                        {% endif %}
                        {% if pagos_credito.has_next %}
                            <a href="?page_credito={{ pagos_credito.next_page_number }}{% if request.GET.fecha_desde_credito %}&fecha_desde_credito={{ request.GET.fecha_desde_credito }}{% endif %}{% if request.GET.fecha_hasta_credito %}&fecha_hasta_credito={{ request.GET.fecha_hasta_credito }}{% endif %}" 
                               class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">Siguiente</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Modales para detalle de pagos con cr√©dito -->
                {% for pago in pagos_credito %}
                    <!-- Modal Detalle Pago Cr√©dito {{ pago.id }} -->
                    <div id="modal-detalle-pago-credito-{{ pago.id }}" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg rounded-md bg-white">
                            <div class="flex justify-between items-center mb-4 pb-3 border-b">
                                <h3 class="text-lg font-bold text-gray-900">üí≥ Detalle de Pago con Cr√©dito</h3>
                                <button onclick="document.getElementById('modal-detalle-pago-credito-{{ pago.id }}').classList.add('hidden'); document.getElementById('modal-detalle-pago-credito-{{ pago.id }}').classList.remove('flex');" 
                                        class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                    √ó
                                </button>
                            </div>
                            
                            <!-- Contenido cargado con HTMX -->
                            <div id="modal-detalle-pago-credito-content-{{ pago.id }}" class="overflow-y-auto max-h-[70vh]">
                                <div class="text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    <p class="text-sm text-gray-600 mt-2">Cargando detalle del pago...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- ========================================
             TAB 4: PAGOS ANULADOS
             ======================================== -->
        <div id="content-pagos-anulados" class="tab-content hidden">
            <div class="p-4">
                
                <!-- ==================== CONTADOR DE REGISTROS ENCONTRADOS ==================== -->
                <div class="mb-2">
                    <div class="bg-gradient-to-r from-red-50 to-rose-50 border border-red-300 rounded-lg p-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg">
                                    ‚ùå
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-gray-600 uppercase tracking-wide">
                                        Registros Encontrados
                                    </div>
                                    <div class="text-[10px] text-gray-500 mt-0.5">
                                        Seg√∫n filtros aplicados
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-red-700">
                                    {{ pagos_anulados.paginator.count|default:0 }}
                                </div>
                                <div class="text-[10px] text-gray-600 font-medium mt-0.5">
                                    registro{{ pagos_anulados.paginator.count|pluralize }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n Limpiar Pagos Anulados -->
                <div class="mb-4 flex justify-end">
                    <a href="{% url 'facturacion:limpiar_pagos_anulados' %}" 
                       class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2">
                        üßπ Limpiar Pagos Anulados
                    </a>
                </div>
                
                <!-- Filtros Mejorados -->
                <div class="mb-2 bg-red-50 border border-red-200 rounded-lg p-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-1.5">
                        
                        <!-- Filtro por tipo -->
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">
                                üìã Tipo:
                            </label>
                            <select id="filtro_tipo_anulados"
                                    name="filtro_tipo_anulados"
                                     
                                    class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-red-500">
                                <option value="todos" {% if filtro_tipo_anulados == 'todos' or not filtro_tipo_anulados %}selected{% endif %}>
                                    üìã Todos
                                </option>
                                <option value="sesiones" {% if filtro_tipo_anulados == 'sesiones' %}selected{% endif %}>
                                    üßò Sesiones Normales
                                </option>
                                <option value="proyectos" {% if filtro_tipo_anulados == 'proyectos' %}selected{% endif %}>
                                    üì¶ Proyectos
                                </option>
                                <option value="mensualidades" {% if filtro_tipo_anulados == 'mensualidades' %}selected{% endif %}>
                                    üí≥ Mensualidades
                                </option>
                                <option value="adelantados" {% if filtro_tipo_anulados == 'adelantados' %}selected{% endif %}>
                                    üí∞ Adelantados
                                </option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">üìÖ Fecha desde:</label>
                            <input type="date" id="fecha_desde_anulados" name="fecha_desde" 
                                   value="{{ request.GET.fecha_desde_anulados }}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-red-500">
                        </div>
                        
                        <div>
                            <label class="block text-[9px] font-bold text-gray-700 mb-0.5">üìÖ Fecha hasta:</label>
                            <input type="date" id="fecha_hasta_anulados" name="fecha_hasta" 
                                   value="{{ request.GET.fecha_hasta_anulados }}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-1 focus:ring-red-500">
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="mt-1.5 flex gap-2">
                        <button onclick="aplicarFiltrosAnulados()" 
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-bold transition-colors">
                            üîç Aplicar Filtros
                        </button>
                        <button onclick="limpiarFiltrosAnulados()" 
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-sm font-bold transition-colors">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>

                <!-- Tabla de Pagos Anulados -->
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-red-600">
                            <tr>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Recibo
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Concepto
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Fecha Pago
                                </th>
                                <th class="px-2 py-1.5 text-right text-[10px] font-bold text-white uppercase tracking-wider">
                                    <div>Monto</div>
                                    <!-- Suma total din√°mica -->
                                    <div class="text-yellow-300 font-black text-sm mt-1">
                                        Total: Bs. <span id="suma-total-anulados">{{ suma_total_anulados|floatformat:2|default:"0.00" }}</span>
                                    </div>
                                </th>
                                <th class="px-2 py-1.5 text-left text-[10px] font-bold text-white uppercase tracking-wider">
                                    Anulaci√≥n
                                </th>
                                <th class="px-2 py-1.5 text-center text-[10px] font-bold text-white uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for pago in pagos_anulados %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-2 py-1.5 whitespace-nowrap text-sm font-bold text-gray-900">
                                    {{ pago.numero_recibo }}
                                </td>
                                <td class="px-2 py-1.5 whitespace-nowrap">
                                    {% if pago.sesion %}
                                        <span class="text-xs">üßò Sesi√≥n Normal</span>
                                    {% elif pago.proyecto %}
                                        <span class="text-xs">üì¶ Proyecto</span>
                                    {% elif pago.mensualidad %}
                                        <span class="text-xs">üí≥ Mensualidad</span>
                                    {% else %}
                                        <span class="text-xs">üíµ Pago Adelantado</span>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-1.5">
                                    <div class="text-sm text-gray-900">{{ pago.concepto|truncatewords:8 }}</div>
                                </td>
                                <td class="px-2 py-1.5 whitespace-nowrap text-sm text-gray-900">
                                    {{ pago.fecha_pago|date:"d/m/Y" }}
                                </td>
                                <td class="px-2 py-1.5 whitespace-nowrap text-right text-sm font-bold text-red-600">
                                    Bs. {{ pago.monto|floatformat:2 }}
                                </td>
                                <td class="px-2 py-1.5">
                                    <div class="text-xs text-gray-900">
                                        <strong>Por:</strong> {{ pago.anulado_por.get_full_name|default:pago.anulado_por.username }}
                                    </div>
                                    <div class="text-xs text-gray-600">
                                        {{ pago.fecha_anulacion|date:"d/m/Y H:i" }}
                                    </div>
                                    {% if pago.motivo_anulacion %}
                                        <p class="text-[9px] text-gray-600 mt-1 italic">
                                            "{{ pago.motivo_anulacion|truncatewords:15 }}"
                                        </p>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-1.5 text-center whitespace-nowrap">
                                    <button 
                                        hx-get="{% url 'facturacion:detalle_pago_partial' pago.id %}"
                                        hx-target="#modal-detalle-pago-anulado-content-{{ pago.id }}"
                                        hx-swap="innerHTML"
                                        onclick="document.getElementById('modal-detalle-pago-anulado-{{ pago.id }}').classList.remove('hidden'); document.getElementById('modal-detalle-pago-anulado-{{ pago.id }}').classList.add('flex');"
                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-[10px] font-bold">
                                        üëÅÔ∏è Ver Detalle
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    <p class="text-sm">No hay pagos anulados</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginaci√≥n -->
                {% if pagos_anulados.has_other_pages %}
                <div class="px-2 py-1.5 bg-gray-50 border-t flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Mostrando {{ pagos_anulados.start_index }} - {{ pagos_anulados.end_index }} de {{ pagos_anulados.paginator.count }}
                    </div>
                    <div class="flex gap-2">
                        {% if pagos_anulados.has_previous %}
                            <a href="?page_anulados={{ pagos_anulados.previous_page_number }}{% if request.GET.fecha_desde_anulados %}&fecha_desde_anulados={{ request.GET.fecha_desde_anulados }}{% endif %}{% if request.GET.fecha_hasta_anulados %}&fecha_hasta_anulados={{ request.GET.fecha_hasta_anulados }}{% endif %}" 
                               class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">Anterior</a>
                        {% endif %}
                        {% if pagos_anulados.has_next %}
                            <a href="?page_anulados={{ pagos_anulados.next_page_number }}{% if request.GET.fecha_desde_anulados %}&fecha_desde_anulados={{ request.GET.fecha_desde_anulados }}{% endif %}{% if request.GET.fecha_hasta_anulados %}&fecha_hasta_anulados={{ request.GET.fecha_hasta_anulados }}{% endif %}" 
                               class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">Siguiente</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Modales para detalle de pagos anulados -->
                {% for pago in pagos_anulados %}
                    <!-- Modal Detalle Pago Anulado {{ pago.id }} -->
                    <div id="modal-detalle-pago-anulado-{{ pago.id }}" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg rounded-md bg-white">
                            <div class="flex justify-between items-center mb-4 pb-3 border-b">
                                <h3 class="text-lg font-bold text-gray-900">‚ùå Detalle de Pago Anulado</h3>
                                <button onclick="document.getElementById('modal-detalle-pago-anulado-{{ pago.id }}').classList.add('hidden'); document.getElementById('modal-detalle-pago-anulado-{{ pago.id }}').classList.remove('flex');" 
                                        class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                    √ó
                                </button>
                            </div>
                            
                            <!-- Contenido cargado con HTMX -->
                            <div id="modal-detalle-pago-anulado-content-{{ pago.id }}" class="overflow-y-auto max-h-[70vh]">
                                <div class="text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
                                    <p class="text-sm text-gray-600 mt-2">Cargando detalle del pago...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

    </div> <!-- Fin del contenedor de tabs -->

</div> <!-- Fin del contenedor principal -->

<!-- ========================================
     MODALES
     ======================================== -->

<!-- Modal para Anular Pagos -->
<div id="modal-anular" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-bold text-gray-900 mb-4">‚ö†Ô∏è Anular Pago</h3>
        <p class="text-gray-700 mb-4">¬øEst√°s seguro de anular el recibo <strong id="recibo-numero"></strong>?</p>
        
        <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-2">Motivo de anulaci√≥n *</label>
            <textarea id="motivo-anulacion-detalle" 
                      required
                      rows="3"
                      class="w-full px-2 py-1 border rounded-lg"
                      placeholder="Especifica el motivo..."></textarea>
        </div>
        
        <div class="flex gap-3">
            <button onclick="procesarAnulacion()" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold">
                Confirmar Anulaci√≥n
            </button>
            <button type="button" 
                    onclick="cerrarModalAnular()" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- ========================================
     JAVASCRIPT
     ======================================== -->

<script>

// ==================== DEBUG: VERIFICAR CARGA ==================== 
console.log('‚úÖ Script de detalle_cuenta.html cargado correctamente');

// ==================== FUNCIONES DE MEN√ö DESPLEGABLE ====================

// ==================== FUNCI√ìN MEJORADA TOGGLE DETALLE CON PERSISTENCIA ====================

function toggleDetalle(id) {
    const detalle = document.getElementById(id);
    const icono = document.getElementById('icono-' + id);
    
    console.log('üîÑ Toggle llamado para:', id);
    
    if (!detalle || !icono) {
        console.error('‚ùå Elementos no encontrados para:', id);
        return;
    }
    
    const estaAbierto = detalle.classList.contains('abierto');
    console.log('üìä Estado actual:', estaAbierto ? 'ABIERTO' : 'CERRADO');
    
    if (estaAbierto) {
        // Est√° abierto, vamos a cerrarlo
        console.log('‚¨áÔ∏è Cerrando...');
        detalle.classList.remove('abierto');
        icono.classList.remove('rotado');
        // Forzar estilos inline por si acaso
        detalle.style.maxHeight = '0';
        detalle.style.opacity = '0';
        icono.style.transform = 'rotate(0deg)';
        // Guardar estado cerrado
        localStorage.setItem('desplegable_' + id, 'cerrado');
    } else {
        // Est√° cerrado, vamos a abrirlo
        console.log('‚¨ÜÔ∏è Abriendo...');
        detalle.classList.add('abierto');
        icono.classList.add('rotado');
        // Forzar estilos inline por si acaso
        detalle.style.maxHeight = '50000px';
        detalle.style.opacity = '1';
        icono.style.transform = 'rotate(180deg)';
        // Guardar estado abierto
        localStorage.setItem('desplegable_' + id, 'abierto');
    }
    
    console.log('‚úÖ Toggle completado');
}

// ==================== FUNCI√ìN PARA PAGOS MASIVOS ====================
function toggleDetallePagoMasivo(id) {
    const detalle = document.getElementById(id);
    const icono = document.getElementById('icono-' + id);
    
    console.log('üîÑ Toggle Pago Masivo llamado para:', id);
    
    if (!detalle || !icono) {
        console.error('‚ùå Elementos no encontrados para:', id);
        return;
    }
    
    // Verificar si est√° abierto por la clase
    const estaAbierto = detalle.classList.contains('abierto');
    console.log('üìä Estado actual:', estaAbierto ? 'ABIERTO' : 'CERRADO');
    
    if (estaAbierto) {
        // Est√° abierto, vamos a cerrarlo
        console.log('‚¨áÔ∏è Cerrando pago masivo...');
        detalle.classList.remove('abierto');
        icono.classList.remove('rotado');
        detalle.style.maxHeight = '0';
        detalle.style.opacity = '0';
        icono.style.transform = 'rotate(0deg)';
        
        // Ocultar completamente despu√©s de la animaci√≥n
        setTimeout(() => {
            detalle.style.display = 'none';
        }, 500); // Coincidir con transition de 0.5s
    } else {
        // Est√° cerrado, vamos a abrirlo
        console.log('‚¨ÜÔ∏è Abriendo pago masivo...');
        detalle.style.display = 'table-row'; // ‚úÖ CORREGIDO: Usar table-row para tablas
        
        // Peque√±o delay para que la transici√≥n funcione
        setTimeout(() => {
            detalle.classList.add('abierto');
            icono.classList.add('rotado');
            detalle.style.maxHeight = '2000px';
            detalle.style.opacity = '1';
            icono.style.transform = 'rotate(180deg)';
        }, 10);
    }
    
    console.log('‚úÖ Toggle Pago Masivo completado');
}

// ==================== FUNCIONES DE TABS ====================

function mostrarTab(tab) {
    // Ocultar todos los contenidos
    document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.add('hidden');
    });
    
    // Resetear estilos de botones
    document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50');
        el.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Mostrar contenido seleccionado
    const contenido = document.getElementById('content-' + tab);
    if (contenido) {
        contenido.classList.remove('hidden');
    }
    
    // Activar bot√≥n seleccionado
    const boton = document.getElementById('tab-' + tab);
    if (boton) {
        boton.classList.remove('border-transparent', 'text-gray-500');
        boton.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
    }
}

// ‚úÖ Detectar qu√© tab mostrar al cargar seg√∫n par√°metros
document.addEventListener('DOMContentLoaded', function() {
    console.log('üì± DOM cargado, inicializando...');
    
    // ==================== VERIFICAR QUE LOS ELEMENTOS EXISTEN ====================
    const tarjetasIds = [
        'tarjeta-estado-actual-body',
        'tarjeta-proyeccion-body',
        'tarjeta-credito-body'
    ];
    
    tarjetasIds.forEach(id => {
        const elemento = document.getElementById(id);
        const icono = document.getElementById('icono-' + id);
        
        if (elemento) {
            console.log(`‚úÖ ${id} encontrado`);
            console.log('  - Clases:', elemento.className);
            console.log('  - Display:', window.getComputedStyle(elemento).display);
            console.log('  - MaxHeight:', window.getComputedStyle(elemento).maxHeight);
        } else {
            console.error(`‚ùå ${id} NO encontrado`);
        }
        
        if (icono) {
            console.log(`‚úÖ icono-${id} encontrado`);
        } else {
            console.error(`‚ùå icono-${id} NO encontrado`);
        }
    });
    
    // ==================== RESTAURAR ESTADOS DE DESPLEGABLES ====================
    const desplegables = [
        'tarjeta-estado-actual-body',
        'tarjeta-proyeccion-body',
        'tarjeta-credito-body',
        'detalle-mensualidades',
        'detalle-proyectos-actual',
        'detalle-pagado-actual',
        'detalle-deudas-actual',
        'detalle-mensualidades-proyeccion',
        'detalle-proyectos-progreso-proyeccion',
        'detalle-proyectos-planificados-proyeccion',
        'detalle-pagado-proyeccion',
        'detalle-deudas-proyeccion'
    ];
    
    // NO restaurar estados - iniciar siempre CERRADO
    // (Las tarjetas comienzan contra√≠das por defecto)
    desplegables.forEach(id => {
        const detalle = document.getElementById(id);
        const icono = document.getElementById('icono-' + id);
        if (detalle && icono) {
            // Asegurar que empieza cerrado
            detalle.classList.remove('abierto');
            icono.classList.remove('rotado');
            detalle.style.maxHeight = '0';
            detalle.style.opacity = '0';
            icono.style.transform = 'rotate(0deg)';
        }
    });
    
    // ==================== DETECTAR TAB A MOSTRAR ====================
    const urlParams = new URLSearchParams(window.location.search);
    
    // Priorizar seg√∫n filtros o paginaci√≥n
    // ‚úÖ CORREGIDO: Detectar pesta√±a seg√∫n TODOS los par√°metros posibles
    if (urlParams.has('filtro_tipo_anulados') || 
        urlParams.has('page_anulados') || 
        urlParams.has('fecha_desde_anulados') || 
        urlParams.has('fecha_hasta_anulados')) {
        mostrarTab('pagos-anulados');
    } else if (urlParams.has('filtro_tipo_credito') || 
               urlParams.has('page_credito') || 
               urlParams.has('fecha_desde_credito') || 
               urlParams.has('fecha_hasta_credito')) {
        mostrarTab('pagos-credito');
    } else if (urlParams.has('filtro_tipo_validos') || 
               urlParams.has('filtro_metodo_validos') || 
               urlParams.has('page_validos') || 
               urlParams.has('fecha_desde_validos') || 
               urlParams.has('fecha_hasta_validos')) {
        mostrarTab('pagos-validos');
    } else if (urlParams.has('tipo_concepto') || 
               urlParams.has('estado_servicio') || 
               urlParams.has('estado_pago') || 
               urlParams.has('page') || 
               urlParams.has('fecha_desde_registros') || 
               urlParams.has('fecha_hasta_registros') || 
               urlParams.has('mostrar_programadas')) {
        mostrarTab('registros-cobros');
    } else {
        mostrarTab('registros-cobros'); // Tab por defecto
    }

    // ==================== INICIALIZAR FILTROS MEJORADOS ====================
    
    // Event listener para cambio de tipo de concepto
    const filtroTipoConcepto = document.getElementById('filtro_tipo_concepto');
    if (filtroTipoConcepto) {
        filtroTipoConcepto.addEventListener('change', actualizarOpcionesEstadoServicio);
        
        // Actualizar opciones al cargar la p√°gina seg√∫n el filtro actual
        actualizarOpcionesEstadoServicio();
    }
    
    // Event listener para Enter en los campos de fecha
    const fechaDesde = document.getElementById('fecha_desde_registros');
    const fechaHasta = document.getElementById('fecha_hasta_registros');
    
    if (fechaDesde) {
        fechaDesde.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                aplicarFiltrosRegistrosMejorados();
            }
        });
    }
    
    if (fechaHasta) {
        fechaHasta.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                aplicarFiltrosRegistrosMejorados();
            }
        });
    }
    
    console.log('‚úÖ Filtros de Registros de Cobros inicializados correctamente');
    
});

// ==================== FUNCIONES DE FILTROS ====================

function aplicarFiltroRegistros(filtro) {
    const url = new URL(window.location.href);
    url.searchParams.set('filtro_registros', filtro);
    url.searchParams.delete('page'); // Reset paginaci√≥n
    window.location.href = url.toString();
}

function limpiarTodosLosFiltros(url) {
    // ========== REGISTROS/SESIONES ==========
    url.searchParams.delete('tipo_concepto');
    url.searchParams.delete('estado_servicio');
    url.searchParams.delete('estado_pago');
    url.searchParams.delete('fecha_desde_registros');
    url.searchParams.delete('fecha_hasta_registros');
    url.searchParams.delete('mostrar_programadas');
    url.searchParams.delete('filtro_registros');  // Filtro antiguo
    
    // ========== PAGOS AL CONTADO ==========
    url.searchParams.delete('filtro_tipo_validos');
    url.searchParams.delete('filtro_metodo_validos');
    url.searchParams.delete('fecha_desde_validos');
    url.searchParams.delete('fecha_hasta_validos');
    url.searchParams.delete('page_validos');
    
    // ========== PAGOS CON CR√âDITO ==========
    url.searchParams.delete('filtro_tipo_credito');
    url.searchParams.delete('fecha_desde_credito');
    url.searchParams.delete('fecha_hasta_credito');
    url.searchParams.delete('page_credito');
    
    // ========== PAGOS ANULADOS ==========
    url.searchParams.delete('filtro_tipo_anulados');
    url.searchParams.delete('fecha_desde_anulados');
    url.searchParams.delete('fecha_hasta_anulados');
    url.searchParams.delete('page_anulados');
    
    // ========== PAGINACI√ìN GENERAL ==========
    url.searchParams.delete('page');
    
    return url;
}

function cambiarPestana(nuevaPestana) {
    // Opci√≥n A: Cambio visual sin recargar p√°gina (mejor UX)
    const url = new URL(window.location.href);
    
    // Limpiar TODOS los filtros de la URL
    limpiarTodosLosFiltros(url);
    
    // Actualizar la URL sin recargar la p√°gina
    window.history.pushState({}, '', url.toString());
    
    // La funci√≥n mostrarTab se encargar√° del cambio visual
    // No hacemos nada m√°s aqu√≠, dejamos que mostrarTab() haga su trabajo
}

function aplicarFiltrosValidos() {
    const url = new URL(window.location.href);
    
    // Obtener todos los valores de filtros
    const tipoFiltro = document.getElementById('filtro_tipo_validos').value;
    const metodoFiltro = document.getElementById('filtro_metodo_validos').value;
    const fechaDesde = document.getElementById('fecha_desde_validos').value;
    const fechaHasta = document.getElementById('fecha_hasta_validos').value;
    
    // Limpiar par√°metros de paginaci√≥n
    url.searchParams.delete('page_validos');
    
    // Aplicar filtros
    if (tipoFiltro && tipoFiltro !== 'todos') {
        url.searchParams.set('filtro_tipo_validos', tipoFiltro);
    } else {
        url.searchParams.delete('filtro_tipo_validos');
    }
    
    if (metodoFiltro && metodoFiltro !== 'todos') {
        url.searchParams.set('filtro_metodo_validos', metodoFiltro);
    } else {
        url.searchParams.delete('filtro_metodo_validos');
    }
    
    if (fechaDesde) {
        url.searchParams.set('fecha_desde_validos', fechaDesde);
    } else {
        url.searchParams.delete('fecha_desde_validos');
    }
    
    if (fechaHasta) {
        url.searchParams.set('fecha_hasta_validos', fechaHasta);
    } else {
        url.searchParams.delete('fecha_hasta_validos');
    }
    
    window.location.href = url.toString();
}

function limpiarFiltrosValidos() {
    const url = new URL(window.location.href);
    
    // Eliminar todos los filtros de esta pesta√±a
    url.searchParams.delete('filtro_tipo_validos');
    url.searchParams.delete('filtro_metodo_validos');
    url.searchParams.delete('fecha_desde_validos');
    url.searchParams.delete('fecha_hasta_validos');
    url.searchParams.delete('page_validos');
    
    window.location.href = url.toString();
}

function aplicarFiltrosFechasRegistros() {
    const url = new URL(window.location.href);
    const fechaDesde = document.getElementById('fecha_desde_registros').value;
    const fechaHasta = document.getElementById('fecha_hasta_registros').value;
    const mostrarProgramadas = document.getElementById('mostrar_programadas').checked;
    
    if (fechaDesde) {
        url.searchParams.set('fecha_desde_registros', fechaDesde);
    } else {
        url.searchParams.delete('fecha_desde_registros');
    }
    
    if (fechaHasta) {
        url.searchParams.set('fecha_hasta_registros', fechaHasta);
    } else {
        url.searchParams.delete('fecha_hasta_registros');
    }
    
    url.searchParams.set('mostrar_programadas', mostrarProgramadas);
    url.searchParams.delete('page');
    
    window.location.href = url.toString();
}

function aplicarFiltrosCredito() {
    const url = new URL(window.location.href);
    
    const tipoFiltro = document.getElementById('filtro_tipo_credito').value;
    const fechaDesde = document.getElementById('fecha_desde_credito').value;
    const fechaHasta = document.getElementById('fecha_hasta_credito').value;
    
    url.searchParams.delete('page_credito');
    
    if (tipoFiltro && tipoFiltro !== 'todos') {
        url.searchParams.set('filtro_tipo_credito', tipoFiltro);
    } else {
        url.searchParams.delete('filtro_tipo_credito');
    }
    
    if (fechaDesde) {
        url.searchParams.set('fecha_desde_credito', fechaDesde);
    } else {
        url.searchParams.delete('fecha_desde_credito');
    }
    
    if (fechaHasta) {
        url.searchParams.set('fecha_hasta_credito', fechaHasta);
    } else {
        url.searchParams.delete('fecha_hasta_credito');
    }
    
    window.location.href = url.toString();
}

function limpiarFiltrosCredito() {
    const url = new URL(window.location.href);
    
    url.searchParams.delete('filtro_tipo_credito');
    url.searchParams.delete('fecha_desde_credito');
    url.searchParams.delete('fecha_hasta_credito');
    url.searchParams.delete('page_credito');
    
    window.location.href = url.toString();
}

function aplicarFiltrosAnulados() {
    const url = new URL(window.location.href);
    
    const tipoFiltro = document.getElementById('filtro_tipo_anulados').value;
    const fechaDesde = document.getElementById('fecha_desde_anulados').value;
    const fechaHasta = document.getElementById('fecha_hasta_anulados').value;
    
    url.searchParams.delete('page_anulados');
    
    if (tipoFiltro && tipoFiltro !== 'todos') {
        url.searchParams.set('filtro_tipo_anulados', tipoFiltro);
    } else {
        url.searchParams.delete('filtro_tipo_anulados');
    }
    
    if (fechaDesde) {
        url.searchParams.set('fecha_desde_anulados', fechaDesde);
    } else {
        url.searchParams.delete('fecha_desde_anulados');
    }
    
    if (fechaHasta) {
        url.searchParams.set('fecha_hasta_anulados', fechaHasta);
    } else {
        url.searchParams.delete('fecha_hasta_anulados');
    }
    
    window.location.href = url.toString();
}

function limpiarFiltrosAnulados() {
    const url = new URL(window.location.href);
    
    url.searchParams.delete('filtro_tipo_anulados');
    url.searchParams.delete('fecha_desde_anulados');
    url.searchParams.delete('fecha_hasta_anulados');
    url.searchParams.delete('page_anulados');
    
    window.location.href = url.toString();
}

// ==================== FUNCIONES DE FILTROS MEJORADOS PARA REGISTROS ====================

/**
 * Actualiza din√°micamente las opciones de estado del servicio
 * seg√∫n el tipo de concepto seleccionado
 */
function actualizarOpcionesEstadoServicio() {
    const tipoConcepto = document.getElementById('filtro_tipo_concepto').value;
    const filtroEstado = document.getElementById('filtro_estado_servicio');
    
    // Obtener todos los optgroups
    const optgroupSesiones = document.getElementById('optgroup-sesiones');
    const optgroupProyectos = document.getElementById('optgroup-proyectos');
    const optgroupMensualidades = document.getElementById('optgroup-mensualidades');
    
    // Ocultar todos los optgroups primero
    if (optgroupSesiones) optgroupSesiones.style.display = 'none';
    if (optgroupProyectos) optgroupProyectos.style.display = 'none';
    if (optgroupMensualidades) optgroupMensualidades.style.display = 'none';
    
    // Mostrar el optgroup correspondiente seg√∫n el tipo seleccionado
    if (tipoConcepto === 'sesiones') {
        if (optgroupSesiones) optgroupSesiones.style.display = 'block';
        if (optgroupProyectos) optgroupProyectos.style.display = 'none';
        if (optgroupMensualidades) optgroupMensualidades.style.display = 'none';
    } else if (tipoConcepto === 'proyectos') {
        if (optgroupSesiones) optgroupSesiones.style.display = 'none';
        if (optgroupProyectos) optgroupProyectos.style.display = 'block';
        if (optgroupMensualidades) optgroupMensualidades.style.display = 'none';
    } else if (tipoConcepto === 'mensualidades') {
        if (optgroupSesiones) optgroupSesiones.style.display = 'none';
        if (optgroupProyectos) optgroupProyectos.style.display = 'none';
        if (optgroupMensualidades) optgroupMensualidades.style.display = 'block';
    } else if (tipoConcepto === 'todos') {
        // Mostrar todos los optgroups
        if (optgroupSesiones) optgroupSesiones.style.display = 'block';
        if (optgroupProyectos) optgroupProyectos.style.display = 'block';
        if (optgroupMensualidades) optgroupMensualidades.style.display = 'block';
    }
    
    // Resetear selecci√≥n a "Todos" cuando cambia el tipo
    filtroEstado.value = 'todos';
}

/**
 * Aplica los filtros mejorados y recarga la p√°gina con los par√°metros
 */
function aplicarFiltrosRegistrosMejorados() {
    const url = new URL(window.location.href);
    
    // Limpiar par√°metros antiguos
    url.searchParams.delete('page');
    url.searchParams.delete('filtro_registros'); // Filtro antiguo
    
    // Obtener valores de los filtros
    const tipoConcepto = document.getElementById('filtro_tipo_concepto').value;
    const estadoServicio = document.getElementById('filtro_estado_servicio').value;
    const estadoPago = document.getElementById('filtro_estado_pago').value;
    const fechaDesde = document.getElementById('fecha_desde_registros').value;
    const fechaHasta = document.getElementById('fecha_hasta_registros').value;
    const mostrarProgramadas = document.getElementById('mostrar_programadas').checked;
    
    // Agregar par√°metros nuevos
    if (tipoConcepto && tipoConcepto !== 'todos') {
        url.searchParams.set('tipo_concepto', tipoConcepto);
    } else {
        url.searchParams.delete('tipo_concepto');
    }
    
    if (estadoServicio && estadoServicio !== 'todos') {
        url.searchParams.set('estado_servicio', estadoServicio);
    } else {
        url.searchParams.delete('estado_servicio');
    }
    
    if (estadoPago && estadoPago !== 'todos') {
        url.searchParams.set('estado_pago', estadoPago);
    } else {
        url.searchParams.delete('estado_pago');
    }
    
    if (fechaDesde) {
        url.searchParams.set('fecha_desde_registros', fechaDesde);
    } else {
        url.searchParams.delete('fecha_desde_registros');
    }
    
    if (fechaHasta) {
        url.searchParams.set('fecha_hasta_registros', fechaHasta);
    } else {
        url.searchParams.delete('fecha_hasta_registros');
    }
    
    // Mostrar programadas
    url.searchParams.set('mostrar_programadas', mostrarProgramadas);
    
    // Redirigir con los nuevos filtros
    window.location.href = url.toString();
}

/**
 * Limpia todos los filtros y recarga la p√°gina
 */
function limpiarFiltrosRegistros() {
    const url = new URL(window.location.href);
    
    // Eliminar todos los par√°metros de filtro
    url.searchParams.delete('tipo_concepto');
    url.searchParams.delete('estado_servicio');
    url.searchParams.delete('estado_pago');
    url.searchParams.delete('fecha_desde_registros');
    url.searchParams.delete('fecha_hasta_registros');
    url.searchParams.delete('mostrar_programadas');
    url.searchParams.delete('page');
    url.searchParams.delete('filtro_registros'); // Filtro antiguo
    
    // Redirigir sin filtros
    window.location.href = url.toString();
}

// ==================== FUNCIONES DE MODALES ====================
let pagoIdAnular = null;

// Funci√≥n para abrir el modal de anulaci√≥n
function confirmarAnulacion(pagoId, numeroRecibo) {
    pagoIdAnular = pagoId;
    document.getElementById('recibo-numero').textContent = numeroRecibo;
    document.getElementById('motivo-anulacion-detalle').value = '';
    document.getElementById('modal-anular').classList.remove('hidden');
    document.getElementById('modal-anular').classList.add('flex');
}

// Funci√≥n para cerrar el modal
function cerrarModalAnular() {
    document.getElementById('modal-anular').classList.add('hidden');
    document.getElementById('modal-anular').classList.remove('flex');
    pagoIdAnular = null;
    document.getElementById('motivo-anulacion-detalle').value = '';
}

// Funci√≥n para procesar la anulaci√≥n con AJAX

// ==================== FUNCI√ìN PARA PROCESAR LA ANULACI√ìN ====================

function procesarAnulacion() {
    const motivo = document.getElementById('motivo-anulacion-detalle').value.trim();
    
    if (!motivo) {
        alert('‚ö†Ô∏è Por favor ingrese un motivo de anulaci√≥n');
        return;
    }
    
    if (!pagoIdAnular) {
        alert('‚ùå Error: No se seleccion√≥ un pago para anular');
        return;
    }
    
    // Deshabilitar el bot√≥n mientras se procesa
    const btnConfirmar = event.target;
    btnConfirmar.disabled = true;
    btnConfirmar.textContent = 'Procesando...';
    
    // Enviar solicitud de anulaci√≥n con AJAX
    fetch(`/facturacion/pago/${pagoIdAnular}/anular/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ motivo: motivo })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Error desconocido');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Cerrar el modal
            cerrarModalAnular();
            
            // Mostrar mensaje de √©xito simple
            mostrarMensajeExito(data.message);
        } else {
            alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Anulaci√≥n';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al anular el recibo: ' + error.message);
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = 'Confirmar Anulaci√≥n';
    });
}

// Funci√≥n para mostrar mensaje de √©xito SIMPLE
function mostrarMensajeExito(mensaje) {
    // Crear el mensaje
    const div = document.createElement('div');
    div.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) translateY(-10px);
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 30px 50px;
        border-radius: 15px;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 999999;
        text-align: center;
        opacity: 0;
    `;
    div.innerHTML = `
        <div style="font-size: 50px; margin-bottom: 10px;">‚úÖ</div>
        <div>${mensaje}</div>
    `;
    
    // Agregar al body
    document.body.appendChild(div);
    
    // Animaci√≥n de entrada (fade-in down)
    setTimeout(() => {
        div.style.transition = 'all 0.8s ease-out';
        div.style.opacity = '1';
        div.style.transform = 'translate(-50%, -50%) translateY(0)';
    }, 10);
    
    // Animaci√≥n de salida y recarga despu√©s de 1 segundo
    setTimeout(() => {
        div.style.transition = 'all 0.8s ease-in';
        div.style.opacity = '0';
        div.style.transform = 'translate(-50%, -50%) translateY(-10px)';
        
        setTimeout(() => {
            location.reload();
        }, 300);
    }, 1000);
}
</script>

{% endblock %}