<!-- facturacion/templates/facturacion/partials/detalle_pago.html -->

<div class="space-y-2 sm:space-y-3">
    <!-- Informaci√≥n Principal del Pago -->
    <div class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-400 rounded-lg p-2 sm:p-3">
        <div class="flex flex-col sm:flex-row justify-between items-start gap-2 mb-2">
            <div>
                <p class="text-[10px] text-green-600 font-semibold">üìÑ Recibo</p>
                <p class="font-mono text-lg sm:text-xl font-black text-green-900">{{ pago.numero_recibo }}</p>
            </div>
            <div class="text-left sm:text-right">
                <p class="text-[10px] text-green-600 font-semibold">üíµ Monto</p>
                <p class="text-xl sm:text-2xl font-black text-green-700">Bs. {{ pago.monto|floatformat:2 }}</p>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-2 sm:gap-3 mt-2">
            <div>
                <p class="text-[10px] text-green-600 font-semibold">üìÖ Fecha de Pago</p>
                <p class="text-xs font-bold text-green-900">{{ pago.fecha_pago|date:"d/m/Y" }}</p>
            </div>
            <div>
                <p class="text-[10px] text-green-600 font-semibold">üí≥ M√©todo</p>
                <span class="inline-block px-2 py-0.5 rounded {% if pago.metodo_pago.nombre == 'Uso de Cr√©dito' %}bg-purple-600{% else %}bg-blue-600{% endif %} text-white font-bold text-xs">
                    {{ pago.metodo_pago.nombre }}
                </span>
            </div>
        </div>
        
        <!-- ‚úÖ INDICADOR DE PAGO CON CR√âDITO -->
        {% if pago.metodo_pago.nombre == "Uso de Cr√©dito" %}
        <div class="mt-2 bg-purple-100 border-2 border-purple-300 rounded-lg p-2">
            <p class="text-[10px] sm:text-xs text-purple-700 font-bold flex items-center gap-1.5">
                <span class="text-base">üí∞</span>
                PAGO REALIZADO CON CR√âDITO
            </p>
            <p class="text-[9px] sm:text-xs text-purple-600 mt-0.5">
                Este pago se realiz√≥ usando el saldo a favor del paciente. No se gener√≥ recibo f√≠sico.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Paciente -->
    <div class="bg-gray-50 rounded-lg p-2 sm:p-3">
        <p class="text-[10px] text-gray-600 font-semibold mb-0.5">üë§ Paciente</p>
        <p class="text-sm sm:text-base font-bold text-gray-900">{{ pago.paciente.nombre_completo }}</p>
        <p class="text-[10px] sm:text-xs text-gray-600">{{ pago.paciente.nombre_tutor }} ¬∑ {{ pago.paciente.telefono_tutor }}</p>
    </div>

    <!-- Concepto -->
    <div class="bg-blue-50 rounded-lg p-2 sm:p-3">
        <p class="text-[10px] sm:text-xs text-blue-600 font-semibold mb-1">üìã Concepto</p>
        <p class="text-xs text-gray-700">{{ pago.concepto }}</p>
    </div>

    <!-- ‚úÖ NUEVO: DETALLES DE PAGO MASIVO -->
    {% if pago.es_pago_masivo %}
    <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-400 rounded-lg p-2 sm:p-3">
        <h3 class="text-xs sm:text-sm font-bold text-purple-900 mb-2 flex items-center gap-1.5">
            <span class="text-base sm:text-lg">üí∞</span>
            Pago Masivo - {{ pago.cantidad_detalles }} √çtem{{ pago.cantidad_detalles|pluralize }}
        </h3>
        
        <p class="text-[10px] text-purple-700 mb-2">
            Este recibo agrupa el pago de m√∫ltiples servicios en una sola transacci√≥n.
        </p>
        
        <div class="space-y-1.5 max-h-60 overflow-y-auto">
            {% for detalle in pago.detalles_masivos.all %}
            <div class="bg-white border border-purple-200 rounded-lg p-2">
                <div class="flex justify-between items-start mb-1">
                    <div class="flex-1">
                        <div class="flex items-center gap-1.5 mb-0.5">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold
                                {% if detalle.tipo == 'sesion' %}bg-purple-100 text-purple-700
                                {% elif detalle.tipo == 'proyecto' %}bg-blue-100 text-blue-700
                                {% elif detalle.tipo == 'mensualidad' %}bg-indigo-100 text-indigo-700
                                {% endif %}">
                                {% if detalle.tipo == 'sesion' %}üßò Sesi√≥n
                                {% elif detalle.tipo == 'proyecto' %}üì¶ Proyecto
                                {% elif detalle.tipo == 'mensualidad' %}üí≥ Mensualidad
                                {% endif %}
                            </span>
                        </div>
                        <p class="text-xs font-bold text-gray-900">{{ detalle.concepto }}</p>
                    </div>
                    <p class="text-sm font-black text-purple-700 ml-2">
                        Bs. {{ detalle.monto|floatformat:2 }}
                    </p>
                </div>
                
                <!-- Informaci√≥n adicional seg√∫n tipo -->
                {% if detalle.sesion %}
                    <p class="text-[10px] text-gray-600">
                        üìÖ {{ detalle.sesion.fecha|date:"d/m/Y" }} ‚Ä¢ 
                        {{ detalle.sesion.servicio.nombre }} ‚Ä¢ 
                        {{ detalle.sesion.profesional.nombre }}
                    </p>
                {% elif detalle.proyecto %}
                    <p class="text-[10px] text-gray-600">
                        üì¶ {{ detalle.proyecto.codigo }} ‚Ä¢ 
                        {{ detalle.proyecto.nombre }}
                    </p>
                {% elif detalle.mensualidad %}
                    <p class="text-[10px] text-gray-600">
                        üí≥ {{ detalle.mensualidad.periodo_display }} ‚Ä¢ 
                        {{ detalle.mensualidad.codigo }}
                    </p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Resumen del pago masivo -->
        <div class="bg-purple-900 rounded-lg p-2 mt-2">
            <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-purple-100">Total del Pago Masivo:</span>
                <span class="text-lg font-black text-white">Bs. {{ pago.monto|floatformat:2 }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- üÜï SESI√ìN ASOCIADA (solo si NO es pago masivo) -->
    {% if pago.sesion and not pago.es_pago_masivo %}
    <div class="border-t pt-2 sm:pt-3">
        <h3 class="text-xs sm:text-sm font-bold text-gray-900 mb-2 flex items-center gap-1.5">
            <span class="text-base sm:text-lg">üìÖ</span>
            Sesi√≥n Asociada
        </h3>
        
        <div class="bg-white border-2 border-gray-200 rounded-lg p-2 sm:p-3">
            <!-- Fecha y hora -->
            <div class="flex flex-col sm:flex-row justify-between items-start gap-2 mb-2">
                <div>
                    <p class="text-[10px] text-gray-600 font-semibold">Fecha y Hora</p>
                    <p class="text-sm sm:text-base font-bold text-gray-900">
                        {{ pago.sesion.fecha|date:"d/m/Y" }} {{ pago.sesion.hora_inicio|time:"H:i" }}
                    </p>
                </div>
                <span class="px-2 py-0.5 rounded text-[10px] sm:text-xs font-bold
                    {% if pago.sesion.estado == 'realizada' %}bg-green-100 text-green-700
                    {% elif pago.sesion.estado == 'realizada_retraso' %}bg-yellow-100 text-yellow-700
                    {% elif pago.sesion.estado == 'programada' %}bg-blue-100 text-blue-700
                    {% elif pago.sesion.estado == 'falta' %}bg-red-100 text-red-700
                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                    {{ pago.sesion.get_estado_display }}
                </span>
            </div>

            <!-- Servicio y Profesional -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                <div>
                    <p class="text-[10px] text-gray-600 font-semibold mb-0.5">ü•º Servicio</p>
                    <div class="flex items-center gap-1.5">
                        <span class="inline-block w-2 h-2 rounded-full" style="background-color: {{ pago.sesion.servicio.color }}"></span>
                        <p class="text-xs font-bold text-gray-900">{{ pago.sesion.servicio.nombre }}</p>
                    </div>
                </div>
                <div>
                    <p class="text-[10px] text-gray-600 font-semibold mb-0.5">üë®‚Äç‚öïÔ∏è Profesional</p>
                    <p class="text-xs font-bold text-gray-900">
                        {{ pago.sesion.profesional.nombre }} {{ pago.sesion.profesional.apellido }}
                    </p>
                </div>
            </div>

            <!-- Costos -->
            <div class="bg-gray-50 rounded p-2">
                <div class="flex justify-between text-xs mb-0.5">
                    <span class="font-semibold">Costo sesi√≥n:</span>
                    <span class="font-bold">Bs. {{ pago.sesion.monto_cobrado|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between text-xs mb-0.5">
                    <span class="font-semibold">Total pagado:</span>
                    <span class="font-bold text-green-700">Bs. {{ pago.sesion.total_pagado|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between text-xs pt-1.5 border-t border-gray-300">
                    <span class="font-semibold">Estado de pago:</span>
                    <span class="font-bold {% if pago.sesion.pagado %}text-green-700{% else %}text-red-700{% endif %}">
                        {% if pago.sesion.pagado %}‚úÖ Pagado completamente
                        {% elif pago.sesion.total_pagado > 0 %}‚ö†Ô∏è Pago parcial (falta Bs. {{ pago.sesion.saldo_pendiente|floatformat:2 }})
                        {% else %}‚ùå Sin pagar{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
    {% elif pago.proyecto and not pago.es_pago_masivo %}
    <!-- Proyecto asociado (solo si NO es pago masivo) -->
    <div class="border-t pt-2 sm:pt-3">
        <h3 class="text-xs sm:text-sm font-bold text-gray-900 mb-2 flex items-center gap-1.5">
            <span class="text-base sm:text-lg">üì¶</span>
            Proyecto Asociado
        </h3>
        
        <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-2 sm:p-3">
            <p class="text-sm sm:text-base font-bold text-purple-900">{{ pago.proyecto.codigo }}</p>
            <p class="text-xs text-purple-700">{{ pago.proyecto.nombre }}</p>
            <p class="text-[10px] text-purple-600 mt-0.5">{{ pago.proyecto.get_tipo_display }}</p>
            
            <div class="bg-white rounded p-2 mt-2">
                <div class="flex justify-between text-xs">
                    <span class="font-semibold">Costo total proyecto:</span>
                    <span class="font-bold">Bs. {{ pago.proyecto.costo_total|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between text-xs mt-0.5">
                    <span class="font-semibold">Total pagado:</span>
                    <span class="font-bold text-green-700">Bs. {{ pago.proyecto.total_pagado|floatformat:2 }}</span>
                </div>
            </div>
        </div>
    </div>
    {% elif not pago.es_pago_masivo %}
    <!-- Pago adelantado / A cuenta (solo si NO es pago masivo) -->
    <div class="border-t pt-2 sm:pt-3">
        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 text-center">
            <p class="text-xl sm:text-2xl mb-1">üí∞</p>
            <p class="text-sm sm:text-base font-bold text-blue-900">Pago Adelantado / A Cuenta</p>
            <p class="text-[10px] sm:text-xs text-blue-700 mt-1.5">
                Este pago no est√° asociado a ninguna sesi√≥n espec√≠fica.
                <br>Est√° disponible como <strong>cr√©dito a favor</strong> del paciente.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Detalles adicionales -->
    {% if pago.numero_transaccion %}
    <div class="bg-gray-50 rounded-lg p-2 sm:p-3">
        <p class="text-[10px] text-gray-600 font-semibold mb-0.5">üî¢ N√∫mero de Transacci√≥n</p>
        <p class="font-mono text-xs text-gray-900">{{ pago.numero_transaccion }}</p>
    </div>
    {% endif %}

    <!-- Observaciones -->
    {% if pago.observaciones %}
    <div class="bg-gray-50 rounded-lg p-2 sm:p-3">
        <p class="text-[10px] text-gray-600 font-semibold mb-1">üìù Observaciones</p>
        <p class="text-xs text-gray-700 whitespace-pre-wrap">{{ pago.observaciones }}</p>
    </div>
    {% endif %}

    <!-- Estado de anulaci√≥n -->
    {% if pago.anulado %}
    <div class="bg-red-50 border-2 border-red-400 rounded-lg p-2 sm:p-3">
        <p class="text-xs sm:text-sm font-bold text-red-900 flex items-center gap-1.5 mb-1.5">
            <span class="text-base sm:text-lg">‚ö†Ô∏è</span>
            PAGO ANULADO
        </p>
        <div class="space-y-1 text-xs">
            <p class="text-red-700"><strong>Motivo:</strong> {{ pago.motivo_anulacion }}</p>
            <p class="text-red-700">
                <strong>Anulado por:</strong> 
                {{ pago.anulado_por.get_full_name|default:pago.anulado_por.username }}
            </p>
            <p class="text-red-700">
                <strong>Fecha:</strong> {{ pago.fecha_anulacion|date:"d/m/Y H:i" }}
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Informaci√≥n de control -->
    <div class="border-t pt-2 sm:pt-3">
        <h3 class="text-[10px] font-bold text-gray-500 mb-2">üìä INFORMACI√ìN DE REGISTRO</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 text-[10px] sm:text-xs text-gray-500">
            <div>
                <p class="font-semibold">Registrado por:</p>
                <p>{{ pago.registrado_por.get_full_name|default:pago.registrado_por.username }}</p>
                <p>{{ pago.fecha_registro|date:"d/m/Y H:i" }}</p>
            </div>
            <div>
                <p class="font-semibold">ID del pago:</p>
                <p class="font-mono">#{{ pago.id }}</p>
            </div>
        </div>
    </div>

    <!-- ‚úÖ Bot√≥n imprimir recibo - SOLO SI NO ES PAGO CON CR√âDITO -->
    {% if pago.metodo_pago.nombre != "Uso de Cr√©dito" %}
    <div class="border-t pt-2 sm:pt-3">
        <a href="{% url 'facturacion:generar_recibo_pdf' pago.id %}" 
        target="_blank"
        class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center px-3 py-2 rounded-lg text-xs sm:text-sm font-bold transition">
            üñ®Ô∏è Imprimir Recibo
        </a>
    </div>
    {% else %}
    <!-- Mensaje informativo para pagos con cr√©dito -->
    <div class="border-t pt-2 sm:pt-3">
        <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-2 sm:p-3 text-center">
            <p class="text-[10px] sm:text-xs text-purple-700 font-medium">
                ‚ÑπÔ∏è Los pagos realizados con cr√©dito no generan recibo f√≠sico
            </p>
            <p class="text-[9px] sm:text-xs text-purple-600 mt-0.5">
                El recibo original se gener√≥ cuando se realiz√≥ el pago adelantado
            </p>
        </div>
    </div>
    {% endif %}
</div>